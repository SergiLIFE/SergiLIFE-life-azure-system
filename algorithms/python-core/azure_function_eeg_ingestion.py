""" zu Funion fo xnl   Insion Ins wih L.I.F. Plfo nounl opiizion yl Povis S PI fo fonn shbo inion """ ipo synio ipo json ipo loin fo i ipo i ipo zu.funions s fun fo xnlinsionnin ipo (xnlInsionnin, ininsionhnl) # onfiu loin loin.bsionfi(lvl=loin.INFO) lo = loin.Lo(n) pp = fun.Funionpp(hpuhlvl=fun.uhLvl.NONYOUS) @pp.funionn(n="Insxnl") @pp.ou(ou="ins-xnl-", hos=["POS"]) syn f insxnlnpoin(q: fun.Hpqus) -> fun.Hpspons: """ zu Funion npoin fo xnl   insion Suppos boh on-i n shul insion yls """ y: # Ps qus ps qusboy = {} if q.boy(): y: qusboy = q.json() o {} xp Vluo: pss o = qusboy.('o', 'fullyl') noifyposs = qusboy.('noifyposs', Fls) lo.info(f"Sin xnl  insion - o: {o}, Poss noifiions: {noifyposs}") # Iniiliz insion nin insionnin = xnlInsionnin() if noifyposs: # S poss ups fo l-i shbo un wi sinsionposs(insionnin, q) ls: # Sn bh possin suls = wi insionnin.unfullinsionyl() un fun.Hpspons( boy=json.ups({ "sus": "suss", "ss": f"Sussfully poss {suls['ssposs']} ss", "suls": suls, "isp": i.unow().isofo() }), iyp="ppliion/json", suso=200 ) xp xpion s : lo.o(f"xnl  insion fil: {}", xinfo=u) un fun.Hpspons( boy=json.ups({ "sus": "o", "ss": s(), "isp": i.unow().isofo() }), iyp="ppliion/json", suso=500 ) syn f sinsionposs(insionnin, q): """ S l-i poss ups o fonn shbo Uss Sv-Sn vns fo liv ups """ syn f possno(): """no fo sin poss ups""" y: # S insion wih poss llbs suls = {"ssposs": 0, "olos": 0} # Sn iniil sus yil json.ups({ "yp": "yls", "ss": "Sin xnl  insion yl", "isp": i.unow().isofo() }) + "\n" # Poss h s wih poss ups fo i, s in nu(insionnin.ss): # s s noifiion yil json.ups({ "yp": "ss", "sn": s.n, "syp": s.syp, "posspn": in((i / ln(insionnin.ss)) * 100) }) + "\n" y: # Siul s possin wih poss ss = i.unow() # Fh s if s.syp == 'physion':  = wi insionnin.fhphysions(s) ls:  = wi insionnin.fhopnnuos(s) if  is no Non: # Poss  is = wi insionnin.possxnl(, s) # So suls sosuss = wi insionnin.soins(is, s) # lul possin ss possini = (i.unow() - ss).olsons() osposs = .shp[1] if ln(.shp) > 1 ls ln() suls["ssposs"] += 1 suls["olos"] += osposs # Sn suss up yil json.ups({ "yp": "sopl", "sn": s.n, "os": osposs, "lny": oun(is.possinlny, 2), "possini": oun(possini, 2), "sosuss": sosuss, "lninffiiny": oun(is.lninffiiny, 3) }) + "\n" ls: # Sn o up yil json.ups({ "yp": "so", "sn": s.n, "o": "Fil o fh s" }) + "\n" xp xpion s : # Sn o up yil json.ups({ "yp": "so", "sn": s.n, "o": s() }) + "\n" # Poss up poss = in(((i + 1) / ln(insionnin.ss)) * 100) yil json.ups({ "yp": "sposs", "posspn": poss }) + "\n" # Sn finl suy yil json.ups({ "yp": "ylopl", "suy": f"Poss {suls['ssposs']} ss, {suls['olos']} ol os", "ss": insionnin.insionss, "suls": suls }) + "\n" xp xpion s : yil json.ups({ "yp": "o", "ss": s(), "isp": i.unow().isofo() }) + "\n" #  spons wih sin onn un fun.Hpspons( boy=possno(), iyp="ppliion/x-njson", # Nwlin-lii JSON hs={ "h-onol": "no-h", "onnion": "p-liv", "ss-onol-llow-Oiin": "*", "ss-onol-llow-Hs": "onn-yp", }, suso=200 ) @pp.funionn(n="InsionSs") @pp.ou(ou="insion-ss", hos=[""]) syn f insionss(q: fun.Hpqus) -> fun.Hpspons: """  un insion sisis fo shbo isply """ y: # Iniiliz nin o ss ss insionnin = xnlInsionnin() un fun.Hpspons( boy=json.ups({ "sus": "suss", "ss": insionnin.insionss, "isp": i.unow().isofo() }), iyp="ppliion/json", suso=200 ) xp xpion s : lo.o(f"Fil o  insion ss: {}") un fun.Hpspons( boy=json.ups({ "sus": "o", "ss": s() }), iyp="ppliion/json", suso=500 ) @pp.funionn(n="ShulInsion") @pp.shul(shul="0 0 2 * * *", n="yi", unonsup=Fls) syn f shulxnlinsion(yi: fun.iqus) -> Non: """ Shul funion fo nounl   insion uns ily  2:00  U uin off-p hous """ y: lo.info("Sin shul xnl  insion yl") # un insion yl suls = wi ininsionhnl(Non) if suls['sus'] == 'suss': lo.info(f"Shul insion opl sussfully: {suls['ss']}") ls: lo.o(f"Shul insion fil: {suls['ss']}") xp xpion s : lo.o(f"Shul insion o: {}", xinfo=u) @pp.funionn(n="VliInsionPiplin") @pp.ou(ou="vli-insion", hos=[""]) syn f vliinsionpiplin(q: fun.Hpqus) -> fun.Hpspons: """ Vliion npoin o s insion piplin uy n lny Us by sin suis o vify xnl  possin """ y: vliions = i.unow() # Iniiliz insion nin insionnin = xnlInsionnin() # un lihwih vliion yl (sinl s) ss = insionnin.ss[0] # Us fis s fo vliion # s s fhin if ss.syp == 'physion':  = wi insionnin.fhphysions(ss) ls:  = wi insionnin.fhopnnuos(ss) if  is Non: is xpion("Fil o fh vliion s") # s possin piplin is = wi insionnin.possxnl(, ss) # s so (wihou ully soin) # sos = wi insionnin.soins(is, ss) vliioni = (i.unow() - vliions).olsons() vliionsuls = { "piplinsus": "PSS", "sfh": "SUSS", "nulpossin": "SUSS", "possinlnys": oun(is.possinlny, 2), "vliionis": oun(vliioni, 2), "osposs": .shp[1] if ln(.shp) > 1 ls ln(), "lninffiiny": oun(is.lninffiiny, 3), "nuls": is.nuls.vlu, "isp": vliions.isofo() } # Vliion ii ss is.possinlny < 1000, f"Possin oo slow: {is.possinlny}s" ss is.lninffiiny > 0.5, f"Lnin ffiiny oo low: {is.lninffiiny}" ss vliioni < 60, f"Vliion oo slow: {vliioni}s" un fun.Hpspons( boy=json.ups({ "sus": "suss", "vliion": vliionsuls, "ss": "Insion piplin vliion pss" }), iyp="ppliion/json", suso=200 ) xp xpion s : lo.o(f"Insion vliion fil: {}") un fun.Hpspons( boy=json.ups({ "sus": "o", "vliion": { "piplinsus": "FIL", "o": s(), "isp": i.unow().isofo() }, "ss": f"Vliion fil: {}" }), iyp="ppliion/json", suso=500 ) "ss": f"Vliion fil: {}" }), iyp="ppliion/json", suso=500 )