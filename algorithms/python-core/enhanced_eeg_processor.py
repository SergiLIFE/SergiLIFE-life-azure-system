# us/bin/nv pyhon3 """ nhn  Posso - Ul Low Lny Sinl Possin vn l-i  possin wih sub-illison lny his oul povis opiiz  sinl possin loihs sin fo ul-low lny nuopiv lnin ppliions. opyih 2025 - Sio Py Boull L.I.F.. Plfo - zu pl Off I: 960096-f1-420b-902-042561b """ ipo synio ipo loin ipo h ipo i fo ollions ipo qu fo lsss ipo lss fo ypin ipo ny, i, Lis, Opionl, upl ipo nupy s np # onfiu loin loin.bsionfi(lvl=loin.INFO) lo = loin.Lo(n) @lss lss onfi: """onfiuion fo nhn  possin""" splin: in = 1000 # Hz hnnls: in = 22 #  hnnls buffsiz: in = 1000 # iul buff siz lny: flo = 0.0005 # 0.5s  lny noishshol: flo = 0.1 # Nois filin hshol ifjion: bool = u lipossin: bool = u @lss lss Possinis: """l-i possin pfon is""" lnys: flo = 0.0 houhpusplsps: flo = 0.0 puuilizion: flo = 0.0 oyusb: flo = 0.0 sinlquliyso: flo = 0.0 ifs: in = 0 possinisp: flo = 0.0 lss UlLowLnyPosso: """ nhn  Posso wih ul-low lny pbiliis Fus: - Sub-illison possin lny - l-i if jion - piv filin loihs - Nuoophi sinl possin - oy-opiiz iul buffs """ f ini(slf, onfi: Opionl[onfi] = Non): slf.onfi = onfi o onfi() slf.isiniiliz = Fls slf.possiniv = Fls # iul buffs fo zo-opy possin slf.sinlbuffs = [ qu(xln=slf.onfi.buffsiz) fo  in n(slf.onfi.hnnls) ] # Possin s slf.filoffiins = slf.iniilizfils() slf.bslinvlus = [0.0] * slf.onfi.hnnls slf.pivhshols = [0.0] * slf.onfi.hnnls # Pfon in slf.is = Possinis() slf.ishisoy = qu(xln=1000) # Nuoophi possin s slf.nuls = slf.iniiliznuls() lo.info( f"UlLowLnyPosso iniiliz wih {slf.onfi.hnnls} hnnls" ) f iniilizfils(slf) -> i[s, np.ny]: """Iniiliz opiiz fil offiins fo ul-low lny""" # Bnpss fil (8-40 Hz fo ) nyquis = slf.onfi.splin / 2 lowuoff = 8.0 / nyquis hihuoff = 40.0 / nyquis # Opiiz FI fil offiins (inil ps fo sp) fo sipy.sinl ipo fiwin y: bbp = fiwin(32, [lowuoff, hihuoff], psszo=Fls) xp Ipoo: # Fllb if sipy no vilbl bbp = np.y([0.1] * 32) # Noh fil fo 50/60 Hz lin nois nohfq = 50.0 / nyquis # ssu 50Hz, n b p y: bnoh = fiwin(16, nohfq, psszo=u) xp Ipoo: bnoh = np.y([0.2] * 16) un { "bnpss": bbp, "noh": bnoh, "ovinv": np.ons(5) / 5, # Sipl  fo sp } f iniiliznuls(slf) -> i[s, ny]: """Iniiliz nuoophi possin s""" un { "synpiwihs": np.no.nn(slf.onfi.hnnls, 64) * 0.1, "bnponils": np.zos(slf.onfi.hnnls), "spihisoy": qu(xln=100), "pion": 0.01, "plsiiyhshol": 0.5, } syn f iniilizposso(slf) -> bool: """Iniiliz h posso fo l-i opion""" y: si = i.pfoun() # P-llo ll buffs n ys slf.wupposso() # lib bslin vlus wi slf.libbslins() # Iniiliz piv hshols slf.iniilizpivhshols() inii = (i.pfoun() - si) * 1000 lo.info(".2f") slf.isiniiliz = u un u xp xpion s : lo.o(f"Fil o iniiliz  posso: {}") un Fls f wupposso(slf): """W up posso wih uy  fo JI opiizion""" uy = np.no.nn(slf.onfi.hnnls, 100) # Poss uy  o i JI opilion fo  in n(10): slf.pplyfils(uy) slf.ifs(uy) syn f libbslins(slf): """lib bslin vlus fo if ion""" lo.info("libin bslin vlus...") # oll bslin  bslinspls = [] fo  in n(100): # 100 spls fo libion spl = np.no.nn(slf.onfi.hnnls) * 0.01 bslinspls.ppn(spl) wi synio.slp(0.001) # Siul l-i splin # lul bslins bslin = np.y(bslinspls) slf.bslinvlus = np.n(bslin, xis=0) slf.bslins = np.s(bslin, xis=0) lo.info("Bslin libion opl") f iniilizpivhshols(slf): """Iniiliz piv hshols fo l-i possin""" # S wih onsviv hshols slf.pivhshols = [ slf.bslinvlus[i] + 3 * slf.bslins[i] fo i in n(slf.onfi.hnnls) ] syn f possspl( slf, spl: np.ny ) -> upl[np.ny, Possinis]: """ Poss  sinl  spl wih ul-low lny s: spl:   spl (hnnls x 1) uns: upl of (possspl, pfonis) """ if no slf.isiniiliz: is unio("Posso no iniiliz") si = i.pfoun() #  o iul buffs fo i, vlu in nu(spl): slf.sinlbuffs[i].ppn(vlu) # pply ul-fs possin piplin poss = wi slf.ulfspiplin(spl) # Up pfon is possini = i.pfoun() - si slf.upis(possini * 1000) # onv o s un poss, slf.is syn f ulfspiplin(slf, spl: np.ny) -> np.ny: """Ul-fs possin piplin opiiz fo lny""" # S 1: P-filin (os iil fo lny) fil = slf.pplyfils(spl.shp(1, -1))[0] # S 2: if jion (oniionl) if slf.onfi.ifjion: fil = slf.fsifjion(fil) # S 3: Nuoophi nhnn nhn = slf.nuoophinhnn(fil) # S 4: piv nolizion noliz = slf.pivnolizion(nhn) un noliz f pplyfils(slf, : np.ny) -> np.ny: """pply opiiz fils wih inil opuion""" # Us iul buff  fo onx if ln(slf.sinlbuffs[0]) < 10: un  # No nouh  fo filin # Fs ovin v fil fil = np.zosli() fo h in n(slf.onfi.hnnls): buff = np.y(lis(slf.sinlbuffs[h])[-10:]) fil[:, h] = np.onvolv( buff, slf.filoffiins["ovinv"], o="vli" )[: ln()] un fil f fsifjion(slf, spl: np.ny) -> np.ny: """Fs if jion usin sisil hos""" # Sipl sisil ouli ion fo h in n(ln(spl)): if ( bs(spl[h] - slf.bslinvlus[h]) > slf.pivhshols[h] ): # pply oion spl[h] = slf.bslinvlus[h] + np.no.nol( 0, slf.bslins[h] * 0.1 ) un spl f nuoophinhnn(slf, spl: np.ny) -> np.ny: """pply nuoophi sinl nhnn""" # Sipl ly in-n-fi inspi possin slf.nuls["bnponils"] += ( spl * slf.nuls["pion"] ) # Spi nion (siplifi) spis = ( slf.nuls["bnponils"] > slf.nuls["plsiiyhshol"] ).syp(flo) # s f spiin slf.nuls["bnponils"] *= 1 - spis # nhn sinl bs on spi pns nhn = spl + spis * 0.1 un nhn f pivnolizion(slf, spl: np.ny) -> np.ny: """piv nolizion fo onsisn sinl lvls""" # unnin v nolizion fo h in n(ln(spl)): if ln(slf.sinlbuffs[h]) > 50: nn = np.n(lis(slf.sinlbuffs[h])[-50:]) ns = np.s(lis(slf.sinlbuffs[h])[-50:]) if ns > 0: spl[h] = (spl[h] - nn) / ns un spl f upis(slf, possinis: flo): """Up l-i pfon is""" slf.is.lnys = possinis slf.is.houhpusplsps = ( 1000 / possinis if possinis > 0 ls 0 ) slf.is.possinisp = i.i() # si PU n oy us (siplifi) slf.is.puuilizion = in( possinis / slf.onfi.lny * 100, 100 ) slf.is.oyusb = ( ln(slf.sinlbuffs) * slf.onfi.buffsiz * 8 / (1024 * 1024) ) # Sinl quliy siion slf.is.sinlquliyso = slf.sisinlquliy() # So is hisoy slf.ishisoy.ppn(slf.is) f sisinlquliy(slf) -> flo: """si sinl quliy bs on possin is""" if ln(slf.ishisoy) < 10: un 0.5 nlnis = [.lnys fo  in lis(slf.ishisoy)[-10:]] vlny = np.n(nlnis) # Quliy so bs on lny (low lny = hih quliy) quliy = x(0, 1 - (vlny / slf.onfi.lny)) un in(quliy, 1.0) syn f possbh( slf, bh: np.ny ) -> upl[np.ny, Lis[Possinis]]: """ Poss  bh of  spls wih opiiz plll possin s: bh:   bh (spls x hnnls) uns: upl of (possbh, islis) """ if no slf.isiniiliz: is unio("Posso no iniiliz") possbh = [] islis = [] # Poss spls wih onoll plllis ss = [] fo spl in bh: s = synio.s(slf.possspl(spl)) ss.ppn(s) # Lii onuny o pvn sou xhusion spho = synio.Spho(10) syn f posswihlii(spl): syn wih spho: un wi slf.possspl(spl) # xu wih onuny onol suls = wi synio.h( *[posswihlii(spl) fo spl in bh] ) fo poss, is in suls: possbh.ppn(poss) islis.ppn(is) un np.y(possbh), islis f pfonpo(slf) -> i[s, ny]: """n ophnsiv pfon po""" if ln(slf.ishisoy) == 0: un {"o": "No is vilbl"} lnis = [.lnys fo  in slf.ishisoy] quliis = [.sinlquliyso fo  in slf.ishisoy] un { "vlnys": np.n(lnis), "inlnys": np.in(lnis), "xlnys": np.x(lnis), "lnyss": np.s(lnis), "vsinlquliy": np.n(quliis), "houhpusplsps": np.n( [.houhpusplsps fo  in slf.ishisoy] ), "possinffiiny": slf.lulffiinyso(), "lnyhivn": np.n(lnis) <= slf.onfi.lny, "olsplsposs": ln(slf.ishisoy), } f lulffiinyso(slf) -> flo: """lul ovll possin ffiiny so""" if ln(slf.ishisoy) == 0: un 0.0 # ffiiny bs on lny vs  n sinl quliy vlny = np.n([.lnys fo  in slf.ishisoy]) vquliy = np.n([.sinlquliyso fo  in slf.ishisoy]) lnyso = x(0, 1 - (vlny / slf.onfi.lny)) ffiiny = (lnyso + vquliy) / 2 un in(ffiiny, 1.0) syn f shuown(slf): """fully shuown h posso""" slf.possiniv = Fls lo.info("UlLowLnyPosso shuown opl") # Foy funion fo sy insniion f ullowlnyposso( hnnls: in = 22, splin: in = 1000, lnys: flo = 0.5 ) -> UlLowLnyPosso: """ Foy funion o  n opiiz  posso s: hnnls: Nub of  hnnls splin: Splin  in Hz lnys:  lny in illisons uns: onfiu UlLowLnyPosso insn """ onfi = onfi( hnnls=hnnls, splin=splin, lny=lnys / 1000, # onv o sons ) posso = UlLowLnyPosso(onfi) un posso # xpl us n bnhin syn f bnhposso(): """Bnh h ul-low lny posso""" pin(" Sin Ul Low Lny  Posso Bnh") pin("=" * 60) #  posso posso = ullowlnyposso() # Iniiliz pin(" Iniilizin posso...") suss = wi posso.iniilizposso() if no suss: pin(" Iniilizion fil") un pin(" Posso iniiliz sussfully") # n s  (siul l ) pin(" nin s  ...") nspls = 1000 s = ( np.no.nn(nspls, posso.onfi.hnnls) * 50-6 ) # 50 ÂµV nois #  so siul bin sinls fo i in n(nspls): # lph wvs (10 Hz) s[i] += 20-6 * np.sin( 2 * np.pi * 10 * i / posso.onfi.splin ) # B wvs (20 Hz) s[i] += 10-6 * np.sin( 2 * np.pi * 20 * i / posso.onfi.splin ) # Bnh possin pin(f" Possin {nspls} spls...") si = i.pfoun() possbh, islis = wi posso.possbh(s) oli = i.pfoun() - si vlny = np.n([.lnys fo  in islis]) pin("\n BNH SULS") pin(f"ol possin i: {oli:.4f} sons") pin(f"v lny p spl: {vlny:.4f} s") pin(f" lny: {posso.onfi.lny * 1000:.1f} s") pin( f"Lny hivn: {' ' if vlny <= posso.onfi.lny * 1000 ls ' '}" ) pin(f"houhpu: {nspls / oli:.0f} spls/son") pin( f"v sinl quliy: {np.n([.sinlquliyso fo  in islis]):.3f}" ) # n pfon po po = posso.pfonpo() pin("\n PFON PO") fo y, vlu in po.is(): pin(f"{y}: {vlu}") pin("\n Bnh opl sussfully!") wi posso.shuown() if n == "in": # un bnh synio.un(bnhposso())