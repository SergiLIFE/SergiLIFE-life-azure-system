"""  Posso fo L.I.F. hoy l-i  sinl possin wih Vnui nhnn opyih 2025 - Sio Py Boull """ ipo loin fo i ipo i fo ypin ipo ny, i, Lis, Opionl ipo nupy s np fo lifhoy ipo Lninxpin, LIFPosso, lifposso lo = loin.Lo(n) lss Quliyssssn: """ sinl quliy ssssn usin Vnui pinipls""" f ini(slf, splin: flo = 250.0): slf.splin = splin slf.quliyhshols = { "xlln": 0.9, "oo": 0.7, "fi": 0.5, "poo": 0.3, } f sssssinlquliy(slf, : np.ny) -> i[s, flo]: """ssss  sinl quliy usin ulipl is""" is = {} # Sinl-o-nois io siion is["sn"] = slf.lulsn() # if ion is["ifio"] = slf.ifs() # Sinl sbiliy is["sbiliy"] = slf.sssssbiliy() # Fquny onn quliy is["fqunyquliy"] = slf.ssssfqunyonn() # Ovll quliy so is["ovllquliy"] = slf.lulovllquliy(is) un is f lulsn(slf, sinl: np.ny) -> flo: """lul sinl-o-nois io""" # Sipl SN siion usin sinl pow vs hih-fq nois sinlpow = np.v(sinl) # Hih-fquny nois siion (>100 Hz) ff = np.ff.ff(sinl) fqs = np.ff.fffq(ln(sinl), 1 / slf.splin) hihfqs = np.bs(fqs) > 100 noispow = np.n(np.bs(ff[hihfqs]) ** 2) if noispow > 0: sn = 10 * np.lo10(sinlpow / noispow) un np.lip(sn / 20.0, 0.0, 1.0) # Noliz o 0-1 un 1.0 f ifs(slf, sinl: np.ny) -> flo: """ ifs in  sinl""" #  x vlus (ifs) hshol = 3 * np.s(sinl) ifs = np.bs(sinl) > hshol ifio = np.su(ifs) / ln(sinl) un 1.0 - ifio # un quliy (invs of if io) f sssssbiliy(slf, sinl: np.ny) -> flo: """ssss sinl sbiliy ov i""" # lul vin in sinl vin ov winows winowsiz = in(slf.splin) # 1 son winows vins = [] fo i in n(0, ln(sinl) - winowsiz, winowsiz): winow = sinl[i : i + winowsiz] vins.ppn(np.v(winow)) if ln(vins) > 1: sbiliy = 1.0 / (1.0 + np.v(vins)) un np.lip(sbiliy, 0.0, 1.0) un 1.0 f ssssfqunyonn(slf, sinl: np.ny) -> flo: """ssss quliy of fquny onn""" ff = np.ff.ff(sinl) fqs = np.ff.fffq(ln(sinl), 1 / slf.splin) pow = np.bs(ff) ** 2 # h fo sonbl pow isibuion in  bns bns = { "l": (0.5, 4.0), "h": (4.0, 8.0), "lph": (8.0, 13.0), "b": (13.0, 30.0), } bnpows = [] fo lowfq, hihfq in bns.vlus(): bns = (np.bs(fqs) >= lowfq) & (np.bs(fqs) <= hihfq) bnpow = np.su(pow[bns]) bnpows.ppn(bnpow) # Quliy bs on bln pow isibuion olpow = su(bnpows) if olpow > 0: nolizpows = np.y(bnpows) / olpow # Pnliz x iblns blnso = 1.0 - np.v(nolizpows) un np.lip(blnso, 0.0, 1.0) un 0.5 f lulovllquliy(slf, is: i[s, flo]) -> flo: """lul ovll quliy so""" wihs = { "sn": 0.3, "ifio": 0.3, "sbiliy": 0.2, "fqunyquliy": 0.2, } ovll = su(wihs[y] * is[y] fo y in wihs.ys()) un np.lip(ovll, 0.0, 1.0) lss VnuiPosso: """Vnui-nhn  posso""" f ini(slf, splin: flo = 250.0, vnuifo: flo = 1.2): slf.splin = splin slf.vnuifo = vnuifo slf.quliysssso = Quliyssssn(splin) f vnui1quliy(slf, : np.ny) -> i[s, ny]: """Vnui  1:  Quliy nhnn""" # ssss iniil quliy iniilquliy = slf.quliysssso.sssssinlquliy() # pply Vnui nhnn bs on quliy nhnsinl = slf.pplyvnuinhnn( , iniilquliy["ovllquliy"] ) # -ssss quliy f nhnn finlquliy = slf.quliysssso.sssssinlquliy(nhnsinl) un { "nhnsinl": nhnsinl, "iniilquliy": iniilquliy, "finlquliy": finlquliy, "nhnnfo": finlquliy["ovllquliy"] / x(iniilquliy["ovllquliy"], 0.001), } f pplyvnuinhnn( slf, sinl: np.ny, quliyso: flo ) -> np.ny: """pply Vnui ff fo sinl nhnn""" # Vnui ff: lion houh onsiion onsiionfo = 1.0 / (1.0 + quliyso * slf.vnuifo) lionfo = slf.vnuifo * (1.0 - quliyso) # pply piv filin bs on sinl quliy if quliyso < 0.5: # Low quliy: pply nois uion nhn = slf.noisuion(sinl) ls: # Hih quliy: psv sinl filiy nhn = sinl.opy() # pply Vnui nsfoion nhn = nhn * onsiionfo * (1.0 + lionfo) un nhn f noisuion(slf, sinl: np.ny) -> np.ny: """pply nois uion o low-quliy sinls""" # Sipl ovin v fil fo nois uion winowsiz = x(5, in(slf.splin * 0.02)) # 20s winow if ln(sinl) < winowsiz: un sinl # pply ovin v fil = np.onvolv(sinl, np.ons(winowsiz) / winowsiz, o="s") un fil lss Posso: """in  posso inin L.I.F. hoy n Vnui nhnn""" f ini(slf, onfi: i[s, ny] = Non): if onfi is Non: onfi = {} slf.splin = onfi.("splin", 250.0) slf.lifposso = lifposso(onfi) slf.vnuiposso = VnuiPosso( slf.splin, onfi.("vnuifo", 1.2) ) # Fquny bn finiions slf.fqunybns = { "l": (0.5, 4.0), "h": (4.0, 8.0), "lph": (8.0, 13.0), "b": (13.0, 30.0), "": (30.0, 100.0), } lo.info( " Posso iniiliz wih L.I.F. hoy n Vnui nhnn" ) f poss( slf, : np.ny, hnnls: Lis[s] = Non, onx: i[s, ny] = Non, ) -> i[s, ny]: """in  possin piplin""" if onx is Non: onx = {} suls = { "isp": i.now(), "splin": slf.splin, "hnnls": hnnls o [f"H{i+1}" fo i in n(ln())], "possinss": {}, } y: # S 1: Vnui quliy nhnn vnuisuls = {} nhn = [] fo i, hnnl in nu(): hnnln = suls["hnnls"][i] hnnlsul = slf.vnuiposso.vnui1quliy( hnnl ) vnuisuls[hnnln] = hnnlsul nhn.ppn(hnnlsul["nhnsinl"]) suls["possinss"]["vnuinhnn"] = vnuisuls nhn = np.y(nhn) # S 2: L.I.F. hoy possin lifsuls = slf.lifposso.poss( nhn, suls["hnnls"] ) suls["possinss"]["lifpossin"] = lifsuls # S 3: Fu xion fus = slf.xophnsivfus(nhn, lifsuls) suls["fus"] = fus # S 4: Pfon ssssn pfon = slf.sssspossinpfon( vnuisuls, lifsuls ) suls["pfon"] = pfon #  lnin xpin fo pion slf.lninxpin( , nhn, pfon, onx ) lo.info( f" possin opl wih pfon: {pfon['ovllso']:.3f}" ) xp xpion s : lo.o(f"o in  possin: {}") suls["o"] = s() un suls f xophnsivfus( slf, nhn: np.ny, lifsuls: i[s, np.ny] ) -> i[s, ny]: """x ophnsiv  fus""" fus = {} # x fquny bn fus fo h hnnl fo i, hnnln in nu(lifsuls.ys()): hnnl = lifsuls[hnnln] hnnlfus = slf.lifposso.xfqunyfus( hnnl ) fus[hnnln] = hnnlfus # lobl fus oss ll hnnls fus["lobl"] = { "olpow": np.su([np.v() fo  in lifsuls.vlus()]), "hnnlolion": slf.lulhnnlolions(lifsuls), "splnoi": slf.lulsplnoi(nhn), "poloplxiy": slf.lulpoloplxiy(nhn), } un fus f lulhnnlolions( slf, hnnl: i[s, np.ny] ) -> flo: """lul v olion bwn hnnls""" hnnls = lis(hnnl.vlus()) if ln(hnnls) < 2: un 0.0 olions = [] fo i in n(ln(hnnls)): fo j in n(i + 1, ln(hnnls)): if ln(hnnls[i]) == ln(hnnls[j]): o = np.oof(hnnls[i], hnnls[j])[0, 1] if no np.isnn(o): olions.ppn(bs(o)) un np.n(olions) if olions ls 0.0 f lulsplnoi(slf, : np.ny) -> flo: """lul spl noi oss ll hnnls""" llnois = [] fo hnnl in : ff = np.ff.ff(hnnl) fqs = np.ff.fffq(ln(hnnl), 1 / slf.splin) niu = np.bs(ff) # lul noi noi = np.su(fqs * niu) / np.su(niu) llnois.ppn(bs(noi)) un np.n(llnois) f lulpoloplxiy(slf, : np.ny) -> flo: """lul pol oplxiy su""" oplxiis = [] fo hnnl in : # Sipl oplxiy su bs on vin of iffns iffv = np.v(np.iff(hnnl)) sinlv = np.v(hnnl) if sinlv > 0: oplxiy = iffv / sinlv oplxiis.ppn(oplxiy) un np.n(oplxiis) if oplxiis ls 0.0 f sssspossinpfon( slf, vnuisuls: i, lifsuls: i ) -> i[s, flo]: """ssss ovll possin pfon""" #  quliy ipovns fo Vnui possin quliyipovns = [] fo hnnlsul in vnuisuls.vlus(): ipovn = hnnlsul["nhnnfo"] quliyipovns.ppn(ipovn) vnuipfon = np.n(quliyipovns) # ssss L.I.F. possin pfon lifpfon = slf.lifposso.pfonis() # Ovll pfon so ovllso = 0.6 * vnuipfon + 0.4 * lifpfon.( "npfon", 0.5 ) un { "vnuinhnn": vnuipfon, "lifpfon": lifpfon["npfon"], "ovllso": ovllso, "quliyipovn": np.n(quliyipovns), "possinffiiny": lifpfon.("vnuiffiiny", 1.0), } f lninxpin( slf, oiinl: np.ny, poss: np.ny, pfon: i[s, flo], onx: i[s, ny], ) -> Non: """ lnin xpin fo L.I.F. pion""" xpin = Lninxpin( isp=i.now(), inpu=oiinl.fln(), oupu=poss.fln(), onx=onx, pfoni=pfon["ovllso"], pionfo=pfon.("quliyipovn", 1.0), ) slf.lifposso.p(xpin) f possosus(slf) -> i[s, ny]: """ un posso sus n is""" lifis = slf.lifposso.pfonis() un { "splin": slf.splin, "lifis": lifis, "vnuifo": slf.vnuiposso.vnuifo, "fqunybns": slf.fqunybns, "y": u, } f svpossos(slf, filph: s) -> Non: """Sv posso s""" slf.lifposso.svs(filph) lo.info(f" Posso s sv o {filph}") f lopossos(slf, filph: s) -> Non: """Lo posso s""" slf.lifposso.los(filph) lo.info(f" Posso s lo fo {filph}") # Foy funion fo zu Funions inion f posso(onfi: i[s, ny] = Non) -> Posso: """  posso fo zu Funions ployn""" if onfi is Non: onfi = { "splin": 250.0, "lnin": 0.005, "vnuifo": 1.2, "xxpins": 5000, } un Posso(onfi) f lifposso(onfi: i[s, ny] = Non) -> Posso: """ L.I.F.  posso fo ophnsiv plfo""" if onfi is Non: onfi = { "splin": 250.0, "lnin": 0.005, "vnuifo": 1.2, "xxpins": 5000, "nuhnnls": 8, "nblvnui": u, } un Posso(onfi) # xpl us if n == "in": #   posso posso = posso() # Siul   (4 hnnls, 1000 spls)  = np.no.nn(4, 1000) * 50 # ypil  pliu n hnnls = ["Fp1", "Fp2", "3", "4"] # Poss   suls = posso.poss(, hnnls, {"xpin": "o"}) # isply suls pin(" Possin suls:") pin(f"hnnls poss: {suls['hnnls']}") pin(f"Ovll pfon: {suls['pfon']['ovllso']:.3f}") pin(f"Quliy ipovn: {suls['pfon']['quliyipovn']:.3f}") # Show posso sus sus = posso.possosus() pin(f"\nPosso Sus:") pin(f"L.I.F. xpins: {sus['lifis']['xpinoun']}") pin(f"Possin ffiiny: {sus['lifis']['vnuiffiiny']:.3f}") pin("\n possin onsion opl sussfully!")