# us/bin/nv pyhon3 """ OUL 7: piv Filin oul (F) ln Filin fo  Nois uion n Sinl nhnn SNLON ONSION - NO Y IN : Oob 6, 2025 opyih 2025 - Sio Py Boull his oul iplns piv ln filin o ipov  sinl quliy by uin nois n ifs whil psvin nul sinl infoion. """ ipo loin fo lsss ipo lss fo i ipo i fo ypin ipo Lis, Opionl, upl ipo nupy s np loin.bsionfi(lvl=loin.INFO) lo = loin.Lo(n) @lss lss Filis: """is fo fil pfon vluion""" sinlonoisio: flo noisuionb: flo sinlpsvion: flo # How uh oiinl sinl in ifjion: flo possinis: flo isp: s lss pivlnFil: """ piv ln Fil fo l-i  sinl possin hnil Bnfis: - us lil nois (50/60 Hz pow lin) - ovs oion ifs - Psvs nul sinl iniy - piv o hnin sinl oniions - l-i possin pbiliy """ f ini( slf, possnois: flo = 1.0, sunnois: flo = 1.0, pion: flo = 0.01, ): """ Iniiliz ln fil wih nois ps s: possnois (Q): Sys ynis uniny sunnois (): Snso sun uniny pion: How quily fil ps o sinl hns """ slf.Q = possnois # Poss nois ovin slf. = sunnois # sun nois ovin slf.pion = pion # Fil s vibls slf.si = 0.0 # un s si slf.oovin = 1.0 # siion o ovin (P) # piv ps slf.pivQ = possnois slf.piv = sunnois # Pfon in slf.innovionhisoy: Lis[flo] = [] slf.inhisoy: Lis[flo] = [] f filsinl(slf, sinl: np.ny) -> upl[np.ny, Filis]: """ pply ln fil o ni sinl s: sinl: w  sinl (1 y) uns: upl of (filsinl, pfonis) """ si = i.now() fil = np.zosli(sinl) slf.ss() fo i, sun in nu(sinl): fil[i] = slf.filsp(sun) # p nois ps vy 100 spls if i > 0 n i % 100 == 0: slf.pps() # lul pfon is is = slf.lulis(sinl, fil, si) un fil, is f filulihnnl( slf, : np.ny ) -> upl[np.ny, Lis[Filis]]: """ pply fil o uli-hnnl   s: : w  y (hnnls × ipoins) uns: upl of (fil, lisofisphnnl) """ hnnls, ipoins = .shp fil = np.zosli() llis = [] lo.info(f"Filin {hnnls}  hnnls wih {ipoins} i poins") fo h in n(hnnls): filhnnl, is = slf.filsinl([h, :]) fil[h, :] = filhnnl llis.ppn(is) if (h + 1) % 10 == 0: lo.bu(f"Poss {h + 1}/{hnnls} hnnls") lo.info( f"Filin opl. v SN ipovn: {np.n([.noisuionb fo  in llis]):.2f} B" ) un fil, llis f filsp(slf, sun: flo) -> flo: """ Sinl ln fil iion his is h o loih: 1. Pi: Poj s fow 2. Up: Inopo sun """ # PIION SP # Pi s si (no hn in sipl ol) pisi = slf.si # Pi o ovin piovin = slf.oovin + slf.pivQ # UP SP # Innovion (sun siul) innovion = sun - pisi slf.innovionhisoy.ppn(innovion) # Innovion ovin innovionovin = piovin + slf.piv # ln in (opil blnin fo) lnin = piovin / innovionovin slf.inhisoy.ppn(lnin) # Up s si slf.si = pisi + lnin * innovion # Up o ovin slf.oovin = (1 - lnin) * piovin un slf.si f pps(slf): """ p Q n  bs on innovion squn his s h fil "s" - i lns opil nois ps fo h sinl islf h hn usin fix vlus. """ if ln(slf.innovionhisoy) < 50: un # si sun nois fo n innovions ninnovions = slf.innovionhisoy[-50:] innovionvin = np.v(ninnovions) # p  (sun nois) bs on innovion vin slf.piv = ( 1 - slf.pion ) * slf.piv + slf.pion * innovionvin # p Q (poss nois) o inin sbiliy nins = slf.inhisoy[-50:] vin = np.n(nins) # If in is oo hih, ins Q (o us in suns) # If in is oo low, s Q (o us in ol) if vin > 0.7: slf.pivQ *= 1.1 lif vin < 0.3: slf.pivQ *= 0.9 # Pvn ps fo oin o xs slf.pivQ = np.lip(slf.pivQ, 0.01, 10.0) slf.piv = np.lip(slf.piv, 0.01, 10.0) f ss(slf): """s fil s fo nw sinl""" slf.si = 0.0 slf.oovin = 1.0 slf.innovionhisoy = [] slf.inhisoy = [] slf.pivQ = slf.Q slf.piv = slf. f lulis( slf, oiinl: np.ny, fil: np.ny, si: i ) -> Filis: """lul fil pfon is""" # si nois s iffn bwn oiinl n fil nois = oiinl - fil # Sinl-o-Nois io (SN) sinlpow = np.v(fil) noispow = np.v(nois) if noispow > 0: sn = 10 * np.lo10(sinlpow / noispow) noisuion = 10 * np.lo10(np.v(oiinl) / noispow) ls: sn = flo("inf") noisuion = flo("inf") # Sinl psvion (olion bwn oiinl n fil) if np.s(oiinl) > 0 n np.s(fil) > 0: sinlpsvion = np.oof(oiinl, fil)[0, 1] ls: sinlpsvion = 0.0 # if jion  (spls wih l innovions) if ln(slf.innovionhisoy) > 0: innovionhshol = 3 * np.s(slf.innovionhisoy) ifs = su( 1 fo inn in slf.innovionhisoy if bs(inn) > innovionhshol ) if = ifs / ln(slf.innovionhisoy) ls: if = 0.0 # Possin i possini = (i.now() - si).olsons() * 1000 un Filis( sinlonoisio=sn, noisuionb=noisuion, sinlpsvion=sinlpsvion, ifjion=if, possinis=possini, isp=i.now().isofo(), ) lss Sinlno: """n synhi  sinls fo sin""" @siho f nln( uions: flo = 4.0, splin: in = 256, fqunybns: Opionl[i] = Non, ) -> np.ny: """n ln synhi  wih nown fquny oponns""" if fqunybns is Non: fqunybns = { "l": (2, 0.8), # (fqunyhz, pliu) "h": (6, 0.6), "lph": (10, 1.0), "b": (20, 0.4), "": (40, 0.2), } ipoins = in(uions * splin)  = np.linsp(0, uions, ipoins) sinl = np.zos(ipoins) fo bn, (fq, p) in fqunybns.is(): #  phs nonss fo lis phs = np.no.no() * 2 * np.pi sinl += p * np.sin(2 * np.pi * fq *  + phs) un sinl @siho f nois( sinl: np.ny, noislvl: flo = 0.3, noisyps: Opionl[Lis[s]] = Non, ) -> np.ny: """ lisi nois o ln  sinl""" if noisyps is Non: noisyps = ["whi", "powlin", "oion"] noisysinl = sinl.opy() if "whi" in noisyps: # Whi ussin nois whinois = np.no.nn(ln(sinl)) * noislvl noisysinl += whinois if "powlin" in noisyps: # 50/60 Hz powlin infn  = np.linsp(0, ln(sinl) / 256, ln(sinl)) powlin = 0.2 * np.sin(2 * np.pi * 50 * ) # 50 Hz (uop) powlin += 0.15 * np.sin(2 * np.pi * 60 * ) # 60 Hz (US) noisysinl += powlin if "oion" in noisyps: # Low-fquny oion ifs oionif = np.zos(ln(sinl)) nifs = np.no.nin(2, 5) fo  in n(nifs): ifs = np.no.nin(0, ln(sinl) - 100) ifuion = np.no.nin(50, 150) ifn = in(ifs + ifuion, ln(sinl)) # ussin-shp if x = np.linsp(-3, 3, ifn - ifs) if = 2.0 * np.xp(-(x**2) / 2) oionif[ifs:ifn] += if noisysinl += oionif un noisysinl # ============================================================================ # ONSION & SIN # ============================================================================ f onspivlnfil(): """ons piv ln Fil wih synhi  """ pin("=" * 80) pin("OUL 7: piv ln Fil - ONSION") pin("=" * 80) pin() # Iniiliz fil lnfil = pivlnFil( possnois=1.0, sunnois=1.0, pion=0.01 ) # n s sinls no = Sinlno() # s 1: Sinl hnnl filin pin("s 1: Sinl hnnl  Filin") pin("-" * 80) lnsinl = no.nln(uions=4.0) noisysinl = no.nois( lnsinl, noislvl=0.5, noisyps=["whi", "powlin", "oion"] ) pin(f"Sinl lnh: {ln(noisysinl)} spls (4 sons  256 Hz)") pin( f"Oiinl SN: {10 * np.lo10(np.v(lnsinl) / np.v(noisysinl - lnsinl)):.2f} B" ) pin() filsinl, is = lnfil.filsinl(noisysinl) pin("Fil Pfon is:") pin(f" SN: {is.sinlonoisio:.2f} B") pin(f" Nois uion: {is.noisuionb:.2f} B") pin(f" Sinl Psvion: {is.sinlpsvion:.3f}") pin(f" if jion : {is.ifjion:.3f}") pin(f" Possin i: {is.possinis:.2f} s") pin() # lul ipovn oiinlo = np.n((noisysinl - lnsinl) ** 2) filo = np.n((filsinl - lnsinl) ** 2) ipovn = (1 - filo / oiinlo) * 100 pin(f"n Squ o uion: {ipovn:.1f}%") pin() pin() # s 2: uli-hnnl  filin pin("s 2: uli-hnnl  Filin (64 hnnls)") pin("-" * 80) nhnnls = 64 uion = 4.0 splin = 256 ipoins = in(uion * splin) # n uli-hnnl  ln = np.zos((nhnnls, ipoins)) noisy = np.zos((nhnnls, ipoins)) pin("nin synhi 64-hnnl  ...") fo h in n(nhnnls): ln[h, :] = no.nln(uion) noisy[h, :] = no.nois( ln[h, :], noislvl=0.3 + np.no.no() * 0.3, # Vibl nois p hnnl ) pin(f" shp: {noisy.shp} (hnnls × ipoins)") pin() # Fil ll hnnls lnfiluli = pivlnFil( possnois=1.0, sunnois=1.0, pion=0.01 ) fil, llis = lnfiluli.filulihnnl(noisy) #  sisis vsn = np.n([.sinlonoisio fo  in llis]) vnoisuion = np.n([.noisuionb fo  in llis]) vpsvion = np.n([.sinlpsvion fo  in llis]) olpossini = su([.possinis fo  in llis]) pin("\n Pfon is:") pin(f" v SN: {vsn:.2f} B") pin(f" v Nois uion: {vnoisuion:.2f} B") pin(f" v Sinl Psvion: {vpsvion:.3f}") pin(f" ol Possin i: {olpossini:.2f} s") pin(f" i p hnnl: {olpossini / nhnnls:.2f} s") pin() # P-hnnl nlysis bshnnl = np.x([.noisuionb fo  in llis]) woshnnl = np.in([.noisuionb fo  in llis]) pin( f"Bs hnnl: {bshnnl} (Nois uion: {llis[bshnnl].noisuionb:.2f} B)" ) pin( f"Wos hnnl: {woshnnl} (Nois uion: {llis[woshnnl].noisuionb:.2f} B)" ) pin() # Ovll ipovn oiinlolo = np.su((noisy - ln) ** 2) filolo = np.su((fil - ln) ** 2) olipovn = (1 - filolo / oiinlolo) * 100 pin(f"Ovll S uion: {olipovn:.1f}%") pin() pin() # s 3: l-i possin pbiliy pin("s 3: l-i Possin pbiliy") pin("-" * 80) # Siul l-i sin hunsiz = 256 # 1 son of  nhuns = 10 pin(f"Siulin l-i possin: {nhuns} huns of {hunsiz} spls") pin() lnli = pivlnFil() hunis = [] fo hunix in n(nhuns): # n hun hunsinl = no.nln(uions=1.0) hunnoisy = no.nois(hunsinl, noislvl=0.4) # Poss hun s = i.now() filhun, hunis = lnli.filsinl(hunnoisy) huni = (i.now() - s).olsons() * 1000 hunis.ppn(huni) if hunix == 0 o hunix == nhuns - 1: pin( f"hun {hunix + 1}: {huni:.2f} s, SN: {hunis.sinlonoisio:.2f} B" ) pin() pin(f"v hun Possin i: {np.n(hunis):.2f} s") pin(f"x hun Possin i: {np.x(hunis):.2f} s") pin( f"l-i pbl: {'YS' if np.x(hunis) < 1000 ls 'NO'} (< 1 son p son of )" ) pin() pin("=" * 80) pin("ONSION OPL") pin("=" * 80) pin() pin("INION NOS:") pin("-  pivlnFil o  possin piplin") pin("- ll filulihnnl() bfo lulbnpow()") pin("- So Filis fo quliy onioin") pin("- Us fil  fo ll owns nul nlysis") pin("- xp uy ipovn: 5-15% in noisy nvionns") pin() pin("PFON IP:") pin(f"- Possin ovh: ~{np.n(hunis):.1f} s p son of ") pin("- oy ovh: inil (sful fil)") pin("- Suibl fo l-i sin  256 Hz") if n == "in": onspivlnfil() onspivlnfil()