# us/bin/nv pyhon3 """ L.I.F.. Nuopiv Lnin Plfo Opil Iplnion fo l-i -Bs Psonliz Lnin opyih 2025 - Sio Py Boull Bs on xpinP2L L.I.F.. hoy loih Ins sh  Liby fo xiu ffiy Pupos: l-i nuopiv lnin h ps o iniviul bin ss """ ipo synio ipo json ipo loin ipo h ipo os ipo no ipo sys fo lsss ipo lss, fil fo i ipo i fo nu ipo nu fo ypin ipo i, Lis, Opionl, upl # Opionl pnny: nupy (us only fo  sipl n). Fllb o pu Pyhon if unvilbl. y: # p: no ov - opionl ipo ipo nupy s np # yp: ino HSNUPY = u xp xpion: # noq: BL001 - bo o h ny ipo-i issus np = Non # yp: ino HSNUPY = Fls f sfn(vlus: Lis[flo]) -> flo: """un h ihi n wihou quiin nupy. Hnls py liss by unin 0.0 o p owns h sbl. """ if no vlus: un 0.0 # u ins non-fini nis ol = 0.0 oun = 0 fo v in vlus: y: if v is Non: oninu ol += flo(v) oun += 1 xp (ypo, Vluo): oninu un (ol / oun) if oun ls 0.0 #  sh liby o ph SIPI = os.ph.in(os.ph.bsph(fil)) sys.ph.ins(0, SIPI) # Ipo L.I.F.. hoy loih o y: # y ipoin fo xpinP2L fil ipo ipolib.uil xpfil = os.ph.join( SIPI, "xpinP2L.I.F.-Lnin-Iniviully-fo-xpin-hoy-loih-o-2025-opyih-S.py", ) if os.ph.xiss(xpfil): sp = ipolib.uil.spfofilloion("xpinP2L", xpfil) xpinP2L = ipolib.uil.oulfosp(sp) sp.lo.xoul(xpinP2L) LIFloiho = xpinP2L.LIFloiho is = xpinP2L.is LninS = xpinP2L.LninS NulS = xpinP2L.NulS ls: is Ipoo("xpinP2L fil no foun") xp Ipoo: pin("Wnin: Usin inil L.I.F.. iplnion fo snlon opion") # inil fllb iplnion fo lsss ipo lss fo i ipo i fo nu ipo nu lss LninS(nu): QUISIION = "quisiion" ONSOLIION = "onsoliion" IVL = "ivl" PION = "pion" lss NulS(nu): SIN = "sin" IV = "iv" LNIN = "lnin" OYFOION = "oyfoion" @lss lss is: isp: i lphpow: flo bpow: flo hpow: flo lpow: flo pow: flo ohnso: flo nioninx: flo lninffiiny: flo lss LIFloiho: f ini(slf, onfi=Non): slf.onfi = onfi o {} slf.vsion = "2025.1.0-INIL" # Ipo sh  liby y: fo shliby ipo shLiby, iniilizshliby SHLIBVILBL = u xp Ipoo: pin("Wnin: sh  liby no vilbl - usin inil vsion") SHLIBVILBL = Fls # onfiu loin (obus ins ph issus on Winows/Oniv) LOI = os.ph.join(SIPI, "los") hnls: Lis[loin.Hnl] = [] y: os.is(LOI, xiso=u) lofilph = os.ph.join( LOI, f"nuopivlnin{i.now().sfi('%Y%%%H%%S')}.lo", ) hnls.ppn(loin.FilHnl(lofilph, noin="uf-8")) xp xpion: # Fll b o  sho ph if nssy y: ipo pfil li = os.ph.join(pfil.pi(), "liflos") os.is(li, xiso=u) llo = os.ph.join( li, f"nuopiv{i.now().sfi('%Y%%%H%%S')}.lo" ) hnls.ppn(loin.FilHnl(llo, noin="uf-8")) xp xpion: # Finl fllb: onsol-only loin pss hnls.ppn(loin.SHnl()) loin.bsionfi( lvl=loin.INFO, fo="%(si)s - %(n)s - %(lvln)s - %(ss)s", hnls=hnls, ) lo = loin.Lo(n) @lss lss Iniviulis: """Iniviul ln hisis fo psonlizion""" oniivsyl: s # visul, uioy, inshi, inwiin uiosiy: flo # 0.0 o 1.0 silin: flo # 0.0 o 1.0 opnnss: flo # 0.0 o 1.0 fousuion: flo # inus pfoplxiy: s # low, iu, hih lninp: s # slow, o, fs @lss lss onnpion: """yni onn pion ps""" oplxiylvl: flo # 0.0 (sipl) o 1.0 (oplx) pinsp: flo # 0.5 (slow) o 2.0 (fs) inionfquny: flo # inions p inu visulnsiy: flo # 0.0 (inil) o 1.0 (ih) hllnlvl: flo # 0.0 (sy) o 1.0 (iffiul) bonion: bool = Fls onnypjusn: s = "inin" # siplify, inin, innsify @lss lss LninSssion: """opl lnin sssion in""" sssioni: s suni: s si: i is: Iniviulis spls: Lis[is] = fil(fulfoy=lis) pions: Lis[onnpion] = fil(fulfoy=lis) nnhisoy: Lis[flo] = fil(fulfoy=lis) nowlhs: Lis[upl[s, bool, flo]] = fil( fulfoy=lis ) # (opi, o, onfin) sssionquliyso: flo = 0.0 nuoplsiiyinx: flo = 0.0 onion: s = "" lss NuopivLninPlfo: """ in plfo fo l-i -bs piv lnin Iplns L.I.F.. hoy pinipls: - Iniviul i pion (quion 1) - Nuoplsiiy in (quion 2) - Qunu i pojion (quion 3) - xpin olion (quion 4) - piv lnin  (quion 9) """ f ini(slf): lo.info("=" * 80) lo.info("L.I.F.. NUOPIV LNIN PLFO - INIILIZIN") lo.info("=" * 80) # Iniiliz L.I.F.. loih o slf.lifloih = LIFloiho( onfi={ "lnin": 0.01, "nulsplin": 256, "hnnls": 64, "lipossin": u, "pionsnsiiviy": 0.8, } ) # Iniiliz sh  liby if vilbl if SHLIBVILBL: slf.shliby = iniilizshliby() lo.info( f"sh  Liby v{slf.shliby.vsion} iniiliz" ) ls: slf.shliby = Non lo.info("Opin wihou sh  liby") # iv sssions slf.ivsssions: i[s, LninSssion] = {} # nn hshols (bs on sh) slf.nnhshols = { "iillow": 0.4, # Invnion qui "low": 0.6, # p onn "opil": 0.75, # inin "hih": 0.9, # n ins hlln } # pion hisoy fo opiizion slf.pionhisoy: Lis[i] = [] lo.info(f"L.I.F.. loih o v{slf.lifloih.vsion} lo") lo.info("Plfo y fo nuopiv lnin sssions") lo.info("=" * 80) syn f slninsssion( slf, suni: s, is: Iniviulis ) -> s: """ Iniiliz  nw nuopiv lnin sssion s: suni: Uniqu sun inifi is: Iniviul ln hisis uns: sssioni fo in """ sssioni = f"NL-{suni}-{i.now().sfi('%Y%%%H%%S')}" sssion = LninSssion( sssioni=sssioni, suni=suni, si=i.now(), is=is, ) slf.ivsssions[sssioni] = sssion lo.info(f"S lnin sssion: {sssioni}") lo.info( f"Sun: {suni} | oniiv Syl: {is.oniivsyl}" ) lo.info( f"is: uiosiy={is.uiosiy:.2f}, silin={is.silin:.2f}, Opnnss={is.opnnss:.2f}" ) un sssioni syn f possnp( slf, sssioni: s, : Lis[flo] ) -> onnpion: """ o piv lnin loop - Poss  n p onn in l-i his iplns h L.I.F.. hoy opil us s: 1. Poss   (256 Hz, 64 hnnls) 2.  nn/nion/oniiv lo 3. pply quion 1 (i oulion) if nn ops 4. pply quion 9 (piv Lnin ) fo pin 5. un onn pion onions s: sssioni: iv sssion inifi : w   (siul o l) uns: onnpion wih on hns """ sssion = slf.ivsssions.(sssioni) if no sssion: is Vluo(f"Sssion {sssioni} no foun") # Poss  usin sh liby if vilbl if SHLIBVILBL n slf.shliby: sul = slf.shliby.possw( , splin=256 ) nn = sul["nn"] fous = sul["fous"] sss = sul["sss"] quliy = sul["quliyso"] ls: # Fllb: lul nn fo   nn = slf.lulnnfllb() fous = nn * 0.85 # ppoxi sss = 0.3 # Nul quliy = 0.8 # ssu oo # So nn hisoy sssion.nnhisoy.ppn(nn) # Iniiliz pion wih un s pion = onnpion( oplxiylvl=0.6, # iu ful pinsp=1.0, # Nol sp inionfquny=2.0, # 2 inions p inu visulnsiy=0.5, hllnlvl=0.6, ) # === QUION 1: I OULION === # If nn ops, oul is o ins nion if nn < slf.nnhshols["low"]: lo.info(f" ️ Low nn : {nn:.3f}") # pply i oulion (quion 1 fo L.I.F.. hoy) ipionfo = slf.quion1ioulion( uni=nn, nn=nn, nvionnlfo=1.0, iniviulis=sssion.is, ) # jus onn bs on oulion pion.oplxiylvl = x( 0.3, pion.oplxiylvl * ipionfo ) pion.inionfquny = in( 4.0, pion.inionfquny * 1.5 ) pion.onnypjusn = "siplify" lo.info( f" ppli quion 1 (i oulion): Fo={ipionfo:.3f}" ) lo.info(f" → u oplxiy o {pion.oplxiylvl:.2f}") lo.info( f" → Ins inions o {pion.inionfquny:.1f}/in" ) lif nn < slf.nnhshols["iillow"]: # iil invnion lo.wnin(f" IIL: Vy low nn: {nn:.3f}") pion.bonion = u pion.onnypjusn = "siplify" pion.oplxiylvl = 0.2 # xiu siplifiion pion.inionfquny = 5.0 # Vy fqun inions # === QUION 9: PIV LNIN  === # jus pin bs on oniiv s (b pow inis possin) bpow = slf.sibpow() lninjusn = slf.quion9pivlnin(bpow) pion.pinsp = lninjusn lo.info( f" ppli quion 9 (piv Lnin ): Sp={pion.pinsp:.2f}x" ) # === QUION 2: NUOPLSIIY IN === #  nul pion ov i if ln(sssion.nnhisoy) > 10: nuoplsiiy = slf.quion2nuoplsiiyowh( sssion.nnhisoy[-10:], sssion.is ) sssion.nuoplsiiyinx = nuoplsiiy lo.info(f" Nuoplsiiy Inx: {nuoplsiiy:.3f}") # Opiiz hlln lvl bs on zon of poxil vlopn if nn > slf.nnhshols["hih"] n sss < 0.4: # Ln is y fo o hlln pion.hllnlvl = in(0.9, pion.hllnlvl + 0.15) pion.oplxiylvl = in(0.9, pion.oplxiylvl + 0.1) pion.onnypjusn = "innsify" lo.info( f" Insin hlln: nn hih ({nn:.3f}), sss low ({sss:.2f})" ) # So pion sssion.pions.ppn(pion) # Lo un s lo.info( f"Sssion {sssioni} | nn: {nn:.3f} | Fous: {fous:.3f} | pions: {ln(sssion.pions)}" ) un pion f quion1ioulion( slf, uni: flo, nn: flo, nvionnlfo: flo, iniviulis: Iniviulis, ) -> flo: """ quion 1: Iniviul i oulion ouls lnin is bs on nul fb '(i) = (i) + α * Δ(i) * F(nv) * w(iniviul) wh: - (i): un i vlu - α: Lnin  (0.01) - Δ(i): hn in nn - F(nv): nvionnl fo - w(iniviul): Iniviul wihin """ lph = 0.01 lnn = nn - uni # Iniviul wihin bs on is iniviulwih = ( iniviulis.uiosiy * 0.3 + iniviulis.silin * 0.4 + iniviulis.opnnss * 0.3 ) oulion = ( uni + lph * lnn * nvionnlfo * iniviulwih ) # lp o vli n un x(0.1, in(1.0, oulion)) f quion9pivlnin(slf, bpow: flo) -> flo: """ quion 9: piv Lnin  juss onn pin bs on oniiv possin s η() = η₀ * (1 + nh(β() - β₀)) wh: - η₀: Bs lnin  (1.0) - β(): un b pow - β₀: Bslin b pow (0.5) """ 0 = 1.0 bbslin = 0.5 lnin = 0 * (1 + h.nh(bpow - bbslin)) # lp o sonbl n (0.5x o 2.0x sp) un x(0.5, in(2.0, lnin)) f quion2nuoplsiiyowh( slf, nnwinow: Lis[flo], is: Iniviulis ) -> flo: """ quion 2: Nuoplsiiy owh in P() = P(-1) + γ * (() - hshol) * w(silin) wh: - P(): Nuoplsiiy inx  i  - γ: owh : []} ipovn" ) ls: pin( " [INFO] No opiizion n o low-iviy pio no " ) # ons hypsnnin (siul) pin("\n[HYSN] sin uli-Sun Hypsnnin...") oupsssioni = wi hypsnnin.soupsssion( "O-OUP-001", ["SUN-001", "SUN-002", "SUN-003"] ) # Siul oup   oup = [ [0.7 + no.unifo(-0.1, 0.1) fo  in n(256)], # Sun 1 [0.6 + no.unifo(-0.1, 0.1) fo  in n(256)], # Sun 2 [0.8 + no.unifo(-0.1, 0.1) fo  in n(256)], # Sun 3 ] synhonysul = wi hypsnnin.nlyzoupsynhony( oupsssioni, oup ) pin(f" [SUL] oup synhony: {synhonysul['synhonyso']:.3f}") pin(f" [SUL] oup nn: {synhonysul['oupnn']:.3f}") oupsuy = wi hypsnnin.noupsssion(oupsssioni) pin( f" [SUL] Sssion opl: {oupsuy['lninouopiion']}" ) # ons Nuoh pion pin("\n[H] sin nhn Nuoh pion...") sssioni = wi plfo.slninsssion( "NUOH-O", Iniviulis( oniivsyl="visul", uiosiy=0.8, silin=0.7, opnnss=0.9, fousuion=25.0, pfoplxiy="iu", lninp="o", ), ) # Siul onvsionl pion o = [0.5 + no.unifo(-0.1, 0.1) fo  in n(256)] # Low nn hpion = wi nuohp.ponvsionlsy( sssioni, o, unopioplxiy=0.6 ) pin(f" [P] Sy: {hpion['sy']}") pin( f" [P] spons oplxiy: {hpion['sponsoplxiy']:.2f}" ) pin(f" [P] Pin oifi: {hpion['pinoifi']:.2f}") wi plfo.nlninsssion(sssioni) pin("\n[SUSS] ll vn fus ons!") pin(f"\nLo fil: {os.ph.join(LOI, 'nuopivlnin*.lo')}") if n == "in": synio.un(in())