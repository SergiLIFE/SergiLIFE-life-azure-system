# us/bin/nv pyhon3 """ nhn Vnui onol Sys - vn Flui ynis Possin l-i piv onol fo h Vnui s wih flui ynis opiizion his oul povis vn onol loihs fo h L.I.F.. Plfo's h Vnui s, iplnin flui ynis pinipls fo ul-low lny  sinl possin. opyih 2025 - Sio Py Boull L.I.F.. Plfo - zu pl Off I: 960096-f1-420b-902-042561b """ ipo synio ipo loin ipo h ipo i fo lsss ipo lss, fil fo nu ipo nu fo ypin ipo ny, i, Lis, Opionl, upl ipo nupy s np # onfiu loin loin.bsionfi(lvl=loin.INFO) lo = loin.Lo(n) lss Vnuiyp(nu): """yps of Vnui s fo iffn possin funions""" SINLNHNN = "sinlnhnn" NOISUION = "noisuion" PNXION = "pnxion" @lss lss Fluiynisonfi: """onfiuion fo flui ynis possin""" onsiionio: flo = 0.8 # Vnui onsiion fo lionfo: flo = 1.2 # Sinl lion ulipli pssuopoffiin: flo = 0.7 # Bnoulli pssu op ubulnhshol: flo = 0.1 # ubuln ion hshol flowsbiliyfo: flo = 0.95 # Flow sbiliy offiin pion: flo = 0.01 # Lnin pion  sonnfquny: flo = 10.0 # Hz, nul sonn fquny @lss lss VnuiS: """l-i s of  Vnui """ pssu: flo = 1.0 vloiy: flo = 1.0 flow: flo = 1.0 ubulnlvl: flo = 0.0 ffiiny: flo = 1.0 pionlvl: flo = 0.0 sonnphs: flo = 0.0 lsup: flo = fil(fulfoy=i.i) @lss lss Vnuionfi: """onfiuion fo iniviul Vnui """ i: s yp: Vnuiyp fluionfi: Fluiynisonfi = fil(fulfoy=Fluiynisonfi) xpssu: flo = 2.0 inpssu: flo = 0.1 xvloiy: flo = 5.0 pionnbl: bool = u lss nhnVnui: """ nhn Vnui  wih vn flui ynis onol Iplns Bnoulli's pinipl n flui ynis fo sinl possin: - Pssu op s vloiy ins (sinl nhnn) - ubuln onol fo nois uion - Flow sonn fo pn xion """ f ini(slf, onfi: Vnuionfi): slf.onfi = onfi slf.s = VnuiS() slf.hisoy = [] slf.fluiynis = slf.iniilizfluiynis() slf.pivonoll = pivonoll(onfi.fluionfi) lo.info( f"nhn Vnui  '{onfi.i}' iniiliz: {onfi.yp.vlu}" ) f iniilizfluiynis(slf) -> i[s, ny]: """Iniiliz flui ynis ps""" un { "onsiion": 1.0 * slf.onfi.fluionfi.onsiionio, "ups": 1.0, "pssuoffiin": slf.onfi.fluionfi.pssuopoffiin, "vloiyoffiin": 1.0 / h.sq(slf.onfi.fluionfi.onsiionio), "ynolsnub": 1000.0, # Lin flow "visosiy": 0.001, # Flui visosiy "nsiy": 1000.0, # Flui nsiy } syn f posssinl( slf, inpusinl: np.ny, onx: Opionl[i[s, ny]] = Non ) -> np.ny: """ Poss sinl houh Vnui  usin flui ynis pinipls s: inpusinl: Inpu sinl y onx: Possin onx (opionl) uns: Poss sinl y """ si = i.pfoun() # pply flui ynis nsfoion poss = wi slf.pplyfluiynis(inpusinl, onx) # Up  s slf.ups(poss, i.pfoun() - si) # piv lnin if slf.onfi.pionnbl: wi slf.pivonoll.p(slf.s, poss) un poss syn f pplyfluiynis( slf, sinl: np.ny, onx: Opionl[i[s, ny]] = Non ) -> np.ny: """pply flui ynis nsfoion bs on  yp""" if slf.onfi.yp == Vnuiyp.SINLNHNN: un wi slf.nhnsinl(sinl, onx) lif slf.onfi.yp == Vnuiyp.NOISUION: un wi slf.unois(sinl, onx) lif slf.onfi.yp == Vnuiyp.PNXION: un wi slf.xpns(sinl, onx) ls: un sinl syn f nhnsinl( slf, sinl: np.ny, onx: Opionl[i[s, ny]] = Non ) -> np.ny: """Sinl nhnn usin Vnui pssu-vloiy onvsion""" # Bnoulli's pinipl: P1 + 1/2ρv1² = P2 + 1/2ρv2² # Pssu op s vloiy ins (sinl plifiion) pssuop = slf.onfi.fluionfi.pssuopoffiin vloiyin = slf.onfi.fluionfi.lionfo # pply pssu op (nuion) follow by vloiy in (plifiion) nu = sinl * (1.0 - pssuop) nhn = nu * vloiyin #  sonn fo fquny-spifi nhnn sonnfq = slf.onfi.fluionfi.sonnfquny nhn = slf.pplysonnfil(nhn, sonnfq) un nhn syn f unois( slf, sinl: np.ny, onx: Opionl[i[s, ny]] = Non ) -> np.ny: """Nois uion usin lin flow sbilizion""" # ubuln s nois - sbiliz flow fo nois uion # lul ubuln lvl ubuln = slf.lulubuln(sinl) # pply lin flow sbilizion if ubuln > slf.onfi.fluionfi.ubulnhshol: # u hih-fquny ubuln (nois) sbiliz = slf.pplylinfil(sinl, ubuln) ls: sbiliz = sinl # pply flow sbiliy fo sbiliyfo = slf.onfi.fluionfi.flowsbiliyfo sbiliz = sbiliz * sbiliyfo + sinl * (1 - sbiliyfo) un sbiliz syn f xpns( slf, sinl: np.ny, onx: Opionl[i[s, ny]] = Non ) -> np.ny: """Pn xion usin flow sonn n honi nlysis""" # x pns houh sonn fquny hin # pply uli-honi sonn honis = [1.0, 2.0, 3.0] # Funnl n honis pnsinl = np.zosli(sinl) fo honi in honis: fq = slf.onfi.fluionfi.sonnfquny * honi sonnoponn = slf.pplysonnfil(sinl, fq) pnsinl += sonnoponn * ( 1.0 / honi ) # Wih honis # nhn pn liy houh phs linn pnsinl = slf.linphss(pnsinl) un pnsinl f pplysonnfil( slf, sinl: np.ny, fquny: flo ) -> np.ny: """pply sonn fil  spifi fquny""" # Sipl sonn fil iplnion  = 1.0 / 1000.0 # ssu 1000 Hz splin o = 2 * h.pi * fquny pin = 0.1 # Lih pin fo sonn # Son-o sonn fil # y[n] = (2 * (1-pin) * os(o) * y[n-1] - (1-pin)^2 * y[n-2] + x[n]) / (1 + pin) if no hs(slf, "sonns"): slf.sonns = {"y1": 0.0, "y2": 0.0} fil = np.zosli(sinl) fo i, x in nu(sinl): y = ( 2 * (1 - pin) * h.os(o) * slf.sonns["y1"] - (1 - pin) ** 2 * slf.sonns["y2"] + x ) / (1 + pin) fil[i] = y slf.sonns["y2"] = slf.sonns["y1"] slf.sonns["y1"] = y un fil f lulubuln(slf, sinl: np.ny) -> flo: """lul ubuln lvl in sinl""" # ubuln su by hih-fquny ny if ln(sinl) < 10: un 0.0 # lul son iviv (lion) s ubuln inio lion = np.iff(np.iff(sinl)) ubulnny = np.n(np.bs(lion)) # Noliz o 0-1 n un in(ubulnny / 10.0, 1.0) f pplylinfil( slf, sinl: np.ny, ubuln: flo ) -> np.ny: """pply lin flow fil o u ubuln""" # Sipl low-pss fil o u hih-fquny ubuln filsnh = in(ubuln * 2.0, 0.9) # piv fil snh # xponnil ovin v fo lin sbilizion if no hs(slf, "lins"): slf.lins = sinl[0] if ln(sinl) > 0 ls 0.0 fil = np.zosli(sinl) fo i, x in nu(sinl): slf.lins = ( slf.lins * (1 - filsnh) + x * filsnh ) fil[i] = slf.lins un fil f linphss(slf, sinl: np.ny) -> np.ny: """lin phss fo pn nhnn""" # Hilb nsfo fo phs linn (siplifi) if ln(sinl) < 2: un sinl # Sipl phs linn usin olion lin = np.zosli(sinl) # Us uoolion fo pn linn fo i in n(1, ln(sinl)): olion = np.ol(sinl[:i], sinl[i - 1 : i + 1], o="vli") if ln(olion) > 0: phsshif = olion[0] / ( np.s(sinl[:i]) * np.s(sinl[i - 1 : i + 1]) + 1-10 ) lin[i] = sinl[i] * ( 1 + phsshif * 0.1 ) # Subl phs linn ls: lin[i] = sinl[i] un lin f ups(slf, posssinl: np.ny, possini: flo): """Up  s bs on possin suls""" # lul flui ynis is sinlny = np.n(np.bs(posssinl)) sinlvin = np.v(posssinl) # Up pssu (l o sinl pliu) slf.s.pssu = in( slf.onfi.xpssu, x(slf.onfi.inpssu, sinlny) ) # Up vloiy (l o possin sp n sinl hn ) vloiyfo = 1.0 / ( possini + 0.001 ) # Fs possin = hih vloiy slf.s.vloiy = in(slf.onfi.xvloiy, vloiyfo) # Up flow  (obinion of pssu n vloiy) slf.s.flow = slf.s.pssu * slf.s.vloiy # Up ubuln (sinl vibiliy) slf.s.ubulnlvl = in(sinlvin / 10.0, 1.0) # Up ffiiny (sinl psvion vs possin i) oiinlny = np.n(np.bs(posssinl)) # ppoxiion slf.s.ffiiny = in(oiinlny / (sinlny + 0.001), 1.0) # Up sonn phs slf.s.sonnphs = (slf.s.sonnphs + 0.1) % (2 * h.pi) slf.s.lsup = i.i() # So hisoy slf.hisoy.ppn( { "isp": i.i(), "pssu": slf.s.pssu, "vloiy": slf.s.vloiy, "ffiiny": slf.s.ffiiny, "ubuln": slf.s.ubulnlvl, } ) # p hisoy boun if ln(slf.hisoy) > 1000: slf.hisoy.pop(0) f is(slf) -> i[s, ny]: """ ophnsiv  pfon is""" if ln(slf.hisoy) == 0: un slf.unis() # lul ns fo hisoy nhisoy = ( slf.hisoy[-100:] if ln(slf.hisoy) > 100 ls slf.hisoy ) pssus = [h["pssu"] fo h in nhisoy] vloiis = [h["vloiy"] fo h in nhisoy] ffiinis = [h["ffiiny"] fo h in nhisoy] ubulns = [h["ubuln"] fo h in nhisoy] un { "unpssu": slf.s.pssu, "unvloiy": slf.s.vloiy, "unffiiny": slf.s.ffiiny, "unubuln": slf.s.ubulnlvl, "vpssu": np.n(pssus), "vvloiy": np.n(vloiis), "vffiiny": np.n(ffiinis), "vubuln": np.n(ubulns), "pssusbiliy": 1.0 - np.s(pssus) / (np.n(pssus) + 0.001), "vloiysbiliy": 1.0 - np.s(vloiis) / (np.n(vloiis) + 0.001), "ffiinyn": ( np.polyfi(n(ln(ffiinis)), ffiinis, 1)[0] if ln(ffiinis) > 1 ls 0 ), "possinhisoylnh": ln(slf.hisoy), } f unis(slf) -> i[s, ny]: """ un is whn no hisoy vilbl""" un { "unpssu": slf.s.pssu, "unvloiy": slf.s.vloiy, "unffiiny": slf.s.ffiiny, "unubuln": slf.s.ubulnlvl, "vpssu": slf.s.pssu, "vvloiy": slf.s.vloiy, "vffiiny": slf.s.ffiiny, "vubuln": slf.s.ubulnlvl, "pssusbiliy": 1.0, "vloiysbiliy": 1.0, "ffiinyn": 0.0, "possinhisoylnh": 0, } lss pivonoll: """piv onoll fo Vnui  opiizion""" f ini(slf, fluionfi: Fluiynisonfi): slf.onfi = fluionfi slf.lnin = fluionfi.pion slf.pfonhisoy = [] slf.opilps = { "onsiionio": fluionfi.onsiionio, "lionfo": fluionfi.lionfo, "pssuopoffiin": fluionfi.pssuopoffiin, } syn f p(slf, s: VnuiS, posssinl: np.ny): """p  ps bs on pfon""" # lul pfon so pfon = slf.lulpfonso(s, posssinl) # So pfon hisoy slf.pfonhisoy.ppn( {"pfon": pfon, "s": s, "isp": i.i()} ) # p hisoy boun if ln(slf.pfonhisoy) > 100: slf.pfonhisoy.pop(0) # p ps if w hv nouh hisoy if ln(slf.pfonhisoy) >= 10: wi slf.upps() f lulpfonso( slf, s: VnuiS, posssinl: np.ny ) -> flo: """lul pfon so fo pion""" # Pfon bs on ffiiny, sbiliy, n sinl quliy ffiinyso = s.ffiiny sbiliyso = 1.0 - s.ubulnlvl sinlquliy = 1.0 / ( np.v(posssinl) + 0.001 ) # Low vin = hih quliy # Noliz sinl quliy o 0-1 n sinlquliy = in(sinlquliy / 1000.0, 1.0) # Wih obinion pfon = ( ffiinyso * 0.4 + sbiliyso * 0.3 + sinlquliy * 0.3 ) un in(x(pfon, 0.0), 1.0) syn f upps(slf): """Up opil ps bs on pfon hisoy""" if ln(slf.pfonhisoy) < 20: un # Fin bs pfoin onfiuions sohisoy = so( slf.pfonhisoy, y=lb x: x["pfon"], vs=u ) # Us op 10% fo p siion oppfos = sohisoy[: x(1, ln(sohisoy) // 10)] # lul opil ps fo op pfos vonsiion = np.n([h["s"].pssu fo h in oppfos]) vlion = np.n([h["s"].vloiy fo h in oppfos]) # Sooh p ups slf.opilps["onsiionio"] = ( slf.opilps["onsiionio"] * (1 - slf.lnin) + (vonsiion / 2.0) * slf.lnin # Sl o sonbl n ) slf.opilps["lionfo"] = ( slf.opilps["lionfo"] * (1 - slf.lnin) + (vlion / 3.0) * slf.lnin ) lss nhnVnuionolSys: """ nhn Vnui onol Sys - Ohss h Vnui s ns h opl flui ynis possin piplin wih: - Sinl nhnn  - Nois uion  - Pn xion  """ f ini(slf): slf.s = {} slf.syss = { "olflow": 0.0, "sysffiiny": 1.0, "honisonn": 0.0, "fluisbiliy": 1.0, } slf.possinpiplin = [] slf.isiniiliz = Fls lo.info("nhn Vnui onol Sys iniiliz") syn f iniilizsys(slf) -> bool: """Iniiliz h h Vnui s sys""" y: #  h Vnui s onfis = [ Vnuionfi( i="sinlnhnn", yp=Vnuiyp.SINLNHNN, fluionfi=Fluiynisonfi( onsiionio=0.8, lionfo=1.3, sonnfquny=12.0, # lph wv nhnn ), ), Vnuionfi( i="noisuion", yp=Vnuiyp.NOISUION, fluionfi=Fluiynisonfi( onsiionio=0.9, lionfo=1.1, ubulnhshol=0.15, flowsbiliyfo=0.98, ), ), Vnuionfi( i="pnxion", yp=Vnuiyp.PNXION, fluionfi=Fluiynisonfi( onsiionio=0.7, lionfo=1.4, sonnfquny=10.0, # Funnl  fquny ), ), ] # Iniiliz s fo onfi in onfis:  = nhnVnui(onfi) slf.s[onfi.i] =  # Opiiz possin piplin wi slf.opiizpiplin() slf.isiniiliz = u lo.info( f"nhn Vnui onol Sys iniiliz wih {ln(slf.s)} s" ) un u xp xpion s : lo.o(f"Fil o iniiliz Vnui onol Sys: {}") un Fls syn f posssinl( slf, inpusinl: np.ny, onx: Opionl[i[s, ny]] = Non ) -> i[s, ny]: """ Poss sinl houh h opl Vnui sys s: inpusinl: Inpu  sinl onx: Possin onx uns: Possin suls iiony """ if no slf.isiniiliz: is unio("Vnui onol Sys no iniiliz") si = i.pfoun() suls = { "inpusinl": inpusinl.opy(), "oupus": {}, "possinis": {}, "sysis": {}, } unsinl = inpusinl # Poss houh piplin fo i in slf.possinpiplin:  = slf.s[i] # Poss houh  s = i.pfoun() poss = wi .posssinl(unsinl, onx) i = i.pfoun() - s # So suls suls["oupus"][i] = poss.opy() suls["possinis"][i] = { "possini": i, "is": .is(), } unsinl = poss # lul sys-lvl is oli = i.pfoun() - si suls["sysis"] = slf.lulsysis(suls, oli) # Up sys s slf.upsyss(suls) un suls syn f opiizpiplin(slf): """Opiiz h possin piplin bs on  hisis""" # Sipl opiizion: o by possin ffiiny ffiinis = [] fo i,  in slf.s.is(): # si ffiiny (hih fo sinl nhnn, low fo nois uion) if .onfi.yp == Vnuiyp.SINLNHNN: ffiiny = 0.9 lif .onfi.yp == Vnuiyp.NOISUION: ffiiny = 0.8 ls: # PNXION ffiiny = 0.85 ffiinis.ppn((i, ffiiny)) # So by ffiiny (hihs fis) ffiinis.so(y=lb x: x[1], vs=u) slf.possinpiplin = [i fo i,  in ffiinis] lo.info(f"Possin piplin opiiz: {slf.possinpiplin}") f lulsysis( slf, suls: i[s, ny], oli: flo ) -> i[s, ny]: """lul sys-lvl pfon is""" is = suls["possinis"] #   ffiinis ffiinis = [] possinis = [] fo i, is in is.is():  = is["is"] ffiinis.ppn(.("unffiiny", 1.0)) possinis.ppn(is["possini"]) # lul sys is sysffiiny = np.n(ffiinis) if ffiinis ls 1.0 olpossini = su(possinis) # lul honi sonn (synhonizion bwn s) if ln(ffiinis) > 1: ffiinys = np.s(ffiinis) honisonn = 1.0 - in( ffiinys, 1.0 ) # Low vin = hih sonn ls: honisonn = 1.0 # lul flui sbiliy (onsisny oss s) fluisbiliy = 1.0 - np.s(possinis) / ( np.n(possinis) + 0.001 ) un { "sysffiiny": sysffiiny, "olpossini": oli, "honisonn": honisonn, "fluisbiliy": fluisbiliy, "houhpuhz": 1.0 / oli if oli > 0 ls 0, "lnys": oli * 1000, "sposs": ln(is), } f upsyss(slf, suls: i[s, ny]): """Up ovll sys s""" sysis = suls["sysis"] slf.syss["olflow"] = sysis["houhpuhz"] slf.syss["sysffiiny"] = sysis["sysffiiny"] slf.syss["honisonn"] = sysis["honisonn"] slf.syss["fluisbiliy"] = sysis["fluisbiliy"] f syssus(slf) -> i[s, ny]: """ ophnsiv sys sus""" sus = {} fo i,  in slf.s.is(): sus[i] = { "yp": .onfi.yp.vlu, "s": .is(), "onfi": { "onsiionio": .onfi.fluionfi.onsiionio, "lionfo": .onfi.fluionfi.lionfo, "sonnfquny": .onfi.fluionfi.sonnfquny, }, } un { "syss": slf.syss, "sus": sus, "possinpiplin": slf.possinpiplin, "isiniiliz": slf.isiniiliz, "ols": ln(slf.s), } syn f shuown(slf): """fully shuown h onol sys""" lo.info("nhn Vnui onol Sys shuown opl") # Foy funion fo sy insniion f nhnvnuisys() -> nhnVnuionolSys: """ Foy funion o  n nhn Vnui onol sys uns: onfiu nhnVnuionolSys insn """ un nhnVnuionolSys() # xpl us n onsion syn f onsvnuisys(): """ons h nhn Vnui onol sys""" pin(" nhn Vnui onol Sys onsion") pin("=" * 60) #  sys sys = nhnvnuisys() # Iniiliz pin(" Iniilizin Vnui onol Sys...") suss = wi sys.iniilizsys() if no suss: pin(" Iniilizion fil") un pin(" Sys iniiliz sussfully") # n s  sinl pin(" nin s  sinl...") nspls = 1000  = np.linsp(0, 1, nspls) #  lisi  sinl wih ulipl fquny oponns sinl = ( 20-6 * np.sin(2 * np.pi * 10 * ) # lph wvs + 15-6 * np.sin(2 * np.pi * 20 * ) # B wvs + 5-6 * np.no.nn(nspls) # Boun nois + 30-6 * np.sin(2 * np.pi * 0.5 * ) # Slow osillions ) # Poss sinl pin(" Possin sinl houh Vnui sys...") si = i.pfoun() suls = wi sys.posssinl(sinl) possini = i.pfoun() - si pin("\n POSSIN SULS") pin(f"Inpu sinl lnh: {ln(sinl)} spls") pin(f"ol possin i: {possini:.4f} sons") pin(f"Lny: {possini * 1000:.1f} s") pin(f"houhpu: {1.0 / possini:.1f} Hz") # isply sys is sysis = suls["sysis"] pin("\n SYS IS") pin(f"Sys ffiiny: {sysis['sysffiiny']:.3f}") pin(f"Honi sonn: {sysis['honisonn']:.3f}") pin(f"Flui Sbiliy: {sysis['fluisbiliy']:.3f}") pin(f"s Poss: {sysis['sposs']}") # isply -by- suls pin("\n ️  POSSIN SULS") fo i, oupu in suls["oupus"].is(): is = suls["possinis"][i]  = is["is"] pin(f"\n{i.upp()}:") pin(f" Possin i: {is['possini']:.6f} sons") pin(f" un ffiiny: {['unffiiny']:.3f}") pin(f" un pssu: {['unpssu']:.3f}") pin(f" un vloiy: {['unvloiy']:.3f}") pin(f" ubuln lvl: {['unubuln']:.3f}") # isply finl sys sus pin("\n FINL SYS SUS") sus = sys.syssus() pin(f"ol flow : {sus['syss']['olflow']:.1f} Hz") pin(f"Sys ffiiny: {sus['syss']['sysffiiny']:.3f}") pin(f"Honi sonn: {sus['syss']['honisonn']:.3f}") pin(f"Flui sbiliy: {sus['syss']['fluisbiliy']:.3f}") pin(f"Possin piplin: {sus['possinpiplin']}") pin("\n onsion opl sussfully!") wi sys.shuown() if n == "in": # un onsion synio.un(onsvnuisys())