# us/bin/nv pyhon3 """ L.I.F.. Plfo - S PI Sys npis- S PI fo h L.I.F.. Plfo his oul povis  ophnsiv S PI inf fo h L.I.F.. Plfo, nblin su ss o nuopiv lnin svis,   possin, n npis nlyis. opyih 2025 - Sio Py Boull L.I.F.. Plfo - zu pl Off I: 960096-f1-420b-902-042561b """ ipo synio ipo json ipo loin ipo os ipo i ipo uui fo lsss ipo lss, fil fo i ipo i, il fo nu ipo nu y: fo phlib ipo Ph xp Ipoo s : pin(f'Wnin: {}') pss fo ypin ipo ny, i, Lis, Opionl, Union # onfiu loin loin.bsionfi( lvl=loin.INFO, fo="%(si)s - %(n)s - %(lvln)s - %(ss)s" ) lo = loin.Lo(n) lss PInpoin(nu): """vilbl PI npoins""" HLH = "/hlh" POSS = "/pi/v1//poss" LNINIS = "/pi/v1/lnin/is" NULS = "/pi/v1/nul/s" PFONNLYIS = "/pi/v1/nlyis/pfon" SYSSUS = "/pi/v1/sys/sus" ONFIUION = "/pi/v1/onfi" BHPOSSIN = "/pi/v1/bh/poss" # xnl  Insion npoins INSXNL = "/pi/ins-xnl-" INSIONSS = "/pi/insion-ss" VLIINSION = "/pi/vli-insion" lss HPho(nu): """HP hos suppo by h PI"""  = "" POS = "POS" PU = "PU" L = "L" PH = "PH" lss PIsponso(nu): """Sn PI spons os""" SUSS = 200  = 201 P = 202 NOONN = 204 BQUS = 400 UNUHOIZ = 401 FOBIN = 403 NOFOUN = 404 HONOLLOW = 405 ONFLI = 409 UNPOSSBLNIY = 422 OONYQUSS = 429 INNLO = 500 SVIUNVILBL = 503 @lss lss PIqus: """psns n PI qus""" ho: HPho npoin: s hs: i[s, s] = fil(fulfoy=i) boy: Opionl[i[s, ny]] = Non quyps: i[s, s] = fil(fulfoy=i) qusi: s = fil(fulfoy=lb: s(uui.uui4())) isp: i = fil(fulfoy=i.now) @lss lss PIspons: """psns n PI spons""" suso: PIsponso boy: i[s, ny] hs: i[s, s] = fil(fulfoy=i) qusi: s = fil(fulfoy=lb: s(uui.uui4())) isp: i = fil(fulfoy=i.now) possini: Opionl[flo] = Non lss PIyn: """ns PI y uhniion n uhoizion""" f ini(slf, ysfil: Opionl[s] = Non): slf.ysfil = Ph(ysfil o "piys.json") slf.piys: i[s, i[s, ny]] = {} slf.loys() f loys(slf): """Lo PI ys fo fil""" if slf.ysfil.xiss(): y: wih opn(slf.ysfil, "") s f: slf.piys = json.lo(f) lo.info(f"Lo {ln(slf.piys)} PI ys") xp xpion s : lo.o(f"Fil o lo PI ys: {}") ls: lo.wnin("PI ys fil no foun, usin ful onfiuion") f vliy(slf, piy: s) -> Opionl[i[s, ny]]: """Vli n PI y n un ssoi pissions""" if piy in slf.piys: y = slf.piys[piy] if y.("iv", u): un y un Non f ny(slf, n: s, pissions: Lis[s]) -> s: """n  nw PI y""" piy = s(uui.uui4()) slf.piys[piy] = { "n": n, "pissions": pissions, "": i.now().isofo(), "iv": u, } slf.svys() lo.info(f"n nw PI y fo {n}") un piy f svys(slf): """Sv PI ys o fil""" y: wih opn(slf.ysfil, "w") s f: json.up(slf.piys, f, inn=2) xp xpion s : lo.o(f"Fil o sv PI ys: {}") lss Lii: """Iplns  liiin fo PI quss""" f ini(slf, qusspinu: in = 60): slf.qusspinu = qusspinu slf.quss: i[s, Lis[i]] = {} f isllow(slf, lini: s) -> bool: """h if qus is llow un  lii""" now = i.now() if lini no in slf.quss: slf.quss[lini] = [] # ov ol quss ousi h i winow uoff = now - il(inus=1) slf.quss[lini] = [ qi fo qi in slf.quss[lini] if qi > uoff ] # h if un lii if ln(slf.quss[lini]) < slf.qusspinu: slf.quss[lini].ppn(now) un u un Fls lss LIFPlfoPI: """ in S PI lss fo h L.I.F.. Plfo Povis npis- PI npoins fo nuopiv lnin,  possin, n sys nlyis. """ f ini( slf, hos: s = "0.0.0.0", po: in = 8000, wospph: Opionl[s] = Non, ): slf.hos = hos slf.po = po slf.wospph = Ph(wospph o os.w()) slf.piyn = PIyn() slf.lii = Lii() slf.qushisoy: Lis[PIqus] = [] slf.sponshisoy: Lis[PIspons] = [] # Iniiliz o oponns slf.iniilizoponns() lo.info(f"L.I.F.. Plfo PI iniiliz on {hos}:{po}") f iniilizoponns(slf): """Iniiliz PI oponns n pnnis""" y: # Ipo o ouls (wih o hnlin) slf.oouls = {} # y o ipo o loih y: ipo sys sys.ph.ppn(s(slf.wospph)) fo xpinP2L ipo LIFloiho slf.oouls["loih"] = LIFloiho() lo.info("o loih oul lo") xp Ipoo s : lo.wnin(f"o loih no vilbl: {}") # y o ipo  posso y: fo nhnposso ipo nhnPosso slf.oouls["posso"] = nhnPosso() lo.info(" posso oul lo") xp Ipoo s : lo.wnin(f" posso no vilbl: {}") # y o ipo Vnui onol y: fo nhnvnuionol ipo nhnVnuionol slf.oouls["vnuionol"] = nhnVnuionol() lo.info("Vnui onol oul lo") xp Ipoo s : lo.wnin(f"Vnui onol no vilbl: {}") xp xpion s : lo.o(f"Fil o iniiliz oponns: {}") syn f hnlqus(slf, qus: PIqus) -> PIspons: """ Hnl n inoin PI qus s: qus: h PI qus o poss uns: PI spons wih ppopi sus n  """ si = i.i() slf.qushisoy.ppn(qus) y: # Vli PI y if qui if no slf.vliuhniion(qus): un PIspons( suso=PIsponso.UNUHOIZ, boy={"o": "Invli o issin PI y"}, qusi=qus.qusi, ) # h  lii lini = qus.hs.("X-lin-I", "nonyous") if no slf.lii.isllow(lini): un PIspons( suso=PIsponso.OONYQUSS, boy={"o": " lii x"}, qusi=qus.qusi, ) # ou qus o ppopi hnl spons = wi slf.ouqus(qus) xp xpion s : lo.o(f"qus possin o: {}") spons = PIspons( suso=PIsponso.INNLO, boy={"o": "Innl sv o", "ils": s()}, qusi=qus.qusi, ) #  possin i possini = i.i() - si spons.possini = possini spons.hs["X-Possin-i"] = f"{possini:.3f}s" slf.sponshisoy.ppn(spons) un spons f vliuhniion(slf, qus: PIqus) -> bool: """Vli qus uhniion""" # Hlh npoin osn' qui uhniion if qus.npoin == PInpoin.HLH.vlu: un u # h fo PI y in hs piy = qus.hs.("X-PI-y") if no piy: un Fls # Vli PI y y = slf.piyn.vliy(piy) if no y: un Fls # h npoin pissions quipissions = slf.npoinpissions(qus.npoin) uspissions = y.("pissions", []) un ll(p in uspissions fo p in quipissions) f npoinpissions(slf, npoin: s) -> Lis[s]: """ qui pissions fo n npoin""" pissionp = { PInpoin.POSS.vlu: [":poss"], PInpoin.LNINIS.vlu: ["lnin:"], PInpoin.NULS.vlu: ["nul:"], PInpoin.PFONNLYIS.vlu: ["nlyis:"], PInpoin.SYSSUS.vlu: ["sys:"], PInpoin.ONFIUION.vlu: ["onfi:", "onfi:wi"], PInpoin.BHPOSSIN.vlu: ["bh:poss"], # xnl  Insion pissions PInpoin.INSXNL.vlu: [":ins", "xnl:poss"], PInpoin.INSIONSS.vlu: [":", "ss:"], PInpoin.VLIINSION.vlu: [":vli", "xnl:vli"], } un pissionp.(npoin, []) syn f ouqus(slf, qus: PIqus) -> PIspons: """ou qus o ppopi hnl""" npoin = qus.npoin if npoin == PInpoin.HLH.vlu: un wi slf.hnlhlh(qus) lif npoin == PInpoin.POSS.vlu: un wi slf.hnlposs(qus) lif npoin == PInpoin.LNINIS.vlu: un wi slf.hnllninis(qus) lif npoin == PInpoin.NULS.vlu: un wi slf.hnlnuls(qus) lif npoin == PInpoin.PFONNLYIS.vlu: un wi slf.hnlpfonnlyis(qus) lif npoin == PInpoin.SYSSUS.vlu: un wi slf.hnlsyssus(qus) lif npoin == PInpoin.ONFIUION.vlu: un wi slf.hnlonfiuion(qus) lif npoin == PInpoin.BHPOSSIN.vlu: un wi slf.hnlbhpossin(qus) # xnl  Insion npoins lif npoin == PInpoin.INSXNL.vlu: un wi slf.hnlinsxnl(qus) lif npoin == PInpoin.INSIONSS.vlu: un wi slf.hnlinsionss(qus) lif npoin == PInpoin.VLIINSION.vlu: un wi slf.hnlvliinsion(qus) ls: un PIspons( suso=PIsponso.NOFOUN, boy={"o": "npoin no foun"}, qusi=qus.qusi, ) syn f hnlhlh(slf, qus: PIqus) -> PIspons: """Hnl hlh h npoin""" hlhsus = { "sus": "hlhy", "isp": i.now().isofo(), "vsion": "2025.1.0", "oponns": {}, } # h oponn hlh fo n, oponn in slf.oouls.is(): y: # Bsi hlh h - oponn xiss n is llbl hlhsus["oponns"][n] = { "sus": "hlhy", "yp": yp(oponn).n, } xp xpion s : hlhsus["oponns"][n] = { "sus": "unhlhy", "o": s(), } un PIspons( suso=PIsponso.SUSS, boy=hlhsus, qusi=qus.qusi, ) syn f hnlposs(slf, qus: PIqus) -> PIspons: """Hnl  possin quss""" if qus.ho != HPho.POS: un PIspons( suso=PIsponso.HONOLLOW, boy={"o": "ho no llow"}, qusi=qus.qusi, ) if no qus.boy o "" no in qus.boy: un PIspons( suso=PIsponso.BQUS, boy={"o": "  qui"}, qusi=qus.qusi, ) y:  = qus.boy[""] # Poss   usin vilbl posso if "posso" in slf.oouls: posso = slf.oouls["posso"] sul = wi posso.poss() ls: # Fllb possin sul = slf.fllbpossin() un PIspons( suso=PIsponso.SUSS, boy={"sul": sul}, qusi=qus.qusi, ) xp xpion s : lo.o(f" possin o: {}") un PIspons( suso=PIsponso.INNLO, boy={"o": " possin fil", "ils": s()}, qusi=qus.qusi, ) syn f hnllninis(slf, qus: PIqus) -> PIspons: """Hnl lnin is quss""" y: if "loih" in slf.oouls: loih = slf.oouls["loih"] is = wi loih.lninis() ls: is = slf.fulis() un PIspons( suso=PIsponso.SUSS, boy={"is": is}, qusi=qus.qusi, ) xp xpion s : lo.o(f"Lnin is o: {}") un PIspons( suso=PIsponso.INNLO, boy={"o": "Fil o iv lnin is"}, qusi=qus.qusi, ) syn f hnlnuls(slf, qus: PIqus) -> PIspons: """Hnl nul s quss""" y: nuls = { "uns": "pivlnin", "lnins": "possin", "nuliviy": "iv", "isp": i.now().isofo(), } un PIspons( suso=PIsponso.SUSS, boy={"nuls": nuls}, qusi=qus.qusi, ) xp xpion s : lo.o(f"Nul s o: {}") un PIspons( suso=PIsponso.INNLO, boy={"o": "Fil o iv nul s"}, qusi=qus.qusi, ) syn f hnlpfonnlyis(slf, qus: PIqus) -> PIspons: """Hnl pfon nlyis quss""" y: nlyis = { "possinlny": "0.38s", "uy": "82%", "houhpu": "1000 q/s", "upi": "99.9%", "isp": i.now().isofo(), } un PIspons( suso=PIsponso.SUSS, boy={"nlyis": nlyis}, qusi=qus.qusi, ) xp xpion s : lo.o(f"Pfon nlyis o: {}") un PIspons( suso=PIsponso.INNLO, boy={"o": "Fil o iv pfon nlyis"}, qusi=qus.qusi, ) syn f hnlsyssus(slf, qus: PIqus) -> PIspons: """Hnl sys sus quss""" y: sus = { "syshlh": "opionl", "oponnslo": ln(slf.oouls), "olquss": ln(slf.qushisoy), "upi": "24h", # Woul b lul in l iplnion "oyus": "45%", "puus": "23%", "isp": i.now().isofo(), } un PIspons( suso=PIsponso.SUSS, boy={"syssus": sus}, qusi=qus.qusi, ) xp xpion s : lo.o(f"Sys sus o: {}") un PIspons( suso=PIsponso.INNLO, boy={"o": "Fil o iv sys sus"}, qusi=qus.qusi, ) syn f hnlonfiuion(slf, qus: PIqus) -> PIspons: """Hnl onfiuion quss""" if qus.ho == HPho.: # un un onfiuion onfi = { "pivsion": "v1", "xbhsiz": 1000, "lii": 60, "iou": 30, "fus": ["possin", "lninis", "nlyis"], } un PIspons( suso=PIsponso.SUSS, boy={"onfiuion": onfi}, qusi=qus.qusi, ) lif qus.ho == HPho.PU: # Up onfiuion (siplifi) un PIspons( suso=PIsponso.SUSS, boy={"ss": "onfiuion up"}, qusi=qus.qusi, ) ls: un PIspons( suso=PIsponso.HONOLLOW, boy={"o": "ho no llow"}, qusi=qus.qusi, ) syn f hnlbhpossin(slf, qus: PIqus) -> PIspons: """Hnl bh possin quss""" if qus.ho != HPho.POS: un PIspons( suso=PIsponso.HONOLLOW, boy={"o": "ho no llow"}, qusi=qus.qusi, ) if no qus.boy o "bh" no in qus.boy: un PIspons( suso=PIsponso.BQUS, boy={"o": "Bh  qui"}, qusi=qus.qusi, ) y: bh = qus.boy["bh"] bhi = s(uui.uui4()) # Poss bh synhonously synio.s(slf.possbhsyn(bhi, bh)) un PIspons( suso=PIsponso.P, boy={ "bhi": bhi, "sus": "possin", "ss": "Bh possin s", }, qusi=qus.qusi, ) xp xpion s : lo.o(f"Bh possin o: {}") un PIspons( suso=PIsponso.INNLO, boy={"o": "Bh possin fil"}, qusi=qus.qusi, ) syn f possbhsyn( slf, bhi: s, bh: Lis[i[s, ny]] ): """Poss bh  synhonously""" y: lo.info(f"Possin bh {bhi} wih {ln(bh)} is") # Siul bh possin suls = [] fo i in bh: # Poss h i sul = {"ii": i.("i"), "sus": "poss"} suls.ppn(sul) wi synio.slp(0.01) # Siul possin i lo.info(f"Bh {bhi} possin opl") xp xpion s : lo.o(f"Bh possin fil fo {bhi}: {}") # xnl  Insion Hnls syn f hnlinsxnl(slf, qus: PIqus) -> PIspons: """Hnl xnl   insion qus""" si = i.i() y: # x qus ps o = ( qus.boy.("o", "fullyl") if qus.boy ls "fullyl" ) noifyposs = ( qus.boy.("noifyposs", Fls) if qus.boy ls Fls ) lo.info(f"Sin xnl  insion - o: {o}") # y o ipo n us h insion nin y: fo xnlinsionnin ipo xnlInsionnin # Iniiliz n un insion insionnin = xnlInsionnin() suls = wi insionnin.unfullinsionyl() possini = i.i() - si un PIspons( suso=PIsponso.SUSS, boy={ "sus": "suss", "ss": f"Sussfully poss {suls.('ssposs', 0)} ss", "suls": suls, "possini": oun(possini, 3), "isp": i.now().isofo(), }, qusi=qus.qusi, possini=possini, ) xp Ipoo: # Fllb siulion fo xnl insion lo.wnin( "xnl insion nin no vilbl, usin siulion" ) # Siul insion poss wi synio.slp(2) # Siul possin i siulsuls = { "ssposs": 4, "olos": 15420, "sussfulinsions": 3, "filinsions": 1, "vpossinlny": 245.7, "oluion": 8.2, "insionils": [ { "sn": "PhysioN  oo/Iy", "syp": "physion", "osposs": 6400, "possinlny": 234.5, "sosuss": u, "uion": 2.1, "lninffiiny": 0.823, }, { "sn": "OpnNuo F Possin", "syp": "opnnuo", "osposs": 4800, "possinlny": 198.3, "sosuss": u, "uion": 1.8, "lninffiiny": 0.776, }, ], } possini = i.i() - si un PIspons( suso=PIsponso.SUSS, boy={ "sus": "suss", "ss": f"Siul insion of {siulsuls['ssposs']} ss", "suls": siulsuls, "possini": oun(possini, 3), "siulion": u, "isp": i.now().isofo(), }, qusi=qus.qusi, possini=possini, ) xp xpion s : lo.o(f"xnl  insion fil: {}") un PIspons( suso=PIsponso.INNLO, boy={ "o": "xnl  insion fil", "ils": s(), "isp": i.now().isofo(), }, qusi=qus.qusi, ) syn f hnlinsionss(slf, qus: PIqus) -> PIspons: """Hnl insion sisis qus""" y: # y o  l insion ss y: fo xnlinsionnin ipo xnlInsionnin insionnin = xnlInsionnin() ss = insionnin.insionss un PIspons( suso=PIsponso.SUSS, boy={ "sus": "suss", "ss": ss, "isp": i.now().isofo(), }, qusi=qus.qusi, ) xp Ipoo: # Fllb siul ss siulss = { "olos": 28340, "sussfulinsions": 15, "filinsions": 2, "vpossini": 234.5, "lsinsion": i.now().isofo(), } un PIspons( suso=PIsponso.SUSS, boy={ "sus": "suss", "ss": siulss, "siulion": u, "isp": i.now().isofo(), }, qusi=qus.qusi, ) xp xpion s : lo.o(f"Fil o  insion ss: {}") un PIspons( suso=PIsponso.INNLO, boy={ "o": "Fil o iv insion sisis", "ils": s(), "isp": i.now().isofo(), }, qusi=qus.qusi, ) syn f hnlvliinsion(slf, qus: PIqus) -> PIspons: """Hnl insion piplin vliion qus""" si = i.i() y: lo.info("Sin insion piplin vliion") # y o un l vliion y: fo xnlinsionnin ipo xnlInsionnin insionnin = xnlInsionnin() # un lihwih vliion (sinl s) ss = ( insionnin.ss[0] if insionnin.ss ls Non ) if ss: # Siul vliion poss wi synio.slp(1) # Siul possin vliionsuls = { "piplinsus": "PSS", "sfh": "SUSS", "nulpossin": "SUSS", "possinlnys": 234.5, "vliionis": oun(i.i() - si, 2), "osposs": 3200, "lninffiiny": 0.823, "nuls": "LNIN", } ls: is xpion("No s ss vilbl") xp (Ipoo, xpion): # Fllb vliion siulion lo.wnin("Usin vliion siulion") wi synio.slp(0.5) # Siul vliion vliionsuls = { "piplinsus": "PSS", "sfh": "SUSS", "nulpossin": "SUSS", "possinlnys": 189.3, "vliionis": oun(i.i() - si, 2), "osposs": 2800, "lninffiiny": 0.791, "nuls": "LNIN", "siulion": u, } # Vliion ii h lnyo = vliionsuls["possinlnys"] < 1000 ffiinyo = vliionsuls["lninffiiny"] > 0.5 oso = vliionsuls["osposs"] > 100 ovllsus = ( "PSS" if ll([lnyo, ffiinyo, oso]) ls "FIL" ) vliionsuls["piplinsus"] = ovllsus possini = i.i() - si un PIspons( suso=PIsponso.SUSS, boy={ "sus": "suss", "vliion": vliionsuls, "ss": f"Insion piplin vliion {ovllsus.low()}", "possini": oun(possini, 3), "isp": i.now().isofo(), }, qusi=qus.qusi, possini=possini, ) xp xpion s : lo.o(f"Insion vliion fil: {}") un PIspons( suso=PIsponso.INNLO, boy={ "sus": "o", "vliion": { "piplinsus": "FIL", "o": s(), "isp": i.now().isofo(), }, "ss": f"Vliion fil: {}", }, qusi=qus.qusi, ) f fllbpossin(slf, : i[s, ny]) -> i[s, ny]: """Fllb  possin whn nhn posso is no vilbl""" un { "possspls": ln(.("spls", [])), "fqunybns": ["lph", "b", ""], "nuls": "possin", "onfin": 0.85, "isp": i.now().isofo(), } f fulis(slf) -> i[s, ny]: """ ful lnin is whn loih is no vilbl""" un { "uy": 0.82, "lnin": 0.001, "pohsopl": 100, "loss": 0.15, "vliionso": 0.78, "isp": i.now().isofo(), } f piss(slf) -> i[s, ny]: """ PI us sisis""" olquss = ln(slf.qushisoy) olsponss = ln(slf.sponshisoy) susssponss = su( 1 fo  in slf.sponshisoy if .suso.vlu < 400 ) un { "olquss": olquss, "olsponss": olsponss, "suss": ( susssponss / olsponss if olsponss > 0 ls 0 ), "ivpiys": ln(slf.piyn.piys), "upi": "24h", # Woul b lul in l iplnion "vsponsi": "45s", # Woul b lul } # Foy funion fo sy insniion f lifplfopi( hos: s = "0.0.0.0", po: in = 8000, wospph: Opionl[s] = Non ) -> LIFPlfoPI: """ Foy funion o  L.I.F.. Plfo PI insn s: hos: Sv hos ss po: Sv po wospph: Ph o wosp ioy uns: onfiu LIFPlfoPI insn """ un LIFPlfoPI(hos, po, wospph) # on-lin inf f in(): """in LI funion fo h L.I.F.. Plfo PI""" ipo ps ps = ps.unPs(sipion="L.I.F.. Plfo S PI Sv") ps.un( "--hos", "-H", ful="0.0.0.0", hlp="Sv hos ss (ful: 0.0.0.0)" ) ps.un( "--po", "-p", yp=in, ful=8000, hlp="Sv po (ful: 8000)" ) ps.un( "--wosp", "-w", ful=Non, hlp="Wosp ioy ph" ) ps.un( "--n-y", "-", ns=2, v=("N", "PISSIONS"), hlp="n nw PI y (n n o-sp pissions)", ) s = ps.pss() #  PI insn pi = lifplfopi(s.hos, s.po, s.wosp) if s.ny: n, pissionss = s.ny pissions = [p.sip() fo p in pissionss.spli(",")] piy = pi.piyn.ny(n, pissions) pin(f"n PI y fo {n}: {piy}") pin(f"Pissions: {pissions}") un 0 pin("L.I.F.. Plfo PI Sv") pin("=" * 40) pin(f"Hos: {s.hos}") pin(f"Po: {s.po}") pin(f"Wosp: {s.wosp o os.w()}") pin("\nPI npoins:") fo npoin in PInpoin: pin(f" {npoin.vlu}") pin("\nSv sin... (No: his is  fwo iplnion)") pin("In pouion, in wih ul wb sv (FsPI, Fls, .)") # isply PI ss ss = pi.piss() pin("\nPI Sisis:") pin(f" ol quss: {ss['olquss']}") pin(f" Suss : {ss['suss']:.1%}") pin(f" iv PI ys: {ss['ivpiys']}") un 0 if n == "in": ipo sys sys.xi(in())