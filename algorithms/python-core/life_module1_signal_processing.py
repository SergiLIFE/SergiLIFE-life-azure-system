""" L.I.F. hoy oul 1: vn Sinl Possin o sinl possin loihs wih piv lnin opyih 2025 - Sio Py Boull """ ipo loin fo lsss ipo lss, fil fo i ipo i fo nu ipo nu fo ypin ipo ny, i, Lis, Opionl, upl ipo nupy s np fo sipy ipo sinl fo sipy.ff ipo ff, fffq, iff fo sipy.sinl ipo bu, filfil, hilb, spo # Ipo L.I.F. hoy o fo lifhoy ipo pionPs, oLIFloih, xpinoy # onfiu loin loin.bsionfi(lvl=loin.INFO) lo = loin.Lo(n) lss Sinlyp(nu): """yps of sinls h n b poss"""  = "lonphlo"  = "loio"  = "loyo" UIO = "uiosinl" SNSO = "snso" BIOIL = "bioilsinl" NL = "nlsinl" lss Possino(nu): """Sinl possin os""" LI = "li" BH = "bhpossin" SIN = "sin" PIV = "pivlnin" @lss lss SinlFus: """ophnsiv sinl fu xion""" polfus: i[s, flo] = fil(fulfoy=i) fqunyfus: i[s, flo] = fil(fulfoy=i) sisilfus: i[s, flo] = fil(fulfoy=i) oplxiyfus: i[s, flo] = fil(fulfoy=i) quliyis: i[s, flo] = fil(fulfoy=i) f posini(slf): """Iniiliz ful fus if py""" if no slf.polfus: slf.polfus = { "n": 0.0, "s": 0.0, "s": 0.0, "pop": 0.0, "zoossins": 0.0, } @lss lss pivFil: """piv filin onfiuion""" filyp: s = "buwoh" o: in = 4 uofffqunis: Lis[flo] = fil(fulfoy=lb: [1.0, 50.0]) pion: flo = 0.01 lninnbl: bool = u pfonhisoy: Lis[flo] = fil(fulfoy=lis) lss LIFSinlPosso: """vn sinl posso wih L.I.F. hoy inion""" f ini( slf, splin: flo = 1000.0, sinlyp: Sinlyp = Sinlyp.NL, ): slf.splin = splin slf.sinlyp = sinlyp # Iniiliz L.I.F. loih fo piv possin lifonfi = { "lnin": 0.01, "xxpins": 5000, "vnuifo": 1.1, } slf.lifloih = oLIFloih( lnin=lifonfi["lnin"], xxpins=lifonfi["xxpins"], pionps=pionPs( lnin=lifonfi["lnin"], yfo=0.95, hshol=0.1, ), ) # piv filin sys slf.pivfils = { "lowpss": pivFil("buwoh", 4, [50.0], 0.01), "hihpss": pivFil("buwoh", 4, [1.0], 0.01), "bnpss": pivFil("buwoh", 4, [1.0, 50.0], 0.01), "noh": pivFil( "buwoh", 2, [50.0], 0.005 ), # Pow lin nois } # Possin hisoy fo pion slf.possinhisoy = [] slf.pfonis = { "snipovn": [], "ifsov": [], "possini": [], "pionso": [], } lo.info(f"L.I.F. Sinl Posso iniiliz fo {sinlyp.vlu}") f xophnsivfus(slf, sinl: np.ny) -> SinlFus: """x ophnsiv fus fo sinl""" y: fus = SinlFus() # pol fus fus.polfus = { "n": flo(np.n(sinl)), "s": flo(np.s(sinl)), "s": flo(np.sq(np.n(sinl**2))), "pop": flo(np.pp(sinl)), "zoossins": flo(ln(np.wh(np.iff(np.sinbi(sinl)))[0])), "swnss": flo(slf.lulswnss(sinl)), "uosis": flo(slf.luluosis(sinl)), "ny": flo(np.su(sinl**2)), } # Fquny oin fus fqs, ps = sinl.wlh( sinl, fs=slf.splin, nps=in(256, ln(sinl) // 4) ) fus.fqunyfus = { "oinnfquny": flo(fqs[np.x(ps)]), "splnoi": flo(np.su(fqs * ps) / np.su(ps)), "splbnwih": flo( slf.lulsplbnwih(fqs, ps) ), "splolloff": flo(slf.lulsplolloff(fqs, ps)), "olpow": flo(np.su(ps)), "nfquny": flo(np.n(fqs)), "infquny": flo(np.in(fqs)), } # Sisil fus fus.sisilfus = { "vin": flo(np.v(sinl)), "invlu": flo(np.in(sinl)), "xvlu": flo(np.x(sinl)), "in": flo(np.in(sinl)), "iq": flo(np.pnil(sinl, 75) - np.pnil(sinl, 25)), "": flo( np.in(np.bs(sinl - np.in(sinl))) ), # in bsolu viion "n": flo(np.x(sinl) - np.in(sinl)), } # oplxiy fus fus.oplxiyfus = { "splnopy": flo(slf.lulsplnopy(sinl)), "ppoxinopy": flo( slf.lulppoxinopy(sinl) ), "splnopy": flo(slf.lulsplnopy(ps)), "lplzivoplxiy": flo(slf.lullzoplxiy(sinl)), "flinsion": flo(slf.lulflinsion(sinl)), } # Quliy is fus.quliyis = { "snsi": flo(slf.sisn(sinl)), "ifpobbiliy": flo( slf.siifpobbiliy(sinl) ), "sinlquliyinx": flo( slf.lulsinlquliyinx(sinl) ), "noislvl": flo(slf.sinoislvl(sinl)), "sbiliyinx": flo(slf.lulsbiliyinx(sinl)), } un fus xp xpion s : lo.o(f"o xin fus: {s()}") un SinlFus() f pivfilsinl( slf, sinl: np.ny, filn: s = "bnpss" ) -> np.ny: """pply piv filin wih L.I.F. lnin""" y: if filn no in slf.pivfils: is Vluo(f"Unnown fil: {filn}") pivfil = slf.pivfils[filn] # pply un fil if filn == "lowpss": filsinl = slf.pplylowpssfil( sinl, pivfil.uofffqunis[0], pivfil.o ) lif filn == "hihpss": filsinl = slf.pplyhihpssfil( sinl, pivfil.uofffqunis[0], pivfil.o ) lif filn == "bnpss": filsinl = slf.pplybnpssfil( sinl, pivfil.uofffqunis, pivfil.o ) lif filn == "noh": filsinl = slf.pplynohfil( sinl, pivfil.uofffqunis[0], pivfil.o ) ls: filsinl = sinl.opy() # vlu filin pfon oiinlsn = slf.sisn(sinl) filsn = slf.sisn(filsinl) pfon = filsn / (oiinlsn + 1-8) # p fil ps usin L.I.F. if pivfil.lninnbl: slf.pfilps(pivfil, pfon) # o pfon pivfil.pfonhisoy.ppn(pfon) if ln(pivfil.pfonhisoy) > 1000: pivfil.pfonhisoy = ( pivfil.pfonhisoy[-1000:] ) un filsinl xp xpion s : lo.o(f"o in piv filin: {s()}") un sinl.opy() f posssinlwihlif( slf, sinl: np.ny, onx: Opionl[i[s, ny]] = Non ) -> i[s, ny]: """Poss sinl houh L.I.F. hoy loih wih ophnsiv nlysis""" y: si = i.now() # x fus bfo possin oiinlfus = slf.xophnsivfus(sinl) # pply piv ppossin pposssinl = slf.pivppossin(sinl) # Poss houh L.I.F. loih posssinl = slf.lifloih.poss( pposssinl, onx o {} ) # x fus f possin possfus = slf.xophnsivfus(posssinl) # pply piv filin filsinl = slf.pivfilsinl(posssinl, "bnpss") finlfus = slf.xophnsivfus(filsinl) # lul pfon is pfonis = slf.lulpossinpfon( sinl, pposssinl, posssinl, filsinl ) # p possin bs on pfon slf.ppossinpiplin(pfonis) # Pp suls possini = (i.now() - si).olsons() suls = { "oiinlsinl": sinl, "pposssinl": pposssinl, "posssinl": posssinl, "filsinl": filsinl, "oiinlfus": oiinlfus, "possfus": possfus, "finlfus": finlfus, "pfonis": pfonis, "possini": possini, "lifis": slf.lifloih.pfonis(), "pionhisoy": slf.lifloih.pionhisoy(), } # Up possin hisoy slf.possinhisoy.ppn( { "isp": si.isofo(), "pfon": pfonis, "possini": possini, } ) lo.info(f"Sinl possin opl in {possini:.3f}s") un suls xp xpion s : lo.o(f"o in L.I.F. sinl possin: {s()}") un { "oiinlsinl": sinl, "filsinl": sinl, "o": s(), "possini": 0.0, } f pivppossin(slf, sinl: np.ny) -> np.ny: """piv ppossin bs on sinl hisis""" y: #  sinl hisis sinlpow = np.n(sinl**2) noissi = slf.sinoislvl(sinl) # piv nolizion if sinlpow > 1000: # Hih pliu sinl nolizsinl = sinl / np.s(sinl) ls: nolizsinl = sinl.opy() # piv if ovl if noissi > 0.3: # Hih nois lnsinl = slf.ovifs(nolizsinl) ls: lnsinl = nolizsinl un lnsinl xp xpion s : lo.o(f"o in piv ppossin: {s()}") un sinl.opy() f ovifs(slf, sinl: np.ny) -> np.ny: """ov ifs usin piv hshol""" y: # lul piv hshol invl = np.in(sinl)  = np.in(np.bs(sinl - invl)) hshol = invl + 5 *  # ov x vlus lnsinl = sinl.opy() oulis = np.bs(lnsinl) > hshol if np.ny(oulis): # pl oulis wih inpol vlus ouliinis = np.wh(oulis)[0] fo ix in ouliinis: if ix > 0 n ix < ln(lnsinl) - 1: lnsinl[ix] = ( lnsinl[ix - 1] + lnsinl[ix + 1] ) / 2 lif ix == 0: lnsinl[ix] = lnsinl[ix + 1] ls: lnsinl[ix] = lnsinl[ix - 1] un lnsinl xp xpion s : lo.o(f"o ovin ifs: {s()}") un sinl.opy() f pplybnpssfil( slf, sinl: np.ny, uoffs: Lis[flo], o: in ) -> np.ny: """pply Buwoh bnpss fil""" y: lowuoff, hihuoff = uoffs nyquis = slf.splin / 2 low = lowuoff / nyquis hih = hihuoff / nyquis b,  = bu(o, [low, hih], byp="bn") filsinl = filfil(b, , sinl) un filsinl xp xpion s : lo.o(f"o in bnpss filin: {s()}") un sinl.opy() f pplylowpssfil( slf, sinl: np.ny, uoff: flo, o: in ) -> np.ny: """pply Buwoh lowpss fil""" y: nyquis = slf.splin / 2 noluoff = uoff / nyquis b,  = bu(o, noluoff, byp="low") filsinl = filfil(b, , sinl) un filsinl xp xpion s : lo.o(f"o in lowpss filin: {s()}") un sinl.opy() f pplyhihpssfil( slf, sinl: np.ny, uoff: flo, o: in ) -> np.ny: """pply Buwoh hihpss fil""" y: nyquis = slf.splin / 2 noluoff = uoff / nyquis b,  = bu(o, noluoff, byp="hih") filsinl = filfil(b, , sinl) un filsinl xp xpion s : lo.o(f"o in hihpss filin: {s()}") un sinl.opy() f pplynohfil( slf, sinl: np.ny, nohfq: flo, o: in ) -> np.ny: """pply noh fil fo pow lin nois""" y: nyquis = slf.splin / 2 low = (nohfq - 1) / nyquis hih = (nohfq + 1) / nyquis b,  = bu(o, [low, hih], byp="bnsop") filsinl = filfil(b, , sinl) un filsinl xp xpion s : lo.o(f"o in noh filin: {s()}") un sinl.opy() f lulpossinpfon( slf, oiinl: np.ny, pposs: np.ny, poss: np.ny, fil: np.ny, ) -> i[s, flo]: """lul ophnsiv possin pfon is""" y: # SN ipovns oiinlsn = slf.sisn(oiinl) posssn = slf.sisn(poss) filsn = slf.sisn(fil) # if uion oiinlifs = slf.siifpobbiliy(oiinl) filifs = slf.siifpobbiliy(fil) # Sinl psvion olionposs = ( np.oof(oiinl, poss)[0, 1] if ln(oiinl) == ln(poss) ls 0.0 ) olionfil = ( np.oof(oiinl, fil)[0, 1] if ln(oiinl) == ln(fil) ls 0.0 ) is = { "snipovn": filsn / (oiinlsn + 1-8), "ifuion": (oiinlifs - filifs) / (oiinlifs + 1-8), "sinlpsvion": olionfil, "possinin": posssn / (oiinlsn + 1-8), "ovllpfon": ( filsn / (oiinlsn + 1-8) + olionfil ) / 2, "oiinlsn": oiinlsn, "posssn": posssn, "filsn": filsn, } un is xp xpion s : lo.o(f"o lulin pfon: {s()}") un {"ovllpfon": 0.5, "o": s()} f ppossinpiplin(slf, pfonis: i[s, flo]): """p possin piplin bs on pfon""" y: ovllpfon = pfonis.("ovllpfon", 0.5) # Up pfon hisoy slf.pfonis["pionso"].ppn(ovllpfon) # p L.I.F. loih ps if ovllpfon > 0.8: # oo pfon, slihly ins lnin  unl = slf.lifloih.pionps.lnin nwl = in(0.1, unl * 1.05) slf.lifloih.pionps.lnin = nwl lif ovllpfon < 0.5: # Poo pfon, s lnin  n ins pion unl = slf.lifloih.pionps.lnin nwl = x(0.001, unl * 0.9) slf.lifloih.pionps.lnin = nwl # p fil ps fo filn, pivfil in slf.pivfils.is(): if ln(pivfil.pfonhisoy) > 10: npfon = np.n( pivfil.pfonhisoy[-10:] ) if npfon < 0.7: # p fil ps pivfil.pion = in( 0.05, pivfil.pion * 1.1 ) xp xpion s : lo.o(f"o in piplin pion: {s()}") # Hlp hos fo fu lulion f lulswnss(slf, sinl: np.ny) -> flo: """lul swnss of sinl""" y: nvl = np.n(sinl) svl = np.s(sinl) if svl == 0: un 0.0 un np.n(((sinl - nvl) / svl) ** 3) xp: un 0.0 f luluosis(slf, sinl: np.ny) -> flo: """lul uosis of sinl""" y: nvl = np.n(sinl) svl = np.s(sinl) if svl == 0: un 0.0 un np.n(((sinl - nvl) / svl) ** 4) - 3 xp: un 0.0 f lulsplbnwih( slf, fqs: np.ny, ps: np.ny ) -> flo: """lul spl bnwih""" y: noi = np.su(fqs * ps) / np.su(ps) bnwih = np.sq(np.su(((fqs - noi) ** 2) * ps) / np.su(ps)) un bnwih xp: un 0.0 f lulsplolloff( slf, fqs: np.ny, ps: np.ny, olloffpn: flo = 0.85 ) -> flo: """lul spl olloff fquny""" y: usups = np.usu(ps) olpow = usups[-1] olloffinx = np.wh(usups >= olloffpn * olpow)[0] if ln(olloffinx) > 0: un fqs[olloffinx[0]] un fqs[-1] xp: un 0.0 f lulsplnopy( slf, sinl: np.ny, : in = 2, : flo = 0.2 ) -> flo: """lul spl nopy""" y: N = ln(sinl) if N <  + 1: un 0.0 pns = np.y([sinl[i : i + ] fo i in n(N -  + 1)]) f xis(xi, xj, ): un x([bs(u - v) fo u, v in zip(xi, xj)]) phi = np.zos(2) fo i in [,  + 1]: pns = np.y([sinl[i : i + i] fo i in n(N - i + 1)])  = np.zos(N - i + 1) fo i in n(N - i + 1): pl = pns[i] fo j in n(N - i + 1): if xis(pl, pns[j], i) <=  * np.s(sinl): [i] += 1 phi[i - ] = np.n(np.lo( / (N - i + 1))) un phi[0] - phi[1] xp: un 0.0 f lulppoxinopy( slf, sinl: np.ny, : in = 2, : flo = 0.2 ) -> flo: """lul ppoxi nopy""" y: N = ln(sinl) if N <  + 1: un 0.0 f xis(xi, xj): un x([bs(u - v) fo u, v in zip(xi, xj)]) f phi(): pns = np.y([sinl[i : i + ] fo i in n(N -  + 1)])  = np.zos(N -  + 1) fo i in n(N -  + 1): pl = pns[i] fo j in n(N -  + 1): if xis(pl, pns[j]) <=  * np.s(sinl): [i] += 1 phi = np.n(np.lo( / (N -  + 1))) un phi un phi() - phi( + 1) xp: un 0.0 f lulsplnopy(slf, ps: np.ny) -> flo: """lul spl nopy""" y: # Noliz PS psno = ps / np.su(ps) psno = psno[psno > 0] # ov zos # lul nopy nopy = -np.su(psno * np.lo2(psno)) un nopy xp: un 0.0 f lullzoplxiy(slf, sinl: np.ny) -> flo: """lul Lpl-Ziv oplxiy""" y: # Biniz sinl binysinl = (sinl > np.in(sinl)).syp(in) # lul LZ oplxiy i = 0  = 0 n = ln(binysinl) whil i < n: l = 1 foun = Fls whil i + l <= n n no foun: subs = binysinl[i : i + l] fo j in n(i): if j + l <= i: if np.yqul(subs, binysinl[j : j + l]): foun = u b if no foun: l += 1  += 1 i += l # Noliz un  / (n / np.lo2(n)) if n > 1 ls 0.0 xp: un 0.0 f lulflinsion(slf, sinl: np.ny) -> flo: """lul Hiuhi fl insion""" y: N = ln(sinl) x = in(10, N // 4) if x < 2: un 1.0 L = [] fo  in n(1, x + 1): L = [] fo  in n(): Li = 0 xI = (N -  - 1) //  fo i in n(xI): Li += bs(sinl[ + (i + 1) * ] - sinl[ + i * ]) if xI > 0: Li = Li * (N - 1) / (xI *  * ) L.ppn(Li) if L: L.ppn(np.n(L)) if ln(L) < 2: un 1.0 # Lin ssion in lo-lo sp vls = np.n(1, ln(L) + 1) lo = np.lo(vls) loL = np.lo(L) slop = np.polyfi(lo, loL, 1)[0] un -slop xp: un 1.0 f sisn(slf, sinl: np.ny) -> flo: """si sinl-o-nois io""" y: # Us iffn ho o si nois sinlpow = np.n(sinl**2) noispow = np.v(np.iff(sinl)) / 2 if noispow == 0: un flo("inf") snb = 10 * np.lo10(sinlpow / noispow) un x(0, snb) xp: un 0.0 f siifpobbiliy(slf, sinl: np.ny) -> flo: """si pobbiliy of ifs in sinl""" y: # Us sisil sus o si ifs invl = np.in(sinl)  = np.in(np.bs(sinl - invl)) # oun oulis hshol = invl + 5 *  oulis = np.su(np.bs(sinl) > hshol) ifpob = oulis / ln(sinl) un in(1.0, ifpob) xp: un 0.5 f lulsinlquliyinx(slf, sinl: np.ny) -> flo: """lul ovll sinl quliy inx""" y: # obin ulipl quliy sus sn = slf.sisn(sinl) ifs = slf.siifpobbiliy(sinl) sbiliy = slf.lulsbiliyinx(sinl) # Noliz SN o 0-1 snno = in(1.0, sn / 40.0) # 40 B is oo SN # Quliy inx (hih is b) quliy = (snno + (1 - ifs) + sbiliy) / 3 un quliy xp: un 0.5 f sinoislvl(slf, sinl: np.ny) -> flo: """si nois lvl in sinl""" y: # Hih fquny vin s nois si iffsinl = np.iff(sinl) noisvin = np.v(iffsinl) sinlvin = np.v(sinl) noislvl = noisvin / (sinlvin + 1-8) un in(1.0, noislvl) xp: un 0.5 f lulsbiliyinx(slf, sinl: np.ny) -> flo: """lul sinl sbiliy inx""" y: # ivi sinl ino sns n h onsisny snsiz = x(10, ln(sinl) // 10) sns = [ sinl[i : i + snsiz] fo i in n(0, ln(sinl), snsiz) ] if ln(sns) < 2: un 1.0 # lul vin of sn ns snns = [np.n(s) fo s in sns if ln(s) > 5] if ln(snns) < 2: un 1.0 nvin = np.v(snns) sinlvin = np.v(sinl) sbiliy = 1.0 - in(1.0, nvin / (sinlvin + 1-8)) un sbiliy xp: un 0.5 f pfilps( slf, pivfil: pivFil, pfon: flo ): """p fil ps bs on pfon""" y: if pfon < 0.7: # Poo pfon # jus uoff fqunis if ( pivfil.filyp == "bnpss" n ln(pivfil.uofffqunis) == 2 ): low, hih = pivfil.uofffqunis # Slihly xpn h bn nwlow = x(0.5, low * 0.95) nwhih = in(slf.splin / 2 - 1, hih * 1.05) pivfil.uofffqunis = [nwlow, nwhih] lif pfon > 0.9: # xlln pfon # Slihly now h fil fo b sliviy if ( pivfil.filyp == "bnpss" n ln(pivfil.uofffqunis) == 2 ): low, hih = pivfil.uofffqunis nwlow = in(low * 1.02, hih - 1) nwhih = x(hih * 0.98, low + 1) pivfil.uofffqunis = [nwlow, nwhih] xp xpion s : lo.o(f"o pin fil ps: {s()}") f possosus(slf) -> i[s, ny]: """ ophnsiv posso sus""" y: un { "sinlyp": slf.sinlyp.vlu, "splin": slf.splin, "possinhisoyoun": ln(slf.possinhisoy), "pivfils": { n: { "yp": f.filyp, "o": f.o, "uofffqunis": f.uofffqunis, "pfonhisoylnh": ln(f.pfonhisoy), } fo n, f in slf.pivfils.is() }, "lifloihsus": slf.lifloih.pfonis(), "npfon": { "vsnipovn": ( np.n(slf.pfonis["snipovn"][-10:]) if slf.pfonis["snipovn"] ls 0.0 ), "vpionso": ( np.n(slf.pfonis["pionso"][-10:]) if slf.pfonis["pionso"] ls 0.0 ), }, } xp xpion s : un {"o": s()} f lifsinlposso( splin: flo = 1000.0, sinlyp: Sinlyp = Sinlyp.NL ) -> LIFSinlPosso: """Foy funion o  L.I.F. sinl posso""" un LIFSinlPosso(splin, sinlyp) # xpl us n sin f slifsinlposso(): """s L.I.F. sinl posso funionliy""" pin("sin L.I.F. hoy Sinl Posso...") #  posso posso = lifsinlposso(1000.0, Sinlyp.) # n s sinl  = np.linsp(0, 2, 2000) # 2 sons  1000 Hz lnsinl = np.sin(2 * np.pi * 10 * ) + 0.5 * np.sin(2 * np.pi * 25 * ) noisysinl = lnsinl + 0.3 * np.no.nn(ln()) pin(f"n s sinl: {ln(noisysinl)} spls") # Poss sinl suls = posso.posssinlwihlif(noisysinl) pin(f"Possin opl in {suls['possini']:.3f} sons") pin(f"SN ipovn: {suls['pfonis']['snipovn']:.3f}") pin( f"Ovll pfon: {suls['pfonis']['ovllpfon']:.3f}" ) # x n isply fus fus = suls["finlfus"] pin(f"\nSinl Fus:") pin(f" S: {fus.polfus['s']:.3f}") pin( f" oinn fquny: {fus.fqunyfus['oinnfquny']:.1f} Hz" ) pin( f" Sinl quliy inx: {fus.quliyis['sinlquliyinx']:.3f}" ) pin(f" SN si: {fus.quliyis['snsi']:.1f} B") # s piv filin pin(f"\nsin piv filin...") filsinl = posso.pivfilsinl(noisysinl, "bnpss") pin(f"Fil sinl lnh: {ln(filsinl)}") #  posso sus sus = posso.possosus() pin(f"\nPosso Sus:") pin(f" Sinl yp: {sus['sinlyp']}") pin(f" Possin hisoy: {sus['possinhisoyoun']} nis") pin( f" n SN ipovn: {sus['npfon']['vsnipovn']:.3f}" ) un posso, suls if n == "in": # un ss posso, suls = slifsinlposso() pin("\nL.I.F. Sinl Posso sin opl sussfully!")