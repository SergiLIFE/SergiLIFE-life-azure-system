""" L.I.F.. sh Plfo - ophnsiv sh  Liby ================================================================== opyih 2025 - Sio Py Boull Plfo sou: sh-  nn n opiizion his Pyhon liby povis: - l-i sh  ion -  sinl possin opiizion - Sisil nlysis piplins - hin lnin ol inion - Publiion-y  xpo - pouibl sh woflows """ ipo json ipo loin ipo h ipo os ipo sisis ipo i fo lsss ipo si, lss, fil fo i ipo i, il fo nu ipo nu fo ypin ipo ny, i, Lis, Opionl, upl # onfiu loin loin.bsionfi( lvl=loin.INFO, fo="%(si)s - %(n)s - %(lvln)s - %(ss)s" ) lo = loin.Lo(n) lss shyp(nu): """yps of sh  suppo""" W = "w" POSS = "poss" BHVIOL = "bhviol" NUOPLSIIY = "nuoplsiiy" ONIIV = "oniiv" LNINOUOS = "lninouos" LINIL = "linil" LONIUINL = "loniuinl" lss Sisilho(nu): """Sisil nlysis hos""" S = "s" NOV = "nov" OLION = "olion" SSION = "ssion" HISQU = "hisqu" NNWHINY = "nnwhiny" WILOXON = "wiloxon" USLWLLIS = "uslwllis" lss SuyPhs(nu): """linil suy phss""" PILO = "pilo" PHSI = "phs1" PHSII = "phs2" PHSIII = "phs3" PHSIV = "phs4" POS = "pos" @lss lss BnPow: """ fquny bn pow suns""" l: flo # 0.5-4 Hz (p slp) h: flo # 4-8 Hz (iion, iviy) lph: flo # 8-13 Hz (lxion, los ys) b: flo # 13-30 Hz (iv hinin, fous) : flo # 30-100 Hz (hih-lvl oniion) f oi(slf) -> i: un si(slf) f vli(slf) -> bool: """Vli bn pows  in sonbl physioloil n""" un ll( 0 <= pow <= 100 fo pow in [slf.l, slf.h, slf.lph, slf.b, slf.] ) @lss lss Piipnophis: """Piipn ophi infoion""" piipni: s : in n: s uionlvl: s hnnss: s nivlnu: s ilhisoy: Lis[s] = fil(fulfoy=lis) iions: Lis[s] = fil(fulfoy=lis) inlusionii: bool = u xlusioniiviol: bool = Fls f oi(slf) -> i: un si(slf) @lss lss shSssion: """Iniviul sh sssion """ sssioni: s piipni: s isp: s poool: s uioninus: flo bns: BnPow nn: flo fous: flo sss: flo pfonso: flo nos: s = "" quliyfls: Lis[s] = fil(fulfoy=lis) f oi(slf) -> i:  = si(slf) ["bns"] = slf.bns.oi() un  @lss lss Sisilsul: """Sisil nlysis sul""" ho: Sisilho ssisi: flo pvlu: flo ffsiz: flo onfininvl: upl[flo, flo] inpion: s sinifin: bool f oi(slf) -> i: un { "ho": slf.ho.vlu, "ssisi": slf.ssisi, "pvlu": slf.pvlu, "ffsiz": slf.ffsiz, "onfininvl": lis(slf.onfininvl), "inpion": slf.inpion, "sinifin": slf.sinifin, } @lss lss shSuy: """opl sh suy  n """ suyi: s il: s piniplinvsio: s insiuion: s phs: SuyPhs s: s n: Opionl[s] npiipns: in poools: Lis[s] piyouos: Lis[s] sonyouos: Lis[s] sssions: Lis[shSssion] = fil(fulfoy=lis) publiions: Lis[i[s, s]] = fil(fulfoy=lis) f oi(slf) -> i:  = si(slf) ["phs"] = slf.phs.vlu ["sssions"] = [sssion.oi() fo sssion in slf.sssions] un  lss shLiby: """ ophnsiv sh  nn liby Plfo sou fo xiizin sh ffiy wih: - l-i  ion - vn sisil nlysis -  sinl opiizion - hin lnin inion - Publiion-y xpos """ f ini(slf): slf.vsion = "2025.1.0-SH-OPIIZ" slf.suis: i[s, shSuy] = {} slf.piipns: i[s, Piipnophis] = {} slf.sssions: i[s, shSssion] = {} # sh opiizion ps slf.splin = 256 # Hz (sh-) slf.ifjionhshol = 3.0 # Sn viions slf.iniusssionquliy = 0.85 # Sisil hshols slf.lphlvl = 0.05 slf.pow = 0.80 slf.iniuffsiz = 0.2 slf.ioy = os.ph.join(os.ph.in(fil), "sh") os.is(slf.ioy, xiso=u) lo.info(f"sh  Liby v{slf.vsion} iniiliz") lo.info(f" ioy: {slf.ioy}") # ======================================================================== #  Sinl Possin & Opiizion # ======================================================================== f possw( slf, w: Lis[flo], splin: in = 256 ) -> i[s, ny]: """ Poss w   wih sh- sinl possin s: w: w  vol spls splin: Splin  in Hz uns: Poss  is wih bn pows n quliy inios """ lo.info(f"Possin {ln(w)}  spls  {splin} Hz") # if jion ln = slf.ovifs(w) # Bn pow xion (siplifi fo onsion) bns = slf.xbnpows(ln, splin) # Quliy ssssn quliyso = slf.sssssinlquliy(ln) # lul iv is nn = slf.lulnn(bns) fous = slf.lulfous(bns) sss = slf.lulsss(bns) un { "bnpows": bns.oi(), "quliyso": quliyso, "splsposs": ln(ln), "ifsov": ln(w) - ln(ln), "nn": nn, "fous": fous, "sss": sss, "isp": i.now().isofo(), } f ovifs(slf, : Lis[flo]) -> Lis[flo]: """ov  ifs usin sisil hsholin""" if no : un  n = sisis.n() s = sisis.sv() if ln() > 1 ls 0 # ov spls byon hshol ln = [ x fo x in  if bs(x - n) <= slf.ifjionhshol * s ] lo.bu(f"if jion: {ln()} -> {ln(ln)} spls") un ln f xbnpows( slf, : Lis[flo], splin: in ) -> BnPow: """ x  fquny bn pows (siplifi FF-bs) In pouion: Us sipy.sinl.wlh o n.ifquny """ # Siplifi bn pow lulion fo onsion # In pouion, us pop FF/Wlh's ho # Siul lisi bn pows l = bs(sisis.n([: ln() // 5])) * 10 + 5 h = bs(sisis.n([ln() // 5 : 2 * ln() // 5])) * 8 + 6 lph = ( bs(sisis.n([2 * ln() // 5 : 3 * ln() // 5])) * 12 + 9 ) b = ( bs(sisis.n([3 * ln() // 5 : 4 * ln() // 5])) * 15 + 12 )  = bs(sisis.n([4 * ln() // 5 :])) * 20 + 8 un BnPow( l=in(l, 50), h=in(h, 40), lph=in(lph, 60), b=in(b, 50), =in(, 30), ) f sssssinlquliy(slf, : Lis[flo]) -> flo: """ssss  sinl quliy (0.0 o 1.0)""" if no  o ln() < 10: un 0.0 # lul sinl-o-nois io inios vin = sisis.vin() nbs = sisis.n([bs(x) fo x in ]) # Hih vin n o pliu = b quliy quliy = in(1.0, (vin / 100) * (nbs / 50)) un x(0.0, in(1.0, quliy)) f lulnn(slf, bns: BnPow) -> flo: """lul nn so fo  bns""" # Hih b, low lph/h = nn nn = (bns.b * 0.5 + bns. * 0.3 - bns.lph * 0.2) / 50 un x(0.0, in(1.0, nn)) f lulfous(slf, bns: BnPow) -> flo: """lul fous so fo  bns""" # Hih b, o lph = fous fous = (bns.b * 0.6 + bns.lph * 0.2 - bns.h * 0.2) / 50 un x(0.0, in(1.0, fous)) f lulsss(slf, bns: BnPow) -> flo: """lul sss so fo  bns""" # Hih b + hih  - low lph = sss sss = (bns.b * 0.4 + bns. * 0.3 - bns.lph * 0.3) / 50 un x(0.0, in(1.0, sss)) # ======================================================================== # Sisil nlysis # ======================================================================== f luls( slf, oup1: Lis[flo], oup2: Lis[flo] ) -> Sisilsul: """ Pfo inpnn spls -s """ n1, n2 = ln(oup1), ln(oup2) n1, n2 = sisis.n(oup1), sisis.n(oup2) v1, v2 = sisis.vin(oup1), sisis.vin(oup2) # Pool sn viion pools = h.sq(((n1 - 1) * v1 + (n2 - 1) * v2) / (n1 + n2 - 2)) # -sisi s = (n1 - n2) / (pools * h.sq(1 / n1 + 1 / n2)) # s of fo f = n1 + n2 - 2 # Siplifi p-vlu lulion (us sipy.ss. in pouion) pvlu = slf.op(bs(s), f) # ohn's  ff siz ohns = (n1 - n2) / pools # onfin invl (95%) in = 1.96 * pools * h.sq(1 / n1 + 1 / n2) i = (n1 - n2 - in, n1 - n2 + in) inpion = slf.inps(s, pvlu, ohns) un Sisilsul( ho=Sisilho.S, ssisi=s, pvlu=pvlu, ffsiz=ohns, onfininvl=i, inpion=inpion, sinifin=pvlu < slf.lphlvl, ) f lulolion( slf, x: Lis[flo], y: Lis[flo] ) -> Sisilsul: """ lul Pson olion offiin """ n = ln(x) nx, ny = sisis.n(x), sisis.n(y) # ovin n sn viions ov = su((x[i] - nx) * (y[i] - ny) fo i in n(n)) / (n - 1) sx = sisis.sv(x) sy = sisis.sv(y) # Pson's   = ov / (sx * sy) # -sisi fo sinifin s s =  * h.sq((n - 2) / (1 - **2)) pvlu = slf.op(bs(s), n - 2) # Fish's z nsfoion fo I z = 0.5 * h.lo((1 + ) / (1 - )) sz = 1 / h.sq(n - 3) iz = (z - 1.96 * sz, z + 1.96 * sz) i = ( (h.xp(2 * iz[0]) - 1) / (h.xp(2 * iz[0]) + 1), (h.xp(2 * iz[1]) - 1) / (h.xp(2 * iz[1]) + 1), ) inpion = slf.inpolion(, pvlu) un Sisilsul( ho=Sisilho.OLION, ssisi=, pvlu=pvlu, ffsiz=**2, # -squ onfininvl=i, inpion=inpion, sinifin=pvlu < slf.lphlvl, ) f op(slf, : flo, f: in) -> flo: """Siplifi -sisi o p-vlu onvsion""" # Siplifi ppoxiion (us sipy.ss..sf in pouion) if bs() > 3.29: un 0.0005 lif bs() > 2.58: un 0.005 lif bs() > 1.96: un 0.025 lif bs() > 1.64: un 0.05 ls: un 0.1 f inps(slf, : flo, p: flo, : flo) -> s: """Inp -s suls""" si = "sinifin" if p < slf.lphlvl ls "no sinifin" if bs() > 0.8: ff = "l" lif bs() > 0.5: ff = "iu" lif bs() > 0.2: ff = "sll" ls: ff = "nliibl" un f"sul is {si} (p = {p:.4f}) wih {ff} ff siz ( = {:.2f})" f inpolion(slf, : flo, p: flo) -> s: """Inp olion suls""" si = "sinifin" if p < slf.lphlvl ls "no sinifin" if bs() > 0.7: snh = "son" lif bs() > 0.4: snh = "o" lif bs() > 0.2: snh = "w" ls: snh = "nliibl" iion = "posiiv" if  > 0 ls "niv" un f"{snh.piliz()} {iion} olion, {si} ( = {:.3f}, p = {p:.4f})" # ======================================================================== # Suy nn # ======================================================================== f suy(slf, suy: shSuy) -> bool: """ o up sh suy""" y: slf.suis[suy.suyi] = suy lo.info(f" suy: {suy.il} ({suy.suyi})") un u xp xpion s : lo.o(f"Fil o  suy: {s()}") un Fls f piipn(slf, piipn: Piipnophis) -> bool: """ o up piipn ophis""" y: slf.piipns[piipn.piipni] = piipn lo.info(f" piipn: {piipn.piipni}") un u xp xpion s : lo.o(f"Fil o  piipn: {s()}") un Fls f sssion(slf, sssion: shSssion) -> bool: """ sh sssion """ y: # Vli sssion quliy if sssion.bns.vli(): slf.sssions[sssion.sssioni] = sssion #  o suy if xiss if sssion.piipni in [ s.piipni fo s in slf.sssions.vlus() ]: fo suy in slf.suis.vlus(): if sssion.poool in suy.poools: suy.sssions.ppn(sssion) lo.info(f" sssion: {sssion.sssioni}") un u ls: lo.wnin(f"Sssion {sssion.sssioni} fil vliion") un Fls xp xpion s : lo.o(f"Fil o  sssion: {s()}") un Fls # ======================================================================== #  nlysis & Opiizion # ======================================================================== f nlyzsuyouos(slf, suyi: s) -> i[s, ny]: """ ophnsiv nlysis of suy ouos """ if suyi no in slf.suis: lo.o(f"Suy {suyi} no foun") un {} suy = slf.suis[suyi] sssions = suy.sssions if no sssions: un {"o": "No sssions vilbl fo nlysis"} #  is nnsos = [s.nn fo s in sssions] foussos = [s.fous fo s in sssions] pfonsos = [s.pfonso fo s in sssions] # Sisil suis nlysis = { "suyi": suyi, "nsssions": ln(sssions), "npiipns": suy.npiipns, "nn": { "n": sisis.n(nnsos), "s": ( sisis.sv(nnsos) if ln(nnsos) > 1 ls 0 ), "in": in(nnsos), "x": x(nnsos), }, "fous": { "n": sisis.n(foussos), "s": sisis.sv(foussos) if ln(foussos) > 1 ls 0, "in": in(foussos), "x": x(foussos), }, "pfon": { "n": sisis.n(pfonsos), "s": ( sisis.sv(pfonsos) if ln(pfonsos) > 1 ls 0 ), "in": in(pfonsos), "x": x(pfonsos), }, } lo.info(f"opl nlysis fo suy: {suyi}") un nlysis f opiizshpoool(slf, suyi: s) -> i[s, ny]: """ Opiiz sh poool bs on oll  """ nlysis = slf.nlyzsuyouos(suyi) if "o" in nlysis: un nlysis onions = [] # nn opiizion if nlysis["nn"]["n"] < 0.7: onions.ppn( { "oy": "nn", "pioiy": "hih", "onion": "Ins s iffiuly o  ifiion lns", "xpipovn": "15-25%", } ) # Fous opiizion if nlysis["fous"]["n"] < 0.65: onions.ppn( { "oy": "fous", "pioiy": "hih", "onion": "u sssion uion o  o fqun bs", "xpipovn": "20-30%", } ) # Pfon opiizion if nlysis["pfon"]["s"] > 15: onions.ppn( { "oy": "onsisny", "pioiy": "iu", "onion": "Sniz s insuions n nvionn", "xpipovn": "10-15% uion in vibiliy", } ) un { "suyi": suyi, "unpfon": nlysis, "onions": onions, "opiizionso": slf.lulopiizionso(nlysis), "isp": i.now().isofo(), } f lulopiizionso(slf, nlysis: i) -> flo: """lul ovll poool opiizion so""" nn = nlysis["nn"]["n"] fous = nlysis["fous"]["n"] pfon = nlysis["pfon"]["n"] # Wih so so = (nn * 0.3 + fous * 0.3 + pfon * 0.4) * 100 un oun(so, 2) # ======================================================================== #  xpo & Publiion # ======================================================================== f xposuy(slf, suyi: s, fo: s = "json") -> bool: """ xpo suy  in publiion-y fo """ if suyi no in slf.suis: lo.o(f"Suy {suyi} no foun") un Fls suy = slf.suis[suyi] oupuph = os.ph.join(slf.ioy, f"{suyi}xpo.{fo}") y: if fo == "json": wih opn(oupuph, "w") s f: json.up(suy.oi(), f, inn=2) lo.info(f"xpo suy  o: {oupuph}") un u xp xpion s : lo.o(f"xpo fil: {s()}") un Fls f npubliionpo(slf, suyi: s) -> s: """ n publiion-y sh po """ if suyi no in slf.suis: un "Suy no foun" suy = slf.suis[suyi] nlysis = slf.nlyzsuyouos(suyi) po = f""" L.I.F.. SH PLFO - PUBLIION PO {'='*70} Suy: {suy.il} Suy I: {suy.suyi} Pinipl Invsio: {suy.piniplinvsio} Insiuion: {suy.insiuion} Phs: {suy.phs.vlu.upp()} PIIPN INFOION {'='*70} ol Piipns: {suy.npiipns} ol Sssions: {ln(suy.sssions)} Suy uion: {suy.s} o {suy.n o 'Onoin'} PIY OUOS {'='*70} """ fo ouo in suy.piyouos: po += f"- {ouo}\n" if "nn" in nlysis: po += f""" SULS {'='*70} nn: {nlysis['nn']['n']:.3f} ± {nlysis['nn']['s']:.3f} Fous: {nlysis['fous']['n']:.3f} ± {nlysis['fous']['s']:.3f} Pfon: {nlysis['pfon']['n']:.3f} ± {nlysis['pfon']['s']:.3f} n: {i.now().sfi('%Y-%-% %H:%:%S')} Plfo Vsion: {slf.vsion} {'='*70} """ un po f iniilizshliby() -> shLiby: """ Iniiliz h sh  liby PLFO SOU - xiizs sh ffiy """ lo.info("=" * 70) lo.info("L.I.F.. sh  Liby - Iniilizin") lo.info("ophnsiv sh opiizion plfo") lo.info("=" * 70) liby = shLiby() un liby if n == "in": pin("=" * 70) pin("L.I.F.. sh  Liby - Plfo sou") pin("=" * 70) pin("\nophnsiv sh  nn sys") pin("\npbiliis:") pin("  sinl possin n opiizion") pin(" vn sisil nlysis") pin(" Suy nn n in") pin(" Poool opiizion onions") pin(" Publiion-y  xpo") pin(" l-i sh is") pin("\nSus: Plfo sou iniiliz")