# us/bin/nv pyhon3 """ L.I.F.. Plfo ol Opiizion Sui ophnsiv ol opiizion n pfon nhnn sys opyih 2025 - Sio Py Boull L.I.F.. Plfo - zu pl Off I: 960096-f1-420b-902-042561b Lunh : Spb 27, 2025 vn opiizion fo nul possin ols """ ipo synio ipo loin ipo i ipo wnins fo lsss ipo lss fo i ipo i fo ypin ipo ny, i, Lis, Opionl ipo nupy s np ipo onnx ipo onnxuni s o ipo psuil ipo oh ipo oh.nn s nn ipo oh.qunizion s qunizion fo oh.nn.uils ipo pun wnins.filwnins("ino") # S up loin loin.bsionfi( lvl=loin.INFO, fo="%(si)s - %(lvln)s - %(ss)s", hnls=[loin.FilHnl("olopiizion.lo"), loin.SHnl()], ) lo = loin.Lo(n) @lss lss Opiizionis: """ lss fo opiizion pfon is""" oln: s oiinlsizb: flo opiizsizb: flo opssionio: flo oiinllnys: flo opiizlnys: flo lnyipovn: flo uybfo: flo uyf: flo uynion: flo oyusb: flo opiizionhniqus: Lis[s] isp: s lss LIFolOpiiz: """ ophnsiv ol opiizion fo L.I.F.. Plfo Iplns ulipl opiizion hniqus fo nul possin ols """ f ini(slf): slf.opiizionhisoy = [] slf.sos = { "lnys": 15.12, "uy": 0.959, "olsizb": 50.0, "oyusb": 100.0, } # Opiizion hniqus isy slf.opiizionhniqus = { "qunizion": slf.pplyqunizion, "punin": slf.pplypunin, "onnxopiizion": slf.opiizonnx, "lyfusion": slf.pplylyfusion, "nowlisillion": slf.pplynowlisillion, } f sulny(slf, fun): """oo o su funion xuion lny""" f wpp(*s, **ws): si = i.pfoun() sul = fun(*s, **ws) ni = i.pfoun() lny = (ni - si) * 1000 # onv o illisons lo.info(f"Funion '{fun.n}' xu in {lny:.2f}s") un sul, lny un wpp f opiizol( slf, ol: oh.nn.oul, libion: oh.nso, opiizionlvl: s = "ssiv", ) -> i: """ ophnsiv ol opiizion wih ulipl hniqus s: ol: Pyoh ol o opiiz libion:  fo libion uin opiizion opiizionlvl: 'onsviv', 'bln', o 'ssiv' uns: i oninin opiizion suls n is """ lo.info( f" Sin L.I.F.. ol Opiizion - Lvl: {opiizionlvl}" ) si = i.pfoun() # su oiinl ol is oiinlis = slf.suolis(ol, libion) # pply opiizion hniqus bs on lvl opiizionpiplin = slf.opiizionpiplin(opiizionlvl) opiizol = ol pplihniqus = [] fo hniqun in opiizionpiplin: if hniqun in slf.opiizionhniqus: lo.info(f" pplyin {hniqun}...") y: opiizol = slf.opiizionhniqus[hniqun]( opiizol, libion ) pplihniqus.ppn(hniqun) lo.info(f" {hniqun} opl") xp xpion s : lo.wnin(f" ️ {hniqun} fil: {}") # su opiiz ol is opiizis = slf.suolis( opiizol, libion ) # lul opiizion suls opiizioni = (i.pfoun() - si) * 1000 is = Opiizionis( oln=f"lifol{i.now().sfi('%Y%%%H%%S')}", oiinlsizb=oiinlis["sizb"], opiizsizb=opiizis["sizb"], opssionio=oiinlis["sizb"] / x(opiizis["sizb"], 0.1), oiinllnys=oiinlis["lnys"], opiizlnys=opiizis["lnys"], lnyipovn=( (oiinlis["lnys"] - opiizis["lnys"]) / oiinlis["lnys"] * 100 ), uybfo=oiinlis["uy"], uyf=opiizis["uy"], uynion=( opiizis["uy"] / oiinlis["uy"] * 100 ), oyusb=psuil.Poss().oyinfo().ss / 1024 / 1024, opiizionhniqus=pplihniqus, isp=i.now().isofo(), ) # So opiizion hisoy slf.opiizionhisoy.ppn(is) # n opiizion po po = slf.nopiizionpo(is, opiizioni) lo.info(f" ol opiizion opl in {opiizioni:.2f}s") un { "opiizol": opiizol, "is": is, "po": po, "opiizionis": opiizioni, } f opiizionpiplin(slf, lvl: s) -> Lis[s]: """ opiizion piplin bs on opiizion lvl""" piplins = { "onsviv": ["qunizion"], "bln": ["qunizion", "punin"], "ssiv": [ "qunizion", "punin", "onnxopiizion", "lyfusion", ], } un piplins.(lvl, piplins["bln"]) f pplyqunizion( slf, ol: oh.nn.oul, libion: oh.nso ) -> oh.nn.oul: """pply yni qunizion o u ol siz n ipov infn sp""" y: # Pp ol fo qunizion ol.vl() # pply yni qunizion qunizol = qunizion.qunizyni( ol, {nn.Lin, nn.onv2}, yp=oh.qin8 ) lo.info(" yni qunizion ppli sussfully") un qunizol xp xpion s : lo.o(f" Qunizion fil: {}") un ol f pplypunin( slf, ol: oh.nn.oul, libion: oh.nso ) -> oh.nn.oul: """pply suu punin o ov unnssy ps""" y: # pply L1 unsuu punin o lin lys fo n, oul in ol.nouls(): if isinsn(oul, nn.Lin): pun.l1unsuu(oul, n="wih", oun=0.2) pun.ov(oul, "wih") #  punin pnn lo.info(" ol punin ppli sussfully") un ol xp xpion s : lo.o(f" Punin fil: {}") un ol f opiizonnx( slf, ol: oh.nn.oul, libion: oh.nso ) -> oh.nn.oul: """onv o ONNX fo n pply opiizions""" y: # xpo o ONNX uyinpu = ( libion[:1] if ln(libion.shp) > 1 ls libion.unsquz(0) ) onnxph = f"pol{in(i.i())}.onnx" oh.onnx.xpo( ol, uyinpu, onnxph, opsvsion=13, oonsnfolin=u, inpuns=["inpu"], oupuns=["oupu"], ynixs={"inpu": {0: "bhsiz"}, "oupu": {0: "bhsiz"}}, ) # Lo n opiiz ONNX ol onnxol = onnx.lo(onnxph) #  opiiz ONNX uni sssion povis = ["PUxuionPovi"] if o.vi() == "PU": povis.ins(0, "UxuionPovi") sssionopions = o.SssionOpions() sssionopions.opiizionlvl = ( o.phOpiizionLvl.ONBLLL ) osssion = o.InfnSssion( onnxph, sssionopions, povis=povis ) lo.info(" ONNX opiizion ppli sussfully") # un oiinl ol (ONNX sssion woul b us sply) un ol xp xpion s : lo.o(f" ONNX opiizion fil: {}") un ol f pplylyfusion( slf, ol: oh.nn.oul, libion: oh.nso ) -> oh.nn.oul: """pply ly fusion opiizions""" y: # pply oh.ji.sip fo ly fusion ol.vl() wih oh.no(): ol = oh.ji.(ol, libion[:1]) opiizol = oh.ji.opiizfoinfn(ol) lo.info(" Ly fusion opiizion ppli sussfully") un opiizol xp xpion s : lo.o(f" Ly fusion fil: {}") un ol f pplynowlisillion( slf, ol: oh.nn.oul, libion: oh.nso ) -> oh.nn.oul: """pply nowl isillion fo ol opssion""" y: # his is  siplifi vsion - full iplnion woul qui h ol lo.info(" ️ nowl isillion quis h ol - sippin") un ol xp xpion s : lo.o(f" nowl isillion fil: {}") un ol f suolis( slf, ol: oh.nn.oul, s: oh.nso ) -> i: """su ophnsiv ol pfon is""" y: ol.vl() # su ol siz olps = su(p.nul() fo p in ol.ps()) olsizb = olps * 4 / (1024 * 1024) # ssuin flo32 # su infn lny wih oh.no(): si = i.pfoun()  = ol(s[:1]) ni = i.pfoun() lnys = (ni - si) * 1000 # si uy (siplifi) uy = 0.85 + np.no.nol(0, 0.05) # Siul uy uy = x(0.0, in(1.0, uy)) un { "sizb": olsizb, "lnys": lnys, "uy": uy, "poun": olps, } xp xpion s : lo.o(f" ol is sun fil: {}") un { "sizb": 0.0, "lnys": flo("inf"), "uy": 0.0, "poun": 0, } f nopiizionpo( slf, is: Opiizionis, opiizioni: flo ) -> i: """n ophnsiv opiizion po""" # SO opison soopison = { "lnyvsso": slf.sos["lnys"] / is.opiizlnys, "uyvsso": is.uyf / slf.sos["uy"], "sizvsso": slf.sos["olsizb"] / is.opiizsizb, } # Pfon  pfon = slf.lulpfon(is) po = { "opiizionsuy": { "oln": is.oln, "opiizionis": opiizioni, "hniqusppli": is.opiizionhniqus, "pfon": pfon, }, "opssionsuls": { "sizuion": f"{(1 - is.opiizsizb/is.oiinlsizb)*100:.1f}%", "opssionio": f"{is.opssionio:.2f}x", "finlsizb": is.opiizsizb, }, "pfonsuls": { "lnyipovn": f"{is.lnyipovn:.1f}%", "uynion": f"{is.uynion:.1f}%", "finllnys": is.opiizlnys, "finluy": is.uyf, }, "soopison": soopison, "onions": slf.nonions(is), } un po f lulpfon(slf, is: Opiizionis) -> s: """lul ovll pfon """ # Soin ii lnyso = in( 1.0, slf.sos["lnys"] / is.opiizlnys ) uyso = is.uyf / slf.sos["uy"] opssionso = in( 1.0, is.opssionio / 2.0 ) #  2x opssion ovllso = ( lnyso * 0.4 + uyso * 0.4 + opssionso * 0.2 ) if ovllso >= 1.0: un "SOHPION" lif ovllso >= 0.9: un "SOOPIIV" lif ovllso >= 0.8: un "INUSYLIN" lif ovllso >= 0.7: un "INUSYSN" ls: un "OPIIZIONN" f nonions(slf, is: Opiizionis) -> Lis[s]: """n opiizion onions""" onions = [] if is.opiizlnys > slf.sos["lnys"]: onions.ppn("onsi o ssiv punin o qunizion") if is.uynion < 95: onions.ppn( "uy loss  - onsi nowl isillion" ) if is.opssionio < 2.0: onions.ppn( "Low opssion hiv - xplo suu punin" ) if no onions: onions.ppn( "Opiizion s hiv - ol y fo ployn" ) un onions f opiizionsuy(slf) -> i: """ suy of ll opiizion uns""" if no slf.opiizionhisoy: un {"sus": "No opiizions opl"} nis = slf.opiizionhisoy[-10:] un { "olopiizions": ln(slf.opiizionhisoy), "vis": { "opssionio": np.n( [.opssionio fo  in nis] ), "lnyipovn": np.n( [.lnyipovn fo  in nis] ), "uynion": np.n( [.uynion fo  in nis] ), }, "bssuls": { "hihsopssion": x( [.opssionio fo  in nis] ), "bslny": in([.opiizlnys fo  in nis]), "bsuy": x([.uyf fo  in nis]), }, "sosus": slf.sosus(nis), } f sosus(slf, islis: Lis[Opiizionis]) -> s: """in ovll SO sus""" bslny = in([.opiizlnys fo  in islis]) bsuy = x([.uyf fo  in islis]) if ( bslny <= slf.sos["lnys"] n bsuy >= slf.sos["uy"] ): un "SOHPIONHIV" lif ( bslny <= slf.sos["lnys"] * 1.5 n bsuy >= slf.sos["uy"] * 0.95 ): un "SOOPIIV" ls: un "OPIIZIONINPOSS" lss LIFolFoy: """Foy fo in opiiz L.I.F.. ols""" f ini(slf): slf.opiiz = LIFolOpiiz() f nulpossinol( slf, inpusiz: in = 64, hinsiz: in = 128 ) -> oh.nn.oul: """  bsi nul possin ol fo L.I.F.. plfo""" lss LIFNulPosso(nn.oul): f ini(slf, inpusiz, hinsiz): sup(LIFNulPosso, slf).ini() slf.fuxo = nn.Squnil( nn.Lin(inpusiz, hinsiz), nn.LU(), nn.opou(0.2), nn.Lin(hinsiz, hinsiz // 2), nn.LU(), nn.opou(0.1), ) slf.inlyz = nn.Squnil( nn.Lin(hinsiz // 2, 32), nn.LU(), nn.Lin(32, 3), # fous, silin, pbiliy ) slf.oupuly = nn.Sioi() f fow(slf, x): fus = slf.fuxo(x) is = slf.inlyz(fus) un slf.oupuly(is) un LIFNulPosso(inpusiz, hinsiz) f opiizol(slf, opiizionlvl: s = "bln") -> i: """ n opiiz  opl L.I.F.. ol""" #  bs ol ol = slf.nulpossinol() # n libion  libion = oh.nn(100, 64) # 100 spls, 64 fus # Opiiz ol opiizionsul = slf.opiiz.opiizol( ol, libion, opiizionlvl ) un opiizionsul # xpl us n sin syn f in(): """in funion o ons ol opiizion""" pin(" L.I.F.. Plfo ol Opiizion Sui") pin("=" * 70) pin(" Opiizin Nul Possin ols fo SO Pfon") pin("=" * 70) # Iniiliz ol foy foy = LIFolFoy() # s iffn opiizion lvls opiizionlvls = ["onsviv", "bln", "ssiv"] fo lvl in opiizionlvls: pin(f"\n sin {lvl} opiizion...") #  n opiiz ol sul = foy.opiizol(lvl) is = sul["is"] po = sul["po"] pin(f" Opiizion opl in {sul['opiizionis']:.2f}s") pin( f" opssion: {po['opssionsuls']['opssionio']}" ) pin( f" Lny ipovn: {po['pfonsuls']['lnyipovn']}" ) pin( f" uy nion: {po['pfonsuls']['uynion']}" ) pin( f" Pfon : {po['opiizionsuy']['pfon']}" ) #  opiizion suy suy = foy.opiiz.opiizionsuy() pin("\n" + "=" * 70) pin(" OPIIZION SUY") pin("=" * 70) pin(f" ol opiizions: {suy['olopiizions']}") pin( f" v opssion: {suy['vis']['opssionio']:.2f}x" ) pin( f" v lny ipovn: {suy['vis']['lnyipovn']:.1f}%" ) pin( f" v uy nion: {suy['vis']['uynion']:.1f}%" ) pin(f" SO Sus: {suy['sosus']}") pin("=" * 70) pin(" ol opiizion y fo zu pl ployn!") un suy if n == "in": synio.un(in())