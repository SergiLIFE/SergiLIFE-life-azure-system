# us/bin/nv pyhon3 """ Vnui Bhin Sys - yni Bh Siz Opiizion L.I.F.. Plfo Vnui-inspi bh opiizion fo nul possin opyih 2025 - Sio Py Boull L.I.F.. Plfo - zu pl Off I: 960096-f1-420b-902-042561b """ ipo synio ipo loin ipo sisis # Us buil-in sisis ins of nupy ipo i fo lsss ipo lss fo ypin ipo ny, i, Lis, Opionl # ipo nupy s np # poily on ou u o sp onsins lo = loin.Lo(n) @lss lss Bhis: """is fo bh possin pfon""" bhsiz: in possini: flo houhpu: flo oyus: flo uy: flo isp: flo lss VnuiBh: """ Vnui-inspi yni bh sizin sys Opiizs bh sizs bs on sys lo n pfon is """ f ini( slf, inbhsiz: in = 1, xbhsiz: in = 512, lny: flo = 0.1, pion: flo = 0.1, ): slf.inbhsiz = inbhsiz slf.xbhsiz = xbhsiz slf.lny = lny slf.pion = pion slf.unbhsiz = 32 # Sin bh siz slf.ishisoy: Lis[Bhis] = [] slf.pfonwinow = 10 # ollin winow fo is lo.info( f"VnuiBh iniiliz: bhsiz={slf.unbhsiz}, " f"lny={lny}s" ) f opiizbhsiz(slf, unis: Bhis) -> in: """ Opiiz bh siz usin Vnui pinipls Bs on flui ynis: onsiion fo n flow lion """ slf.ishisoy.ppn(unis) # p only n is if ln(slf.ishisoy) > slf.pfonwinow: slf.ishisoy.pop(0) if ln(slf.ishisoy) < 3: un slf.unbhsiz # lul pfon ns nis = slf.ishisoy[-3:] vlny = su(.possini fo  in nis) / ln( nis ) vhouhpu = su(.houhpu fo  in nis) / ln(nis) # Vnui opiizion loi lnyio = vlny / slf.lny if lnyio > 1.2: # oo slow, u bh siz onsiionfo = 0.8 lif lnyio < 0.8: # Fs nouh, n ins bh siz onsiionfo = 1.1 ls: # Opil n onsiionfo = 1.0 # lul nw bh siz nwbhsiz = in(slf.unbhsiz * onsiionfo) # pply bouns nwbhsiz = x( slf.inbhsiz, in(slf.xbhsiz, nwbhsiz) ) # Sooh nsiions (on' hn oo silly) xhn = in(slf.unbhsiz * 0.3) if bs(nwbhsiz - slf.unbhsiz) > xhn: if nwbhsiz > slf.unbhsiz: nwbhsiz = slf.unbhsiz + xhn ls: nwbhsiz = slf.unbhsiz - xhn slf.unbhsiz = nwbhsiz lo.bu( f"Bh siz opiiz: {slf.unbhsiz} " f"(lny: {vlny:.3f}s, houhpu: {vhouhpu:.1f})" ) un slf.unbhsiz f bhsusion(slf, quuph: in, syslo: flo) -> in: """  bh siz susion bs on un sys s """ # jus fo quu ph (o is wiin = l bhs) quufo = in(2.0, x(0.5, quuph / 10)) # jus fo sys lo (hih lo = sll bhs) lofo = x(0.3, 1.0 - syslo) sussiz = in(slf.unbhsiz * quufo * lofo) sussiz = x( slf.inbhsiz, in(slf.xbhsiz, sussiz) ) un sussiz f pfonsuy(slf) -> i[s, ny]: """ suy of bhin pfon""" if no slf.ishisoy: un {"sus": "no"} n = slf.ishisoy[-in(10, ln(slf.ishisoy)) :] un { "unbhsiz": slf.unbhsiz, "vlny": su(.possini fo  in n) / ln(n), "vhouhpu": su(.houhpu fo  in n) / ln(n), "vuy": su(.uy fo  in n) / ln(n), "opiizionffiiny": slf.lulffiiny(), "isoun": ln(slf.ishisoy), } f lulffiiny(slf) -> flo: """lul opiizion ffiiny so""" if ln(slf.ishisoy) < 2: un 0.0 # ffiiny bs on lny sbiliy n houhpu lnis = [.possini fo  in slf.ishisoy] lnys = sisis.sv(lnis) if ln(lnis) > 1 ls 0 lnyn = su(lnis) / ln(lnis) # Low offiin of viion = hih ffiiny v = lnys / lnyn if lnyn > 0 ls 1.0 ffiiny = x(0.0, 1.0 - v) un ffiiny lss pivBhPosso: """ piv bh posso usin Vnui bhin sys """ f ini(slf, bh: Opionl[VnuiBh] = Non): slf.bh = bh o VnuiBh() slf.possinquu: Lis[ny] = [] slf.ispossin = Fls syn f obh(slf, i: ny) -> Non: """ i o possin bh""" slf.possinquu.ppn(i) # uo-i possin if quu s l if ln(slf.possinquu) >= slf.bh.unbhsiz: wi slf.possbh() syn f possbh(slf) -> Lis[ny]: """Poss un bh wih pfon onioin""" if no slf.possinquu o slf.ispossin: un [] slf.ispossin = u bh = slf.possinquu[: slf.bh.unbhsiz] slf.possinquu = slf.possinquu[slf.bh.unbhsiz :] y: si = i.i() # Siul possin (pl wih ul possin loi) suls = wi slf.possbhis(bh) possini = i.i() - si bhsiz = ln(bh) # lul is is = Bhis( bhsiz=bhsiz, possini=possini, houhpu=bhsiz / possini if possini > 0 ls 0, oyus=0.0, # Woul n ul oy onioin uy=0.95, # Woul n ul uy lulion isp=i.i(), ) # Opiiz bh siz fo nx iion slf.bh.opiizbhsiz(is) lo.info( f"Poss bh of {bhsiz} is in {possini:.3f}s " f"(houhpu: {is.houhpu:.1f} is/s)" ) un suls finlly: slf.ispossin = Fls syn f possbhis(slf, bh: Lis[ny]) -> Lis[ny]: """Poss iniviul bh is""" # Plhol - pl wih ul possin loi wi synio.slp(0.01) # Siul possin i un [f"poss{i}" fo i in bh] f sus(slf) -> i[s, ny]: """ un posso sus""" un { "quuph": ln(slf.possinquu), "unbhsiz": slf.bh.unbhsiz, "ispossin": slf.ispossin, "pfon": slf.bh.pfonsuy(), } # lobl insn fo sy ss vnuibh = VnuiBh() pivposso = pivBhPosso(vnuibh) if n == "in": # xpl us syn f o(): pin("Vnui Bhin Sys o") pin("=" * 40) #  is o bh fo i in n(50): wi pivposso.obh(f"i{i}") # Poss inin is whil pivposso.possinquu: wi pivposso.possbh() # Show finl sus sus = pivposso.sus() pin(f"\nFinl Sus: {sus}") synio.un(o())