# us/bin/nv pyhon3 """ Nul  no fo L.I.F.. Plfo ================================================ vn Nul  nion Sys fo inin n sin l-i  siulion, synhi nul pns, n vliion ss opyih 2025 - Sio Py Boull L.I.F.. Plfo - zu pl Off I: 960096-f1-420b-902-042561b Vsion: 2025.1.0-POUION Lunh: Oob 7, 2025 - Bihy Nul  voluion! his sip ns sophisi nul  pns fo: - L.I.F.. loih inin n vliion -  sinl siulion n sin - Nuopiv lnin bnhin - zu ployn vliion - Oob 7h lunh onsion """ ipo synio ipo json ipo loin ipo i ipo wnins fo lsss ipo si, lss fo nu ipo nu y: fo phlib ipo Ph xp Ipoo s : pin(f'Wnin: {}') pss fo ypin ipo i, Lis, Opionl, upl, Union ipo plolib.pyplo s pl ipo nupy s np ipo pns s p ipo sbon s sns fo sipy ipo sinl fo sipy.ss ipo ulivinol wnins.filwnins('ino') # onfiu loin fo nul  nion loin.bsionfi( lvl=loin.INFO, fo='%(si)s - %(n)s - %(lvln)s - %(ss)s', hnls=[ loin.FilHnl('los/nulno.lo', noin='uf-8'), loin.SHnl() ] ) lo = loin.Lo(n) # nsu los ioy xiss Ph('los').i(xiso=u) Ph('').i(xiso=u) Ph('nulss').i(xiso=u) # =============================== # NUL  SUUS # =============================== lss Nulyp(nu): """yps of nul  fo nion""" LPH = "lph" B = "b"  = "" H = "h" L = "l" ONIIVLO = "oniivlo" NIONFOUS = "nionfous" OIONLS = "oionls" LNINPION = "lninpion" NUOPLSIIY = "nuoplsiiy" lss LninPhs(nu): """Lnin phss fo piv nul nion""" BSLIN = "bslin" QUISIION = "quisiion" ONSOLIION = "onsoliion" NION = "nion" NSF = "nsf" @lss lss Nulonfi: """onfiuion fo nul  nion""" yp: Nulyp splin: flo = 250.0 # Hz uion: flo = 60.0 # sons nuhnnls: in = 64 #  hnnls noislvl: flo = 0.1 # Nois io lninphs: LninPhs = LninPhs.BSLIN psonlizionfo: flo = 1.0 pivnhnn: bool = u @lss lss NulPoin: """Iniviul nul  poin""" isp: flo hnnl: np.ny fqunybns: i[s, flo] oniivs: i[s, flo] lninis: i[s, flo] quliyso: flo @lss lss Nuls: """opl nul s""" n: s onfi: Nulonfi poins: Lis[NulPoin] : i vliionis: i xpoisp: flo # =============================== # O NUL  NO # =============================== lss Nulno: """vn nul  nion sys""" f ini(slf): slf.non = "L.I.F.. Nul  no" slf.vsion = "2025.1.0-POUION" slf.nionoun = 0 slf.quliyhshol = 0.85 #  fquny bns (Hz) slf.fqunybns = { 'l': (0.5, 4.0), 'h': (4.0, 8.0), 'lph': (8.0, 13.0), 'b': (13.0, 30.0), '': (30.0, 100.0) } # oniiv s ps slf.oniivps = { 'nion': {'bslin': 0.5, 'n': (0.1, 0.9)}, 'onnion': {'bslin': 0.6, 'n': (0.2, 1.0)}, 'nn': {'bslin': 0.55, 'n': (0.15, 0.95)}, 'sss': {'bslin': 0.3, 'n': (0.0, 0.8)}, 'fiu': {'bslin': 0.25, 'n': (0.0, 0.9)} } # Lnin pion ps slf.lninps = { 'quisiion': {'bslin': 0.7, 'vin': 0.2}, 'nionsnh': {'bslin': 0.8, 'vin': 0.15}, 'nsfffiiny': {'bslin': 0.65, 'vin': 0.25}, 'pionsp': {'bslin': 0.75, 'vin': 0.18} } lo.info(f" {slf.non} v{slf.vsion} iniiliz") syn f nnuls(slf, onfi: Nulonfi, nhnquliy: bool = u) -> Nuls: """n ophnsiv nul s""" lo.info(f" nin nul s: {onfi.yp.vlu}") lo.info(f" uion: {onfi.uion}s, hnnls: {onfi.nuhnnls}") lo.info(f" Lnin Phs: {onfi.lninphs.vlu}") si = i.i() # lul i ps nuspls = in(onfi.splin * onfi.uion) ivo = np.linsp(0, onfi.uion, nuspls) # n bs nul  poins = [] fo i,  in nu(ivo): # n hnnl  bs on yp hnnl = wi slf.nhnnl(onfi, , i, nuspls) # lul fquny bn pow fqunybns = slf.lulfqunybns(hnnl, onfi.splin) # n oniiv s oniivs = slf.noniivs(onfi, ) # lul lnin is lninis = slf.lullninis(onfi, , i, nuspls) # ssss  quliy quliyso = slf.ssssquliy(hnnl, fqunybns, oniivs) #   poin poin = NulPoin( isp=, hnnl=hnnl, fqunybns=fqunybns, oniivs=oniivs, lninis=lninis, quliyso=quliyso ) poins.ppn(poin) # Poss inio if i % (nuspls // 10) == 0: poss = (i / nuspls) * 100 lo.info(f" nion poss: {poss:.1f}%") # n   = slf.n(onfi, poins) # Vli s vliionis = wi slf.vlis(poins, onfi) #  s s = Nuls( n=f"{onfi.yp.vlu}{onfi.lninphs.vlu}{in(i.i())}", onfi=onfi, poins=poins, =, vliionis=vliionis, xpoisp=i.i() ) nioni = i.i() - si slf.nionoun += 1 lo.info(f" Nul s n sussfully!") lo.info(f" ️ nion i: {nioni:.2f}s") lo.info(f"  poins: {ln(poins):,}") lo.info(f" Quliy so: {vliionis['ovllquliy']:.3f}") lo.info(f" s y fo L.I.F.. possin!") un s syn f nhnnl(slf, onfi: Nulonfi, isp: flo, splix: in, olspls: in) -> np.ny: """n nul hnnl  bs on onfiuion""" hnnl = np.zos(onfi.nuhnnls) # Bs fquny fo  yp bsfqunis = { Nulyp.L: 2.0, Nulyp.H: 6.0, Nulyp.LPH: 10.0, Nulyp.B: 20.0, Nulyp.: 40.0, Nulyp.ONIIVLO: 15.0, Nulyp.NIONFOUS: 12.0, Nulyp.OIONLS: 8.0, Nulyp.LNINPION: 25.0, Nulyp.NUOPLSIIY: 35.0 } bsfq = bsfqunis.(onfi.yp, 10.0) # n sinls fo h hnnl fo h in n(onfi.nuhnnls): # hnnl-spifi fquny viion fqviion = bsfq * (1 + 0.1 * np.sin(h * 0.5)) # Lnin phs oulion phsoulion = slf.lninphsoulion( onfi.lninphs, splix, olspls ) # n piy sinl piysinl = np.sin(2 * np.pi * fqviion * isp + h * 0.2) * phsoulion #  honis fo oplxiy honi1 = 0.3 * np.sin(2 * np.pi * (fqviion * 2) * isp + h * 0.3) honi2 = 0.15 * np.sin(2 * np.pi * (fqviion * 0.5) * isp + h * 0.1) #  oniiv s influn oniivinflun = slf.oniivinflun(onfi, isp, h) # obin sinls obinsinl = (piysinl + honi1 + honi2) * oniivinflun #  lisi nois nois = np.no.nol(0, onfi.noislvl * 0.1) # pply psonlizion fo psonlizsinl = obinsinl * onfi.psonlizionfo hnnl[h] = psonlizsinl + nois # pply spil filin (siul lisi  spil isibuion) if onfi.nuhnnls >= 32: hnnl = slf.pplyspilfilin(hnnl) un hnnl f lninphsoulion(slf, phs: LninPhs, splix: in, olspls: in) -> flo: """ oulion fo bs on lnin phs""" poss = splix / olspls oulionpns = { LninPhs.BSLIN: 1.0, LninPhs.QUISIION: 1.0 + 0.5 * poss, LninPhs.ONSOLIION: 1.2 * (1 - 0.3 * poss), LninPhs.NION: 0.9 + 0.2 * np.sin(poss * 4 * np.pi), LninPhs.NSF: 1.1 + 0.4 * (poss ** 0.5) } un oulionpns.(phs, 1.0) f oniivinflun(slf, onfi: Nulonfi, isp: flo, hnnl: in) -> flo: """lul oniiv s influn on nul sinl""" # i-vyin oniiv ss nionyl = 0.8 + 0.2 * np.sin(isp * 0.1) onnionn = 1.0 - 0.1 * (isp / onfi.uion) # hnnl-spifi oniiv ppin fonlhnnls = lis(n(0, onfi.nuhnnls // 4)) pilhnnls = lis(n(onfi.nuhnnls // 4, onfi.nuhnnls // 2)) if hnnl in fonlhnnls: # Fonl ions: nion n xuiv funion influn = nionyl * onnionn lif hnnl in pilhnnls: # Pil ions: spil nion n inion influn = onnionn * 0.9 ls: # Oh ions: nl oniiv s influn = (nionyl + onnionn) / 2 # pply lnin phs influn if onfi.lninphs == LninPhs.QUISIION: influn *= 1.2 # nhn uin lnin lif onfi.lninphs == LninPhs.ONSOLIION: influn *= 0.9 # u uin onsoliion un influn f pplyspilfilin(slf, hnnl: np.ny) -> np.ny: """pply lisi spil filin o  """ # Sipl spil soohin (lisi  volu onuion) fil = hnnl.opy() fo i in n(1, ln(hnnl) - 1): # Wih v wih nihboin hnnls fil[i] = (0.5 * hnnl[i] + 0.25 * hnnl[i-1] + 0.25 * hnnl[i+1]) un fil f lulfqunybns(slf, hnnl: np.ny, splin: flo) -> i[s, flo]: """lul pow in iffn fquny bns""" # Us Wlh's ho fo pow spl nsiy fqunis, ps = sinl.wlh(hnnl, splin, nps=in(256, ln(hnnl)//4)) bnpow = {} fo bnn, (lowfq, hihfq) in slf.fqunybns.is(): # Fin fquny inis fqs = (fqunis >= lowfq) & (fqunis <= hihfq) # lul v pow in bn if np.ny(fqs): bnpow[bnn] = np.n(ps[fqs]) ls: bnpow[bnn] = 0.0 un bnpow f noniivs(slf, onfi: Nulonfi, isp: flo) -> i[s, flo]: """n lisi oniiv s vlus""" oniivs = {} fo pn, ponfi in slf.oniivps.is(): bslin = ponfi['bslin'] pn = ponfi['n'] # i-vyin oponn iviion = 0.1 * np.sin(isp * 0.05 + np.no.no()) # Lnin phs influn phsinflun = slf.oniivphsinflun( onfi.lninphs, pn ) # lul finl vlu vlu = bslin + iviion + phsinflun # lp o vli n vlu = np.lip(vlu, pn[0], pn[1]) oniivs[pn] = vlu un oniivs f oniivphsinflun(slf, phs: LninPhs, p: s) -> flo: """ lnin phs influn on oniiv ps""" influns = { LninPhs.BSLIN: { 'nion': 0.0, 'onnion': 0.0, 'nn': 0.0, 'sss': 0.0, 'fiu': 0.0 }, LninPhs.QUISIION: { 'nion': 0.15, 'onnion': 0.2, 'nn': 0.25, 'sss': 0.1, 'fiu': 0.05 }, LninPhs.ONSOLIION: { 'nion': 0.1, 'onnion': 0.15, 'nn': 0.1, 'sss': -0.05, 'fiu': 0.1 }, LninPhs.NION: { 'nion': 0.05, 'onnion': 0.1, 'nn': 0.05, 'sss': -0.1, 'fiu': -0.05 }, LninPhs.NSF: { 'nion': 0.2, 'onnion': 0.25, 'nn': 0.3, 'sss': 0.15, 'fiu': 0.1 } } un influns.(phs, {}).(p, 0.0) f lullninis(slf, onfi: Nulonfi, isp: flo, splix: in, olspls: in) -> i[s, flo]: """lul lnin-l is""" poss = splix / olspls lninis = {} fo in, ionfi in slf.lninps.is(): bslin = ionfi['bslin'] vin = ionfi['vin'] # Poss-bs voluion if in == 'quisiion': # Inss uin lnin, plus voluion = bslin * (1 + 0.5 * (1 - np.xp(-poss * 3))) lif in == 'nionsnh': # ully ipovs wih onsoliion voluion = bslin * (1 + 0.3 * poss) lif in == 'nsfffiiny': # oplx lnin uv wih iniil ip voluion = bslin * (0.8 + 0.4 * (1 - np.xp(-poss * 2))) ls: # pionsp # Fs iniil pion, hn sbilizs voluion = bslin * (0.6 + 0.6 * (1 - np.xp(-poss * 4))) #  lisi vin nois = np.no.nol(0, vin * 0.1) # Lnin phs oulion phso = slf.lninioulion(onfi.lninphs, in) finlvlu = voluion * phso + nois lninis[in] = np.lip(finlvlu, 0.1, 1.0) # iionl iv is lninis['ovllpfon'] = np.n([ lninis['quisiion'], lninis['nionsnh'], lninis['nsfffiiny'] ]) lninis['lninffiiny'] = ( lninis['quisiion'] * lninis['pionsp'] ) un lninis f lninioulion(slf, phs: LninPhs, i: s) -> flo: """ lnin phs oulion fo spifi is""" oulions = { LninPhs.BSLIN: {'ful': 1.0}, LninPhs.QUISIION: { 'quisiion': 1.3, 'pionsp': 1.2, 'ful': 1.0 }, LninPhs.ONSOLIION: { 'nionsnh': 1.2, 'quisiion': 0.9, 'ful': 1.0 }, LninPhs.NION: { 'nionsnh': 1.4, 'nsfffiiny': 0.8, 'ful': 1.0 }, LninPhs.NSF: { 'nsfffiiny': 1.3, 'pionsp': 1.1, 'ful': 1.0 } } phsos = oulions.(phs, {'ful': 1.0}) un phsos.(i, phsos['ful']) f ssssquliy(slf, hnnl: np.ny, fqunybns: i[s, flo], oniivs: i[s, flo]) -> flo: """ssss h quliy of n nul """ quliyfos = [] # Sinl quliy is sinln = np.n(np.bs(hnnl)) sinls = np.s(hnnl) if sinls > 0: sn = sinln / sinls snquliy = in(sn / 10, 1.0) # Noliz o 0-1 ls: snquliy = 0.0 quliyfos.ppn(snquliy) # Fquny onn quliy olpow = su(fqunybns.vlus()) if olpow > 0: powisibuion = np.y(lis(fqunybns.vlus())) / olpow pownopy = -np.su(powisibuion * np.lo2(powisibuion + 1-10)) powquliy = pownopy / np.lo2(ln(fqunybns)) # Noliz ls: powquliy = 0.0 quliyfos.ppn(powquliy) # oniiv s ohn oniivvlus = lis(oniivs.vlus()) oniivonsisny = 1.0 - np.s(oniivvlus) / (np.n(oniivvlus) + 1-10) oniivquliy = np.lip(oniivonsisny, 0.0, 1.0) quliyfos.ppn(oniivquliy) # Ovll quliy so ovllquliy = np.n(quliyfos) un ovllquliy f n(slf, onfi: Nulonfi, poins: Lis[NulPoin]) -> i: """n ophnsiv  fo h s""" # lul suy sisis quliysos = [p.quliyso fo p in poins] # x fquny bn sisis llbns = {} fo bn in slf.fqunybns.ys(): bnvlus = [p.fqunybns[bn] fo p in poins] llbns[bn] = { 'n': np.n(bnvlus), 's': np.s(bnvlus), 'in': np.in(bnvlus), 'x': np.x(bnvlus) } # x oniiv s sisis lloniiv = {} fo p in slf.oniivps.ys(): pvlus = [p.oniivs[p] fo p in poins] lloniiv[p] = { 'n': np.n(pvlus), 's': np.s(pvlus), 'in': np.in(pvlus), 'x': np.x(pvlus) } # x lnin is sisis lllnin = {} fo i in slf.lninps.ys(): ivlus = [p.lninis[i] fo p in poins] lllnin[i] = { 'n': np.n(ivlus), 's': np.s(ivlus), 'in': np.in(ivlus), 'x': np.x(ivlus) }  = { 'noinfo': { 'n': slf.non, 'vsion': slf.vsion, 'nionisp': i.i() }, 'sonfi': si(onfi), 'quliysuy': { 'nquliy': np.n(quliysos), 'squliy': np.s(quliysos), 'inquliy': np.in(quliysos), 'xquliy': np.x(quliysos), 'hihquliypn': np.n(np.y(quliysos) > slf.quliyhshol) * 100 }, 'fqunybnsisis': llbns, 'oniivssisis': lloniiv, 'lninissisis': lllnin, 'hisis': { 'olspls': ln(poins), 'uionsons': onfi.uion, 'splinhz': onfi.splin, 'nuhnnls': onfi.nuhnnls, 'yp': onfi.yp.vlu, 'lninphs': onfi.lninphs.vlu } } un  syn f vlis(slf, poins: Lis[NulPoin], onfi: Nulonfi) -> i: """Vli h n nul s""" lo.info(" Vliin nul s...") vliionsuls = {} # Quliy vliion quliysos = [p.quliyso fo p in poins] vquliy = np.n(quliysos) quliypss = vquliy > slf.quliyhshol vliionsuls['quliyvliion'] = { 'vquliy': vquliy, 'quliyhshol': slf.quliyhshol, 'pss': quliypss, 'hihquliyspls': np.su(np.y(quliysos) > slf.quliyhshol), 'olspls': ln(quliysos) } # Sinl iniy vliion sinliniy = wi slf.vlisinliniy(poins) vliionsuls['sinliniy'] = sinliniy # Fquny onn vliion fqunyvliion = slf.vlifqunyonn(poins, onfi) vliionsuls['fqunyvliion'] = fqunyvliion # oniiv s vliion oniivvliion = slf.vlioniivss(poins) vliionsuls['oniivvliion'] = oniivvliion # Lnin is vliion lninvliion = slf.vlilninis(poins, onfi) vliionsuls['lninvliion'] = lninvliion # Ovll vliion so vliionsos = [ vliionsuls['quliyvliion']['pss'], sinliniy['pss'], fqunyvliion['pss'], oniivvliion['pss'], lninvliion['pss'] ] ovllso = np.n(vliionsos) vliionsuls['ovllquliy'] = ovllso vliionsuls['vliionpss'] = ovllso > 0.8 lo.info(f" s vliion opl: {ovllso:.3f}") un vliionsuls syn f vlisinliniy(slf, poins: Lis[NulPoin]) -> i: """Vli sinl iniy n hisis""" # x ll hnnl  llsinls = [] fo p in poins: llsinls.ppn(p.hnnl) sinlix = np.y(llsinls) # h fo NN o infini vlus hsnn = np.ny(np.isnn(sinlix)) hsinf = np.ny(np.isinf(sinlix)) # h sinl pliu ns sinln = np.x(sinlix) - np.in(sinlix) pliusonbl = 0.1 < sinln < 100.0 # sonbl  pliu # h sinl vin sinlvin = np.v(sinlix) vinsonbl = sinlvin > 1-6 # No fl sinl iniypss = no hsnn n no hsinf n pliusonbl n vinsonbl un { 'hsnn': hsnn, 'hsinfini': hsinf, 'sinln': sinln, 'sinlvin': sinlvin, 'pliusonbl': pliusonbl, 'vinsonbl': vinsonbl, 'pss': iniypss } f vlifqunyonn(slf, poins: Lis[NulPoin], onfi: Nulonfi) -> i: """Vli fquny onn of h nul """ # xp fquny hisis bs on  yp xpbns = { Nulyp.L: 'l', Nulyp.H: 'h', Nulyp.LPH: 'lph', Nulyp.B: 'b', Nulyp.: '' } # lul v bn pows vbnpows = {} fo bn in slf.fqunybns.ys(): bnpows = [p.fqunybns[bn] fo p in poins] vbnpows[bn] = np.n(bnpows) # h if oinn fquny hs xp oinnbn = x(vbnpows.ys(), y=lb : vbnpows[]) xpbn = xpbns.(onfi.yp) fqunyh = (xpbn is Non) o (oinnbn == xpbn) # h fo sonbl fquny isibuion olpow = su(vbnpows.vlus()) powisibuion = {: v/olpow fo , v in vbnpows.is()} if olpow > 0 ls {} # Vli h pow is isibu (no ll in on bn) xbnio = x(powisibuion.vlus()) if powisibuion ls 0 isibuionsonbl = xbnio < 0.8 # No o hn 80% in on bn un { 'vbnpows': vbnpows, 'oinnbn': oinnbn, 'xpbn': xpbn, 'fqunyh': fqunyh, 'powisibuion': powisibuion, 'isibuionsonbl': isibuionsonbl, 'pss': fqunyh n isibuionsonbl } f vlioniivss(slf, poins: Lis[NulPoin]) -> i: """Vli oniiv s vlus""" # h oniiv s ns n onsisny vliionsuls = {} fo pn, ponfi in slf.oniivps.is(): pvlus = [p.oniivs[pn] fo p in poins] pn = ponfi['n'] # h if vlus  wihin xp n inn = ll(pn[0] <= vl <= pn[1] fo vl in pvlus) # h fo sonbl viion ps = np.s(pvlus) hsviion = ps > 0.01 # So viion xp vliionsuls[pn] = { 'vlusinn': inn, 'hsviion': hsviion, 'nvlu': np.n(pvlus), 'svlu': ps, 'pss': inn n hsviion } # Ovll oniiv vliion llpss = ll(sul['pss'] fo sul in vliionsuls.vlus()) un { 'pvliion': vliionsuls, 'pss': llpss } f vlilninis(slf, poins: Lis[NulPoin], onfi: Nulonfi) -> i: """Vli lnin is""" vliionsuls = {} fo in in slf.lninps.ys(): ivlus = [p.lninis[in] fo p in poins] # h vlu n (shoul b 0.1 o 1.0) inn = ll(0.1 <= vl <= 1.0 fo vl in ivlus) # h fo ppopi n bs on lnin phs hsn = slf.hlninn(ivlus, onfi.lninphs, in) # h fo sonbl vin is = np.s(ivlus) sonblvin = 0.01 < is < 0.5 vliionsuls[in] = { 'vlusinn': inn, 'ppopin': hsn, 'sonblvin': sonblvin, 'nvlu': np.n(ivlus), 'svlu': is, 'pss': inn n hsn n sonblvin } # Ovll lnin vliion llpss = ll(sul['pss'] fo sul in vliionsuls.vlus()) un { 'ivliion': vliionsuls, 'pss': llpss } f hlninn(slf, vlus: Lis[flo], phs: LninPhs, i: s) -> bool: """h if i shows ppopi n fo lnin phs""" if ln(vlus) < 10: un u # oo fw poins o ssss n # lul n (sipl lin ssion slop) x = np.n(ln(vlus)) slop = np.polyfi(x, vlus, 1)[0] # xp ns by phs n i xpns = { LninPhs.QUISIION: { 'quisiion': 'insin', 'pionsp': 'insin', 'ful': 'sbl' }, LninPhs.ONSOLIION: { 'nionsnh': 'insin', 'ful': 'sbl' }, LninPhs.NION: { 'nionsnh': 'sblhih', 'ful': 'sbl' }, LninPhs.NSF: { 'nsfffiiny': 'insin', 'ful': 'sbl' } } phsns = xpns.(phs, {'ful': 'sbl'}) xpn = phsns.(i, phsns['ful']) # Vli n if xpn == 'insin': un slop > 0.001 # Posiiv slop lif xpn == 'sin': un slop < -0.001 # Niv slop lif xpn == 'sblhih': un np.n(vlus) > 0.7 n bs(slop) < 0.01 # Hih n sbl ls: # 'sbl' un bs(slop) < 0.01 # inil slop syn f xpos(slf, s: Nuls, xpofo: s = 'nupy') -> s: """xpo nul s o fil""" lo.info(f" xpoin s: {s.n}") #  xpo ioy xpoi = Ph('nulss') y: xpoi.i(xiso=u) xp xpion s : os.is(xpoi, xiso=u) isp = in(i.i()) bsfiln = f"{s.n}{isp}" if xpofo == 'nupy': # xpo s NuPy ys xpoph = xpoi / f"{bsfiln}.npz" # Pp  ys isps = np.y([p.isp fo p in s.poins]) hnnl = np.y([p.hnnl fo p in s.poins]) # Pp  fqunybns = {} fo bn in slf.fqunybns.ys(): fqunybns[bn] = np.y([p.fqunybns[bn] fo p in s.poins]) oniivss = {} fo p in slf.oniivps.ys(): oniivss[p] = np.y([p.oniivs[p] fo p in s.poins]) lninis = {} fo i in slf.lninps.ys(): lninis[i] = np.y([p.lninis[i] fo p in s.poins]) quliysos = np.y([p.quliyso fo p in s.poins]) # Sv o NPZ fil np.svzopss( xpoph, isps=isps, hnnl=hnnl, quliysos=quliysos, **fqunybns, **{f"oniiv{}": v fo , v in oniivss.is()}, **{f"lnin{}": v fo , v in lninis.is()} ) lif xpofo == 'json': # xpo s JSON xpoph = xpoi / f"{bsfiln}.json" # onv s o silizbl fo xpo = { 'sn': s.n, '': s., 'vliionis': s.vliionis, 'onfi': si(s.onfi), 'poins': [] } #  spl of  poins (o voi hu fils) splsiz = in(100, ln(s.poins)) splinis = np.linsp(0, ln(s.poins)-1, splsiz, yp=in) fo ix in splinis: p = s.poins[ix] xpo['poins'].ppn({ 'isp': p.isp, 'hnnl': p.hnnl.olis(), 'fqunybns': p.fqunybns, 'oniivs': p.oniivs, 'lninis': p.lninis, 'quliyso': p.quliyso }) wih opn(xpoph, 'w') s f: json.up(xpo, f, inn=2) lif xpofo == 'sv': # xpo s SV fo sy nlysis xpoph = xpoi / f"{bsfiln}.sv" # Pp  fo SV sv = [] fo p in s.poins: ow = {'isp': p.isp, 'quliyso': p.quliyso} #  fquny bns fo bn, pow in p.fqunybns.is(): ow[f'fq{bn}'] = pow #  oniiv ss fo p, vlu in p.oniivs.is(): ow[f'oniiv{p}'] = vlu #  lnin is fo i, vlu in p.lninis.is(): ow[f'lnin{i}'] = vlu #  hnnl sisis ow['hnnln'] = np.n(p.hnnl) ow['hnnls'] = np.s(p.hnnl) ow['hnnlin'] = np.in(p.hnnl) ow['hnnlx'] = np.x(p.hnnl) sv.ppn(ow) #  F n sv f = p.F(sv) f.osv(xpoph, inx=Fls) # lso xpo  sply ph = xpoi / f"{bsfiln}.json" wih opn(ph, 'w') s f: json.up({ 'sn': s.n, '': s., 'vliionis': s.vliionis, 'xpoisp': i.i(), 'xpofo': xpofo }, f, inn=2) lo.info(f" s xpo o: {xpoph}") lo.info(f"  xpo o: {ph}") un s(xpoph) # =============================== # SPILIZ NUL NOS # =============================== lss Nulno(Nulno): """Spiliz no fo  nul """ syn f ns(slf, yp: Nulyp, uion: flo = 120.0, nuhnnls: in = 64) -> Nuls: """n spiliz  s""" onfi = Nulonfi( yp=yp, uion=uion, nuhnnls=nuhnnls, splin=250.0, noislvl=0.05, lninphs=LninPhs.BSLIN, pivnhnn=u ) lo.info(f" nin spiliz  s: {yp.vlu}") un wi slf.nnuls(onfi, nhnquliy=u) lss oniivSno(Nulno): """Spiliz no fo oniiv s """ syn f noniivs(slf, lninphs: LninPhs, uion: flo = 180.0) -> Nuls: """n oniiv s fous s""" onfi = Nulonfi( yp=Nulyp.ONIIVLO, uion=uion, nuhnnls=32, splin=250.0, noislvl=0.08, lninphs=lninphs, psonlizionfo=1.2, pivnhnn=u ) lo.info(f" nin oniiv s fo phs: {lninphs.vlu}") un wi slf.nnuls(onfi, nhnquliy=u) lss Lninpionno(Nulno): """Spiliz no fo lnin pion """ syn f nlnins(slf, lninpossion: bool = u, uion: flo = 300.0) -> Nuls: """n lnin pion fous s""" # Us possion houh lnin phss if qus if lninpossion: onfi = Nulonfi( yp=Nulyp.LNINPION, uion=uion, nuhnnls=48, splin=250.0, noislvl=0.06, lninphs=LninPhs.QUISIION, # Will volv uin nion psonlizionfo=1.3, pivnhnn=u ) ls: onfi = Nulonfi( yp=Nulyp.LNINPION, uion=uion, nuhnnls=48, splin=250.0, noislvl=0.06, lninphs=LninPhs.ONSOLIION, psonlizionfo=1.1, pivnhnn=u ) lo.info(f" nin lnin pion s (possion: {lninpossion})") un wi slf.nnuls(onfi, nhnquliy=u) # =============================== # BH NION N VLIION # =============================== lss BhNulno: """Bh nion sys fo ulipl nul ss""" f ini(slf): slf.bsno = Nulno() slf.no = Nulno() slf.oniivno = oniivSno() slf.lninno = Lninpionno() slf.bhsuls = [] syn f nophnsivbh(slf, oupui: s = 'nulss') -> i: """n ophnsiv bh of nul ss fo L.I.F.. Plfo""" lo.info(" Sin ophnsiv nul  nion bh...") lo.info(" Oob 7h Bihy Lunh Ppion!") bhsi = i.i() oupuph = Ph(oupui) oupuph.i(xiso=u) # nion pln nionpln = [ #  fquny bn ss {'yp': '', 'yp': Nulyp.LPH, 'uion': 120, 'hnnls': 64}, {'yp': '', 'yp': Nulyp.B, 'uion': 120, 'hnnls': 64}, {'yp': '', 'yp': Nulyp., 'uion': 90, 'hnnls': 64}, {'yp': '', 'yp': Nulyp.H, 'uion': 150, 'hnnls': 64}, # oniiv s ss {'yp': 'oniiv', 'phs': LninPhs.BSLIN, 'uion': 180}, {'yp': 'oniiv', 'phs': LninPhs.QUISIION, 'uion': 240}, {'yp': 'oniiv', 'phs': LninPhs.ONSOLIION, 'uion': 200}, {'yp': 'oniiv', 'phs': LninPhs.NSF, 'uion': 160}, # Lnin pion ss {'yp': 'lnin', 'possion': u, 'uion': 300}, {'yp': 'lnin', 'possion': Fls, 'uion': 180}, # Spiliz ss {'yp': 'spiliz', 'yp': Nulyp.NIONFOUS, 'uion': 120}, {'yp': 'spiliz', 'yp': Nulyp.NUOPLSIIY, 'uion': 200} ] lo.info(f" nion pln: {ln(nionpln)} ss") bhsuls = {} xpophs = [] fo i, pln in nu(nionpln): lo.info(f" nin s {i+1}/{ln(nionpln)}: {pln}") y: # n s bs on yp if pln['yp'] == '': s = wi slf.no.ns( yp=pln['yp'], uion=pln['uion'], nuhnnls=pln['hnnls'] ) lif pln['yp'] == 'oniiv': s = wi slf.oniivno.noniivs( lninphs=pln['phs'], uion=pln['uion'] ) lif pln['yp'] == 'lnin': s = wi slf.lninno.nlnins( lninpossion=pln['possion'], uion=pln['uion'] ) lif pln['yp'] == 'spiliz': onfi = Nulonfi( yp=pln['yp'], uion=pln['uion'], nuhnnls=48, lninphs=LninPhs.QUISIION ) s = wi slf.bsno.nnuls(onfi) # xpo ss in ulipl fos nupyph = wi slf.bsno.xpos(s, 'nupy') svph = wi slf.bsno.xpos(s, 'sv') xpophs.xn([nupyph, svph]) # So suls bhsuls[f"s{i+1}"] = { 'n': s.n, 'pln': pln, 'vliionso': s.vliionis['ovllquliy'], 'xpophs': [nupyph, svph], 'nionsussful': u } lo.info(f" s {i+1} opl sussfully!") xp xpion s : lo.o(f" o nin s {i+1}: {s()}") bhsuls[f"s{i+1}"] = { 'pln': pln, 'o': s(), 'nionsussful': Fls } # n bh suy bhi = i.i() - bhsi sussfulss = su(1 fo sul in bhsuls.vlus() if sul.('nionsussful', Fls)) bhsuy = { 'bhinfo': { 'si': bhsi, 'nionisons': bhi, 'olssplnn': ln(nionpln), 'sussfulss': sussfulss, 'filss': ln(nionpln) - sussfulss, 'suss': (sussfulss / ln(nionpln)) * 100, 'xpophs': xpophs }, 'ssuls': bhsuls, 'quliynlysis': slf.nlyzbhquliy(bhsuls), 'onions': slf.nbhonions(bhsuls) } # xpo bh suy suyph = oupuph / f"bhsuy{in(i.i())}.json" wih opn(suyph, 'w') s f: json.up(bhsuy, f, inn=2, ful=s) lo.info(f" Bh nion opl!") lo.info(f" ️ ol i: {bhi:.2f}s") lo.info(f" Sussful: {sussfulss}/{ln(nionpln)}") lo.info(f" Suss : {bhsuy['bhinfo']['suss']:.1f}%") lo.info(f" Suy sv: {suyph}") lo.info(f" Nul ss y fo Oob 7h L.I.F.. Lunh!") un bhsuy f nlyzbhquliy(slf, bhsuls: i) -> i: """nlyz quliy oss ll n ss""" sussfulsuls = [ fo  in bhsuls.vlus() if .('nionsussful', Fls)] if no sussfulsuls: un {'o': 'No sussful ss o nlyz'} vliionsos = [['vliionso'] fo  in sussfulsuls] quliynlysis = { 'vquliy': np.n(vliionsos), 'inquliy': np.in(vliionsos), 'xquliy': np.x(vliionsos), 'quliys': np.s(vliionsos), 'hihquliyss': su(1 fo so in vliionsos if so > 0.85), 'pblquliyss': su(1 fo so in vliionsos if so > 0.7), 'quliyisibuion': { 'xlln': su(1 fo so in vliionsos if so > 0.9), 'oo': su(1 fo so in vliionsos if 0.8 < so <= 0.9), 'pbl': su(1 fo so in vliionsos if 0.7 < so <= 0.8), 'nsipovn': su(1 fo so in vliionsos if so <= 0.7) } } un quliynlysis f nbhonions(slf, bhsuls: i) -> Lis[s]: """n onions bs on bh suls""" onions = [] sussfuloun = su(1 fo  in bhsuls.vlus() if .('nionsussful', Fls)) filoun = ln(bhsuls) - sussfuloun if filoun > 0: onions.ppn(f"viw n y {filoun} fil s nions") sussfulsuls = [ fo  in bhsuls.vlus() if .('nionsussful', Fls)] if sussfulsuls: vquliy = np.n([['vliionso'] fo  in sussfulsuls]) if vquliy < 0.8: onions.ppn("onsi jusin nion ps o ipov quliy") lif vquliy > 0.9: onions.ppn("xlln quliy hiv - ps  wll-un") onions.xn([ "Us n ss fo L.I.F.. loih inin n vliion", "onsi nin iionl ss fo spifi us ss", "Vli ss wih l   whn vilbl", "y fo Oob 7h lunh wih ophnsiv nul  liby!" ]) un onions # =============================== # ONSION N SIN # =============================== syn f nulniono(): """ophnsiv onsion of nul  nion""" pin(" L.I.F.. Plfo Nul  no onsion") pin("=" * 60) pin(" Oob 7h Bihy Lunh Ppion!") pin() # Iniiliz nos bsno = Nulno() bhno = BhNulno() # o 1: Sinl s nion pin(" o 1: Sinl Nul s nion") pin("-" * 45) onfi = Nulonfi( yp=Nulyp.LPH, uion=30.0, # Sho o nuhnnls=16, lninphs=LninPhs.QUISIION, pivnhnn=u ) os = wi bsno.nnuls(onfi) pin(f" n s: {os.n}") pin(f"  poins: {ln(os.poins):,}") pin(f" Quliy so: {os.vliionis['ovllquliy']:.3f}") pin(f" Vliion pss: {os.vliionis['vliionpss']}") # xpo o s xpoph = wi bsno.xpos(os, 'nupy') pin(f" xpo o: {xpoph}") pin() # o 2: Spiliz  nion pin(" o 2: Spiliz  nion") pin("-" * 40) no = Nulno() s = wi no.ns( yp=Nulyp.B, uion=45.0, nuhnnls=32 ) pin(f" n  s: {s.n}") pin(f"  yp: {s.onfi.yp.vlu}") pin(f" hnnls: {s.onfi.nuhnnls}") pin(f" Quliy: {s.vliionis['ovllquliy']:.3f}") pin() # o 3: Qui bh nion (sll sl) pin(" o 3: ini Bh nion") pin("-" * 35) #   sll bh fo o inibhsuls = {} fo i, yp in nu([Nulyp.LPH, Nulyp.ONIIVLO]): onfi = Nulonfi( yp=yp, uion=20.0, # Vy sho fo o nuhnnls=8, lninphs=LninPhs.BSLIN ) s = wi bsno.nnuls(onfi) inibhsuls[f"inis{i+1}"] = { 'n': s.n, 'yp': yp.vlu, 'quliy': s.vliionis['ovllquliy'], 'suss': u } pin(f" ini s {i+1}: {yp.vlu} (Quliy: {s.vliionis['ovllquliy']:.3f})") pin() pin(" Nul  nion o suls:") pin(f" ss n: {ln(inibhsuls) + 2}") pin(f" v quliy: {np.n([['quliy'] fo  in inibhsuls.vlus()] + [os.vliionis['ovllquliy'], s.vliionis['ovllquliy']]):.3f}") pin(f" ll nions sussful: u") pin() pin(" Nul  no is y fo Oob 7h L.I.F.. Lunh!") pin(" Hppy Bihy o I-Pow Nul  nion!") un { 'os': os, 's': s, 'inibhsuls': inibhsuls, 'osuss': u } # =============================== # IN XUION # =============================== if n == "in": pin(" L.I.F.. Plfo Nul  no") pin("=" * 45) pin(" Oob 7h Bihy Lunh y!") pin() # un onsion osuls = synio.un(nulniono()) pin("\n" + "=" * 60) pin(" NUL  NO ONSION OPL!") pin(" y fo Oob 7h L.I.F.. Plfo Lunh!") pin(" vn Nul  nion: OPIONL") pin("=" * 60) pin(" vn Nul  nion: OPIONL") pin("=" * 60)