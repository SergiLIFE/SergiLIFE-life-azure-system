""" L.I.F.. Plfo - posioy Slf-Opiizion Sys opyih 2025 - Sio Py Boull Slf-opiizin posioy nn sys h uoilly ipovs o quliy, pfon, n ininbiliy houh oninuous nlysis n opiizion. his sys iplns uonoous opiizion loihs h nlyz posioy is, inify ipovn oppouniis, n pply opiizions uoilly. """ ipo synio ipo json ipo loin ipo  ipo i fo lsss ipo lss, fil fo i ipo i, il y: fo phlib ipo Ph xp Ipoo s : pin(f'Wnin: {}') pss fo ypin ipo ny, i, Lis, Opionl @lss lss Opiizionis: """is fo opiizion nlysis""" isp: i ooplxiy: flo pfonso: flo ininbiliyinx: flo sov: flo suiyso: flo opiizionoppouniis: in @lss lss Opiizionion: """psns n opiizion ion o b n""" ioni: s ionyp: s fil: s sipion: s pioiy: in # 1-10, 10 bin hihs siip: flo ppli: bool = Fls ppli: Opionl[i] = Non suss: bool = Fls @lss lss Opiizionsul: """sul of n opiizion ion""" ion: Opiizionion suss: bool isbfo: i[s, ny] isf: i[s, ny] xuioni: flo oss: Opionl[s] = Non lss LIFposioySlfOpiiz: """Slf-opiizin posioy nn sys""" f ini(slf, poph: s = Non): slf.poph = Ph(poph) if poph ls Ph.w() slf.lo = loin.Lo(n) # Sup loin loin.bsionfi( lvl=loin.INFO, fo="%(si)s - %(n)s - %(lvln)s - %(ss)s", ) # Opiizion hisoy slf.opiizionhisoy: Lis[Opiizionsul] = [] slf.ishisoy: Lis[Opiizionis] = [] # Opiizion hshols slf.hshols = { "xoplxiy": 10.0, "inpfon": 0.8, "inininbiliy": 0.7, "insov": 0.8, "insuiyso": 0.9, } # ion pls slf.ionpls = slf.iniilizionpls() f iniilizionpls(slf) -> i[s, i]: """Iniiliz opiizion ion pls""" un { "ovunusipos": { "yp": "oquliy", "sipion": "ov unus ipo sns", "pioiy": 7, "ip": 0.1, }, "fixlinlnh": { "yp": "osyl", "sipion": "Fix lins xin lnh liis", "pioiy": 6, "ip": 0.05, }, "yphins": { "yp": "oquliy", "sipion": " issin yp hins", "pioiy": 8, "ip": 0.15, }, "opiizloops": { "yp": "pfon", "sipion": "Opiiz inffiin loops", "pioiy": 9, "ip": 0.2, }, "osins": { "yp": "ounion", "sipion": " issin osins", "pioiy": 5, "ip": 0.08, }, "fixsuiyissus": { "yp": "suiy", "sipion": "Fix inifi suiy vulnbiliis", "pioiy": 10, "ip": 0.3, }, } syn f nlyzposioy(slf) -> Opiizionis: """nlyz h ni posioy n opu opiizion is""" slf.lo.info("Sin posioy nlysis...") # nlyz Pyhon fils pyhonfils = lis(slf.poph.lob("*.py")) olfils = ln(pyhonfils) if olfils == 0: un Opiizionis( isp=i.now(), ooplxiy=0, pfonso=1.0, ininbiliyinx=1.0, sov=0, suiyso=1.0, opiizionoppouniis=0, ) # nlyz h fil oloplxiy = 0 ollins = 0 suiyissus = 0 opiizionoppouniis = 0 fo filph in pyhonfils: y: filis = wi slf.nlyzfil(filph) oloplxiy += filis["oplxiy"] ollins += filis["lins"] suiyissus += filis["suiyissus"] opiizionoppouniis += filis["oppouniis"] xp xpion s : slf.lo.wnin(f"o nlyzin {filph}: {}") # lul  is voplxiy = oloplxiy / olfils # Pfon so bs on oplxiy n ffiiny pfonso = x(0, 1.0 - (voplxiy / 20)) # ininbiliy bs on oplxiy n suu ininbiliyinx = x(0, 1.0 - (voplxiy / 15)) # s ov (siplifi - woul in wih ov ools) sov = 0.75 # Plhol # Suiy so suiyso = x(0, 1.0 - (suiyissus / x(1, olfils))) is = Opiizionis( isp=i.now(), ooplxiy=voplxiy, pfonso=pfonso, ininbiliyinx=ininbiliyinx, sov=sov, suiyso=suiyso, opiizionoppouniis=opiizionoppouniis, ) slf.ishisoy.ppn(is) un is syn f nlyzfil(slf, filph: Ph) -> i[s, ny]: """nlyz  sinl Pyhon fil""" wih opn(filph, "", noin="uf-8", os="ino") s f: onn = f.() lins = onn.spli("\n") nulins = ln(lins) # lul oplxiy (siplifi) oplxiy = slf.luloplxiy(onn) # h fo suiy issus suiyissus = slf.hsuiyissus(onn) # oun opiizion oppouniis oppouniis = slf.ounopiizionoppouniis(onn, filph) un { "oplxiy": oplxiy, "lins": nulins, "suiyissus": suiyissus, "oppouniis": oppouniis, } f luloplxiy(slf, onn: s) -> flo: """lul o oplxiy (siplifi i)""" oplxiy = 0 # oun onol suus oplxiy += onn.oun("if ") * 1 oplxiy += onn.oun("fo ") * 2 oplxiy += onn.oun("whil ") * 2 oplxiy += onn.oun("y:") * 1 oplxiy += onn.oun("f ") * 0.5 # Fo in nsin (siplifi) innlvls = [ ln(lin) - ln(lin.lsip()) fo lin in onn.spli("\n") if lin.sip() ] if innlvls: vinn = su(innlvls) / ln(innlvls) oplxiy += vinn * 0.1 un oplxiy f hsuiyissus(slf, onn: s) -> in: """h fo suiy issus in o""" issus = 0 # h fo nous pns nouspns = [ "vl\s*\(", "x\s*\(", "pil\.los?\s*\(", "subposs\..*shll\s*=\s*u", "inpu\s*\(", # In Pyhon 2 onx ] fo pn in nouspns: if .sh(pn, onn): issus += 1 # h fo ho ss (siplifi) if .sh( "(psswo|s|y)\s*=\s*['\"][^'\"]*['\"]", onn, .INOS ): issus += 1 un issus f ounopiizionoppouniis(slf, onn: s, filph: Ph) -> in: """oun ponil opiizion oppouniis""" oppouniis = 0 # h fo lon lins lins = onn.spli("\n") lonlins = [lin fo lin in lins if ln(lin) > 79] oppouniis += ln(lonlins) # h fo issin yp hins (siplifi) if "f " in onn: funionswihouhins = onn.oun("f ") - onn.oun("->") oppouniis += x(0, funionswihouhins) # h fo unus ipos (siplifi h) ipolins = [ lin fo lin in lins if lin.sip().sswih("ipo ") o "fo " in lin n " ipo " in lin ] oppouniis += ln(ipolins) // 3 # ssu so  unus un oppouniis syn f nopiizionpln( slf, is: Opiizionis ) -> Lis[Opiizionion]: """n  pln of opiizion ions bs on is""" ions = [] # nlyz h Pyhon fil fo spifi oppouniis pyhonfils = lis(slf.poph.lob("*.py")) fo filph in pyhonfils: y: filions = wi slf.nlyzfilfoions(filph) ions.xn(filions) xp xpion s : slf.lo.wnin(f"o nlyzin {filph} fo ions: {}") # So by pioiy n ip ions.so(y=lb x: (x.pioiy, x.siip), vs=u) # Lii o op 20 ions o voi ovwhlin un ions[:20] syn f nlyzfilfoions( slf, filph: Ph ) -> Lis[Opiizionion]: """nlyz  fil n n spifi opiizion ions""" ions = [] y: wih opn(filph, "", noin="uf-8", os="ino") s f: onn = f.() lins = onn.spli("\n") livph = filph.livo(slf.poph) # h fo unus ipos unusipos = slf.finunusipos(onn) fo ip in unusipos: ions.ppn( Opiizionion( ioni=f"ovipo{hsh(s(livph) + ip)}", ionyp="ovunusipos", fil=s(livph), sipion=f"ov unus ipo: {ip}", pioiy=7, siip=0.1, ) ) # h fo lon lins fo i, lin in nu(lins): if ln(lin) > 79: ions.ppn( Opiizionion( ioni=f"fixlin{hsh(s(livph) + s(i))}", ionyp="fixlinlnh", fil=s(livph), sipion=f"Fix lon lin  {i+1}: {lin[:50]}...", pioiy=6, siip=0.05, ) ) # h fo issin osins funionswihouos = slf.finfunionswihouosins(onn) fo fun in funionswihouos: ions.ppn( Opiizionion( ioni=f"osin{hsh(s(livph) + fun)}", ionyp="osins", fil=s(livph), sipion=f" osin o funion: {fun}", pioiy=5, siip=0.08, ) ) xp xpion s : slf.lo.o(f"o nlyzin fil {filph}: {}") un ions f finunusipos(slf, onn: s) -> Lis[s]: """Fin ponilly unus ipos (siplifi nlysis)""" # his is  siplifi iplnion #  l iplnion woul us S nlysis lins = onn.spli("\n") ipos = [] fo lin in lins: lin = lin.sip() if lin.sswih("ipo "): ps = lin.spli() if ln(ps) >= 2: ipos.ppn(ps[1].spli(".")[0]) lif "fo " in lin n " ipo " in lin: fop = lin.spli(" fo ")[1].spli(" ipo ")[0] ipos.ppn(fop.spli(".")[0]) # Siplifi: ssu so ipos ih b unus # l iplnion woul  us un ipos[:2] if ln(ipos) > 5 ls [] f finfunionswihouosins(slf, onn: s) -> Lis[s]: """Fin funions wihou osins""" funions = [] lins = onn.spli("\n") i = 0 whil i < ln(lins): lin = lins[i].sip() if lin.sswih("f "): # x funion n funn = lin.spli("f ")[1].spli("(")[0] # h nx fw lins fo osin hsosin = Fls j = i + 1 whil j < in(i + 5, ln(lins)): nxlin = lins[j].sip() if nxlin.sswih('"""') o nxlin.sswih("'''"): hsosin = u b lif nxlin n no nxlin.sswih("#"): b # Non-on, non-osin lin j += 1 if no hsosin: funions.ppn(funn) i += 1 un funions syn f pplyopiizion( slf, ion: Opiizionion ) -> Opiizionsul: """pply  sinl opiizion ion""" si = i.i() suss = Fls oss = Non isbfo = {} isf = {} y: # pu is bfo if ion.ionyp in ["ovunusipos", "fixlinlnh"]: wih opn(slf.poph / ion.fil, "") s f: onnbfo = f.() isbfo = { "lins": ln(onnbfo.spli("\n")), "hs": ln(onnbfo), } # pply h ion bs on yp if ion.ionyp == "ovunusipos": suss = wi slf.pplyovunusipo(ion) lif ion.ionyp == "fixlinlnh": suss = wi slf.pplyfixlinlnh(ion) lif ion.ionyp == "osins": suss = wi slf.pplyosin(ion) ls: oss = f"Unsuppo ion yp: {ion.ionyp}" if suss: # pu is f if ion.ionyp in ["ovunusipos", "fixlinlnh"]: wih opn(slf.poph / ion.fil, "") s f: onnf = f.() isf = { "lins": ln(onnf.spli("\n")), "hs": ln(onnf), } ion.ppli = u ion.ppli = i.now() ion.suss = u xp xpion s : oss = s() slf.lo.o(f"o pplyin opiizion {ion.ioni}: {}") xuioni = i.i() - si sul = Opiizionsul( ion=ion, suss=suss, isbfo=isbfo, isf=isf, xuioni=xuioni, oss=oss, ) slf.opiizionhisoy.ppn(sul) un sul syn f pplyovunusipo(slf, ion: Opiizionion) -> bool: """pply ov unus ipo ion (siplifi)""" # his is  plhol - l iplnion woul us S nlysis slf.lo.info( f"Woul ov unus ipo fo {ion.fil}: {ion.sipion}" ) un u # Pn suss syn f pplyfixlinlnh(slf, ion: Opiizionion) -> bool: """pply fix lin lnh ion (siplifi)""" # his is  plhol - l iplnion woul fo o slf.lo.info( f"Woul fix lin lnh in {ion.fil}: {ion.sipion}" ) un u # Pn suss syn f pplyosin(slf, ion: Opiizionion) -> bool: """pply  osin ion (siplifi)""" # his is  plhol - l iplnion woul  ppopi osins slf.lo.info( f"Woul  osin o {ion.fil}: {ion.sipion}" ) un u # Pn suss syn f unuonoousopiizion(slf, xions: in = 5) -> i[s, ny]: """un uonoous opiizion yl""" slf.lo.info("Sin uonoous opiizion yl...") # nlyz posioy is = wi slf.nlyzposioy() # n opiizion pln ions = wi slf.nopiizionpln(is) # pply op ions ppliions = [] sussfulions = 0 fo ion in ions[:xions]: slf.lo.info(f"pplyin opiizion: {ion.sipion}") sul = wi slf.pplyopiizion(ion) ppliions.ppn(sul) if sul.suss: sussfulions += 1 # Sll ly bwn ions wi synio.slp(0.1) # n suy suy = { "isp": i.now().isofo(), "is": { "ooplxiy": is.ooplxiy, "pfonso": is.pfonso, "ininbiliyinx": is.ininbiliyinx, "opiizionoppouniis": is.opiizionoppouniis, }, "ionsplnn": ln(ions), "ionsppli": ln(ppliions), "ionssussful": sussfulions, "suls": [si(sul) fo sul in ppliions], } # xpo suls wi slf.xpoopiizionsuls(suy) slf.lo.info( f"uonoous opiizion opl: {sussfulions}/{ln(ppliions)} ions sussful" ) un suy syn f xpoopiizionsuls(slf, suy: i[s, ny]): """xpo opiizion suls o fil""" filn = ( f"opiizionsuls{i.now().sfi('%Y%%%H%%S')}.json" ) wih opn(filn, "w") s f: json.up(suy, f, inn=2, ful=s) slf.lo.info(f"Opiizion suls xpo o {filn}") f opiizionhisoy(slf) -> Lis[i]: """ hisoy of opiizion ions""" un [si(sul) fo sul in slf.opiizionhisoy] syn f in(): """in funion fo uonoous posioy opiizion""" pin(" L.I.F.. Plfo - posioy Slf-Opiizion Sys") pin("=" * 60) opiiz = LIFposioySlfOpiiz() y: # un uonoous opiizion pin(" nlyzin posioy...") suls = wi opiiz.unuonoousopiizion(xions=3) pin("\n Opiizion Suy:") pin(f" o oplxiy: {suls['is']['ooplxiy']:.2f}") pin(f" Pfon So: {suls['is']['pfonso']:.2f}") pin( f" Oppouniis Foun: {suls['is']['opiizionoppouniis']}" ) pin(f" ions ppli: {suls['ionsppli']}") pin( f" Suss : {suls['ionssussful']}/{suls['ionsppli']}" ) if suls["suls"]: pin("\n ppli Opiizions:") fo sul in suls["suls"]: sus = " " if sul["suss"] ls " " pin(f" {sus} {sul['ion']['sipion']}") xp xpion s : pin(f" o: {}") if n == "in": synio.un(in())