# us/bin/nv pyhon3 """ PhysioN & Opn Sin   Insion Sys L.I.F. Plfo - l  Sn s suls Lo Suppos: - PhysioN BI opiion IV-2 (oo Iy) - PhysioN Slp-F (Slp sin) - PhysioN - ouplin - OpnNuo  ss - uso F/SV uplos opyih 2025 - Sio Py Boull zu pl Off I: 960096-f1-420b-902-042561b """ ipo synio ipo json ipo loin ipo os ipo pfil fo lsss ipo si, lss fo i ipo i y: fo phlib ipo Ph xp Ipoo s : pin(f'Wnin: {}') pss fo ypin ipo i, Lis, Opionl, upl ipo nupy s np ipo quss fo sipy ipo sinl # Sup loin os.is("los", xiso=u) loin.bsionfi( lvl=loin.INFO, fo="%(si)s - %(n)s - %(lvln)s - %(ss)s", ) lo = loin.Lo(n) @lss lss s: """ s """ n: s sou: s # physion, opnnuo, lol subji: s sssion: s hnnls: in splin: flo uionsons: flo fo: s # f, sv, npy linilnos: s = "" sul: s = "" @lss lss Snsul: """Ins  sn sul""" s: s wsinl: np.ny # Shp: (hnnls, spls) posssinl: np.ny quliyis: i fqunynlysis: i ifion: i isp: s filph: s lss PhysioNInso: """PhysioN & Opn Sin   Insion""" # PhysioN s ULs PHYSIONSS = { "biiv2": { "ulbs": "hps://physion.o/fils/ib/1.0.0", "sipion": "BI opiion IV-2: oo Iy ", "subjs": 9, "hnnls": 22, "splin": 250, }, "slpf": { "ulbs": "hps://physion.o/fils/slp-fx/1.0.0", "sipion": "Slp-F: Slp sin wih ", "subjs": 197, "hnnls": 2, "splin": 100, }, "ouplin": { "ulbs": "hps://physion.o/fils/ib/1.0.0", "sipion": "- ouplin uin s", "subjs": 109, "hnnls": 64, "splin": 256, }, "psizu": { "ulbs": "hps://physion.o/fils/hbi/1.0.0", "sipion": "Sizu  (HB-I slp )", "subjs": 24, "hnnls": 23, "splin": 256, }, "plunivsiysizu": { "ulbs": "hps://physion.o/fils/uh/1.0.0", "sipion": "pl Univsiy Hospil ", "subjs": 109, "hnnls": 21, "splin": 250, }, } f ini(slf): slf.pi = pfil.p(pfix="physion") slf.hi = Ph("physionh") y: slf.hi.i(xiso=u) xp xpion s : os.is(hi, xiso=u) lo.info(f"PhysioN Inso iniiliz. h: {slf.hi}") syn f ownlos( slf, sn: s, subji: in = 1, sssion: in = 1 ) -> Opionl[bys]: """ownlo   fo PhysioN""" if sn no in slf.PHYSIONSS: lo.o(f"Unnown s: {sn}") un Non sinfo = slf.PHYSIONSS[sn] lo.info(f"ownloin {sn}: {sinfo['sipion']}") y: if sn == "biiv2": un wi slf.ownlobiiv2(subji, sssion) lif sn == "slpf": un wi slf.ownloslpf(subji) lif sn == "ouplin": un wi slf.ownlo(subji) lif sn == "psizu": un wi slf.ownlohbi(subji) lif sn == "plunivsiysizu": un wi slf.ownlouh(subji) xp xpion s : lo.o(f"ownlo fil: {}") un Non syn f ownlobiiv2(slf, subj: in, sssion: in) -> Opionl[bys]: """ownlo BI opiion IV-2 """ ul = ( f"{slf.PHYSIONSS['biiv2']['ulbs']}/S{subj:03}/" f"S{subj:03}{sssion:02}.f" ) y: lo.info(f"Fhin: {ul}") spons = quss.(ul, iou=60) spons.isfosus() lo.info(f"ownlo {ln(spons.onn)} bys") un spons.onn xp quss.qusxpion s : lo.o(f"Fil o ownlo fo {ul}: {}") un Non syn f ownloslpf(slf, subj: in) -> Opionl[bys]: """ownlo Slp-F """ # Slp-F suu: slp-ss/S4nnn0-PS.f o S4nnn-PS.f ul = ( f"{slf.PHYSIONSS['slpf']['ulbs']}/slp-ss/" f"S4{subj:03}0-PS.f" ) y: lo.info(f"Fhin Slp-F: {ul}") spons = quss.(ul, iou=60) spons.isfosus() un spons.onn xp quss.qusxpion s : lo.o(f"Fil o ownlo Slp-F: {}") un Non syn f ownlo(slf, subj: in) -> Opionl[bys]: """ownlo - ouplin """ ul = ( f"{slf.PHYSIONSS['ouplin']['ulbs']}/S{subj:03}/" f"S{subj:03}02.f" ) y: lo.info(f"Fhin -: {ul}") spons = quss.(ul, iou=60) spons.isfosus() un spons.onn xp quss.qusxpion s : lo.o(f"Fil o ownlo -: {}") un Non syn f ownlohbi(slf, subj: in) -> Opionl[bys]: """ownlo HB-I Sizu """ ul = ( f"{slf.PHYSIONSS['psizu']['ulbs']}/hb{subj:02}/" f"hb{subj:02}01.f" ) y: lo.info(f"Fhin HB-I: {ul}") spons = quss.(ul, iou=60) spons.isfosus() un spons.onn xp quss.qusxpion s : lo.o(f"Fil o ownlo HB-I: {}") un Non syn f ownlouh(slf, subj: in) -> Opionl[bys]: """ownlo pl Univsiy Hospil """ # UH suu o oplx, usin siplifi ph ul = ( f"{slf.PHYSIONSS['plunivsiysizu']['ulbs']}/" f"v/bnol/01pl/000/{subj:06}.f" ) y: lo.info(f"Fhin UH: {ul}") spons = quss.(ul, iou=60) spons.isfosus() un spons.onn xp quss.qusxpion s : lo.o(f"Fil o ownlo UH: {}") un Non f psffil( slf, filph: s, hnnls: Opionl[Lis[in]] = Non ) -> upl[np.ny, i]: """Ps F fil n x  """ y: fo pyflib ipo f  = f(filph) #  sinl info nsinls = .sinlsinfil sinllbls = .SinlLbls() lo.info(f"F fil hs {nsinls} sinls: {sinllbls}") # x  hnnls (ypilly lbl wih  pfix) hnnlsix = [ i fo i, lbl in nu(sinllbls) if "" in lbl.upp() ] if no hnnlsix: # Fllb: us fis hnnls hnnlsix = lis(n(in(22, nsinls))) if hnnls: hnnlsix = hnnlsix[: ln(hnnls)] #  sinls  = [] fo ix in hnnlsix: sinl = .Sinl(ix) .ppn(sinl) .los() y = np.y() #    = { "nhnnls": ln(), "olsinls": nsinls, "sinllbls": sinllbls, "hnnls": [sinllbls[i] fo i in hnnlsix], "uions": .filuion, "splin": .SplFquny(hnnlsix[0]), } lo.info(f"Ps F: {}") un y,  xp Ipoo: lo.o("pyflib no insll. Insll wih: pip insll pyflib") un Non, Non xp xpion s : lo.o(f"Fil o ps F: {}") un Non, Non f posssinl( slf, wsinl: np.ny, splin: flo = 250 ) -> i: """Poss w  sinl""" suls = {} y: # 1. Quliy ssssn suls["quliy"] = slf.sssssinlquliy(wsinl) # 2. Fquny nlysis suls["fquny"] = slf.nlyzfqunybns( wsinl, splin ) # 3. if ion suls["ifs"] = slf.ifs(wsinl) # 4. Sinl possin suls["poss"] = slf.pplyfils(wsinl, splin) lo.info( f"Sinl possin opl. Quliy: {suls['quliy']['so']:.2f}" ) xp xpion s : lo.o(f"Sinl possin o: {}") un suls f sssssinlquliy(slf, sinl: np.ny) -> i: """ssss  sinl quliy""" is = {} # Sinl-o-nois io siion sinls = np.sq(np.n(sinl**2)) noiss = np.sq(np.n(np.iff(sinl) ** 2)) / np.sq(2) is["snb"] = 20 * np.lo10(sinls / (noiss + 1-10)) # P-o-p vol is["popuv"] = np.x(sinl) - np.in(sinl) # Sinl vin is["vin"] = np.v(sinl) # So ou of 100 snso = in(100, x(0, (is["snb"] + 20) * 2)) ppso = 100 if 10 < is["popuv"] < 300 ls 50 vso = in(100, is["vin"] / 10) is["so"] = (snso + ppso + vso) / 3 is["in"] = ( "xlln" if is["so"] > 80 ls ( "oo" if is["so"] > 60 ls "Fi" if is["so"] > 40 ls "Poo" ) ) un is f nlyzfqunybns( slf, sinl: np.ny, splin: flo ) -> i: """nlyz  fquny bns""" # opu FF fqs = np.ff.fffq(ln(sinl), 1 / splin) ffvls = np.bs(np.ff.ff(sinl)) # fin bns bns = { "l": (0.5, 4), # p slp "h": (4, 8), # owsinss "lph": (8, 12), # lxion "b": (12, 30), # lnss "": (30, 100), # oniion } suls = {} olpow = np.su(ffvls**2) fo bnn, (low, hih) in bns.is(): s = (fqs >= low) & (fqs <= hih) bnpow = np.su(ffvls[s] ** 2) suls[f"{bnn}powpn"] = 100 * bnpow / olpow suls[f"{bnn}pfq"] = ( fqs[np.x(ffvls[s])] if np.ny(s) ls 0 ) un suls f ifs(slf, sinl: np.ny) -> i: """ oon  ifs""" ifs = {} # y blins: hih pliu ps hshol = 5 * np.s(sinl) blinoun = np.su(np.bs(sinl) > hshol) ifs["blinvns"] = in(blinoun) ifs["blinpn"] = 100 * blinoun / ln(sinl) # usl ifs: hih-fquny buss # Sipl: h fo susin hih vin in 15-30 Hz hihfq = sinl.hilb(sinl[::10]) uslpow = np.n(np.bs(hihfq) ** 2) ifs["uslifpow"] = flo(uslpow) # Lin nois (50/60 Hz) fqs = np.ff.fffq(ln(sinl), 1 / 250) ffvls = np.bs(np.ff.ff(sinl)) lins = ((fqs > 49) & (fqs < 51)) | ((fqs > 59) & (fqs < 61)) linnois = np.su(ffvls[lins] ** 2) ifs["linnoispsn"] = linnois > np.n(ffvls**2) * 10 un ifs f pplyfils(slf, sinl: np.ny, splin: flo) -> i: """pply sn  fils""" # Bnpss 0.5-40 Hz (sn ) nyquis = splin / 2 low = 0.5 / nyquis hih = 40 / nyquis # sin II Buwoh fil b,  = sinl.bu(4, [low, hih], byp="bn") fil = sinl.filfil(b, , sinl) un { "filsinl": fil.olis()[:1000], # Fis 1000 spls "filyp": "Buwoh 4h o", "fqunynhz": "0.5-40", "sffil": flo(np.sq(np.n(fil**2))), } lss OpnNuoInso: """OpnNuo (BIS-oplin)  s Insion""" OPNNUOSS = { "s002778": {"n": "oo Iy Pilo", "subjs": 2}, "s003505": {"n": "Nuoypil ", "subjs": 17}, "s001810": {"n": "Woin oy", "subjs": 26}, } syn f ownlos(slf, si: s) -> Opionl[s]: """ownlo OpnNuo BIS s""" if si no in slf.OPNNUOSS: lo.o(f"Unnown OpnNuo s: {si}") un Non ul = f"hps://opnnuo.o/n/ss/{si}" lo.info(f"OpnNuo s {si} vilbl : {ul}") lo.info("Us WS LI o syn: ws s3 syn --no-sin-qus ...") un ul lss Foonv: """onv bwn iffn   fos""" @siho f nupyosv( : np.ny, oupuph: s, hnnlns: Opionl[Lis[s]] = Non ): """onv nupy y o SV""" if hnnlns is Non: hnnlns = [f"H{i+1}" fo i in n(.shp[0])] f = np.vs([hnnlns[:, Non], .]) np.svx(oupuph, f, lii=",", f="%s", h="hnnls") lo.info(f"xpo o SV: {oupuph}") @siho f nupyonpy(: np.ny, oupuph: s): """Sv nupy y o NPY fo""" np.sv(oupuph, ) lo.info(f"xpo o NPY: {oupuph}") @siho f svonupy(svph: s, siph: in = 1) -> np.ny: """Lo SV o nupy y"""  = np.lox(svph, lii=",", sipows=siph) lo.info(f"Lo SV: {svph}, shp: {.shp}") un  syn f in(): """o: Ins n poss l  """ inso = PhysioNInso() pin("\n" + "=" * 80) pin(" L.I.F.. PhysioN & Opn Sin   Insion Sys") pin("=" * 80) # vilbl ss pin("\n vilbl PhysioN ss:") fo n, info in inso.PHYSIONSS.is(): pin( f" • {n}: {info['sipion']}" f" ({info['subjs']} subjs, {info['hnnls']} hnnls)" ) pin("\n vilbl OpnNuo ss:") fo si, info in OpnNuoInso.OPNNUOSS.is(): pin(f" • {si}: {info['n']} ({info['subjs']} subjs)") # xpl: ownlo BI IV-2  pin("\n xpl: ownloin BI opiion IV-2 (Subj 1, Sssion 1)...")  = wi inso.ownlos("biiv2", subji=1, sssion=1) if : # Sv o p fil pfil = os.ph.join(inso.pi, "spl.f") wih opn(pfil, "wb") s f: f.wi() # Ps F pin(f"\n Psin F fil: {pfil}") y,  = inso.psffil(pfil) if y is no Non: pin(f" Sussfully lo  : {y.shp}") pin(f" : {json.ups(, inn=2)}") # Poss sinl pin("\n Possin  sinl...") possinsuls = inso.posssinl( y[0], splin=["splin"] ) pin("\n Possin suls:") pin(f" Quliy So: {possinsuls['quliy']['so']:.2f}/100") pin(f" Quliy in: {possinsuls['quliy']['in']}") pin(f" SN: {possinsuls['quliy']['snb']:.2f} B") pin( f" P-o-P: {possinsuls['quliy']['popuv']:.2f} µV" ) pin("\n Fquny nlysis:") fo bn, pow in possinsuls["fquny"].is(): if "pn" in bn: pin(f" {bn}: {pow:.2f}%") pin("\n if ion:") pin(f" Blins: {possinsuls['ifs']['blinvns']}") pin( f" Blin Pn: {possinsuls['ifs']['blinpn']:.2f}%" ) pin( f" Lin Nois: {possinsuls['ifs']['linnoispsn']}" ) pin("\n" + "=" * 80) pin(" PhysioN/OpnNuo insion opl!") pin("=" * 80) if n == "in": synio.un(in())