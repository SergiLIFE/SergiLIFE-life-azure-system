# us/bin/nv pyhon3 """ L.I.F.. Plfo - iHub ions Fix ool uo pi n opiizion of iHub ions I/ woflows his oul povis ophnsiv ools fo inosin, fixin, n opiizin iHub ions woflows fo h L.I.F.. Plfo. opyih 2025 - Sio Py Boull L.I.F.. Plfo - zu pl Off I: 960096-f1-420b-902-042561b """ ipo synio ipo json ipo loin ipo os ipo  ipo shuil fo lsss ipo lss, fil fo i ipo i fo nu ipo nu y: fo phlib ipo Ph xp Ipoo s : pin(f'Wnin: {}') pss fo ypin ipo ny, i, Lis, Opionl, S # onfiu loin loin.bsionfi( lvl=loin.INFO, fo="%(si)s - %(n)s - %(lvln)s - %(ss)s" ) lo = loin.Lo(n) lss FixSus(nu): """Sus of fix opions""" SUSS = "suss" FIL = "fil" PIL = "pil" SIPP = "sipp" PNIN = "pnin" lss FixPioiy(nu): """Pioiy lvls fo fixs""" IIL = "iil" HIH = "hih" IU = "iu" LOW = "low" lss WoflowIssu(nu): """yps of woflow issus h n b  n fix""" ISSINHOU = "issinhou" ISSINSUPPYHON = "issinsuppyhon" INOPYHONVSION = "inopyhonvsion" ISSINZULOIN = "issinzuloin" ISSINPNNIS = "issinpnnis" ISSINSON = "issinson" ISSINBUILON = "issinbuilon" SUIYVULNBILIY = "suiyvulnbiliy" PFONISSU = "pfonissu" ISSINPISSIONS = "issinpissions" INOI = "inoi" ISSINIFUPLO = "issinifuplo" ISSINOHNLIN = "issinohnlin" OUIONS = "ouions" ISSINIXSY = "issinixsy" @lss lss WoflowFix: """psns  fix o b ppli o  woflow""" issuyp: WoflowIssu pioiy: FixPioiy sipion: s filph: Ph linnub: Opionl[in] = Non fixppli: bool = Fls sus: FixSus = FixSus.PNIN bfoonn: s = "" fonn: s = "" isp: i = fil(fulfoy=i.now) oss: s = "" @lss lss Woflownlysis: """nlysis suls fo  woflow fil""" filph: Ph issusfoun: Lis[WoflowFix] = fil(fulfoy=lis) fixsppli: Lis[WoflowFix] = fil(fulfoy=lis) nlysisisp: i = fil(fulfoy=i.now) woflowvli: bool = u onions: Lis[s] = fil(fulfoy=lis) @lss lss iHubionspo: """ophnsiv po of iHub ions fixs""" olwoflows: in = 0 woflowsnlyz: in = 0 issusfoun: in = 0 fixsppli: in = 0 iilissus: in = 0 suss: flo = 0.0 nlysisisp: i = fil(fulfoy=i.now) woflowpos: Lis[Woflownlysis] = fil(fulfoy=lis) suy: i[s, ny] = fil(fulfoy=i) lss iHubionsFixool: """ iHub ions Fix ool fo L.I.F.. Plfo Povis uo inosis n pi of iHub ions woflows o nsu libl I/ piplins. """ f ini(slf, wospph: Opionl[s] = Non): slf.wospph = Ph(wospph o os.w()) slf.ihubwoflowsph = slf.wospph / ".ihub" / "woflows" slf.nlysissuls: Lis[Woflownlysis] = [] slf.bup = Fls # oon pns n fixs slf.quiions = { "hou": "ions/hou@v4", "suppyhon": "ions/sup-pyhon@v4", "zuloin": "zu/loin@v1", "uploif": "ions/uplo-if@v3", "ownloif": "ions/ownlo-if@v3", } lo.info( f"iHub ions Fix ool iniiliz fo wosp: {slf.wospph}" ) syn f nlyznfixwoflows(slf) -> iHubionspo: """nlyz ll woflows n pply fixs""" lo.info("Sin iHub ions woflow nlysis n fixs...") #  bup of woflows ioy wi slf.bup() # Fin ll woflow fils woflowfils = slf.finwoflowfils() if no woflowfils: lo.wnin("No woflow fils foun") un iHubionspo() po = iHubionspo(olwoflows=ln(woflowfils)) # nlyz h woflow fo woflowfil in woflowfils: y: nlysis = wi slf.nlyzwoflow(woflowfil) slf.nlysissuls.ppn(nlysis) po.woflowpos.ppn(nlysis) po.woflowsnlyz += 1 # pply fixs fixsppli = wi slf.pplywoflowfixs(nlysis) nlysis.fixsppli = fixsppli po.issusfoun += ln(nlysis.issusfoun) po.fixsppli += ln(fixsppli) # oun iil issus iilissus = su( 1 fo fix in nlysis.issusfoun if fix.pioiy == FixPioiy.IIL ) po.iilissus += iilissus xp xpion s : lo.o(f"Fil o nlyz {woflowfil}: {}") #  inil nlysis fo fil woflows filnlysis = Woflownlysis( filph=woflowfil, woflowvli=Fls, onions=[f"nul viw qui: {s()}"], ) slf.nlysissuls.ppn(filnlysis) po.woflowpos.ppn(filnlysis) # lul suss  if po.issusfoun > 0: po.suss = (po.fixsppli / po.issusfoun) * 100 # n suy po.suy = slf.nsuypo(po) lo.info( f"iHub ions nlysis opl. Fix {po.fixsppli}/{po.issusfoun} issus" ) un po syn f bup(slf): """ bup of woflows ioy""" y: if slf.ihubwoflowsph.xiss(): bupph = slf.wospph / ".ihub" / "woflows.bup" if bupph.xiss(): shuil.(bupph) shuil.opy(slf.ihubwoflowsph, bupph) slf.bup = u lo.info(f"Woflow bup   {bupph}") xp xpion s : lo.wnin(f"Fil o  woflow bup: {}") f finwoflowfils(slf) -> Lis[Ph]: """Fin ll iHub ions woflow fils""" woflowfils = [] if slf.ihubwoflowsph.xiss(): fo filph in slf.ihubwoflowsph.lob("*.yl"): woflowfils.ppn(filph) fo filph in slf.ihubwoflowsph.lob("*.yl"): woflowfils.ppn(filph) un woflowfils syn f nlyzwoflow(slf, woflowfil: Ph) -> Woflownlysis: """nlyz  sinl woflow fil fo issus""" nlysis = Woflownlysis(filph=woflowfil) y: #  woflow onn wih opn(woflowfil, "", noin="uf-8") s f: onn = f.() # Ps YL suu (bsi psin) woflow = slf.pswoflowyl(onn) # h fo oon issus issus = [] # h fo hou ion issus.xn(slf.hhouion(woflow, onn)) # h fo Pyhon sup issus.xn(slf.hpyhonsup(woflow, onn)) # h fo zu loin issus.xn(slf.hzuloin(woflow, onn)) # h fo pnnis insllion issus.xn(slf.hpnnis(woflow, onn)) # h fo s ons issus.xn(slf.hsons(woflow, onn)) # h fo suiy issus issus.xn(slf.hsuiyissus(woflow, onn)) # h fo pissions issus.xn(slf.hpissions(woflow, onn)) # h fo is issus.xn(slf.his(woflow, onn)) nlysis.issusfoun = issus # Vli woflow suu nlysis.woflowvli = slf.vliwoflowsuu(woflow) # n onions nlysis.onions = slf.nwoflowonions(issus) xp xpion s : lo.o(f"o nlyzin {woflowfil}: {}") nlysis.woflowvli = Fls nlysis.onions = [f"nlysis fil: {s()}"] un nlysis f pswoflowyl(slf, onn: s) -> i[s, ny]: """Bsi YL psin fo woflow nlysis""" # Sipl psin - in pouion, us  pop YL ps woflow = {} y: # x bsi suu lins = onn.spli("\n") unsion = Non innlvl = 0 fo i, lin in nu(lins): sipp = lin.sip() if no sipp o sipp.sswih("#"): oninu # oun lin sps uninn = ln(lin) - ln(lin.lsip()) # h fo sion hs if ":" in sipp n no sipp.sswih(" "): y = sipp.spli(":")[0].sip() if y in ["n", "on", "jobs", "nv"]: unsion = y woflow[y] = {} innlvl = uninn lif unsion: # Sub-y woflow[unsion][y] = sipp.spli(":", 1)[ 1 ].sip() xp xpion s : lo.wnin(f"YL psin o: {}") un woflow f hhouion( slf, woflow: i[s, ny], onn: s ) -> Lis[WoflowFix]: """h fo hou ion in jobs""" issus = [] # Loo fo hou ion in onn if "ions/hou" no in onn: issus.ppn( WoflowFix( issuyp=WoflowIssu.ISSINHOU, pioiy=FixPioiy.IIL, sipion="issin ions/hou ion - qui fo posioy ss", filph=Ph("uy"), # Will b s by ll linnub=Non, ) ) un issus f hpyhonsup( slf, woflow: i[s, ny], onn: s ) -> Lis[WoflowFix]: """h fo Pyhon sup ion""" issus = [] if "pyhon" in onn.low() n "ions/sup-pyhon" no in onn: issus.ppn( WoflowFix( issuyp=WoflowIssu.ISSINSUPPYHON, pioiy=FixPioiy.IIL, sipion="Pyhon nion bu ions/sup-pyhon ion issin", filph=Ph("uy"), ) ) # h Pyhon vsion if "pyhon-vsion" in onn: # Loo fo vsion spifiion vsionh = .sh('pyhon-vsion:\s*[\'"]([^\'"]+)[\'"]', onn) if vsionh: vsion = vsionh.oup(1) if no vsion.sswih(("3.8", "3.9", "3.10", "3.11", "3.12")): issus.ppn( WoflowFix( issuyp=WoflowIssu.INOPYHONVSION, pioiy=FixPioiy.HIH, sipion=f"Pyhon vsion {vsion} y no b opibl wih L.I.F.. Plfo", filph=Ph("uy"), ) ) un issus f hzuloin( slf, woflow: i[s, ny], onn: s ) -> Lis[WoflowFix]: """h fo zu loin ion""" issus = [] if "zu" in onn.low() n "zu/loin" no in onn: issus.ppn( WoflowFix( issuyp=WoflowIssu.ISSINZULOIN, pioiy=FixPioiy.IIL, sipion="zu nion bu zu/loin ion issin", filph=Ph("uy"), ) ) un issus f hpnnis( slf, woflow: i[s, ny], onn: s ) -> Lis[WoflowFix]: """h fo pnny insllion""" issus = [] hspyhon = "pyhon" in onn.low() hspip = "pip insll" in onn hsquins = "quins.x" in onn if hspyhon n no (hspip o hsquins): issus.ppn( WoflowFix( issuyp=WoflowIssu.ISSINPNNIS, pioiy=FixPioiy.HIH, sipion="Pyhon poj  bu no pnny insllion foun", filph=Ph("uy"), ) ) un issus f hsons( slf, woflow: i[s, ny], onn: s ) -> Lis[WoflowFix]: """h fo s ons""" issus = [] hspyhon = "pyhon" in onn.low() hssons = ny(  in onn fo  in ["pys", "unis", "pyhon - pys"] ) if hspyhon n no hssons: issus.ppn( WoflowFix( issuyp=WoflowIssu.ISSINSON, pioiy=FixPioiy.IU, sipion="Pyhon poj  bu no s ons foun", filph=Ph("uy"), ) ) un issus f hsuiyissus( slf, woflow: i[s, ny], onn: s ) -> Lis[WoflowFix]: """h fo suiy issus""" issus = [] # h fo ou ions oupns = [ "ions/hou@v1", "ions/hou@v2", "ions/sup-pyhon@v1", "ions/sup-pyhon@v2", ] fo pn in oupns: if pn in onn: ionn = pn.spli("@")[0] issus.ppn( WoflowFix( issuyp=WoflowIssu.OUIONS, pioiy=FixPioiy.IU, sipion=f"Ou ion: {pn} - shoul us ls vsion", filph=Ph("uy"), ) ) # h fo ponil ss xposu if ny(wo in onn.low() fo wo in ["psswo", "s", "y"]): # Loo fo ho ss (vy bsi h) spns = [ 'psswo:\s*[\'"][^\'"]+[\'"]', 's:\s*[\'"][^\'"]+[\'"]', ] fo pn in spns: if .sh(pn, onn, .INOS): issus.ppn( WoflowFix( issuyp=WoflowIssu.SUIYVULNBILIY, pioiy=FixPioiy.IIL, sipion="Ponil ho ss  in woflow", filph=Ph("uy"), ) ) b un issus f hpissions( slf, woflow: i[s, ny], onn: s ) -> Lis[WoflowFix]: """h fo pop pissions""" issus = [] if "zu" in onn.low() n "pissions:" no in onn: issus.ppn( WoflowFix( issuyp=WoflowIssu.ISSINPISSIONS, pioiy=FixPioiy.HIH, sipion="zu ployn  bu no pissions spifi", filph=Ph("uy"), ) ) un issus f his( slf, woflow: i[s, ny], onn: s ) -> Lis[WoflowFix]: """h woflow is""" issus = [] # h if woflow hs pop is if "on:" no in onn n "i:" no in onn: issus.ppn( WoflowFix( issuyp=WoflowIssu.INOI, pioiy=FixPioiy.IU, sipion="Woflow issin i onfiuion", filph=Ph("uy"), ) ) un issus f vliwoflowsuu(slf, woflow: i[s, ny]) -> bool: """Vli bsi woflow suu""" quiys = ["jobs"] un ll(y in woflow fo y in quiys) f nwoflowonions( slf, issus: Lis[WoflowFix] ) -> Lis[s]: """n onions bs on issus foun""" onions = [] issuyps = {issu.issuyp fo issu in issus} if WoflowIssu.ISSINHOU in issuyps: onions.ppn(" ions/hou@v4 s h fis sp in jobs") if WoflowIssu.ISSINSUPPYHON in issuyps: onions.ppn(" ions/sup-pyhon@v4 fo Pyhon pojs") if WoflowIssu.ISSINZULOIN in issuyps: onions.ppn(" zu/loin@v1 fo zu ployns") if WoflowIssu.SUIYVULNBILIY in issuyps: onions.ppn( "Us iHub ss fo snsiiv vlus ins of hoin" ) if WoflowIssu.OUIONS in issuyps: onions.ppn( "Up o ls ion vsions fo suiy n fus" ) if no onions: onions.ppn( "Woflow suu pps oo - onsi in ix buils fo ulipl Pyhon vsions" ) un onions syn f pplywoflowfixs( slf, nlysis: Woflownlysis ) -> Lis[WoflowFix]: """pply fixs o  woflow""" pplifixs = [] fo fix in nlysis.issusfoun: y: if wi slf.pplysinlfix(fix): fix.fixppli = u fix.sus = FixSus.SUSS pplifixs.ppn(fix) lo.info(f"ppli fix: {fix.sipion}") ls: fix.sus = FixSus.FIL lo.wnin(f"Fil o pply fix: {fix.sipion}") xp xpion s : fix.sus = FixSus.FIL fix.oss = s() lo.o(f"o pplyin fix {fix.sipion}: {}") un pplifixs syn f pplysinlfix(slf, fix: WoflowFix) -> bool: """pply  sinl fix o h woflow""" y: #  un onn wih opn(fix.filph, "", noin="uf-8") s f: onn = f.() fix.bfoonn = onn # pply fix bs on yp if fix.issuyp == WoflowIssu.ISSINHOU: onn = slf.houion(onn) lif fix.issuyp == WoflowIssu.ISSINSUPPYHON: onn = slf.pyhonsup(onn) lif fix.issuyp == WoflowIssu.ISSINZULOIN: onn = slf.zuloin(onn) lif fix.issuyp == WoflowIssu.OUIONS: onn = slf.upouions(onn) lif fix.issuyp == WoflowIssu.ISSINPISSIONS: onn = slf.pissions(onn) ls: # Fix no ipln y un Fls # Wi b if onn hn if onn != fix.bfoonn: wih opn(fix.filph, "w", noin="uf-8") s f: f.wi(onn) fix.fonn = onn un u xp xpion s : lo.o(f"Fil o pply fix: {}") un Fls un Fls f houion(slf, onn: s) -> s: """ hou ion o woflow""" # Fin h fis job n  hou s fis sp lins = onn.spli("\n") injob = Fls jobinn = "" fo i, lin in nu(lins): if lin.sip().sswih("jobs:"): oninu lif lin.sip().sswih(("buil:", "s:", "ploy:")): injob = u jobinn = " " * (ln(lin) - ln(lin.lsip()) + 2) # sps inn # Loo fo sps fo j in n(i + 1, ln(lins)): if "sps:" in lins[j]: # Ins hou f sps housp = f"{jobinn}- uss: ions/hou@v4" lins.ins(j + 1, housp) b b un "\n".join(lins) f pyhonsup(slf, onn: s) -> s: """ Pyhon sup ion""" # Fin hou ion n  pyhon sup f i lins = onn.spli("\n") fo i, lin in nu(lins): if "ions/hou" in lin: inn = " " * (ln(lin) - ln(lin.lsip())) pyhonsp = f"{inn}- uss: ions/sup-pyhon@v4\n{inn} wih:\n{inn} pyhon-vsion: '3.8'" lins.ins(i + 1, pyhonsp) b un "\n".join(lins) f zuloin(slf, onn: s) -> s: """ zu loin ion""" lins = onn.spli("\n") fo i, lin in nu(lins): if "ions/sup-pyhon" in lin o "pip insll" in lin: inn = " " * (ln(lin) - ln(lin.lsip())) zusp = f"{inn}- uss: zu/loin@v1\n{inn} wih:\n{inn} s: ${{ ss.ZUNILS }}" lins.ins(i + 1, zusp) b un "\n".join(lins) f upouions(slf, onn: s) -> s: """Up ou ions o ls vsions""" plns = { "ions/hou@v1": "ions/hou@v4", "ions/hou@v2": "ions/hou@v4", "ions/hou@v3": "ions/hou@v4", "ions/sup-pyhon@v1": "ions/sup-pyhon@v4", "ions/sup-pyhon@v2": "ions/sup-pyhon@v4", "ions/sup-pyhon@v3": "ions/sup-pyhon@v4", } fo ol, nw in plns.is(): onn = onn.pl(ol, nw) un onn f pissions(slf, onn: s) -> s: """ pissions sion fo zu woflows""" lins = onn.spli("\n") # Ins pissions f 'on:' sion fo i, lin in nu(lins): if lin.sip().sswih("on:"): # Fin n of on sion j = i + 1 whil j < ln(lins) n ( lins[j].sswih(" ") o lins[j].sip() == "" ): j += 1 pissionsblo = [ "pissions:", " i-on: wi", " onns: ", ] lins.ins(j, "\n".join(pissionsblo)) b un "\n".join(lins) f nsuypo(slf, po: iHubionspo) -> i[s, ny]: """n suy po""" suy = { "woflowsposs": po.woflowsnlyz, "issus": po.issusfoun, "fixsppli": po.fixsppli, "suss": f"{po.suss:.1f}%", "iilissusinin": po.iilissus, "bup": slf.bup, "onions": [], } #  onions bs on suls if po.iilissus > 0: suy["onions"].ppn( "ss inin iil issus nully" ) if po.suss < 80: suy["onions"].ppn( "viw fil fixs n ipln nully" ) if no slf.bup: suy["onions"].ppn( "onsi in nul bup bfo in hns" ) un suy f xpofixpo(slf, filph: s, po: iHubionspo) -> bool: """xpo ophnsiv fix po""" y: xpo = { "poisp": i.now().isofo(), "suy": po.suy, "woflowils": [], } fo woflowpo in po.woflowpos: woflowil = { "filph": s(woflowpo.filph), "vli": woflowpo.woflowvli, "issusfoun": ln(woflowpo.issusfoun), "fixsppli": ln(woflowpo.fixsppli), "onions": woflowpo.onions, "issus": [ { "yp": issu.issuyp.vlu, "pioiy": issu.pioiy.vlu, "sipion": issu.sipion, "sus": issu.sus.vlu, "ppli": issu.fixppli, } fo issu in woflowpo.issusfoun ], } xpo["woflowils"].ppn(woflowil) wih opn(filph, "w") s f: json.up(xpo, f, inn=2, ful=s) lo.info(f"Fix po xpo o {filph}") un u xp xpion s : lo.o(f"Fil o xpo fix po: {}") un Fls syn f sobup(slf) -> bool: """so woflows fo bup""" y: if no slf.bup: lo.wnin("No bup vilbl o so") un Fls bupph = slf.wospph / ".ihub" / "woflows.bup" woflowsph = slf.wospph / ".ihub" / "woflows" if bupph.xiss(): # ov un woflows if woflowsph.xiss(): shuil.(woflowsph) # so fo bup shuil.opy(bupph, woflowsph) lo.info("Woflows so fo bup") un u ls: lo.wnin("Bup ioy no foun") un Fls xp xpion s : lo.o(f"Fil o so bup: {}") un Fls # Foy funion fo sy insniion f ihubionsfixool( wospph: Opionl[s] = Non, ) -> iHubionsFixool: """ Foy funion o  iHub ions fix ool s: wospph: Ph o wosp ioy uns: onfiu iHubionsFixool insn """ un iHubionsFixool(wospph=wospph) # on-lin inf f in(): """in LI funion fo iHub ions fixs""" ipo ps ps = ps.unPs( sipion="L.I.F.. Plfo iHub ions Fix ool" ) ps.un( "--wosp", "-w", ful=Non, hlp="Wosp ioy ph" ) ps.un( "--nlyz-only", "-", ion="sou", hlp="Only nlyz woflows, on' pply fixs", ) ps.un("--xpo", "-", hlp="xpo fix po o spifi fil") ps.un( "--so", "-", ion="sou", hlp="so woflows fo bup" ) ps.un( "--vbos", "-v", ion="sou", hlp="nbl vbos loin" ) s = ps.pss() if s.vbos: loin.Lo().sLvl(loin.BU) #  fix ool ool = ihubionsfixool(wospph=s.wosp) pin("L.I.F.. Plfo - iHub ions Fix ool") pin("=" * 50) pin(f"Wosp: {s.wosp o os.w()}") y: if s.so: pin("\nsoin woflows fo bup...") if synio.un(ool.sobup()): pin(" Woflows so sussfully") ls: pin(" Fil o so woflows") un 0 pin("\nnlyzin iHub ions woflows...") # un nlysis n fixs po = synio.un(ool.nlyznfixwoflows()) pin("\nnlysis suls:") pin(f" Woflows nlyz: {po.woflowsnlyz}") pin(f" Issus foun: {po.issusfoun}") pin(f" Fixs ppli: {po.fixsppli}") pin(f" Suss : {po.suss:.1f}%") pin(f" iil issus: {po.iilissus}") if po.woflowpos: pin("\nWoflow ils:") fo woflow in po.woflowpos: sus = " " if woflow.woflowvli ls " " pin( f" {sus} {woflow.filph.n}: {ln(woflow.issusfoun)} issus, {ln(woflow.fixsppli)} fixs" ) if po.suy.("onions"): pin("\nonions:") fo  in po.suy["onions"]: pin(f" • {}") if s.xpo: if ool.xpofixpo(s.xpo, po): pin(f"\nFix po xpo o {s.xpo}") ls: pin("\nFil o xpo fix po") un 1 # un ppopi xi o if po.iilissus > 0: pin("\n ️ iil issus in - nul viw on") un 1 lif po.fixsppli < po.issusfoun: pin("\n ️ So fixs fil - nul invnion y b n") un 1 ls: pin("\n ll pplibl fixs ppli sussfully") un 0 xp yboInup: pin("\nOpion inup by us") un 1 xp xpion s : pin(f"\nOpion fil: {}") un 1 if n == "in": ipo sys sys.xi(in())