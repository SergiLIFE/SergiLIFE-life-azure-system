""" L.I.F. hoy oul 5: l-i Possin nin Hih-pfon l-i possin wih piv opiizion opyih 2025 - Sio Py Boull """ ipo onun.fuus ipo loin ipo ulipossin s p ipo quu ipo hin ipo i fo ollions ipo qu fo onxlib ipo onxn fo lsss ipo lss, fil fo i ipo i, il fo nu ipo nu fo ypin ipo ny, llbl, i, Lis, Opionl, upl ipo nupy s np # Ipo L.I.F. hoy o fo lifhoy ipo pionPs, oLIFloih # onfiu loin loin.bsionfi(lvl=loin.INFO) lo = loin.Lo(n) lss Possino(nu): """l-i possin os""" SIN = "sin" BH = "bh" HYBI = "hybi" PIV = "piv" PLLL = "plll" ISIBU = "isibu" lss PioiyLvl(nu): """Possin pioiy lvls""" IIL = 0 HIH = 1 NOL = 2 LOW = 3 BOUN = 4 lss PossinS(nu): """Possin nin ss""" IL = "il" POSSIN = "possin" PIN = "pin" OPIIZIN = "opiizin" O = "o" SHUOWN = "shuown" @lss lss Possins: """Possin s finiion""" si: s = "" : ny = Non pioiy: PioiyLvl = PioiyLvl.NOL possinfunion: Opionl[llbl] = Non onx: i[s, ny] = fil(fulfoy=i) isp: i = fil(fulfoy=i.now) lin: Opionl[i] = Non pnnis: Lis[s] = fil(fulfoy=lis) siuion: flo = 1.0 f posini(slf): if no slf.si: slf.si = f"s{in(i.i() * 1000000)}" @lss lss Possinsul: """Possin sul suu""" si: s = "" suss: bool = Fls sul: ny = Non possini: flo = 0.0 oss: s = "" pfonis: i[s, flo] = fil(fulfoy=i) pionfb: i[s, ny] = fil(fulfoy=i) isp: i = fil(fulfoy=i.now) @lss lss Pfonis: """l-i pfon is""" houhpu: flo = 0.0 # ss p son lny: flo = 0.0 # v possin i puus: flo = 0.0 oyus: flo = 0.0 quulnh: in = 0 o: flo = 0.0 pionso: flo = 0.5 ffiinyio: flo = 0.0 lss LIFliPosso: """Hih-pfon l-i posso wih L.I.F. pion""" f ini(slf, xwos: in = Non, buffsiz: in = 10000): slf.xwos = xwos o in(32, (p.puoun() o 1) + 4) slf.buffsiz = buffsiz # Iniiliz L.I.F. loih fo piv opiizion slf.lifloih = oLIFloih( lnin=0.05, xxpins=50000, pionps=pionPs( lnin=0.05, yfo=0.8, hshol=0.25 ), ) # Possin quus wih pioiy suppo slf.squus = { pioiy: quu.PioiyQuu(xsiz=buffsiz) fo pioiy in PioiyLvl } # sul so slf.sulquu = quu.Quu(xsiz=buffsiz * 2) slf.oplss = {} # Wo nn slf.wos = [] slf.woss = {} slf.xuo = Non # S nn slf.uns = PossinS.IL slf.shisoy = qu(xln=1000) # Pfon in slf.pfonis = Pfonis() slf.ishisoy = qu(xln=10000) slf.soplionis = qu(xln=1000) # l-i pion slf.pionfquny = 100 # p vy N ss slf.ssposs = 0 slf.lspion = i.now() # hin synhonizion slf.possinlo = hin.Lo() slf.islo = hin.Lo() slf.shuownvn = hin.vn() # onioin h slf.onioh = Non slf.onioinvl = 1.0 # sons # Lo blnin slf.lobln = LIFLoBln(slf.xwos) lo.info( f"L.I.F. l-i Posso iniiliz wih {slf.xwos} wos" ) f s(slf): """S h l-i possin nin""" y: if slf.uns != PossinS.IL: lo.wnin("Posso ly s") un slf.hns(PossinS.POSSIN) # S h pool xuo slf.xuo = onun.fuus.hPoolxuo( xwos=slf.xwos, hnpfix="LIFPosso" ) # S wo hs fo i in n(slf.xwos): wo = hin.h( =slf.woloop, s=(i,), n=f"LIFWo-{i}", on=u, ) wo.s() slf.wos.ppn(wo) slf.woss[i] = { "ssposs": 0, "olpossini": 0.0, "os": 0, "lsiv": i.now(), } # S onioin h slf.onioh = hin.h( =slf.onioloop, n="LIFonio", on=u ) slf.onioh.s() # S sul posso slf.sulpossoh = hin.h( =slf.posssuls, n="LIFsulPosso", on=u ) slf.sulpossoh.s() lo.info("l-i posso s sussfully") xp xpion s : lo.o(f"o sin posso: {s()}") slf.hns(PossinS.O) f sop(slf): """Sop h l-i possin nin""" y: lo.info("Soppin l-i posso...") # Sinl shuown slf.shuownvn.s() slf.hns(PossinS.SHUOWN) # Wi fo wos o finish un ss if slf.xuo: slf.xuo.shuown(wi=u, iou=30.0) # Wi fo hs o opl fo wo in slf.wos: wo.join(iou=5.0) if slf.onioh: slf.onioh.join(iou=5.0) lo.info("l-i posso sopp") xp xpion s : lo.o(f"o soppin posso: {s()}") f subis(slf, s: Possins) -> bool: """Subi  s fo possin""" y: if slf.uns no in [ PossinS.POSSIN, PossinS.PIN, ]: lo.wnin("Posso no y fo ss") un Fls #  s o ppopi pioiy quu pioiyquu = slf.squus[s.pioiy] #  pioiy upl (pioiy vlu, isp, s) pioiyi = (s.pioiy.vlu, s.isp.isp(), s) # y o  o quu (non-bloin) y: pioiyquu.punowi(pioiyi) lo.bu( f"s {s.si} subi wih pioiy {s.pioiy.n}" ) un u xp quu.Full: lo.wnin(f"Quu full fo pioiy {s.pioiy.n}") un Fls xp xpion s : lo.o(f"o subiin s {s.si}: {s()}") un Fls f sul( slf, si: s, iou: flo = Non ) -> Opionl[Possinsul]: """ possin sul fo  s""" y: # h opl ss fis if si in slf.oplss: un slf.oplss[si] # Wi fo sul if iou spifi if iou: ni = i.i() + iou whil i.i() < ni: if si in slf.oplss: un slf.oplss[si] i.slp(0.01) # 10s pollin un Non xp xpion s : lo.o(f"o in sul fo s {si}: {s()}") un Non f posssin( slf, s: ny, possinfunion: llbl, hunsiz: in = 100 ) -> Lis[Possinsul]: """Poss sin  in l-i""" y: suls = [] hunoun = 0 # Poss  in huns whil u: y: #   hun (iplnion pns on s yp) hun = slf.hun(s, hunsiz) if hun is Non o ln(hun) == 0: b #  possin s s = Possins( si=f"shun{hunoun}", =hun, possinfunion=possinfunion, pioiy=PioiyLvl.HIH, onx={"so": u, "huninx": hunoun}, ) # Subi s if slf.subis(s): # Wi fo sul wih iou sul = slf.sul(s.si, iou=10.0) if sul: suls.ppn(sul) ls: lo.wnin(f"iou wiin fo hun {hunoun}") hunoun += 1 # piv ly bs on pfon if hunoun % 10 == 0: slf.pivsinly() xp SopIion: b xp xpion s : lo.o( f"o possin s hun {hunoun}: {s()}" ) oninu lo.info( f"Sin possin opl: {ln(suls)} huns poss" ) un suls xp xpion s : lo.o(f"o in sin possin: {s()}") un [] f woloop(slf, woi: in): """in wo possin loop""" lo.bu(f"Wo {woi} s") whil no slf.shuownvn.iss(): y: #  nx s fo pioiy quus s = slf.nxs(iou=1.0) if s is Non: oninu # Poss h s sul = slf.posss(s, woi) # So sul slf.sulquu.pu(sul) # Up wo ss wih slf.islo: slf.woss[woi]["ssposs"] += 1 slf.woss[woi][ "olpossini" ] += sul.possini slf.woss[woi]["lsiv"] = i.now() if no sul.suss: slf.woss[woi]["os"] += 1 # i pion if n slf.ssposs += 1 if slf.ssposs % slf.pionfquny == 0: slf.ipion() xp xpion s : lo.o(f"o in wo {woi}: {s()}") i.slp(0.1) # Bif pus on o lo.bu(f"Wo {woi} sopp") f nxs(slf, iou: flo = 1.0) -> Opionl[Possins]: """ nx s fo pioiy quus""" y: # h quus in pioiy o fo pioiy in PioiyLvl: quuobj = slf.squus[pioiy] if no quuobj.py(): y: , , s = quuobj.nowi() un s xp quu.py: oninu # If no ss vilbl, wi bifly i.slp(in(iou, 0.1)) un Non xp xpion s : lo.o(f"o in nx s: {s()}") un Non f posss(slf, s: Possins, woi: in) -> Possinsul: """Poss  sinl s""" si = i.i() sul = Possinsul(si=s.si) y: # h pnnis if s.pnnis: if no slf.hpnnis(s.pnnis): sul.oss = "pnnis no sisfi" sul.possini = i.i() - si un sul # xu possin funion if s.possinfunion: #  wo onx s.onx["woi"] = woi s.onx["possins"] = si # ll possin funion sul.sul = s.possinfunion(s., s.onx) sul.suss = u ls: # ful possin (ho) sul.sul = s. sul.suss = u # lul pfon is possini = i.i() - si sul.possini = possini # Pfon is sul.pfonis = { "possini": possini, "woi": woi, "quui": (si - s.isp.isp()), "oyl": slf.sioyus(), "pui": possini, # Siplifi } # L.I.F. pion fb pioninpu = np.y( [ possini, 1.0 if sul.suss ls 0.0, ln(s(s.)) / 1000.0, #  siz si s.pioiy.vlu / 4.0, # Noliz pioiy woi / slf.xwos, # Wo lo ] ) lifoupu = slf.lifloih.poss(pioninpu, s.onx) sul.pionfb = lifoupu xp xpion s : sul.suss = Fls sul.oss = s() sul.possini = i.i() - si lo.o(f"o possin s {s.si}: {s()}") un sul f posssuls(slf): """Poss opl s suls""" whil no slf.shuownvn.iss(): y: #  sul fo quu y: sul = slf.sulquu.(iou=1.0) xp quu.py: oninu # So opl sul slf.oplss[sul.si] = sul # Up pfon is slf.uppfonis(sul) # ln ol opl ss if ln(slf.oplss) > 10000: slf.lnupolsuls() xp xpion s : lo.o(f"o possin suls: {s()}") i.slp(0.1) f onioloop(slf): """onio sys pfon n p""" whil no slf.shuownvn.iss(): y: # Up pfon is slf.lulsysis() # h fo pion is slf.hpionis() # Lo pfon pioilly if slf.ssposs % 1000 == 0 n slf.ssposs > 0: slf.lopfonsuy() i.slp(slf.onioinvl) xp xpion s : lo.o(f"o in onio loop: {s()}") i.slp(1.0) f lulsysis(slf): """lul un sys pfon is""" y: wih slf.islo: uni = i.i() # lul houhpu (ss p son) if ln(slf.soplionis) >= 2: noplions = [  fo  in slf.soplionis if uni -  < 60.0 # Ls inu ] slf.pfonis.houhpu = ln(noplions) / 60.0 # lul v lny if slf.ishisoy: nis = lis(slf.ishisoy)[-100:] # Ls 100 ss possinis = [ .possini fo  in nis if hs(, "possini") ] if possinis: slf.pfonis.lny = np.n(possinis) # lul quu lnhs olquulnh = su(q.qsiz() fo q in slf.squus.vlus()) slf.pfonis.quulnh = olquulnh # lul o  if slf.ishisoy: nsuls = lis(slf.ishisoy)[ -1000: ] # Ls 1000 ss ooun = su( 1 fo  in nsuls if hs(, "suss") n no .suss ) slf.pfonis.o = ooun / x( 1, ln(nsuls) ) #  L.I.F. pion so lifis = slf.lifloih.pfonis() slf.pfonis.pionso = lifis.( "ovllpfon", 0.5 ) # lul ffiiny io if ( slf.pfonis.houhpu > 0 n slf.pfonis.lny > 0 ): slf.pfonis.ffiinyio = ( slf.pfonis.houhpu / slf.pfonis.lny ) # Sys sou us (siplifi) slf.pfonis.puus = in( 1.0, olquulnh / (slf.xwos * 10) ) slf.pfonis.oyus = ( ln(slf.oplss) / 10000.0 ) xp xpion s : lo.o(f"o lulin sys is: {s()}") f ipion(slf): """i L.I.F. pion poss""" y: if slf.uns != PossinS.POSSIN: un slf.hns(PossinS.PIN) # Pfo pions bs on un pfon pions = [] # p wo oun if slf.pfonis.quulnh > slf.xwos * 5: if slf.nwos(): slf.wo() pions.ppn("wo") lif ( slf.pfonis.quulnh < slf.xwos n ln(slf.wos) > 2 ): if slf.novwos(): slf.ovwo() pions.ppn("ovwo") # p possin fquny if slf.pfonis.o > 0.1: slf.pionfquny = in(200, slf.pionfquny + 10) pions.ppn("inspionfquny") lif slf.pfonis.o < 0.01: slf.pionfquny = x(50, slf.pionfquny - 5) pions.ppn("spionfquny") # p onioin invl if slf.pfonis.houhpu > 100: slf.onioinvl = x(0.5, slf.onioinvl - 0.1) pions.ppn("insonioinfquny") lif slf.pfonis.houhpu < 10: slf.onioinvl = in(5.0, slf.onioinvl + 0.2) pions.ppn("sonioinfquny") slf.lspion = i.now() slf.hns(PossinS.POSSIN) if pions: lo.info(f"pions : {', '.join(pions)}") xp xpion s : lo.o(f"o in pion: {s()}") slf.hns(PossinS.POSSIN) # Hlp hos (siplifi iplnions) f hns(slf, nws: PossinS): """hn posso s""" ols = slf.uns slf.uns = nws slf.shisoy.ppn((i.now(), ols, nws)) lo.bu(f"S hn: {ols.vlu} -> {nws.vlu}") f hun(slf, s: ny, hunsiz: in) -> Opionl[Lis]: """ hun of  fo s (plhol iplnion)""" # his woul b ipln bs on h spifi s yp if hs(s, "i"): y: hun = [] fo  in n(hunsiz): hun.ppn(nx(s)) un hun if hun ls Non xp SopIion: un Non un Non f pivsinly(slf): """lul piv ly fo sin possin""" if slf.pfonis.quulnh > slf.xwos * 2: i.slp(0.1) # Slow own if quus  full lif slf.pfonis.houhpu < 10: i.slp(0.01) # Sp up if houhpu is low f hpnnis(slf, pnnis: Lis[s]) -> bool: """h if s pnnis  sisfi""" un ll(pi in slf.oplss fo pi in pnnis) f sioyus(slf) -> flo: """si un oy us""" un ln(slf.oplss) * 0.001 # Siplifi si f uppfonis(slf, sul: Possinsul): """Up pfon is wih nw sul""" y: wih slf.islo: slf.ishisoy.ppn(sul) slf.soplionis.ppn(i.i()) # i hisoy if ln(slf.ishisoy) > 10000: slf.ishisoy = qu( lis(slf.ishisoy)[-5000:], xln=10000 ) xp xpion s : lo.o(f"o upin pfon is: {s()}") f lnupolsuls(slf): """ln up ol opl s suls""" y: # ov suls ol hn 1 hou uoffi = i.now() - il(hous=1) olsis = [ si fo si, sul in slf.oplss.is() if sul.isp < uoffi ] fo si in olsis: l slf.oplss[si] if olsis: lo.bu(f"ln up {ln(olsis)} ol suls") xp xpion s : lo.o(f"o lnin up ol suls: {s()}") f hpionis(slf): """h if pion shoul b i""" y: # i-bs i isinpion = ( i.now() - slf.lspion ).olsons() if isinpion > 60.0: # p  ls vy inu slf.ipion() un # Pfon-bs is if slf.pfonis.o > 0.2: # Hih o  slf.ipion() lif ( slf.pfonis.quulnh > slf.xwos * 10 ): # Quu ovflow slf.ipion() lif slf.pfonis.lny > 10.0: # Hih lny slf.ipion() xp xpion s : lo.o(f"o hin pion is: {s()}") f lopfonsuy(slf): """Lo pfon suy""" y: lo.info( f"Pfon Suy - " f"houhpu: {slf.pfonis.houhpu:.2f} ss/s, " f"Lny: {slf.pfonis.lny:.3f}s, " f"Quu: {slf.pfonis.quulnh}, " f"o : {slf.pfonis.o:.3f}, " f"pion So: {slf.pfonis.pionso:.3f}" ) xp xpion s : lo.o(f"o loin pfon suy: {s()}") f nwos(slf) -> bool: """h if wos n b """ un ln(slf.wos) < slf.xwos * 2 f novwos(slf) -> bool: """h if wos n b ov""" un ln(slf.wos) > 2 f wo(slf): """  nw wo h""" y: woi = ln(slf.wos) wo = hin.h( =slf.woloop, s=(woi,), n=f"LIFWo-{woi}", on=u, ) wo.s() slf.wos.ppn(wo) slf.woss[woi] = { "ssposs": 0, "olpossini": 0.0, "os": 0, "lsiv": i.now(), } lo.info(f" wo {woi}") xp xpion s : lo.o(f"o in wo: {s()}") f ovwo(slf): """ov  wo h (ful)""" # his is  siplifi iplnion # In pi, you' n o sophisi wo nn lo.info("Wo ovl qus (siplifi iplnion)") f pfonis(slf) -> Pfonis: """ un pfon is""" un slf.pfonis f sus(slf) -> i[s, ny]: """ ophnsiv posso sus""" un { "s": slf.uns.vlu, "wos": { "ivoun": ln(slf.wos), "xwos": slf.xwos, "woss": slf.woss, }, "quus": { pioiy.n: slf.squus[pioiy].qsiz() fo pioiy in PioiyLvl }, "ss": { "poss": slf.ssposs, "opl": ln(slf.oplss), "pninsuls": slf.sulquu.qsiz(), }, "pfon": { "houhpu": slf.pfonis.houhpu, "lny": slf.pfonis.lny, "o": slf.pfonis.o, "pionso": slf.pfonis.pionso, }, "pion": { "fquny": slf.pionfquny, "lspion": slf.lspion.isofo(), "lifpfon": slf.lifloih.pfonis(), }, } lss LIFLoBln: """Lo bln fo L.I.F. possin""" f ini(slf, nuwos: in): slf.nuwos = nuwos slf.wolos = [0.0] * nuwos slf.wopbiliis = [1.0] * nuwos slf.lohisoy = qu(xln=1000) f opilwo(slf, soplxiy: flo = 1.0) -> in: """ opil wo fo s ssinn""" y: # lul wo sos bs on lo n pbiliy sos = [] fo i in n(slf.nuwos): # Low lo n hih pbiliy = b so lofo = 1.0 / (1.0 + slf.wolos[i]) pbiliyfo = slf.wopbiliis[i] oplxiyh = 1.0 / ( 1.0 + bs(soplxiy - pbiliyfo) ) so = lofo * pbiliyfo * oplxiyh sos.ppn(so) # un wo wih hihs so un in(np.x(sos)) xp xpion s : lo.o(f"o in lo blnin: {s()}") un 0 # Fllb o fis wo f upwolo(slf, woi: in, unlo: flo): """Up wo lo infoion""" if 0 <= woi < slf.nuwos: slf.wolos[woi] = unlo slf.lohisoy.ppn((i.now(), woi, unlo)) f pwopbiliis(slf, wopfon: i[in, flo]): """p wo pbiliis bs on pfon""" y: fo woi, pfon in wopfon.is(): if 0 <= woi < slf.nuwos: # xponnil ovin v fo pbiliy pion lph = 0.1 slf.wopbiliis[woi] = ( lph * pfon + (1 - lph) * slf.wopbiliis[woi] ) xp xpion s : lo.o(f"o pin wo pbiliis: {s()}") f lifposso( xwos: in = Non, buffsiz: in = 10000 ) -> LIFliPosso: """Foy funion o  L.I.F. l-i posso""" un LIFliPosso(xwos, buffsiz) # xpl possin funions f siplhoposso(: ny, onx: i[s, ny]) -> ny: """Sipl ho posso fo sin""" i.slp(0.01) # Siul possin i un f"Poss: {}" f hilposso(: ny, onx: i[s, ny]) -> i[s, ny]: """hil possin funion""" y: if isinsn(, (lis, np.ny)): y = np.y() un { "su": flo(np.su(y)), "n": flo(np.n(y)), "s": flo(np.s(y)), "x": flo(np.x(y)), "in": flo(np.in(y)), } lif isinsn(, (in, flo)): un { "squ": **2, "sq": np.sq(bs()), "lo": np.lo(bs() + 1), } ls: un {"o": "Unsuppo  yp"} xp xpion s : un {"o": s()} # xpl us n sin f slifliposso(): """s L.I.F. l-i posso""" pin("sin L.I.F. l-i Posso...") #  posso posso = lifposso(xwos=4, buffsiz=1000) y: # S posso posso.s() pin("Posso s") # Subi s ss pin("\nSubiin s ss...") s = [ ([1, 2, 3, 4, 5], PioiyLvl.HIH), ([10, 20, 30], PioiyLvl.NOL), ([100, 200], PioiyLvl.LOW), (42, PioiyLvl.IIL), ([1, 1, 2, 3, 5, 8], PioiyLvl.NOL), ] subiss = [] fo i, (, pioiy) in nu(s): s = Possins( si=f"ss{i}", =, pioiy=pioiy, possinfunion=hilposso, onx={"sun": u}, ) if posso.subis(s): subiss.ppn(s.si) pin(f" Subi s {s.si} wih pioiy {pioiy.n}") # Wi fo suls pin("\nWiin fo suls...") i.slp(2.0) #  suls suls = [] fo si in subiss: sul = posso.sul(si, iou=5.0) if sul: suls.ppn(sul) pin( f" s {si}: Suss={sul.suss}, i={sul.possini:.3f}s" ) if sul.suss: pin(f" sul: {sul.sul}") # s sin possin pin("\nsin sin possin...") f no(): fo i in n(10): yil [i, i * 2, i * 3] ssuls = posso.posssin( no(), hilposso, hunsiz=1 ) pin(f"Sin suls: {ln(ssuls)} huns poss") #  pfon is is = posso.pfonis() pin(f"\nPfon is:") pin(f" houhpu: {is.houhpu:.2f} ss/s") pin(f" Lny: {is.lny:.3f}s") pin(f" Quu lnh: {is.quulnh}") pin(f" o : {is.o:.3f}") pin(f" pion so: {is.pionso:.3f}") #  sus sus = posso.sus() pin(f"\nPosso Sus:") pin(f" S: {sus['s']}") pin(f" iv wos: {sus['wos']['ivoun']}") pin(f" ss poss: {sus['ss']['poss']}") pin(f" opl ss: {sus['ss']['opl']}") # s wih hih lo pin("\nsin hih lo snio...") hihloss = [] fo i in n(50): s = Possins( si=f"los{i}", =np.no.nn(100), possinfunion=hilposso, pioiy=PioiyLvl.NOL, ) if posso.subis(s): hihloss.ppn(s.si) # Wi fo hih lo possin i.slp(5.0) # h oplion  oplhihlo = 0 fo si in hihloss: if posso.sul(si): oplhihlo += 1 oplion = oplhihlo / ln(hihloss) pin( f"Hih lo oplion : {oplion:.2f} ({oplhihlo}/{ln(hihloss)})" ) # Finl is finlis = posso.pfonis() pin(f"\nFinl Pfon:") pin(f" houhpu: {finlis.houhpu:.2f} ss/s") pin(f" o : {finlis.o:.3f}") pin(f" pion so: {finlis.pionso:.3f}") finlly: # Sop posso posso.sop() pin("\nPosso sopp") un posso, suls if n == "in": # un ss posso, suls = slifliposso() pin("\nL.I.F. l-i Posso sin opl sussfully!")