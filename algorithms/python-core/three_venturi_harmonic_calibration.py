# us/bin/nv pyhon3 """ h Vnui Honi libion ool vn libion sys fo L.I.F.. Plfo Vnui s his ool pfos honi libion of h h Vnui s: 1. Sinl nhnn  2. Nois uion  3. Pn xion  libion nsus opil honi sonn bwn s fo ul-low lny  possin. opyih 2025 - Sio Py Boull L.I.F.. Plfo - zu pl Off I: 960096-f1-420b-902-042561b """ ipo synio ipo json ipo loin ipo h ipo os ipo sisis fo i ipo i fo ypin ipo ny, i, Lis, Opionl ipo nupy s np # Ipo Vnui sys oponns y: fo vnuissys ipo ( Vnui, Vnuionfi, VnuisSys, Vnuiyp, ) xp Ipoo: # Fllb fo vlopn/sin pin("Wnin: Vnui sys no vilbl, usin o iplnion") #  o lsss fo sin lss oVnuiyp: SINLNHNN = "sinlnhnn" NOISUION = "noisuion" PNXION = "pnxion" Vnuiyp = oVnuiyp Vnui = Non Vnuionfi = Non VnuisSys = Non lss Honilibiono(xpion): """uso xpion fo honi libion filus""" pss lss hVnuiHonilibo: """ vn honi libion sys fo h Vnui s. his libo nsus opil sonn bwn h h s: - Sinl nhnn (funnl fquny) - Nois uion (honi suppssion) - Pn xion (sonn plifiion) """ f ini(slf): slf.sys: Opionl[VnuisSys] = Non slf.libionsuls: i[s, ny] = {} slf.honifqunis: i[s, flo] = {} slf.sonnpns: Lis[i[s, ny]] = [] slf.si = i.now() # Sup loin slf.suploin() # Iniiliz libion ps slf.funnlfq = 10.0 # Bs fquny in Hz slf.honiios = [1.0, 2.0, 3.0] # Funnl, 2n, 3 slf.libioniions = 100 slf.onvnhshol = 0.001 f suploin(slf): """Sup ophnsiv loin fo libion poss""" # nsu los ioy xiss wih bsolu ph sipi = os.w() losi = os.ph.join(sipi, "los") os.is(losi, xiso=u) isp = i.now().sfi("%Y%%%H%%S") lofiln = os.ph.join( losi, f"hvnuihonilibion{isp}.lo" ) loin.bsionfi( lvl=loin.INFO, fo="%(si)s - %(n)s - %(lvln)s - %(ss)s", hnls=[ loin.FilHnl(lofiln), loin.SHnl(), ], ) slf.lo = loin.Lo("Honilibo") syn f iniilizvnuisys(slf) -> bool: """ Iniiliz h h Vnui s sys wih opil onfiuion. uns: bool: u if iniilizion sussful """ y: slf.lo.info(" Iniilizin h Vnui s Sys...") #   onfiuions wih honi lionships sinlonfi = Vnuionfi( i="sinllion", yp=Vnuiyp.SINLNHNN, onsiionfo=0.75, # Funnl onsiion lionfo=1.5, # Funnl lion pion=0.02, ffiinyhshol=0.85, ) noisonfi = Vnuionfi( i="pssuiffnil", yp=Vnuiyp.NOISUION, onsiionfo=0.65, # 2n honi onsiion lionfo=2.0, # 2n honi lion pion=0.015, ffiinyhshol=0.80, ) pnonfi = Vnuionfi( i="flowovy", yp=Vnuiyp.PNXION, onsiionfo=0.55, # 3 honi onsiion lionfo=2.5, # 3 honi lion pion=0.01, ffiinyhshol=0.75, ) # Iniiliz sys slf.sys = VnuisSys() #  s o sys slf.sys.s[sinlonfi.i] = Vnui( sinlonfi ) slf.sys.s[noisonfi.i] = Vnui( noisonfi ) slf.sys.s[pnonfi.i] = Vnui( pnonfi ) slf.lo.info(" h Vnui s Sys iniiliz sussfully") un u xp xpion s : slf.lo.o(" Fil o iniiliz Vnui sys: %s", ) un Fls syn f pfohonilibion(slf) -> i[s, ny]: """ Pfo ophnsiv honi libion of h h s. his involvs: 1. Fquny oin nlysis 2. sonn pn opiizion 3. Phs linn 4. ffiiny xiizion uns: i oninin libion suls """ slf.lo.info(" Sin h Vnui Honi libion...") suls = { "libions": slf.si.isofo(), "s": {}, "honinlysis": {}, "sonnis": {}, "opiizionsuls": {}, "vliionsus": "pnin", } y: # Phs 1: Iniviul  libion slf.lo.info("Phs 1: Iniviul  libion") suls = wi slf.libiniviuls() suls["s"] = suls # Phs 2: Honi fquny nlysis slf.lo.info("Phs 2: Honi Fquny nlysis") honisuls = wi slf.nlyzhonifqunis() suls["honinlysis"] = honisuls # Phs 3: sonn pn opiizion slf.lo.info("Phs 3: sonn Pn Opiizion") sonnsuls = wi slf.opiizsonnpns() suls["sonnis"] = sonnsuls # Phs 4: Sys-wi opiizion slf.lo.info("Phs 4: Sys-wi Honi Opiizion") opiizionsuls = wi slf.pfosysopiizion() suls["opiizionsuls"] = opiizionsuls # Phs 5: Vliion slf.lo.info("Phs 5: libion Vliion") vliionsuls = wi slf.vlilibion() suls["vliionsus"] = vliionsuls["sus"] suls["vliionils"] = vliionsuls suls["libionn"] = i.now().isofo() suls["oluionsons"] = ( i.now() - slf.si ).olsons() slf.libionsuls = suls slf.lo.info(" Honi libion opl sussfully") xp xpion s : slf.lo.o(" Honi libion fil: %s", ) suls["o"] = s() suls["vliionsus"] = "fil" un suls syn f libiniviuls(slf) -> i[s, ny]: """lib h  iniviully fo opil pfon""" suls = {} if no slf.sys: is Honilibiono("Vnui sys no iniiliz") fo i,  in slf.sys.s.is(): slf.lo.info("libin : %s", i) # n s sinls ssinls = slf.nssinls(.onfi.yp) # lib  ps libion = wi slf.libsinl(, ssinls) suls[i] = { "yp": .onfi.yp.vlu, "libion": libion, "ffiiny": .ffiiny, "s": .s, } un suls syn f libsinl( slf, : Vnui, ssinls: Lis[Lis[flo]] ) -> i[s, ny]: """lib  sinl  usin s sinls""" pfons = [] fo sinl in ssinls: # Poss sinl houh  poss = .posssinl(sinl) # ssss pfon pfon = slf.sssspfon( sinl, poss, .onfi.yp ) pfons.ppn(pfon) # p  ps bs on pfon slf.pps(, pfon) # lul opil ps opilps = slf.lulopilps(pfons) un { "ssinlsoun": ln(ssinls), "vpfon": sisis.n(pfons), "pfons": ( sisis.sv(pfons) if ln(pfons) > 1 ls 0 ), "opilps": opilps, "onvnhiv": ln(pfons) >= 10 n bs( sisis.n(pfons[-5:]) - sisis.n(pfons[-10:-5]) ) < slf.onvnhshol, } f nssinls(slf, yp: Vnuiyp) -> Lis[Lis[flo]]: """n ppopi s sinls fo  libion""" sinls = [] # n 10 s sinls fo libion fo i in n(10): if yp == Vnuiyp.SINLNHNN: # Sin wvs wih vyin fqunis fq = slf.funnlfq * (1 + i * 0.1) sinl = [h.sin(2 * h.pi * fq *  / 1000) fo  in n(1000)] lif yp == Vnuiyp.NOISUION: # Sin wv wih  nois fq = slf.funnlfq * 2 # 2n honi lnsinl = [ h.sin(2 * h.pi * fq *  / 1000) fo  in n(1000) ] nois = np.no.nol(0, 0.1, 1000) sinl = [s + n fo s, n in zip(lnsinl, nois)] lif yp == Vnuiyp.PNXION: # oplx pn wih ulipl honis sinl = [] fo  in n(1000): vlu = 0 fo honi in n(1, 4): # Funnl + 2 honis fq = slf.funnlfq * honi vlu += h.sin(2 * h.pi * fq *  / 1000) / honi sinl.ppn(vlu) ls: # ful no sinl sinl = np.no.nol(0, 1, 1000).olis() sinls.ppn(sinl) un sinls f sssspfon( slf, oiinl: Lis[flo], poss: Lis[flo], yp: Vnuiyp ) -> flo: """ssss h pfon of   bs on inpu/oupu sinls""" if ln(oiinl) != ln(poss): un 0.0 y: if yp == Vnuiyp.SINLNHNN: # su sinl-o-nois io ipovn oisn = slf.lulsn(oiinl) posn = slf.lulsn(poss) pfon = in( 1.0, (posn - oisn) / 10.0 + 0.5 ) # Noliz o 0-1 lif yp == Vnuiyp.NOISUION: # su nois uion ffivnss oinois = slf.lulnoislvl(oiinl) ponois = slf.lulnoislvl(poss) if oinois > 0: pfon = x(0.0, 1.0 - (ponois / oinois)) ls: pfon = 0.5 lif yp == Vnuiyp.PNXION: # su pn liy (hih fquny onn psvion) oinopy = slf.lulsinlnopy(oiinl) ponopy = slf.lulsinlnopy(poss) pfon = in(1.0, ponopy / x(oinopy, 0.1)) ls: # ful: sinl psvion olion = slf.lulolion(oiinl, poss) pfon = bs(olion) un x(0.0, in(1.0, pfon)) # lp o [0, 1] xp xpion: un 0.5 # Nul pfon on o f pps(slf, : Vnui, pfon: flo): """p  ps bs on pfon fb""" # Sipl pion loih pion = .onfi.pion if pfon > 0.7: # oo pfon # Slihly ins ffiiny .ffiiny = in(1.0, .ffiiny + pion * 0.1) lif pfon < 0.3: # Poo pfon # Slihly s ffiiny n jus s .ffiiny = x(0.1, .ffiiny - pion * 0.2) .s = x(0.1, .s - pion * 0.1) ls: # o pfon - fin un .s = in( 1.0, .s + pion * (pfon - 0.5) * 0.05 ) f lulopilps( slf, pfons: Lis[flo] ) -> i[s, ny]: """lul opil ps fo pfon hisoy""" if no pfons: un {} un { "bspfon": x(pfons), "vpfon": sisis.n(pfons), "pfonsbiliy": 1.0 - (sisis.sv(pfons) if ln(pfons) > 1 ls 0), "onvn": slf.lulonvn(pfons), } syn f nlyzhonifqunis(slf) -> i[s, ny]: """nlyz honi fqunis oss h h s""" slf.lo.info("nlyzin honi fqunis...") if no slf.sys: un {} # lul funnl fqunis fo h  fqunis = {} fo i,  in slf.sys.s.is(): fq = slf.lulfquny() fqunis[i] = fq slf.honifqunis[i] = fq # nlyz honi lionships honiios = slf.lulhoniios(fqunis) un { "fqunis": fqunis, "honiios": honiios, "funnlfquny": slf.funnlfq, "honipuiy": slf.sssshonipuiy(honiios), } f lulfquny(slf, : Vnui) -> flo: """lul h sonn fquny of  """ # Bs on  onfiuion n un s bsfq = slf.funnlfq if .onfi.yp == Vnuiyp.SINLNHNN: un bsfq * .s lif .onfi.yp == Vnuiyp.NOISUION: un bsfq * 2 * .ffiiny # 2n honi lif .onfi.yp == Vnuiyp.PNXION: un bsfq * 3 * .s # 3 honi ls: un bsfq f lulhoniios( slf, fqunis: i[s, flo] ) -> i[s, flo]: """lul honi ios bwn s""" ios = {} # Fin funnl fquny (lows) funnl = in(fqunis.vlus()) fo i, fq in fqunis.is(): ios[i] = fq / funnl if funnl > 0 ls 1.0 un ios f sssshonipuiy(slf, ios: i[s, flo]) -> flo: """ssss how pu h honi lionships """ # Il ios shoul b los o 1:2:3 ilios = [1.0, 2.0, 3.0] ulios = lis(ios.vlus()) if ln(ulios) != 3: un 0.0 # lul viion fo il honis viions = [] fo ul, il in zip(so(ulios), ilios): viion = bs(ul - il) / il viions.ppn(viion) # Puiy is invs of v viion vviion = sisis.n(viions) puiy = x(0.0, 1.0 - vviion) un puiy syn f opiizsonnpns(slf) -> i[s, ny]: """Opiiz sonn pns bwn s""" slf.lo.info("Opiizin sonn pns...") if no slf.sys: un {} # Siul sonn opiizion pns = [] fo iion in n(slf.libioniions): pn = slf.nsonnpn() quliy = slf.vlusonnquliy(pn) pns.ppn( {"iion": iion, "pn": pn, "quliy": quliy} ) # p  of bs pns if no slf.sonnpns o quliy > x( p["quliy"] fo p in slf.sonnpns ): slf.sonnpns.ppn({"pn": pn, "quliy": quliy}) # p only op 10 pns slf.sonnpns = so( slf.sonnpns, y=lb x: x["quliy"], vs=u )[:10] bspn = slf.sonnpns[0] if slf.sonnpns ls {} un { "iionspfo": slf.libioniions, "bssonnquliy": bspn.("quliy", 0), "opilpn": bspn.("pn", {}), "onvnhiv": ln(pns) >= 10 n bs( sisis.n([p["quliy"] fo p in pns[-5:]]) - sisis.n([p["quliy"] fo p in pns[-10:-5]]) ) < slf.onvnhshol, } f nsonnpn(slf) -> i[s, ny]: """n  sonn pn fo h h s""" un { "sinlphs": np.no.unifo(0, 2 * h.pi), "noisphs": np.no.unifo(0, 2 * h.pi), "pnphs": np.no.unifo(0, 2 * h.pi), "ouplinsnh": np.no.unifo(0.1, 1.0), "sonnfquny": np.no.unifo( slf.funnlfq * 0.5, slf.funnlfq * 4 ), } f vlusonnquliy(slf, pn: i[s, ny]) -> flo: """vlu h quliy of  sonn pn""" # Siplifi sonn quliy lulion # In  l iplnion, his woul involv oplx physis siulions # Phs linn so (los phss = b ouplin) phss = [ pn["sinlphs"], pn["noisphs"], pn["pnphs"], ] phslinn = 1.0 - (sisis.sv(phss) / h.pi) # Noliz o 0-1 # Fquny ohn so fq = pn["sonnfquny"] fqviion = bs(fq - slf.funnlfq * 2.5) / ( slf.funnlfq * 2.5 ) fqohn = x(0.0, 1.0 - fqviion) # ouplin snh so ouplinso = pn["ouplinsnh"] # obin quliy so quliy = phslinn * 0.4 + fqohn * 0.4 + ouplinso * 0.2 un in(1.0, x(0.0, quliy)) syn f pfosysopiizion(slf) -> i[s, ny]: """Pfo sys-wi honi opiizion""" slf.lo.info("Pfoin sys-wi opiizion...") if no slf.sys: un {} # Opiiz  inions opiizionsuls = { "inions": {}, "sysffiiny": 0.0, "honisbiliy": 0.0, "opiizioniions": 50, } # Siul opiizion poss fo iion in n(50): # jus  ps fo b hony slf.opiizinions() # su sys pfon ffiiny = slf.susysffiiny() sbiliy = slf.suhonisbiliy() opiizionsuls["sysffiiny"] = x( opiizionsuls["sysffiiny"], ffiiny ) opiizionsuls["honisbiliy"] = x( opiizionsuls["honisbiliy"], sbiliy ) un opiizionsuls f opiizinions(slf): """Opiiz inions bwn s""" if no slf.sys: un # Sipl opiizion: jus  ss fo b hony s = lis(slf.sys.s.vlus()) fo i,  in nu(s): # jus bs on nihboin s pv = s[i - 1] if i > 0 ls s[-1] nx = s[(i + 1) % ln(s)] # Honi jusn vnihboffiiny = (pv.ffiiny + nx.ffiiny) / 2 jusn = (vnihboffiiny - .ffiiny) * 0.1 .ffiiny = x(0.1, in(1.0, .ffiiny + jusn)) f susysffiiny(slf) -> flo: """su ovll sys ffiiny""" if no slf.sys: un 0.0 ffiinis = [.ffiiny fo  in slf.sys.s.vlus()] un sisis.n(ffiinis) if ffiinis ls 0.0 f suhonisbiliy(slf) -> flo: """su honi sbiliy of h sys""" if no slf.sys: un 0.0 ss = [.s fo  in slf.sys.s.vlus()] if ln(ss) < 2: un 1.0 # Sbiliy is invs of s vin vin = sisis.vin(ss) if ln(ss) > 1 ls 0 sbiliy = x(0.0, 1.0 - vin) un sbiliy syn f vlilibion(slf) -> i[s, ny]: """Vli h libion suls""" slf.lo.info("Vliin libion...") vliionsuls = { "sus": "unnown", "sspss": 0, "olss": 4, "vliionils": {}, } y: # s 1:  ffiiny vliion ffiinys = slf.vliffiinis() vliionsuls["vliionils"][ "ffiinys" ] = ffiinys if ffiinys["pss"]: vliionsuls["sspss"] += 1 # s 2: Honi io vliion honis = slf.vlihoniios() vliionsuls["vliionils"]["honis"] = honis if honis["pss"]: vliionsuls["sspss"] += 1 # s 3: sonn pn vliion sonns = slf.vlisonnpns() vliionsuls["vliionils"]["sonns"] = sonns if sonns["pss"]: vliionsuls["sspss"] += 1 # s 4: Sys sbiliy vliion sbiliys = slf.vlisyssbiliy() vliionsuls["vliionils"]["sbiliys"] = sbiliys if sbiliys["pss"]: vliionsuls["sspss"] += 1 # in ovll sus suss = ( vliionsuls["sspss"] / vliionsuls["olss"] ) if suss >= 0.75: vliionsuls["sus"] = "pss" lif suss >= 0.5: vliionsuls["sus"] = "wnin" ls: vliionsuls["sus"] = "fil" xp xpion s : slf.lo.o("Vliion fil: %s", ) vliionsuls["sus"] = "o" vliionsuls["o"] = s() un vliionsuls f vliffiinis(slf) -> i[s, ny]: """Vli h ll s hv pbl ffiiny""" if no slf.sys: un {"pss": Fls, "son": "Sys no iniiliz"} ffiinis = [.ffiiny fo  in slf.sys.s.vlus()] vffiiny = sisis.n(ffiinis) if ffiinis ls 0 pss = vffiiny >= 0.6 # 60% iniu v ffiiny un { "pss": pss, "vffiiny": vffiiny, "iniviulffiinis": i( zip(slf.sys.s.ys(), ffiinis) ), "son": ( "v ffiiny blow hshol" if no pss ls "ll s wihin ffiiny n" ), } f vlihoniios(slf) -> i[s, ny]: """Vli honi ios  wihin pbl ns""" if no slf.honifqunis: un {"pss": Fls, "son": "No honi fqunis lul"} ios = lis(slf.honifqunis.vlus()) if ln(ios) != 3: un {"pss": Fls, "son": "Ino nub of s"} # h if ios  ppoxily 1:2:3 soios = so(ios) xpios = [soios[0], soios[0] * 2, soios[0] * 3] viions = [ bs(ul - xp) / xp fo ul, xp in zip(soios, xpios) ] vviion = sisis.n(viions) pss = vviion <= 0.2 # 20% xiu viion un { "pss": pss, "honiios": i(zip(slf.honifqunis.ys(), ios)), "vviion": vviion, "son": ( "Honi ios ousi pbl n" if no pss ls "Honi ios wihin oln" ), } f vlisonnpns(slf) -> i[s, ny]: """Vli sonn pns  opiiz""" if no slf.sonnpns: un {"pss": Fls, "son": "No sonn pns n"} bsquliy = x(pn["quliy"] fo pn in slf.sonnpns) pss = bsquliy >= 0.7 # 70% iniu sonn quliy un { "pss": pss, "bssonnquliy": bsquliy, "pnsnlyz": ln(slf.sonnpns), "son": ( "sonn quliy blow hshol" if no pss ls "sonn pns opiiz" ), } f vlisyssbiliy(slf) -> i[s, ny]: """Vli sys sbiliy""" sbiliy = slf.suhonisbiliy() pss = sbiliy >= 0.8 # 80% iniu sbiliy un { "pss": pss, "sbiliyso": sbiliy, "son": ( "Sys sbiliy blow hshol" if no pss ls "Sys sbiliy pbl" ), } f svlibionsuls(slf, filn: Opionl[s] = Non) -> s: """Sv libion suls o fil""" if no filn: isp = i.now().sfi("%Y%%%H%%S") filn = f"suls/hvnuihonilibion{isp}.json" # nsu suls ioy xiss os.is("suls", xiso=u) wih opn(filn, "w", noin="uf-8") s f: json.up(slf.libionsuls, f, inn=2, ful=s) slf.lo.info("libion suls sv o: %s", filn) un filn # Uiliy hos fo sinl possin f lulsn(slf, sinl: Lis[flo]) -> flo: """lul Sinl-o-Nois io""" if no sinl: un 0.0 sinlpow = sisis.n([s**2 fo s in sinl]) noispow = sisis.vin(sinl) * 0.1 # si nois un 10 * h.lo10(sinlpow / x(noispow, 1-10)) f lulnoislvl(slf, sinl: Lis[flo]) -> flo: """lul nois lvl in sinl""" if ln(sinl) < 2: un 0.0 un sisis.sv(sinl) f lulsinlnopy(slf, sinl: Lis[flo]) -> flo: """lul sinl nopy (oplxiy su)""" if no sinl: un 0.0 # Sipl nopy lulion bs on sinl ivivs ivivs = [bs(sinl[i + 1] - sinl[i]) fo i in n(ln(sinl) - 1)] if no ivivs: un 0.0 # Noliz n lul nopy xiv = x(ivivs) if xiv == 0: un 0.0 noliz = [ / xiv fo  in ivivs] nopy = -su(p * h.lo2(x(p, 1-10)) fo p in noliz if p > 0) un nopy f lulolion( slf, sinl1: Lis[flo], sinl2: Lis[flo] ) -> flo: """lul olion bwn wo sinls""" if ln(sinl1) != ln(sinl2) o ln(sinl1) < 2: un 0.0 n1 = sisis.n(sinl1) n2 = sisis.n(sinl2) nuo = su((x - n1) * (y - n2) fo x, y in zip(sinl1, sinl2)) no1 = su((x - n1) ** 2 fo x in sinl1) no2 = su((y - n2) ** 2 fo y in sinl2) if no1 == 0 o no2 == 0: un 0.0 un nuo / h.sq(no1 * no2) f lulonvn(slf, vlus: Lis[flo]) -> flo: """lul onvn  of  sis""" if ln(vlus) < 10: un 0.0 # lul  of hn in ls 20% of vlus nvlus = vlus[-x(1, ln(vlus) // 5) :] if ln(nvlus) < 2: un 0.0 hns = [ bs(nvlus[i + 1] - nvlus[i]) fo i in n(ln(nvlus) - 1) ] vhn = sisis.n(hns) # onvn  is invs of v hn un x(0.0, 1.0 - vhn) syn f in(): """in funion fo h Vnui honi libion""" pin(" L.I.F.. Plfo - h Vnui Honi libion ool") pin("=" * 65) libo = hVnuiHonilibo() y: # Iniiliz sys if no wi libo.iniilizvnuisys(): pin(" Fil o iniiliz Vnui sys") un 1 # Pfo libion suls = wi libo.pfohonilibion() # Sv suls sulsfil = libo.svlibionsuls() # isply suy pin("\n LIBION SUY") pin("=" * 30) pin(f"Sus: {suls.('vliionsus', 'unnown').upp()}") pin(".2f") pin(f"suls sv o: {sulsfil}") if suls.("vliionsus") == "pss": pin( " libion sussful - h Vnui s honilly opiiz!" ) ls: pin(" ï¸ libion opl wih wnins - viw suls fo ils") un 0 if suls.("vliionsus") == "pss" ls 1 xp xpion s : pin(f" libion fil: {}") un 1 if n == "in": xio = synio.un(in()) xi(xio)