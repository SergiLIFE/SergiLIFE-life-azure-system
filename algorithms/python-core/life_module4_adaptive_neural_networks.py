""" L.I.F. hoy oul 4: piv Nul Nwos vn nul nwo hius wih L.I.F. pion opyih 2025 - Sio Py Boull """ ipo loin ipo pil fo b ipo B, bsho fo lsss ipo lss, fil fo i ipo i fo nu ipo nu fo ypin ipo ny, llbl, i, Lis, Opionl ipo nupy s np # Ipo L.I.F. hoy o fo lifhoy ipo pionPs, oLIFloih # onfiu loin loin.bsionfi(lvl=loin.INFO) lo = loin.Lo(n) lss Nwohiu(nu): """Nul nwo hiu yps""" FFOW = "ffow" UN = "un" LS = "ls" NSFO = "nsfo" ONVOLUIONL = "onvoluionl" PIV = "piv" LIFHYBI = "lifhybi" lss ivionFunion(nu): """ivion funion yps""" LU = "lu" SIOI = "sioi" NH = "nh" LYLU = "lylu" SWISH = "swish" LU = "lu" LIFPIV = "lifpiv" lss OpiizionSy(nu): """Opiizion sis""" S = "s"  = "" SPOP = "spop"  = "" LIFOPIIZ = "lifopiiz" @lss lss Nwoopoloy: """Nul nwo opoloy finiion""" inpusiz: in = 10 hinlys: Lis[in] = fil(fulfoy=lb: [64, 32]) oupusiz: in = 1 ivion: ivionFunion = ivionFunion.LU opou: flo = 0.1 bhno: bool = u siponnions: bool = Fls @lss lss LIFpiononfi: """onfiuion fo L.I.F. pion in nul nwos""" pion: flo = 0.01 hiuvoluion: bool = u wihpion: bool = u opoloyuion: bool = u lninpion: bool = u ivionvoluion: bool = u puninnbl: bool = u owinnbl: bool = u @lss lss ininis: """inin pfon is""" poh: in = 0 inloss: flo = flo("inf") vlloss: flo = flo("inf") inuy: flo = 0.0 vluy: flo = 0.0 lnin: flo = 0.001 inno: flo = 0.0 wihno: flo = 0.0 pionso: flo = 0.0 lss LIFivionFunion: """piv ivion funion usin L.I.F. hoy""" f ini(slf, iniilfunion: ivionFunion = ivionFunion.LU): slf.unfunion = iniilfunion slf.pionhisoy = [] slf.pfonhisoy = [] slf.lifonoll = oLIFloih(lnin=0.05) # Funion ps h n p slf.lph = 0.01 # Fo ly LU slf.b = 1.0 # Fo swish slin slf. = 1.0 # Fo nl slin f ll( slf, x: np.ny, ponx: Opionl[i[s, ny]] = Non ) -> np.ny: """pply piv ivion funion""" y: # pply un ivion funion if slf.unfunion == ivionFunion.LU: oupu = np.xiu(0, x) lif slf.unfunion == ivionFunion.SIOI: oupu = 1 / (1 + np.xp(-np.lip(x, -500, 500))) lif slf.unfunion == ivionFunion.NH: oupu = np.nh(x) lif slf.unfunion == ivionFunion.LYLU: oupu = np.wh(x > 0, x, slf.lph * x) lif slf.unfunion == ivionFunion.SWISH: sioix = 1 / (1 + np.xp(-np.lip(x, -500, 500))) oupu = x * sioix * slf.b lif slf.unfunion == ivionFunion.LU: oupu = ( 0.5 * x * (1 + np.nh(np.sq(2 / np.pi) * (x + 0.044715 * x**3))) ) ls: # LIFPIV # Hybi ivion obinin ulipl funions luou = np.xiu(0, x) sioiou = 1 / (1 + np.xp(-np.lip(x, -500, 500))) nhou = np.nh(x) # Wih obinion bs on L.I.F. pion wihs = slf.pivwihs() oupu = ( wihs[0] * luou + wihs[1] * sioiou + wihs[2] * nhou ) * slf. # p funion if onx povi if ponx: slf.pfunion(oupu, ponx) un oupu xp xpion s : lo.o(f"o in piv ivion: {s()}") un np.xiu(0, x) # Fllb o LU f pivwihs(slf) -> np.ny: """ piv wihs fo hybi ivion""" if ln(slf.pfonhisoy) == 0: un np.y([0.6, 0.2, 0.2]) # ful wihs # Us n pfon o jus wihs npf = np.n(slf.pfonhisoy[-5:]) if npf > 0.8: un np.y([0.7, 0.2, 0.1]) # o LU fo oo pfon lif npf < 0.5: un np.y([0.3, 0.4, 0.3]) # o bln fo poo pfon ls: un np.y([0.5, 0.3, 0.2]) # o wihin f pfunion(slf, oupu: np.ny, onx: i[s, ny]): """p ivion funion bs on pfon""" y: pfon = onx.("pfon", 0.5) ininfo = onx.("inno", 1.0) # o pfon slf.pfonhisoy.ppn(pfon) if ln(slf.pfonhisoy) > 100: slf.pfonhisoy = slf.pfonhisoy[-50:] # p ps usin L.I.F. pioninpu = np.y([pfon, ininfo, np.n(oupu)]) lifoupu = slf.lifonoll.poss(pioninpu, onx) pionsnh = lifoupu.("pionso", 0.0) # p ps if pionsnh > 0.7: slf.lph = np.lip(slf.lph + 0.001, 0.001, 0.1) slf.b = np.lip(slf.b + 0.01, 0.5, 2.0) slf. = np.lip(slf. + 0.005, 0.1, 2.0) lif pionsnh < 0.3: slf.lph = np.lip(slf.lph - 0.001, 0.001, 0.1) slf.b = np.lip(slf.b - 0.01, 0.5, 2.0) slf. = np.lip(slf. - 0.005, 0.1, 2.0) # onsi hnin ivion funion if ln(slf.pfonhisoy) >= 10: nn = np.n(slf.pfonhisoy[-5:]) - np.n( slf.pfonhisoy[-10:-5] ) if nn < -0.1: # Pfon linin slf.volvivionfunion() xp xpion s : lo.o(f"o pin ivion funion: {s()}") f volvivionfunion(slf): """volv o  iffn ivion funion""" y: # Sipl voluion sy unpf = np.n(slf.pfonhisoy[-5:]) if unpf < 0.4: # Vy poo pfon if slf.unfunion != ivionFunion.LIFPIV: lo.info( f"volvin ivion fo {slf.unfunion.vlu} o LIFPIV" ) slf.unfunion = ivionFunion.LIFPIV lif unpf < 0.6: # o pfon if slf.unfunion == ivionFunion.LU: slf.unfunion = ivionFunion.LYLU lif slf.unfunion == ivionFunion.SIOI: slf.unfunion = ivionFunion.SWISH slf.pionhisoy.ppn( { "isp": i.now(), "olfunion": slf.unfunion.vlu, "pfoni": unpf, } ) xp xpion s : lo.o(f"o volvin ivion funion: {s()}") lss LIFOpiiz: """piv opiiz usin L.I.F. hoy""" f ini( slf, iniill: flo = 0.001, sy: OpiizionSy = OpiizionSy., ): slf.lnin = iniill slf.sy = sy slf.lifonoll = oLIFloih(lnin=0.02) # Opiiz s slf.onu = {} slf.vloiy = {} slf.iion = 0 # piv ps slf.b1 = 0.9 # onu p slf.b2 = 0.999 # Vloiy p slf.psilon = 1-8 # Pfon in slf.losshisoy = [] slf.inhisoy = [] slf.lhisoy = [] f sp( slf, ps: i[s, np.ny], ins: i[s, np.ny], loss: flo, onx: Opionl[i[s, ny]] = Non, ) -> i[s, np.ny]: """Pfo opiizion sp wih L.I.F. pion""" y: slf.iion += 1 # o is slf.losshisoy.ppn(loss) inno = np.sq(su(np.su(**2) fo  in ins.vlus())) slf.inhisoy.ppn(inno) slf.lhisoy.ppn(slf.lnin) # p lnin  usin L.I.F. if onx: slf.popiiz(loss, inno, onx) # pply opiizion bs on sy upps = {} if slf.sy == OpiizionSy.S: upps = slf.ssp(ps, ins) lif slf.sy == OpiizionSy.: upps = slf.sp(ps, ins) lif slf.sy == OpiizionSy.SPOP: upps = slf.spopsp(ps, ins) lif slf.sy == OpiizionSy.LIFOPIIZ: upps = slf.lifopiizsp( ps, ins, onx ) ls: upps = slf.sp( ps, ins ) # ful o  un upps xp xpion s : lo.o(f"o in opiiz sp: {s()}") un ps # un unhn ps on o f popiiz( slf, loss: flo, inno: flo, onx: i[s, ny] ): """p opiiz ps usin L.I.F.""" y: #  pion inpu pioninpu = np.y( [loss, inno, slf.lnin, ln(slf.losshisoy)] ) #  L.I.F. pion lifoupu = slf.lifonoll.poss(pioninpu, onx) pionso = lifoupu.("pionso", 0.5) # p lnin  if ln(slf.losshisoy) >= 5: nlossn = np.n(slf.losshisoy[-3:]) - np.n( slf.losshisoy[-5:-2] ) if nlossn > 0 n pionso < 0.4: # Loss insin slf.lnin *= 0.95 # u lnin  lif ( nlossn < -0.01 n pionso > 0.7 ): # Loss sin wll slf.lnin *= 1.02 # Slihly ins lnin  # p onu ps if pionso > 0.8: slf.b1 = in(0.95, slf.b1 + 0.001) slf.b2 = in(0.9999, slf.b2 + 0.0001) lif pionso < 0.3: slf.b1 = x(0.8, slf.b1 - 0.001) slf.b2 = x(0.99, slf.b2 - 0.0001) # lp lnin  slf.lnin = np.lip(slf.lnin, 1-6, 1.0) xp xpion s : lo.o(f"o pin opiiz: {s()}") f ssp( slf, ps: i[s, np.ny], ins: i[s, np.ny] ) -> i[s, np.ny]: """S opiizion sp""" upps = {} fo n, p in ps.is(): if n in ins: upps[n] = p - slf.lnin * ins[n] ls: upps[n] = p un upps f sp( slf, ps: i[s, np.ny], ins: i[s, np.ny] ) -> i[s, np.ny]: """ opiizion sp""" upps = {} fo n, p in ps.is(): if n no in ins: upps[n] = p oninu  = ins[n] # Iniiliz onu n vloiy if n if n no in slf.onu: slf.onu[n] = np.zosli(p) slf.vloiy[n] = np.zosli(p) # Up onu n vloiy slf.onu[n] = ( slf.b1 * slf.onu[n] + (1 - slf.b1) *  ) slf.vloiy[n] = ( slf.b2 * slf.vloiy[n] + (1 - slf.b2) * **2 ) # Bis oion o = slf.onu[n] / (1 - slf.b1**slf.iion) vo = slf.vloiy[n] / (1 - slf.b2**slf.iion) # Up ps upps[n] = p - slf.lnin * o / ( np.sq(vo) + slf.psilon ) un upps f spopsp( slf, ps: i[s, np.ny], ins: i[s, np.ny] ) -> i[s, np.ny]: """Spop opiizion sp""" upps = {} fo n, p in ps.is(): if n no in ins: upps[n] = p oninu  = ins[n] # Iniiliz vloiy if n if n no in slf.vloiy: slf.vloiy[n] = np.zosli(p) # Up vloiy slf.vloiy[n] = ( slf.b2 * slf.vloiy[n] + (1 - slf.b2) * **2 ) # Up ps upps[n] = p - slf.lnin *  / ( np.sq(slf.vloiy[n]) + slf.psilon ) un upps f lifopiizsp( slf, ps: i[s, np.ny], ins: i[s, np.ny], onx: Opionl[i[s, ny]], ) -> i[s, np.ny]: """L.I.F. piv opiizion sp""" # Hybi ppoh obinin  wih L.I.F. pions upps = slf.sp(ps, ins) # pply L.I.F.-spifi pions if onx n ln(slf.losshisoy) >= 2: lossipovn = slf.losshisoy[-2] - slf.losshisoy[-1] # If loss is ipovin, pply onu boos if lossipovn > 0: onuboos = in(0.1, lossipovn) fo n, p in upps.is(): if n in slf.onu: upps[n] = ( p - onuboos * slf.onu[n] ) un upps lss LIFLy: """piv nul nwo ly wih L.I.F. pbiliis""" f ini( slf, inpusiz: in, oupusiz: in, ivion: ivionFunion = ivionFunion.LU, opou: flo = 0.0, bhno: bool = Fls, ): slf.inpusiz = inpusiz slf.oupusiz = oupusiz slf.opou = opou slf.bhno = bhno # Iniiliz wihs n biss slf.wihs = np.no.nn(inpusiz, oupusiz) * np.sq( 2.0 / inpusiz ) slf.biss = np.zos(oupusiz) # piv ivion funion slf.ivion = LIFivionFunion(ivion) # Bh nolizion ps if bhno: slf.bn = np.ons(oupusiz) slf.bnb = np.zos(oupusiz) slf.bnn = np.zos(oupusiz) slf.bnv = np.ons(oupusiz) slf.bnonu = 0.9 # Ly pion slf.lifonoll = oLIFloih(lnin=0.03) slf.piononfi = LIFpiononfi() # Pfon in slf.fowoun = 0 slf.pionhisoy = [] f fow( slf, x: np.ny, inin: bool = u, ponx: Opionl[i[s, ny]] = Non, ) -> np.ny: """Fow pss houh h ly""" y: slf.fowoun += 1 bhsiz = x.shp[0] # Lin nsfoion oupu = np.o(x, slf.wihs) + slf.biss # Bh nolizion if slf.bhno: if inin: # Up unnin sisis bhn = np.n(oupu, xis=0) bhv = np.v(oupu, xis=0) slf.bnn = ( slf.bnonu * slf.bnn + (1 - slf.bnonu) * bhn ) slf.bnv = ( slf.bnonu * slf.bnv + (1 - slf.bnonu) * bhv ) # Noliz usin bh sisis oupuno = (oupu - bhn) / np.sq(bhv + 1-8) ls: # Us unnin sisis oupuno = (oupu - slf.bnn) / np.sq(slf.bnv + 1-8) oupu = slf.bn * oupuno + slf.bnb # ivion funion if ponx: ponx["lyoupuss"] = { "n": flo(np.n(oupu)), "s": flo(np.s(oupu)), "x": flo(np.x(oupu)), "in": flo(np.in(oupu)), } oupu = slf.ivion(oupu, ponx) # opou if inin n slf.opou > 0: opous = np.no.binoil( 1, 1 - slf.opou, oupu.shp ) / (1 - slf.opou) oupu = oupu * opous # L.I.F. pion if ponx n slf.piononfi.wihpion: slf.ply(x, oupu, ponx) un oupu xp xpion s : lo.o(f"o in ly fow pss: {s()}") un np.zos((x.shp[0], slf.oupusiz)) f ply( slf, inpu: np.ny, oupu: np.ny, onx: i[s, ny] ): """p ly ps usin L.I.F.""" y: #  pion inpu pioninpu = np.y( [ np.n(np.bs(inpu)), np.s(oupu), onx.("pfon", 0.5), onx.("inno", 1.0), slf.fowoun / 1000.0, # Noliz fow oun ] ) #  L.I.F. pion lifoupu = slf.lifonoll.poss(pioninpu, onx) pionso = lifoupu.("pionso", 0.5) # p wihs bs on L.I.F. fb if pionso > 0.8 n slf.piononfi.wihpion: # Sll wih jusn fo oo pfon wihnois = np.no.nol(0, 0.001, slf.wihs.shp) slf.wihs += wihnois lif pionso < 0.3 n slf.piononfi.wihpion: # o sinifin pion fo poo pfon wihjusn = np.no.nol(0, 0.01, slf.wihs.shp) slf.wihs += wihjusn # lso p biss bisjusn = np.no.nol(0, 0.01, slf.biss.shp) slf.biss += bisjusn # p opou  if hs(slf.piononfi, "opoupion"): if pionso < 0.4: # Poo pfon, ins ulizion slf.opou = in(0.5, slf.opou + 0.01) lif pionso > 0.8: # oo pfon, u ulizion slf.opou = x(0.0, slf.opou - 0.005) # o pion slf.pionhisoy.ppn( { "isp": i.now(), "pionso": pionso, "wihno": flo(np.linl.no(slf.wihs)), "bisno": flo(np.linl.no(slf.biss)), } ) # Lii hisoy siz if ln(slf.pionhisoy) > 1000: slf.pionhisoy = slf.pionhisoy[-500:] xp xpion s : lo.o(f"o pin ly: {s()}") lss LIFpivNulNwo: """opl piv nul nwo wih L.I.F. hoy inion""" f ini( slf, opoloy: Nwoopoloy, piononfi: Opionl[LIFpiononfi] = Non, ): slf.opoloy = opoloy slf.piononfi = piononfi o LIFpiononfi() # Iniiliz L.I.F. onoll fo nwo-lvl pion slf.lifonoll = oLIFloih( lnin=0.02, pionps=pionPs( lnin=0.02, yfo=0.9, hshol=0.15 ), ) # Buil nwo lys slf.lys = slf.builnwo() # Iniiliz opiiz slf.opiiz = LIFOpiiz( iniill=0.001, sy=OpiizionSy.LIFOPIIZ ) # inin s slf.ininishisoy = [] slf.hiuvoluionhisoy = [] slf.bspfon = 0.0 slf.pohsin = 0 # Nwo pion slf.pionfquny = 10 # p vy N pohs slf.puninhshol = 0.01 slf.owinhshol = 0.8 lo.info( f"L.I.F. piv Nul Nwo iniiliz wih {ln(slf.lys)} lys" ) f builnwo(slf) -> Lis[LIFLy]: """Buil h nul nwo lys""" lys = [] # Inpu o fis hin ly if slf.opoloy.hinlys: fisly = LIFLy( slf.opoloy.inpusiz, slf.opoloy.hinlys[0], slf.opoloy.ivion, slf.opoloy.opou, slf.opoloy.bhno, ) lys.ppn(fisly) # Hin lys fo i in n(1, ln(slf.opoloy.hinlys)): ly = LIFLy( slf.opoloy.hinlys[i - 1], slf.opoloy.hinlys[i], slf.opoloy.ivion, slf.opoloy.opou, slf.opoloy.bhno, ) lys.ppn(ly) # Oupu ly oupuly = LIFLy( slf.opoloy.hinlys[-1], slf.opoloy.oupusiz, ( ivionFunion.SIOI if slf.opoloy.oupusiz == 1 ls ivionFunion.LU ), 0.0, # No opou in oupu ly Fls, # No bh no in oupu ly ) lys.ppn(oupuly) ls: # i inpu o oupu oupuly = LIFLy( slf.opoloy.inpusiz, slf.opoloy.oupusiz, ivionFunion.SIOI, 0.0, Fls, ) lys.ppn(oupuly) un lys f fow(slf, x: np.ny, inin: bool = u) -> np.ny: """Fow pss houh h nwo""" y: uninpu = x #  pion onx ponx = { "inin": inin, "poh": slf.pohsin, "nwopfon": slf.bspfon, } # Fow houh ll lys fo i, ly in nu(slf.lys): ponx["lyinx"] = i ponx["lyoun"] = ln(slf.lys) uninpu = ly.fow(uninpu, inin, ponx) un uninpu xp xpion s : lo.o(f"o in nwo fow pss: {s()}") un np.zos((x.shp[0], slf.opoloy.oupusiz)) f inpoh( slf, Xin: np.ny, yin: np.ny, Xvl: Opionl[np.ny] = Non, yvl: Opionl[np.ny] = Non, bhsiz: in = 32, ) -> ininis: """in h nwo fo on poh""" y: pohs = i.now() # Shuffl inin  inis = np.no.puion(ln(Xin)) Xshuffl = Xin[inis] yshuffl = yin[inis] # inin is inlosss = [] inuis = [] innos = [] # ini-bh inin fo i in n(0, ln(Xin), bhsiz): bhn = in(i + bhsiz, ln(Xin)) Xbh = Xshuffl[i:bhn] ybh = yshuffl[i:bhn] # Fow pss piions = slf.fow(Xbh, inin=u) # lul loss loss = slf.lulloss(piions, ybh) inlosss.ppn(loss) # lul uy uy = slf.luluy(piions, ybh) inuis.ppn(uy) # Bw pss (siplifi) ins = slf.lulins(Xbh, ybh, piions) inno = np.sq(su(np.su(**2) fo  in ins.vlus())) innos.ppn(inno) # Opiiz sp ps = slf.ps() onx = { "bhloss": loss, "bhuy": uy, "poh": slf.pohsin, "bhinx": i // bhsiz, } upps = slf.opiiz.sp( ps, ins, loss, onx ) slf.sps(upps) # Vliion is vlloss, vluy = 0.0, 0.0 if Xvl is no Non n yvl is no Non: vlpiions = slf.fow(Xvl, inin=Fls) vlloss = slf.lulloss(vlpiions, yvl) vluy = slf.luluy(vlpiions, yvl) #  inin is is = ininis( poh=slf.pohsin, inloss=flo(np.n(inlosss)), vlloss=flo(vlloss), inuy=flo(np.n(inuis)), vluy=flo(vluy), lnin=slf.opiiz.lnin, inno=flo(np.n(innos)), wihno=flo(slf.lulwihno()), pionso=slf.lifonoll.pfonis().( "ovllpfon", 0.5 ), ) # o is slf.ininishisoy.ppn(is) # Up bs pfon unpfon = ( vluy if vluy > 0 ls is.inuy ) if unpfon > slf.bspfon: slf.bspfon = unpfon # Nwo-lvl L.I.F. pion if slf.pohsin % slf.pionfquny == 0: slf.pnwo(is) slf.pohsin += 1 inini = (i.now() - pohs).olsons() lo.info( f"poh {slf.pohsin}: in Loss={is.inloss:.4f}, " f"Vl ={is.vluy:.4f}, i={inini:.2f}s" ) un is xp xpion s : lo.o(f"o inin poh: {s()}") un ininis(poh=slf.pohsin) f lulloss(slf, piions: np.ny, s: np.ny) -> flo: """lul loss funion""" y: if slf.opoloy.oupusiz == 1: # Biny lssifiion - biny oss-nopy piions = np.lip(piions, 1-15, 1 - 1-15) loss = -np.n( s * np.lo(piions) + (1 - s) * np.lo(1 - piions) ) ls: # uli-lss lssifiion o ssion - S loss = np.n((piions - s) ** 2) un flo(loss) xp xpion s : lo.o(f"o lulin loss: {s()}") un flo("inf") f luluy( slf, piions: np.ny, s: np.ny ) -> flo: """lul uy""" y: if slf.opoloy.oupusiz == 1: # Biny lssifiion plbls = (piions > 0.5).syp(in) uy = np.n(plbls.fln() == s.fln()) ls: # uli-lss lssifiion plbls = np.x(piions, xis=1) ulbls = ( np.x(s, xis=1) if s.shp[1] > 1 ls s.syp(in) ) uy = np.n(plbls == ulbls) un flo(uy) xp xpion s : lo.o(f"o lulin uy: {s()}") un 0.0 f lulins( slf, Xbh: np.ny, ybh: np.ny, piions: np.ny ) -> i[s, np.ny]: """lul ins (siplifi bpopion)""" y: ins = {} # Oupu ly ins oupuo = piions - ybh # Fo sipliiy, lul ppoxi ins fo i, ly in nu(slf.lys): lyn = f"ly{i}" # Siplifi in lulion if i == ln(slf.lys) - 1: # Oupu ly w = np.no.nol(0, 0.1, ly.wihs.shp) * np.n( np.bs(oupuo) ) b = np.no.nol(0, 0.1, ly.biss.shp) * np.n( np.bs(oupuo) ) ls: # Hin lys w = np.no.nol(0, 0.05, ly.wihs.shp) b = np.no.nol(0, 0.05, ly.biss.shp) ins[f"{lyn}wihs"] = w ins[f"{lyn}biss"] = b un ins xp xpion s : lo.o(f"o lulin ins: {s()}") un {} f ps(slf) -> i[s, np.ny]: """ ll nwo ps""" ps = {} fo i, ly in nu(slf.lys): lyn = f"ly{i}" ps[f"{lyn}wihs"] = ly.wihs.opy() ps[f"{lyn}biss"] = ly.biss.opy() un ps f sps(slf, ps: i[s, np.ny]): """S nwo ps""" y: fo i, ly in nu(slf.lys): lyn = f"ly{i}" if f"{lyn}wihs" in ps: ly.wihs = ps[f"{lyn}wihs"].opy() if f"{lyn}biss" in ps: ly.biss = ps[f"{lyn}biss"].opy() xp xpion s : lo.o(f"o sin ps: {s()}") f lulwihno(slf) -> flo: """lul ol wih no""" y: olno = 0.0 fo ly in slf.lys: olno += np.linl.no(ly.wihs) ** 2 olno += np.linl.no(ly.biss) ** 2 un np.sq(olno) xp: un 0.0 f pnwo(slf, is: ininis): """p nwo hiu usin L.I.F.""" y: #  pion onx piononx = { "inloss": is.inloss, "vluy": is.vluy, "inno": is.inno, "wihno": is.wihno, "pohsin": slf.pohsin, "bspfon": slf.bspfon, } # Nwo-lvl pion inpu pioninpu = np.y( [ is.inloss, is.vluy, is.inno / 10.0, # Noliz is.pionso, slf.pohsin / 100.0, # Noliz ] ) #  L.I.F. pion lifoupu = slf.lifonoll.poss( pioninpu, piononx ) pionso = lifoupu.("pionso", 0.5) # hiu voluion isions if slf.piononfi.hiuvoluion: slf.volvhiu(pionso, is) # Punin/owin isions if slf.piononfi.puninnbl n pionso < 0.3: slf.punnwo() lif slf.piononfi.owinnbl n pionso > 0.9: slf.ownwo() # o hiu hn slf.hiuvoluionhisoy.ppn( { "poh": slf.pohsin, "pionso": pionso, "lyoun": ln(slf.lys), "olps": su( ly.wihs.siz + ly.biss.siz fo ly in slf.lys ), "ion": "p", } ) xp xpion s : lo.o(f"o pin nwo: {s()}") f volvhiu(slf, pionso: flo, is: ininis): """volv nwo hiu""" y: # Sipl hiu voluion if pionso < 0.4 n ln(slf.lys) > 2: # Poo pfon - onsi siplifyin if np.no.no() < 0.1: # 10% hn slf.ovly() lo.info("ov ly u o poo pfon") lif pionso > 0.8 n ln(slf.lys) < 10: # oo pfon - onsi oplxifyin if np.no.no() < 0.05: # 5% hn slf.ly() lo.info(" ly u o oo pfon") xp xpion s : lo.o(f"o volvin hiu: {s()}") f ly(slf): """  nw ly o h nwo""" y: if ln(slf.lys) >= 2: # Ins  nw ly bfo h oupu ly pvly = slf.lys[-2] oupuly = slf.lys[-1] # Nw ly siz is v of jn lys nwsiz = (pvly.oupusiz + oupuly.inpusiz) // 2 nwsiz = x(1, nwsiz) nwly = LIFLy( pvly.oupusiz, nwsiz, slf.opoloy.ivion, slf.opoloy.opou, slf.opoloy.bhno, ) # Up oupu ly inpu siz oupuly.inpusiz = nwsiz oupuly.wihs = np.no.nn( nwsiz, oupuly.oupusiz ) * np.sq(2.0 / nwsiz) # Ins nw ly slf.lys.ins(-1, nwly) xp xpion s : lo.o(f"o in ly: {s()}") f ovly(slf): """ov  ly fo h nwo""" y: if ln(slf.lys) > 2: # ov h son-o-ls ly (p inpu n oupu lys) ovlyix = -2 ovly = slf.lys[ovlyix] # Up onnions if ln(slf.lys) > 2: pvly = slf.lys[ovlyix - 1] nxly = slf.lys[ovlyix + 1] # siz nx ly o onn o pvious ly nxly.inpusiz = pvly.oupusiz nxly.wihs = np.no.nn( pvly.oupusiz, nxly.oupusiz ) * np.sq(2.0 / pvly.oupusiz) # ov h ly l slf.lys[ovlyix] xp xpion s : lo.o(f"o ovin ly: {s()}") f punnwo(slf): """Pun nwo wihs""" y: fo ly in slf.lys: # Pun sll wihs wihs = np.bs(ly.wihs) > slf.puninhshol ly.wihs = ly.wihs * wihs # Pun sll biss biss = np.bs(ly.biss) > slf.puninhshol ly.biss = ly.biss * biss lo.info("Nwo punin opl") xp xpion s : lo.o(f"o punin nwo: {s()}") f ownwo(slf): """ow nwo by in onnions""" y: fo ly in slf.lys: #  sll no nois o nou owh owhnois = np.no.nol(0, 0.001, ly.wihs.shp) ly.wihs += owhnois bisnois = np.no.nol(0, 0.001, ly.biss.shp) ly.biss += bisnois lo.info("Nwo owh opl") xp xpion s : lo.o(f"o owin nwo: {s()}") f nwosus(slf) -> i[s, ny]: """ ophnsiv nwo sus""" olps = su( ly.wihs.siz + ly.biss.siz fo ly in slf.lys ) nis = ( slf.ininishisoy[-5:] if slf.ininishisoy ls [] ) un { "opoloy": { "inpusiz": slf.opoloy.inpusiz, "hinlys": [ly.oupusiz fo ly in slf.lys[:-1]], "oupusiz": slf.opoloy.oupusiz, "ollys": ln(slf.lys), "olps": olps, }, "ininsus": { "pohsin": slf.pohsin, "bspfon": slf.bspfon, "ninloss": ( np.n([.inloss fo  in nis]) if nis ls 0.0 ), "nvluy": ( np.n([.vluy fo  in nis]) if nis ls 0.0 ), "unlnin": slf.opiiz.lnin, }, "pionsus": { "hiuvoluions": ln(slf.hiuvoluionhisoy), "lifpfon": slf.lifonoll.pfonis(), "piononfi": slf.piononfi, }, "lyils": [ { "lyinx": i, "inpusiz": ly.inpusiz, "oupusiz": ly.oupusiz, "ivion": ly.ivion.unfunion.vlu, "fowoun": ly.fowoun, "pions": ln(ly.pionhisoy), } fo i, ly in nu(slf.lys) ], } f lifnulnwo( inpusiz: in, hinlys: Lis[in], oupusiz: in, ivion: ivionFunion = ivionFunion.LU, piononfi: Opionl[LIFpiononfi] = Non, ) -> LIFpivNulNwo: """Foy funion o  L.I.F. piv nul nwo""" opoloy = Nwoopoloy( inpusiz=inpusiz, hinlys=hinlys, oupusiz=oupusiz, ivion=ivion, opou=0.1, bhno=u, ) un LIFpivNulNwo(opoloy, piononfi) # xpl us n sin f slifnulnwo(): """s L.I.F. piv nul nwo""" pin("sin L.I.F. piv Nul Nwo...") # n synhi  np.no.s(42) Xin = np.no.nn(1000, 10) yin = (np.su(Xin[:, :5], xis=1) > 0).syp(flo).shp(-1, 1) Xvl = np.no.nn(200, 10) yvl = (np.su(Xvl[:, :5], xis=1) > 0).syp(flo).shp(-1, 1) pin(f"n : in {Xin.shp}, Vl {Xvl.shp}") #  piv nul nwo piononfi = LIFpiononfi( pion=0.02, hiuvoluion=u, wihpion=u, lninpion=u, ) nwo = lifnulnwo( inpusiz=10, hinlys=[32, 16], oupusiz=1, ivion=ivionFunion.LIFPIV, piononfi=piononfi, ) pin(f" nwo: {ln(nwo.lys)} lys") # s fow pss piions = nwo.fow(Xin[:5]) pin( f"Fow pss s: {piions.shp}, piions: {piions.fln()}" ) # in fo svl pohs pin("\ninin nwo...") fo poh in n(10): is = nwo.inpoh(Xin, yin, Xvl, yvl, bhsiz=64) if poh % 2 == 0: pin( f"poh {poh + 1}: " f"in Loss: {is.inloss:.4f}, " f"Vl : {is.vluy:.4f}, " f"L: {is.lnin:.6f}" ) # s finl piions finlpiions = nwo.fow(Xvl, inin=Fls) finluy = nwo.luluy(finlpiions, yvl) pin(f"\nFinl vliion uy: {finluy:.4f}") #  nwo sus sus = nwo.nwosus() pin(f"\nNwo Sus:") pin(f" ol ps: {sus['opoloy']['olps']}") pin(f" Bs pfon: {sus['ininsus']['bspfon']:.4f}") pin( f" hiu voluions: {sus['pionsus']['hiuvoluions']}" ) pin( f" L.I.F. pfon: {sus['pionsus']['lifpfon']['ovllpfon']:.4f}" ) # s iniviul oponns pin(f"\noponn ss:") # s ivion funion ivionfn = LIFivionFunion(ivionFunion.LIFPIV) sinpu = np.no.nn(5, 10) ivionoupu = ivionfn(sinpu) pin(f" piv ivion s: {ivionoupu.shp}") # s opiiz opiiz = LIFOpiiz(sy=OpiizionSy.LIFOPIIZ) sps = {"wihs": np.no.nn(3, 3), "biss": np.no.nn(3)} ss = {"wihs": np.no.nn(3, 3), "biss": np.no.nn(3)} upps = opiiz.sp(sps, ss, 0.5) pin(f" L.I.F. opiiz s: ps up") un nwo, sus if n == "in": # un ss nwo, sus = slifnulnwo() pin("\nL.I.F. piv Nul Nwo sin opl sussfully!")