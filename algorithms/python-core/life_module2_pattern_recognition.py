""" L.I.F. hoy oul 2: vn Pn oniion hin lnin n pn oniion wih piv lnin opyih 2025 - Sio Py Boull """ ipo loin fo lsss ipo lss, fil fo i ipo i fo nu ipo nu fo ypin ipo ny, i, Lis, Opionl ipo nupy s np fo sln.lus ipo BSN, ns fo sln.oposiion ipo P, FsI fo sln.nsbl ipo noFoslssifi fo sln.is ipo uyso, f1so, pisionso, llso fo sln.nulnwo ipo LPlssifi fo sln.ppossin ipo SnSl # Ipo L.I.F. hoy o fo lifhoy ipo pionPs, oLIFloih # onfiu loin loin.bsionfi(lvl=loin.INFO) lo = loin.Lo(n) lss Pnyp(nu): """yps of pns h n b oniz""" POL = "polpn" SPIL = "spilpn" SPL = "splpn" BHVIOL = "bhviolpn" NUL = "nulpn" PHYSIOLOIL = "physioloilpn" lss Lnino(nu): """Lnin os fo pn oniion""" SUPVIS = "supvislnin" UNSUPVIS = "unsupvislnin" SISUPVIS = "sisupvislnin" INFON = "infonlnin" PIV = "pivlnin" @lss lss PnFus: """Pn fu psnion""" wfus: np.ny = fil(fulfoy=lb: np.y([])) ufus: np.ny = fil(fulfoy=lb: np.y([])) sisilfus: i[s, flo] = fil(fulfoy=i) oplxiysus: i[s, flo] = fil(fulfoy=i) quliyis: i[s, flo] = fil(fulfoy=i) @lss lss lssifiionsul: """lssifiion sul suu""" pilss: in = -1 onfin: flo = 0.0 lsspobbiliis: Lis[flo] = fil(fulfoy=lis) isionbounyisn: flo = 0.0 fuipon: Lis[flo] = fil(fulfoy=lis) @lss lss lusinsul: """lusin sul suu""" luslbls: Lis[in] = fil(fulfoy=lis) lusns: np.ny = fil(fulfoy=lb: np.y([])) silhouso: flo = 0.0 ini: flo = 0.0 nuluss: in = 0 lss LIFPnoniz: """vn pn oniion wih L.I.F. hoy inion""" f ini(slf, pnyp: Pnyp = Pnyp.POL): slf.pnyp = pnyp # Iniiliz L.I.F. loih fo piv pn lnin slf.lifloih = oLIFloih( lnin=0.02, xxpins=10000, pionps=pionPs( lnin=0.02, yfo=0.9, hshol=0.15 ), ) # Pn oniion ols slf.ols = { "nulnwo": LPlssifi( hinlysizs=(100, 50), xi=500, nos=42 ), "nofos": noFoslssifi(nsios=100, nos=42), "ns": ns(nluss=5, nos=42), "bsn": BSN(ps=0.5, inspls=5), } # Fu possin slf.fupossos = { "sl": SnSl(), "p": P(noponns=0.95), "i": FsI(noponns=Non, nos=42), } # Pn oy n pion slf.pnoy = [] slf.pionhisoy = [] slf.pfonis = { "uyhisoy": [], "f1hisoy": [], "pionsos": [], "pnoplxiy": [], } # ol inin sus slf.inols = s() slf.fuinsions = {} lo.info(f"L.I.F. Pn oniz iniiliz fo {pnyp.vlu}") f xpnfus( slf, : np.ny, onx: Opionl[i[s, ny]] = Non ) -> PnFus: """x ophnsiv pn fus fo """ y: fus = PnFus() # nsu  is 2 (spls x fus) if .ni == 1:  = .shp(1, -1) lif .ni > 2:  = .shp(.shp[0], -1) fus.wfus = .opy() # Sisil fus fus.sisilfus = { "n": flo(np.n()), "s": flo(np.s()), "vin": flo(np.v()), "swnss": flo(slf.lulswnss(.fln())), "uosis": flo(slf.luluosis(.fln())), "nopy": flo(slf.lulnopy(.fln())), "ny": flo(np.su(**2)), "s": flo(np.sq(np.n(**2))), } # oplxiy sus fus.oplxiysus = { "lzoplxiy": flo(slf.lullzoplxiy(.fln())), "ppoxinopy": flo( slf.lulppoxinopy(.fln()) ), "splnopy": flo(slf.lulsplnopy(.fln())), "flinsion": flo( slf.lulflinsion(.fln()) ), "splnopy": flo( slf.lulsplnopy(.fln()) ), } # Quliy is fus.quliyis = { "sinlonois": flo(slf.sisn(.fln())), "quliy": flo(slf.ssssquliy()), "fusbiliy": flo(slf.lulfusbiliy()), "infoiononn": flo(slf.lulinfoiononn()), } # insionliy uion if .shp[1] > 10: # Only u if w hv nouh fus y: if hs(slf.fupossos["p"], "oponns"): u = slf.fupossos["p"].nsfo() ls: u = slf.fupossos["p"].finsfo(  ) fus.ufus = u xp: fus.ufus = .opy() ls: fus.ufus = .opy() un fus xp xpion s : lo.o(f"o xin pn fus: {s()}") un PnFus() f inpnlssifi( slf, X: np.ny, y: np.ny, oln: s = "nulnwo" ) -> i[s, ny]: """in pn lssifi wih L.I.F. pion""" y: if oln no in slf.ols: is Vluo(f"Unnown ol: {oln}") si = i.now() # Pposs fus Xposs = slf.ppossfus(X, fi=u) # x pn fus pnfus = slf.xpnfus(Xposs) # in ol ol = slf.ols[oln] if oln in ["nulnwo", "nofos"]: # Hihlyvis lnin ol.fi(Xposs, y) # Pi on inin  fo vluion yp = ol.pi(Xposs) # lul is uy = uyso(y, yp) f1 = f1so(y, yp, v="wih") pision = pisionso(y, yp, v="wih") ll = llso(y, yp, v="wih") is = { "uy": uy, "f1so": f1, "pision": pision, "ll": ll, } #  fu ipon if vilbl if hs(ol, "fuipons"): fuipon = ol.fuipons.olis() lif hs(ol, "ofs"): # Fo nul nwos, us v bsolu wihs fuipon = np.n( np.bs(ol.ofs[0]), xis=1 ).olis() ls: fuipon = [] ls: # Unsupvis lnin luslbls = ol.fipi(Xposs) is = { "nuluss": ln(np.uniqu(luslbls)), "silhouso": slf.lulsilhouso( Xposs, luslbls ), } fuipon = [] # p usin L.I.F. loih piononx = { "olyp": oln, "pfon": is.( "uy", is.("silhouso", 0.5) ), "fuoun": Xposs.shp[1], "sploun": Xposs.shp[0], } pfus = slf.lifloih.poss( Xposs.fln()[:1000], # Us subs fo pion piononx, ) # Up pfon hisoy slf.pfonis["uyhisoy"].ppn( is.("uy", 0.5) ) slf.pfonis["f1hisoy"].ppn(is.("f1so", 0.5)) #  ol s in slf.inols.(oln) slf.fuinsions[oln] = Xposs.shp[1] inini = (i.now() - si).olsons() sul = { "oln": oln, "ininis": is, "fuipon": fuipon, "pnfus": pnfus, "pionsul": pfus, "inini": inini, "lifis": slf.lifloih.pfonis(), "suss": u, } lo.info( f"ol {oln} in sussfully in {inini:.2f}s" ) un sul xp xpion s : lo.o(f"o inin ol {oln}: {s()}") un { "oln": oln, "suss": Fls, "o": s(), "inini": 0.0, } f lssifypn( slf, X: np.ny, oln: s = "nulnwo" ) -> lssifiionsul: """lssify pn usin in ol""" y: if oln no in slf.inols: is Vluo(f"ol {oln} no in y") # Pposs fus Xposs = slf.ppossfus(X, fi=Fls) # nsu o insions if Xposs.shp[1] != slf.fuinsions[oln]: # P o un fus if Xposs.shp[1] < slf.fuinsions[oln]: pin = np.zos( ( Xposs.shp[0], slf.fuinsions[oln] - Xposs.shp[1], ) ) Xposs = np.hs([Xposs, pin]) ls: Xposs = Xposs[:, : slf.fuinsions[oln]] ol = slf.ols[oln] #  piion if hs(ol, "pipob"): # lssifiion wih pobbiliis piions = ol.pi(Xposs) pobbiliis = ol.pipob(Xposs) sul = lssifiionsul( pilss=in(piions[0]) if ln(piions) > 0 ls -1, onfin=( flo(np.x(pobbiliis[0])) if ln(pobbiliis) > 0 ls 0.0 ), lsspobbiliis=( pobbiliis[0].olis() if ln(pobbiliis) > 0 ls [] ), isionbounyisn=( flo(np.x(pobbiliis[0]) - np.so(pobbiliis[0])[-2]) if ln(pobbiliis) > 0 n ln(pobbiliis[0]) > 1 ls 0.0 ), ) # Fu ipon fo his piion if hs(ol, "fuipons"): sul.fuipon = ol.fuipons.olis() ls: # Sipl piion piions = ol.pi(Xposs) sul = lssifiionsul( pilss=in(piions[0]) if ln(piions) > 0 ls -1, onfin=0.5, # Unnown onfin fo non-pobbilisi ols ) # p bs on piion onfin if sul.onfin < 0.7: # Low onfin piion piononx = { "lowonfin": u, "pilss": sul.pilss, "onfin": sul.onfin, } slf.lifloih.poss( Xposs.fln()[:100], piononx ) un sul xp xpion s : lo.o(f"o in pn lssifiion: {s()}") un lssifiionsul() f isovpns( slf, X: np.ny, ho: s = "ns" ) -> lusinsul: """isov pns usin unsupvis lnin""" y: # Pposs fus Xposs = slf.ppossfus(X, fi=u) if ho == "ns": # in opil nub of luss opil = slf.finopilluss(Xposs) slf.ols["ns"].sps(nluss=opil) luslbls = slf.ols["ns"].fipi(Xposs) lusns = slf.ols["ns"].lusns ini = slf.ols["ns"].ini lif ho == "bsn": luslbls = slf.ols["bsn"].fipi(Xposs) lusns = np.y([]) # BSN osn' hv xplii ns ini = 0.0 ls: is Vluo(f"Unnown lusin ho: {ho}") # lul lusin quliy silhou = slf.lulsilhouso(Xposs, luslbls) sul = lusinsul( luslbls=luslbls.olis(), lusns=lusns, silhouso=silhou, ini=ini, nuluss=ln( np.uniqu(luslbls[luslbls != -1]) ), # xlu nois poins ) # p bs on lusin quliy piononx = { "lusinho": ho, "silhouso": silhou, "nuluss": sul.nuluss, "poins": Xposs.shp[0], } slf.lifloih.poss( Xposs.fln()[:1000], piononx ) lo.info( f"Pn isovy opl: {sul.nuluss} luss foun" ) un sul xp xpion s : lo.o(f"o in pn isovy: {s()}") un lusinsul() f pivpnlnin( slf, X: np.ny, y: Opionl[np.ny] = Non, lnino: Lnino = Lnino.PIV, ) -> i[s, ny]: """piv pn lnin usin L.I.F. hoy""" y: si = i.now() # x iniil pn fus iniilfus = slf.xpnfus(X) suls = { "lnino": lnino.vlu, "iniilfus": iniilfus, "pionsps": [], "finlpfon": {}, "lninjoy": [], } # in lnin ppoh if lnino == Lnino.SUPVIS n y is no Non: # Hihlyvis piv lnin fo sp in n(5): # ulipl pion sps # in lssifi ininsul = slf.inpnlssifi( X, y, "nulnwo" ) # vlu n p pfon = ininsul["ininis"]["uy"] # p fus bs on pfon if pfon < 0.8: X = slf.nhnfus( X, ininsul["fuipon"] ) suls["pionsps"].ppn( { "sp": sp, "pfon": pfon, "fuoun": X.shp[1], } ) suls["lninjoy"].ppn(pfon) suls["finlpfon"] = ininsul["ininis"] lif lnino == Lnino.UNSUPVIS: # Unsupvis piv lnin fo sp in n(3): # isov pns lusinsul = slf.isovpns(X, "ns") # p bs on lusin quliy if lusinsul.silhouso < 0.5: X = slf.nsfofusfolusin(X) suls["pionsps"].ppn( { "sp": sp, "silhouso": lusinsul.silhouso, "nuluss": lusinsul.nuluss, } ) suls["lninjoy"].ppn( lusinsul.silhouso ) suls["finlpfon"] = { "silhouso": lusinsul.silhouso, "nuluss": lusinsul.nuluss, } lif lnino == Lnino.PIV: # Pu L.I.F. piv lnin pionsos = [] fo sp in n(10): # Poss houh L.I.F. loih p = slf.lifloih.poss( X.fln()[:1000], # Us subs {"sp": sp, "lnino": "piv"}, ) # lul pion so pionso = slf.lifloih.pfonis()[ "ovllpfon" ] pionsos.ppn(pionso) suls["pionsps"].ppn( { "sp": sp, "pionso": pionso, "xpins": ln( slf.lifloih.xpinoy.xpins ), } ) suls["lninjoy"] = pionsos suls["finlpfon"] = { "finlpionso": pionsos[-1], "lninipovn": pionsos[-1] - pionsos[0], } # o lnin sssion lnini = (i.now() - si).olsons() suls["lnini"] = lnini # Up pion hisoy slf.pionhisoy.ppn( { "isp": si.isofo(), "lnino": lnino.vlu, "finlpfon": suls["finlpfon"], "lnini": lnini, } ) lo.info(f"piv pn lnin opl in {lnini:.2f}s") un suls xp xpion s : lo.o(f"o in piv pn lnin: {s()}") un {"o": s(), "lnino": lnino.vlu} f ppossfus(slf, X: np.ny, fi: bool = Fls) -> np.ny: """Pposs fus fo ol inin/piion""" y: # nsu 2 y if X.ni == 1: X = X.shp(1, -1) lif X.ni > 2: X = X.shp(X.shp[0], -1) # Sl fus if fi: Xsl = slf.fupossos["sl"].finsfo(X) ls: Xsl = slf.fupossos["sl"].nsfo(X) un Xsl xp xpion s : lo.o(f"o ppossin fus: {s()}") un X.opy() if X.ni == 2 ls X.shp(1, -1) f finopilluss(slf, X: np.ny, x: in = 10) -> in: """Fin opil nub of luss usin lbow ho""" y: x = in(x, X.shp[0] - 1) if x < 2: un 2 inis = [] n = n(2, x + 1) fo  in n: ns = ns(nluss=, nos=42) ns.fi(X) inis.ppn(ns.ini) # Fin lbow poin if ln(inis) < 2: un 2 # lul son iviv o fin lbow iffs = np.iff(inis) iff2 = np.iff(iffs) if ln(iff2) > 0: lbowinx = np.x(iff2) + 2 # +2 bus w s fo =2 un in(x, x(2, lbowinx)) ls: un in(5, x) # ful o 5 luss xp xpion s : lo.o(f"o finin opil luss: {s()}") un 3 # ful f lulsilhouso(slf, X: np.ny, lbls: np.ny) -> flo: """lul silhou so fo lusin""" y: fo sln.is ipo silhouso # ov nois poins (lbl -1) fo BSN vlis = lbls != -1 if np.su(vlis) < 2: un 0.0 Xvli = X[vlis] lblsvli = lbls[vlis] if ln(np.uniqu(lblsvli)) < 2: un 0.0 so = silhouso(Xvli, lblsvli) un flo(so) xp xpion s : lo.o(f"o lulin silhou so: {s()}") un 0.0 f nhnfus( slf, X: np.ny, fuipon: Lis[flo] ) -> np.ny: """nhn fus bs on ipon sos""" y: if no fuipon o ln(fuipon) != X.shp[1]: un X.opy() #  polynoil fus fo ipon fus iponhshol = np.n(fuipon) iponfus = np.y(fuipon) > iponhshol nhnX = X.opy() #  inion s fo ipon fus fo i, isiponi in nu(iponfus): if isiponi: fo j, isiponj in nu(iponfus): if isiponj n i < j: inion = (X[:, i] * X[:, j]).shp(-1, 1) nhnX = np.hs([nhnX, inion]) un nhnX xp xpion s : lo.o(f"o nhnin fus: {s()}") un X.opy() f nsfofusfolusin(slf, X: np.ny) -> np.ny: """nsfo fus o ipov lusin""" y: # pply I nsfoion if X.shp[1] > 1: nsfoX = slf.fupossos["i"].finsfo(X) un nsfoX ls: un X.opy() xp xpion s : lo.o(f"o nsfoin fus: {s()}") un X.opy() # Hlp hos fo fu lulions (us fo sinl posso) f lulswnss(slf, : np.ny) -> flo: y: nvl = np.n() svl = np.s() if svl == 0: un 0.0 un np.n((( - nvl) / svl) ** 3) xp: un 0.0 f luluosis(slf, : np.ny) -> flo: y: nvl = np.n() svl = np.s() if svl == 0: un 0.0 un np.n((( - nvl) / svl) ** 4) - 3 xp: un 0.0 f lulnopy(slf, : np.ny) -> flo: y: # Hiso-bs nopy his,  = np.hiso(, bins=50, nsiy=u) his = his + 1-12 # voi lo(0) nopy = -np.su(his * np.lo2(his)) un nopy xp: un 0.0 f lullzoplxiy(slf, : np.ny) -> flo: """Siplifi LZ oplxiy lulion""" y: biny = ( > np.in()).syp(in) un ln( s(upl(biny[i : i + 4]) fo i in n(ln(biny) - 3)) ) / ln(biny) xp: un 0.0 f lulppoxinopy( slf, : np.ny, : in = 2, : flo = 0.2 ) -> flo: """Siplifi ppoxi nopy""" y: N = ln() if N < 50: un 0.0 un np.v() / (np.n() ** 2 + 1-8) xp: un 0.0 f lulsplnopy(slf, : np.ny) -> flo: """Siplifi spl nopy""" y: un slf.lulppoxinopy() xp: un 0.0 f lulflinsion(slf, : np.ny) -> flo: """Siplifi fl insion""" y: iff = np.iff() un 1.0 + np.lo(np.n(np.bs(iff))) / np.lo(ln()) xp: un 1.0 f lulsplnopy(slf, : np.ny) -> flo: """Siplifi spl nopy""" y: ff = np.bs(np.ff.ff()) ps = ff**2 psno = ps / np.su(ps) psno = psno[psno > 0] un -np.su(psno * np.lo2(psno)) xp: un 0.0 f sisn(slf, : np.ny) -> flo: """si sinl-o-nois io""" y: sinlpow = np.n(**2) noispow = np.v(np.iff()) / 2 if noispow == 0: un 100.0 un 10 * np.lo10(sinlpow / noispow) xp: un 0.0 f ssssquliy(slf, : np.ny) -> flo: """ssss ovll  quliy""" y: # h fo NN/inf vlus if np.ny(~np.isfini()): un 0.0 # h fo onsn vlus if np.s() == 0: un 0.2 # h fo sonbl n n = np.pp() if n == 0: un 0.3 # obin quliy so un 0.8 + 0.2 * in(1.0, np.s() / np.n(np.bs() + 1-8)) xp: un 0.5 f lulfusbiliy(slf, : np.ny) -> flo: """lul fu sbiliy oss spls""" y: if .shp[0] < 2: un 1.0 # lul offiin of viion fo h fu fuvs = [] fo i in n(.shp[1]): fuol = [:, i] if np.s(fuol) == 0: v = 0.0 ls: v = np.s(fuol) / (np.n(np.bs(fuol)) + 1-8) fuvs.ppn(v) # Sbiliy is invs of vibiliy vv = np.n(fuvs) sbiliy = 1.0 / (1.0 + vv) un sbiliy xp: un 0.5 f lulinfoiononn(slf, : np.ny) -> flo: """lul infoion onn of """ y: # Us nopy s infoion su fln = .fln() un slf.lulnopy(fln) / np.lo2(ln(fln)) xp: un 0.5 f onizsus(slf) -> i[s, ny]: """ ophnsiv oniz sus""" un { "pnyp": slf.pnyp.vlu, "inols": lis(slf.inols), "pnoysiz": ln(slf.pnoy), "pionhisoysiz": ln(slf.pionhisoy), "nuy": ( np.n(slf.pfonis["uyhisoy"][-5:]) if slf.pfonis["uyhisoy"] ls 0.0 ), "nf1": ( np.n(slf.pfonis["f1hisoy"][-5:]) if slf.pfonis["f1hisoy"] ls 0.0 ), "lifloihsus": slf.lifloih.pfonis(), "fuinsions": slf.fuinsions, } f lifpnoniz( pnyp: Pnyp = Pnyp.POL, ) -> LIFPnoniz: """Foy funion o  L.I.F. pn oniz""" un LIFPnoniz(pnyp) # xpl us n sin f slifpnoniz(): """s L.I.F. pn oniz funionliy""" pin("sin L.I.F. hoy Pn oniz...") #  oniz oniz = lifpnoniz(Pnyp.NUL) # n s  np.no.s(42) # lssifiion  Xlss = np.no.nn(200, 10) ylss = np.no.nin(0, 3, 200) # lusin  Xlus = np.no.nn(100, 5) pin( f"n s : {Xlss.shp} fo lssifiion, {Xlus.shp} fo lusin" ) # s fu xion fus = oniz.xpnfus(Xlss[:10]) pin( f"x fus - w: {fus.wfus.shp}, u: {fus.ufus.shp}" ) pin(f"Sisil fus: {ln(fus.sisilfus)}") pin(f"Quliy is: {fus.quliyis}") # s supvis lnin pin("\nsin supvis pn lnin...") ininsul = oniz.inpnlssifi( Xlss, ylss, "nulnwo" ) pin(f"inin uy: {ininsul['ininis']['uy']:.3f}") pin(f"inin F1 so: {ininsul['ininis']['f1so']:.3f}") # s lssifiion sspl = Xlss[:1] lssifiion = oniz.lssifypn(sspl, "nulnwo") pin( f"lssifiion sul: lss {lssifiion.pilss}, onfin {lssifiion.onfin:.3f}" ) # s unsupvis lnin pin("\nsin unsupvis pn isovy...") lusinsul = oniz.isovpns(Xlus, "ns") pin(f"isov {lusinsul.nuluss} luss") pin(f"Silhou so: {lusinsul.silhouso:.3f}") # s piv lnin pin("\nsin piv pn lnin...") pivsul = oniz.pivpnlnin( Xlss, ylss, Lnino.PIV ) pin(f"piv lnin sps: {ln(pivsul['pionsps'])}") pin(f"Lnin joy: {pivsul['lninjoy']}") #  sus sus = oniz.onizsus() pin(f"\noniz Sus:") pin(f" Pn yp: {sus['pnyp']}") pin(f" in ols: {sus['inols']}") pin(f" n uy: {sus['nuy']:.3f}") un oniz, pivsul if n == "in": # un ss oniz, suls = slifpnoniz() pin("\nL.I.F. Pn oniz sin opl sussfully!")