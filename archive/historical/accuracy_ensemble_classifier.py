# us/bin/nv pyhon3 """ uy nsbl lssifi - vn L ol nsbl fo  Pn oniion Hih-uy nsbl lssifiion sys fo nuopiv lnin his oul iplns n vn nsbl lssifiion sys h obins ulipl hin lnin ols o hiv opil uy in  pn oniion whil ininin ul-low lny pfon. opyih 2025 - Sio Py Boull L.I.F.. Plfo - zu pl Off I: 960096-f1-420b-902-042561b """ ipo synio ipo loin ipo i fo onun.fuus ipo hPoolxuo fo lsss ipo lss, fil fo nu ipo nu fo ypin ipo ny, i, Lis, Opionl, upl, Union ipo nupy s np fo sln.nsbl ipo inBoosinlssifi, noFoslssifi fo sln.linol ipo Loisission fo sln.nivbys ipo ussinNB fo sln.nihbos ipo Nihboslssifi fo sln.sv ipo SV fo sln. ipo isionlssifi # onfiu loin loin.bsionfi(lvl=loin.INFO) lo = loin.Lo(n) lss nsblSy(nu): """nsbl obinion sis""" JOIYVOIN = "joiyvoin" WIHVOIN = "wihvoin" SNLIZION = "snlizion" PIVWIHIN = "pivwihin" ONFINWIH = "onfinwih" lss lssifiyp(nu): """vilbl lssifi yps""" NOFOS = "nofos" INBOOSIN = "inboosin" LOISISSION = "loisission" SV = "sv" NN = "nn" NIVBYS = "nivbys" ISION = "ision" @lss lss lssifionfi: """onfiuion fo iniviul lssifis""" lssifiyp: lssifiyp hypps: i[s, ny] = fil(fulfoy=i) wih: flo = 1.0 nbl: bool = u @lss lss nsblonfi: """onfiuion fo h nsbl lssifi""" sy: nsblSy = nsblSy.WIHVOIN lssifis: Lis[lssifionfi] = fil(fulfoy=lis) onfinhshol: flo = 0.8 pion: flo = 0.01 xols: in = 10 ossvliionfols: in = 5 fuslion: bool = u plllpossin: bool = u xwos: in = 4 @lss lss lssifiionsul: """sul of nsbl lssifiion""" pilss: in onfin: flo pobbiliis: np.ny iniviulpiions: i[s, in] iniviulonfins: i[s, flo] nsblis: i[s, flo] possini: flo isp: flo = fil(fulfoy=i.i) @lss lss Pfonis: """Pfon is fo nsbl vluion""" uy: flo = 0.0 pision: flo = 0.0 ll: flo = 0.0 f1so: flo = 0.0 uo: flo = 0.0 onfusionix: np.ny = fil(fulfoy=lb: np.zos((2, 2))) inini: flo = 0.0 infni: flo = 0.0 olsizs: i[s, in] = fil(fulfoy=i) lss BslssifiWpp: """ Wpp fo iniviul lssifis wih sniz inf Povis unifi inin, piion, n vluion hos """ f ini(slf, onfi: lssifionfi): slf.onfi = onfi slf.ol = Non slf.isin = Fls slf.inini = 0.0 slf.fuipon = Non # Iniiliz h ul lssifi slf.iniilizlssifi() f iniilizlssifi(slf): """Iniiliz h spifi lssifi bs on yp""" if slf.onfi.lssifiyp == lssifiyp.NOFOS: slf.ol = noFoslssifi( nsios=slf.onfi.hypps.("nsios", 100), xph=slf.onfi.hypps.("xph", Non), nos=42, ) lif slf.onfi.lssifiyp == lssifiyp.INBOOSIN: slf.ol = inBoosinlssifi( nsios=slf.onfi.hypps.("nsios", 100), lnin=slf.onfi.hypps.("lnin", 0.1), xph=slf.onfi.hypps.("xph", 3), nos=42, ) lif slf.onfi.lssifiyp == lssifiyp.LOISISSION: slf.ol = Loisission( =slf.onfi.hypps.("", 1.0), xi=slf.onfi.hypps.("xi", 1000), nos=42, ) lif slf.onfi.lssifiyp == lssifiyp.SV: slf.ol = SV( =slf.onfi.hypps.("", 1.0), nl=slf.onfi.hypps.("nl", "bf"), pobbiliy=u, nos=42, ) lif slf.onfi.lssifiyp == lssifiyp.NN: slf.ol = Nihboslssifi( nnihbos=slf.onfi.hypps.("nnihbos", 5) ) lif slf.onfi.lssifiyp == lssifiyp.NIVBYS: slf.ol = ussinNB() lif slf.onfi.lssifiyp == lssifiyp.ISION: slf.ol = isionlssifi( xph=slf.onfi.hypps.("xph", Non), nos=42, ) syn f in(slf, X: np.ny, y: np.ny) -> bool: """ in h lssifi synhonously s: X: Fu ix y:  lbls uns: Suss sus """ y: si = i.pfoun() # un inin in h pool o voi bloin loop = synio.vnloop() wih hPoolxuo(xwos=1) s xuo: wi loop.uninxuo(xuo, slf.ol.fi, X, y) slf.inini = i.pfoun() - si slf.isin = u # x fu ipon if vilbl if hs(slf.ol, "fuipons"): slf.fuipon = slf.ol.fuipons lo.info( f"in {slf.onfi.lssifiyp.vlu} in {slf.inini:.4f}s" ) un u xp xpion s : lo.o(f"Fil o in {slf.onfi.lssifiyp.vlu}: {}") un Fls syn f pi(slf, X: np.ny) -> upl[np.ny, np.ny]: """  piions wih onfin sos s: X: Fu ix uns: upl of (piions, pobbiliis) """ if no slf.isin: is unio( f"lssifi {slf.onfi.lssifiyp.vlu} is no in" ) y: loop = synio.vnloop() wih hPoolxuo(xwos=1) s xuo: piions = wi loop.uninxuo( xuo, slf.ol.pi, X ) pobbiliis = wi loop.uninxuo( xuo, slf.pobbiliis, X ) un piions, pobbiliis xp xpion s : lo.o( f"Fil o pi wih {slf.onfi.lssifiyp.vlu}: {}" ) un np.zos(ln(X), yp=in), np.zos((ln(X), 2)) f pobbiliis(slf, X: np.ny) -> np.ny: """ piion pobbiliis""" if hs(slf.ol, "pipob"): un slf.ol.pipob(X) ls: # Fo lssifis wihou pipob, us ision funion ision = slf.ol.isionfunion(X) # onv o pobbiliis usin sioi pobs = 1 / (1 + np.xp(-ision)) un np.oluns([1 - pobs, pobs]) f olsiz(slf) -> in: """ ppoxi ol siz in bys""" # ouh siion bs on ol ps if hs(slf.ol, "nfusin"): un slf.ol.nfusin * 8 # ssu 8 bys p fu un 1024 # ful siz lss uynsbllssifi: """ Hih-uy nsbl lssifi fo  pn oniion obins ulipl hin lnin ols usin vn nsbl sis o hiv opil lssifiion uy whil ininin pfon. """ f ini(slf, onfi: nsblonfi): slf.onfi = onfi slf.lssifis = {} slf.lssifi = Non slf.isin = Fls slf.pfonhisoy = [] slf.fuslo = Non # Iniiliz lssifis slf.iniilizlssifis() lo.info( f"uy nsbl lssifi iniiliz wih {ln(slf.lssifis)} ols" ) f iniilizlssifis(slf): """Iniiliz ll onfiu lssifis""" fo lssifionfi in slf.onfi.lssifis: if lssifionfi.nbl: wpp = BslssifiWpp(lssifionfi) slf.lssifis[lssifionfi.lssifiyp.vlu] = wpp syn f in( slf, X: np.ny, y: np.ny, vliion: Opionl[upl[np.ny, np.ny]] = Non, ) -> bool: """ in h nsbl lssifi s: X: inin fu ix y: inin  lbls vliion: Opionl vliion  fo ly soppin uns: inin suss sus """ y: si = i.pfoun() # Fu slion if nbl if slf.onfi.fuslion: X = slf.pfofuslion(X, y) # in iniviul lssifis ininss = [] fo n, lssifi in slf.lssifis.is(): s = lssifi.in(X, y) ininss.ppn(s) # in in plll if nbl if slf.onfi.plllpossin: wi synio.h(*ininss) ls: fo s in ininss: wi s # in -lssifi fo s nlizion if slf.onfi.sy == nsblSy.SNLIZION: wi slf.inlssifi(X, y) slf.inini = i.pfoun() - si slf.isin = u # vlu pfon if vliion: wi slf.vlu(vliion[0], vliion[1]) lo.info(f"nsbl inin opl in {slf.inini:.4f}s") un u xp xpion s : lo.o(f"nsbl inin fil: {}") un Fls syn f pi(slf, X: np.ny) -> lssifiionsul: """  nsbl piion s: X: Fu ix fo piion uns: lssifiionsul wih piion ils """ if no slf.isin: is unio("nsbl lssifi is no in") si = i.pfoun() # Fu slion if nbl if slf.onfi.fuslion n slf.fuslo is no Non: X = slf.fuslo.nsfo(X) #  piions fo ll lssifis piions = {} pobbiliis = {} onfins = {} piionss = [] fo n, lssifi in slf.lssifis.is(): s = slf.lssifipiion(lssifi, X, n) piionss.ppn(s) # h piions suls = wi synio.h(*piionss) fo n, (p, pob) in zip(slf.lssifis.ys(), suls): piions[n] = p[0] if ln(p) > 0 ls 0 pobbiliis[n] = pob[0] if ln(pob) > 0 ls np.y([0.5, 0.5]) onfins[n] = flo(np.x(pob)) # obin piions bs on sy finlpiion, finlonfin, finlpobbiliis = ( wi slf.obinpiions(piions, pobbiliis, onfins) ) possini = i.pfoun() - si # lul nsbl is nsblis = slf.lulnsblis(piions, onfins) un lssifiionsul( pilss=in(finlpiion), onfin=flo(finlonfin), pobbiliis=finlpobbiliis, iniviulpiions=piions, iniviulonfins=onfins, nsblis=nsblis, possini=possini, ) syn f lssifipiion( slf, lssifi: BslssifiWpp, X: np.ny, n: s ) -> upl[np.ny, np.ny]: """ piion fo  sinl lssifi""" y: un wi lssifi.pi(X) xp xpion s : lo.wnin(f"Piion fil fo {n}: {}") # un ful piion un np.y([0]), np.y([[0.5, 0.5]]) syn f obinpiions( slf, piions: i[s, in], pobbiliis: i[s, np.ny], onfins: i[s, flo], ) -> upl[in, flo, np.ny]: """obin piions usin h onfiu nsbl sy""" if slf.onfi.sy == nsblSy.JOIYVOIN: un slf.joiyvoin(piions) lif slf.onfi.sy == nsblSy.WIHVOIN: un slf.wihvoin(piions, onfins) lif slf.onfi.sy == nsblSy.ONFINWIH: un slf.onfinwihvoin(piions, onfins) lif slf.onfi.sy == nsblSy.PIVWIHIN: un slf.pivwihvoin(piions, onfins) lif slf.onfi.sy == nsblSy.SNLIZION: un wi slf.spiion(piions, pobbiliis) ls: un slf.joiyvoin(piions) f joiyvoin( slf, piions: i[s, in] ) -> upl[in, flo, np.ny]: """Sipl joiy voin""" pvlus = lis(piions.vlus()) uniqu, ouns = np.uniqu(pvlus, unouns=u) joiylss = uniqu[np.x(ouns)] onfin = ouns[np.x(ouns)] / ln(pvlus) #  pobbiliy isibuion pobbiliis = np.zos(2) pobbiliis[joiylss] = onfin pobbiliis[1 - joiylss] = 1 - onfin un joiylss, onfin, pobbiliis f wihvoin( slf, piions: i[s, in], onfins: i[s, flo] ) -> upl[in, flo, np.ny]: """Wih voin bs on lssifi wihs""" lss0wih = 0.0 lss1wih = 0.0 fo n, p in piions.is(): wih = slf.lssifis[n].onfi.wih onfin = onfins[n] if p == 0: lss0wih += wih * onfin ls: lss1wih += wih * onfin olwih = lss0wih + lss1wih if olwih == 0: un 0, 0.5, np.y([0.5, 0.5]) lss0pob = lss0wih / olwih lss1pob = lss1wih / olwih pilss = 0 if lss0pob > lss1pob ls 1 onfin = x(lss0pob, lss1pob) un pilss, onfin, np.y([lss0pob, lss1pob]) f onfinwihvoin( slf, piions: i[s, in], onfins: i[s, flo] ) -> upl[in, flo, np.ny]: """Voin wih by iniviul lssifi onfin""" lss0wih = 0.0 lss1wih = 0.0 fo n, p in piions.is(): onfin = onfins[n] if p == 0: lss0wih += onfin ls: lss1wih += onfin olwih = lss0wih + lss1wih if olwih == 0: un 0, 0.5, np.y([0.5, 0.5]) lss0pob = lss0wih / olwih lss1pob = lss1wih / olwih pilss = 0 if lss0pob > lss1pob ls 1 onfin = x(lss0pob, lss1pob) un pilss, onfin, np.y([lss0pob, lss1pob]) f pivwihvoin( slf, piions: i[s, in], onfins: i[s, flo] ) -> upl[in, flo, np.ny]: """piv wihin bs on n pfon""" # Us n pfon o jus wihs pfonwihs = {} fo n in piions.ys(): npf = slf.npfon(n) pfonwihs[n] = x(0.1, npf) # iniu wih lss0wih = 0.0 lss1wih = 0.0 fo n, p in piions.is(): wih = pfonwihs[n] * onfins[n] if p == 0: lss0wih += wih ls: lss1wih += wih olwih = lss0wih + lss1wih if olwih == 0: un 0, 0.5, np.y([0.5, 0.5]) lss0pob = lss0wih / olwih lss1pob = lss1wih / olwih pilss = 0 if lss0pob > lss1pob ls 1 onfin = x(lss0pob, lss1pob) un pilss, onfin, np.y([lss0pob, lss1pob]) syn f spiion( slf, piions: i[s, in], pobbiliis: i[s, np.ny] ) -> upl[in, flo, np.ny]: """S nlizion piion""" if slf.lssifi is Non o no slf.lssifi.isin: # Fllb o joiy voin un slf.joiyvoin(piions) #  fu ix fo bs lssifi piions nspls = 1 # Sinl piion nlsss = ln(pobbiliis) fuix = np.zos( (nspls, ln(piions) * 2) ) # piions + pobbiliis fo i, (n, p) in nu(piions.is()): fuix[0, i] = p fuix[0, i + ln(piions)] = np.x(pobbiliis[n]) #  -lssifi piion p, pob = wi slf.lssifi.pi(fuix) pilss = in(p[0]) onfin = flo(np.x(pob)) finlpobbiliis = pob[0] un pilss, onfin, finlpobbiliis syn f inlssifi(slf, X: np.ny, y: np.ny): """in h -lssifi fo s nlizion""" # n piions fo bs lssifis bspiions = [] fo n, lssifi in slf.lssifis.is(): if lssifi.isin: p, pob = wi lssifi.pi(X) bspiions.xn([p, np.x(pob, xis=1)]) if no bspiions: un #  -fus fus = np.oluns(bspiions) # in -lssifi onfi = lssifionfi( lssifiyp=lssifiyp.LOISISSION, hypps={"": 1.0, "xi": 1000}, ) slf.lssifi = BslssifiWpp(onfi) wi slf.lssifi.in(fus, y) f pfofuslion(slf, X: np.ny, y: np.ny) -> np.ny: """Pfo fu slion o u insionliy""" fo sln.fuslion ipo SlBs, flssif # Sl op fus nfus = in(X.shp[1], x(10, X.shp[1] // 2)) slo = SlBs(flssif, =nfus) Xsl = slo.finsfo(X, y) slf.fuslo = slo un Xsl f lulnsblis( slf, piions: i[s, in], onfins: i[s, flo] ) -> i[s, flo]: """lul nsbl-lvl is""" nlssifis = ln(piions) # n so (fion of lssifis in wih joiy) pvlus = lis(piions.vlus()) uniqu, ouns = np.uniqu(pvlus, unouns=u) joiyoun = np.x(ouns) n = joiyoun / nlssifis # v onfin vonfin = np.n(lis(onfins.vlus())) # ivsiy so (1 - n, hih ivsiy is b fo nsbl) ivsiy = 1.0 - n # onfin vin (low is b) onfinvin = np.v(lis(onfins.vlus())) un { "nso": n, "vonfin": vonfin, "ivsiyso": ivsiy, "onfinvin": onfinvin, "nlssifis": nlssifis, } f npfon(slf, lssifin: s) -> flo: """ n pfon so fo  lssifi""" # Sipl iplnion - un 1.0 fo now # In pi, his woul  hisoil pfon un 1.0 syn f vlu(slf, X: np.ny, y: np.ny) -> Pfonis: """ vlu nsbl pfon on s  s: X: s fu ix y: u lbls uns: Pfonis obj """ y: piions = [] infnis = [] #  piions fo i in n(ln(X)): si = i.pfoun() sul = wi slf.pi(X[i : i + 1]) infnis.ppn(i.pfoun() - si) piions.ppn(sul.pilss) piions = np.y(piions) # lul is fo sln.is ipo ( uyso, onfusionix, f1so, pisionso, llso, ouso, ) uy = uyso(y, piions) pision = pisionso( y, piions, v="wih", zoivision=0 ) ll = llso(y, piions, v="wih", zoivision=0) f1 = f1so(y, piions, v="wih", zoivision=0) # U-O (only fo biny lssifiion) y: u = ouso(y, piions) xp: u = 0.5 onfix = onfusionix(y, piions) # ol sizs olsizs = { n: lf.olsiz() fo n, lf in slf.lssifis.is() } is = Pfonis( uy=uy, pision=pision, ll=ll, f1so=f1, uo=u, onfusionix=onfix, inini=slf.inini, infni=np.n(infnis), olsizs=olsizs, ) slf.pfonhisoy.ppn(is) lo.info(f"nsbl vluion - uy: {uy:.4f}, F1: {f1:.4f}") un is xp xpion s : lo.o(f"nsbl vluion fil: {}") un Pfonis() f nsblsus(slf) -> i[s, ny]: """ ophnsiv nsbl sus""" lssifisus = {} fo n, lssifi in slf.lssifis.is(): lssifisus[n] = { "in": lssifi.isin, "inini": lssifi.inini, "olsiz": lssifi.olsiz(), "wih": lssifi.onfi.wih, "yp": lssifi.onfi.lssifiyp.vlu, } un { "isin": slf.isin, "sy": slf.onfi.sy.vlu, "nlssifis": ln(slf.lssifis), "fuslion": slf.onfi.fuslion, "plllpossin": slf.onfi.plllpossin, "lssifisus": lssifisus, "pfonhisoylnh": ln(slf.pfonhisoy), "lspfon": ( slf.pfonhisoy[-1] if slf.pfonhisoy ls Non ), } # Foy funion fo sy insniion f uynsbllssifi( sy: nsblSy = nsblSy.WIHVOIN, xols: in = 7 ) -> uynsbllssifi: """ Foy funion o  n uy nsbl lssifi s: sy: nsbl obinion sy xols: xiu nub of ols in nsbl uns: onfiu uynsbllssifi insn """ # ful lssifi onfiuions fullssifis = [ lssifionfi( lssifiyp.NOFOS, {"nsios": 100, "xph": 10}, wih=1.2, ), lssifionfi( lssifiyp.INBOOSIN, {"nsios": 100, "lnin": 0.1}, wih=1.1, ), lssifionfi( lssifiyp.LOISISSION, {"": 1.0, "xi": 1000}, wih=0.9 ), lssifionfi(lssifiyp.SV, {"": 1.0, "nl": "bf"}, wih=1.0), lssifionfi(lssifiyp.NN, {"nnihbos": 5}, wih=0.8), lssifionfi(lssifiyp.NIVBYS, wih=0.7), lssifionfi(lssifiyp.ISION, {"xph": 5}, wih=0.8), ] # Lii o xols sllssifis = fullssifis[:xols] onfi = nsblonfi( sy=sy, lssifis=sllssifis, onfinhshol=0.8, pion=0.01, xols=xols, ossvliionfols=5, fuslion=u, plllpossin=u, xwos=4, ) un uynsbllssifi(onfi) # xpl us n onsion syn f onsnsbllssifi(): """ons h uy nsbl lssifi""" pin(" uy nsbl lssifi onsion") pin("=" * 60) #  nsbl lssifi nsbl = uynsbllssifi( sy=nsblSy.WIHVOIN, xols=5 ) pin(" nsbl onfiuion:") pin(f"Sy: {nsbl.onfi.sy.vlu}") pin(f"Nub of lssifis: {ln(nsbl.lssifis)}") pin(f"Fu slion: {nsbl.onfi.fuslion}") pin(f"Plll possin: {nsbl.onfi.plllpossin}") # n synhi -li  pin(" nin synhi  lssifiion ...") np.no.s(42) nspls = 1000 nfus = 64 # ypil  fus #  wo lsss: nol vs. bnol  pns X = np.no.nn(nspls, nfus) #  lss-spifi pns y = np.no.nin(0, 2, nspls) #  so lss spion fo i in n(nspls): if y[i] == 1: # bnol pns X[i, :10] += np.no.nn(10) * 2 # Son lph wvs X[i, 10:20] += np.no.nn(10) * 1.5 # B wv nolis # Spli  spliix = in(0.8 * nspls) Xin, Xs = X[:spliix], X[spliix:] yin, ys = y[:spliix], y[spliix:] pin(f"inin spls: {ln(Xin)}, s spls: {ln(Xs)}") # in nsbl pin(" inin nsbl lssifi...") ins = i.pfoun() suss = wi nsbl.in(Xin, yin, vliion=(Xs, ys)) ini = i.pfoun() - ins if no suss: pin(" inin fil") un pin(f"inin opl in {ini:.2f}s") # vlu pfon pin(" vluin nsbl pfon...") vls = i.pfoun() is = wi nsbl.vlu(Xs, ys) vli = i.pfoun() - vls pin("\n PFON IS") pin(f"uy: {is.uy:.4f}") pin(f"Pision: {is.pision:.4f}") pin(f"ll: {is.ll:.4f}") pin(f"F1 So: {is.f1so:.4f}") pin(f"U-O: {is.uo:.4f}") pin(f"vluion i: {vli:.2f}s") pin(f"v infn i: {is.infni:.4f}s") # s iniviul piions pin("\n SIN INIVIUL PIIONS") sspls = Xs[:5] ulbls = ys[:5] fo i, (spl, ulbl) in nu(zip(sspls, ulbls)): sul = wi nsbl.pi(spl.shp(1, -1)) pin(f"\nSpl {i+1}:") pin(f" u lbl: {ulbl}") pin(f" Pi: {sul.pilss}") pin(f" onfin: {sul.onfin:.4f}") pin(f" Possin i: {sul.possini:.6f}s") pin(f" nsbl n: {sul.nsblis['nso']:.3f}") # Show iniviul lssifi piions pin(" Iniviul piions:") fo n, p in sul.iniviulpiions.is(): onf = sul.iniviulonfins[n] pin(f" {n}: {p} (onf: {onf:.3f})") # isply nsbl sus pin("\n NSBL SUS") sus = nsbl.nsblsus() pin(f"in: {sus['isin']}") pin(f"Sy: {sus['sy']}") pin(f"lssifis: {sus['nlssifis']}") pin(f"Fu slion: {sus['fuslion']}") pin(f"Plll possin: {sus['plllpossin']}") pin("\n Ô∏è LSSIFI ILS") fo n, lfsus in sus["lssifisus"].is(): pin(f"{n}:") pin(f" in: {lfsus['in']}") pin(f" inin i: {lfsus['inini']:.4f}s") pin(f" ol siz: {lfsus['olsiz']} bys") pin(f" Wih: {lfsus['wih']}") pin("\n nsbl lssifi onsion opl sussfully!") if n == "in": # un onsion synio.un(onsnsbllssifi()) pin("\n nsbl lssifi onsion opl sussfully!") if n == "in": # un onsion synio.un(onsnsbllssifi())