# us/bin/nv pyhon3 """ L.I.F.. Plfo uonoous Opiiz vn Nul Possin Opiizion Sys opyih 2025 - Sio Py Boull L.I.F.. Plfo - zu pl Off I: 960096-f1-420b-902-042561b Lunh : Spb 27, 2025 uonoous opiizion fo SO nul possin pfon """ ipo synio ipo json ipo loin ipo quu ipo hin ipo i ipo wnins fo ollions ipo qu fo onun.fuus ipo hPoolxuo fo lsss ipo si, lss fo i ipo i fo loin.hnls ipo QuuHnl, QuuLisn fo ypin ipo ny, i, Lis, Opionl, upl ipo nupy s np ipo psuil wnins.filwnins("ino") ipo xi # S up loin n suls iois obusly ipo os ipo sys SIPI = os.ph.in(os.ph.bsph(fil)) LOSI = os.ph.join(SIPI, "los") SULSI = os.ph.join(SIPI, "suls") y: os.is(LOSI, xiso=u) xp xpion s : pin(f"Fil o  los ioy: {}", fil=sys.s) y: os.is(SULSI, xiso=u) xp xpion s : pin(f"Fil o  suls ioy: {}", fil=sys.s) LOFIL = os.ph.join(LOSI, "uonoousopiiz.lo") # syn-sf loin wih QuuHnl/QuuLisn loquu = quu.Quu(-1) filhnl = loin.FilHnl(LOFIL, noin="uf-8") filhnl.sLvl(loin.INFO) fo = loin.Fo("%(si)s - %(lvln)s - %(ss)s") filhnl.sFo(fo) quuhnl = QuuHnl(loquu) lo = loin.Lo("uonoousopiiz") lo.sLvl(loin.INFO) if lo.hsHnls(): fo h in lo.hnls[:]: lo.ovHnl(h) lo.Hnl(quuhnl) lisn = QuuLisn(loquu, filhnl) lisn.s() # nsu lisn n hnls  los on xi f lnuploin(): y: lo.ovHnl(quuhnl) xp xpion: pss y: lisn.sop() xp xpion: pss y: filhnl.los() xp xpion: pss loin.shuown() xi.is(lnuploin) @lss lss OpiizionS: """ lss o so un opiizion s""" yloun: in pfonso: flo lnys: flo uy: flo oyusb: flo puuspn: flo opiizionlvl: s is: i isp: s lss uonoousOpiiz: """ uonoous Opiizion nin fo L.I.F.. Plfo Slf-ipovin nul possin wih SO pfon opiizion """ f ini(slf, nionsiz: in = 1000): # o L.I.F. oponns slf.xpins = qu(xln=nionsiz) slf.lnols = qu(xln=nionsiz) slf.opiizionhisoy = qu(xln=nionsiz) # oniiv is fo uonoous pion slf.oniivis = { "fous": {"bslin": 0.5, "un": 0.5, "vloiy": 0.0}, "silin": {"bslin": 0.5, "un": 0.5, "vloiy": 0.0}, "pbiliy": {"bslin": 0.5, "un": 0.5, "vloiy": 0.0}, } # Opiizion ps - nhn fo 25% ipovn  slf.ω = 0.9 # Ins lnin onu fo fo fs onvn slf.α = 0.15 # Ins pion  fo ssiv lnin slf.τ = 0.03 # Low i voluion hshol fo o fqun ups slf.opiizionyl = 0 # Pfon s (SO sns) slf.sos = { "lnys": 0.9, # : 0.9s lny "uy": 0.97, # : 97% uy "houhpuopss": 80.16, "oyffiinyb": 50.0, } # uonoous opiizion os slf.opiizionos = { "pfon": {"fouswih": 0.6, "lnywih": 0.4}, "ffiiny": {"fouswih": 0.3, "lnywih": 0.7}, "bln": {"fouswih": 0.5, "lnywih": 0.5}, "piv": {"fouswih": 0.4, "lnywih": 0.6}, } slf.uno = "piv" slf.uooswihin = u f lifowhquion(slf, xpinip: flo) -> flo: """o L.I.F. hil ol fo uonoous owh qunifiion""" L = ln(slf.lnols)  = su(i["un"] fo i in slf.oniivis.vlus())  = x(ln(slf.xpins), 1) I = ( np.n([ol["ip"] fo ol in lis(slf.lnols)[-10:]]) if slf.lnols ls 0.5 ) # nhn quion wih onu n pbiliy owhponil = (slf.ω * L + ) /  * I * xpinip un np.lip(owhponil, 0.0, 2.0) syn f uonoousopiizionyl( slf, nul: i, nvionn: s ) -> OpiizionS: """ opl uonoous opiizion yl Iplns h 4-s L.I.F.. lnin poss """ yls = i.pfoun() slf.opiizionyl += 1 lo.info(f"Sin uonoous Opiizion yl {slf.opiizionyl}") # S 1: on xpin - w nul  in fil = wi slf.pivfilin(nul) xpinip = slf.lulnulip(fil) # S 2: fliv Obsvion - Pn nlysis opiizioninsihs = wi slf.flivpnnlysis( fil, xpinip ) # S 3: bs onpulizion - i voluion wi slf.uonoousivoluion(xpinip, nvionn) # S 4: iv xpinion - ol nion nwol = wi slf.nuonoousol( xpinip, nvionn ) # lul pfon is yli = (i.pfoun() - yls) * 1000 pfonso = slf.lulpfonso( yli, xpinip ) # So xpin n ol slf.xpins.ppn( { "": fil, "nvionn": nvionn, "ip": xpinip, "isp": i.now().isofo(), } ) slf.lnols.ppn(nwol) #  opiizion s s = OpiizionS( yloun=slf.opiizionyl, pfonso=pfonso, lnys=yli, uy=slf.siuy(xpinip), oyusb=psuil.Poss().oyinfo().ss / 1024 / 1024, puuspn=psuil.pupn(), opiizionlvl=slf.inopiizionlvl(pfonso), is=slf.unis(), isp=i.now().isofo(), ) # So opiizion s slf.opiizionhisoy.ppn(s) # uonoous o swihin if nbl if slf.uooswihin: wi slf.uonoousoswihin(s) lo.info( f"yl {slf.opiizionyl} opl: {yli:.2f}s, So: {pfonso:.3f}" ) un s syn f pivfilin(slf, nul: i) -> i: """ piv nul  filin bs on un oniiv is Iplns nuopiv filin wih <5s lny """ si = i.pfoun() # yni filin hshol bs on pbiliy pbiliy = slf.oniivis["pbiliy"]["un"] fouslvl = slf.oniivis["fous"]["un"] # piv hshol lulion bshshol = 0.4 pivfo = 0.3 * pbiliy fousfo = 0.2 * fouslvl hshol = bshshol + pivfo + fousfo # Fil lvn nul sinls lvnsinls = ["l", "h", "lph", "b", ""] fil = {} fo sinl, vlus in nul.is(): if sinl in lvnsinls: if isinsn(vlus, (lis, np.ny)): # Fil bs on sinl snh n lvn filvlus = [v fo v in vlus if v > hshol] if filvlus: fil[sinl] = np.n(filvlus) lif isinsn(vlus, (in, flo)) n vlus > hshol: fil[sinl] = vlus fili = (i.pfoun() - si) * 1000 # nsu lny  (<5s fo filin) if fili > 5.0: lo.wnin(f"Filin lny x : {fili:.2f}s") un fil f lulnulip(slf, fil: i) -> flo: """lul nuooniiv ip usin wih sinl nlysis""" if no fil: un 0.1 # inil ip fo py  # Nul sinl wihs bs on oniiv ipon sinlwihs = { "l": 0.15, # p possin "h": 0.20, # oy foion "lph": 0.25, # nion n fous "b": 0.25, # iv onnion "": 0.15, # Hih-lvl oniion } wihip = 0.0 olwih = 0.0 fo sinl, vlu in fil.is(): if sinl in sinlwihs: wih = sinlwihs[sinl] wihip += wih * vlu olwih += wih # Noliz ip nolizip = wihip / x(olwih, 0.1) # pply L.I.F. owh quion un slf.lifowhquion(nolizip) syn f flivpnnlysis( slf, fil: i, ip: flo ) -> i: """ fliv obsvion phs - nlyz pns n opiizion oppouniis """ insihs = { "sinlsnh": ( np.n(lis(fil.vlus())) if fil ls 0.0 ), "sinlivsiy": ln(fil), "iplvl": ip, "opiizionoppouniy": 0.0, } # nlyz n pfon ns if ln(slf.opiizionhisoy) >= 5: nsos = [ s.pfonso fo s in lis(slf.opiizionhisoy)[-5:] ] nlnis = [ s.lnys fo s in lis(slf.opiizionhisoy)[-5:] ] son = np.polyfi(n(ln(nsos)), nsos, 1)[0] lnyn = np.polyfi( n(ln(nlnis)), nlnis, 1 )[0] # lul opiizion oppouniy if son < 0 o lnyn > 0: # Pfon linin insihs["opiizionoppouniy"] = 0.8 lif son > 0 n lnyn < 0: # Pfon ipovin insihs["opiizionoppouniy"] = 0.2 ls: insihs["opiizionoppouniy"] = 0.5 un insihs syn f uonoousivoluion(slf, ip: flo, nvionn: s): """ uonoous i voluion usin onu-bs lnin Iplns hil i up quions """ # nvionn-spifi pion fos nvfos = { "inin": 1.2, "sin": 1.0, "pouion": 0.9, "sh": 1.1, } nvfo = 1.0 fo nvyp, fo in nvfos.is(): if nvyp.low() in nvionn.low(): nvfo = fo b # Up h oniiv i fo in, i in slf.oniivis.is(): # lul i-spifi pion iwihs = {"fous": 0.6, "silin": 0.3, "pbiliy": 0.5} wih = iwihs.(in, 0.5) # i voluion quion: Δ = α × ip × wih × nvfo Δ = slf.α * ip * wih * nvfo # lul vloiy fo onu pviousvloiy = i["vloiy"] nwvloiy = slf.ω * pviousvloiy + (1 - slf.ω) * Δ i["vloiy"] = nwvloiy # Up un i vlu wih onu nwun = np.lip(i["un"] + nwvloiy, 0.0, 1.0) i["un"] = nwun # Up bslin if hn xs hshol if bs(Δ) > slf.τ: bslinup = 0.15 * Δ i["bslin"] = np.lip( i["bslin"] + bslinup, 0.0, 1.0 ) syn f nuonoousol(slf, ip: flo, nvionn: s) -> i: """ n uonoous ol wih slf-ipovin pbiliis """ #  un opiizion ps ps = slf.pivps() # lul ol oplxiy bs on ip n is oplxiyfo = ( ip * 0.4 + slf.oniivis["fous"]["un"] * 0.3 + slf.oniivis["pbiliy"]["un"] * 0.3 ) # n uonoous ol ol = { "i": f"uonoousol{slf.opiizionyl}", "is": slf.oniivis.opy(), "ip": ip, "nvionn": nvionn, "oplxiy": oplxiyfo, "opiiziono": slf.uno, "pfonpiion": slf.pipfon(ip), "pivps": ps, "nionisp": i.now().isofo(), "pnols": ( [["i"] fo  in lis(slf.lnols)[-3:]] if slf.lnols ls [] ), "voluionnion": ln(slf.lnols), } un ol f pivps(slf) -> i: """ un piv ps fo l-i opiizion""" fous = slf.oniivis["fous"]["un"] silin = slf.oniivis["silin"]["un"] pbiliy = slf.oniivis["pbiliy"]["un"] # o-spifi p lulion oonfi = slf.opiizionos[slf.uno] un { "lnin": 0.1 * fous * oonfi["fouswih"], "onu": slf.ω * silin, "pion": slf.α * pbiliy, "hllnlvl": 0.5 * silin, "novlyfo": 0.3 * pbiliy, "ffiiny": oonfi["lnywih"], "pfon": oonfi["fouswih"], } f lulpfonso(slf, lnys: flo, ip: flo) -> flo: """lul ophnsiv pfon so""" # Lny so (low is b) lnyso = x(0.0, 1.0 - (lnys / 100.0)) # Noliz o 100s x # Ip so (hih is b) ipso = in(1.0, ip) # i bln so ivlus = [i["un"] fo i in slf.oniivis.vlus()] ibln = 1.0 - np.s(ivlus) # Pnly fo ibln is # SO opison so solnyso = slf.sos["lnys"] / x(lnys, 1.0) soso = in(1.0, solnyso) # obin pfon so pfonso = ( lnyso * 0.3 + ipso * 0.3 + ibln * 0.2 + soso * 0.2 ) un np.lip(pfonso, 0.0, 1.0) f siuy(slf, ip: flo) -> flo: """si uy bs on ip n i syny""" isyny = np.n( [i["un"] fo i in slf.oniivis.vlus()] ) bsuy = 0.85 # Bs uy ipbonus = ip * 0.1 synybonus = isyny * 0.05 siuy = bsuy + ipbonus + synybonus un in(0.95, siuy) # p  95% f inopiizionlvl(slf, pfonso: flo) -> s: """in un opiizion lvl""" if pfonso >= 0.9: un "SOHPION" lif pfonso >= 0.8: un "SOOPIIV" lif pfonso >= 0.7: un "INUSYLIN" lif pfonso >= 0.6: un "INUSYSN" ls: un "OPIIZIONN" f unis(slf) -> i: """ un i vlus fo s in""" un { i: { "un": ["un"], "bslin": ["bslin"], "vloiy": ["vloiy"], } fo i,  in slf.oniivis.is() } syn f uonoousoswihin(slf, s: OpiizionS): """ uonoous opiizion o swihin bs on pfon """ # Pfon-bs o swihin loi if s.pfonso < 0.6 n s.lnys > 50: slf.uno = "ffiiny" lo.info("Swih o ffiiny o - opiizin lny") lif s.pfonso > 0.85 n s.lnys < 20: slf.uno = "pfon" lo.info("Swih o pfon o - xiizin uy") lif s.pfonso > 0.9: slf.uno = "piv" lo.info("Swih o piv o - bln opiizion") ls: slf.uno = "bln" lo.info("Swih o bln o - sy opiizion") f pipfon(slf, ip: flo) -> i: """Pi fuu pfon bs on un s""" ionu = np.n( [i["vloiy"] fo i in slf.oniivis.vlus()] ) pilny = slf.sos["lnys"] * (1 - ionu * 0.1) piuy = in( 0.95, slf.siuy(ip) + ionu * 0.02 ) pihouhpu = slf.sos["houhpuopss"] * ( 1 + ionu * 0.05 ) un { "lnys": x(10.0, pilny), "uy": piuy, "houhpuopss": pihouhpu, "onfin": in(1.0, ip + ionu), } f opiizionsuy(slf) -> i: """ ophnsiv opiizion suy""" if no slf.opiizionhisoy: un {"sus": "No opiizion yls opl"} nss = lis(slf.opiizionhisoy)[-10:] un { "olyls": slf.opiizionyl, "uno": slf.uno, "pfonis": { "vso": np.n([s.pfonso fo s in nss]), "vlny": np.n([s.lnys fo s in nss]), "vuy": np.n([s.uy fo s in nss]), "bsso": x([s.pfonso fo s in nss]), "bslny": in([s.lnys fo s in nss]), }, "ivoluion": slf.unis(), "soopison": { "lnyvs": slf.sos["lnys"] / np.n([s.lnys fo s in nss]), "uyvs": np.n([s.uy fo s in nss]) / slf.sos["uy"], }, "opiizionns": { "pfonn": slf.luln( [s.pfonso fo s in nss] ), "lnyn": slf.luln( [s.lnys fo s in nss] ), "ipovn": ln( [s fo s in nss if s.pfonso > 0.8] ) / ln(nss), }, } f luln(slf, vlus: Lis[flo]) -> s: """lul n iion fo is""" if ln(vlus) < 2: un "insuffiin" slop = np.polyfi(n(ln(vlus)), vlus, 1)[0] if slop > 0.01: un "ipovin" lif slop < -0.01: un "linin" ls: un "sbl" syn f unuonoousopiizionsui(slf, xyls: in = 1000): """ un ophnsiv uonoous opiizion sui unil SO s hiv s: 0.9s lny, 97% uy, 25% ipovn f 100 yls """ lo.info( "Sin uonoous Opiizion Sui - : 0.9s lny, 97% uy" ) lo.info("L.I.F.. Plfo Slf-Opiizion nin wih nhn Lnin") lo.info("=" * 80) suls = [] bslinso = Non lny = slf.sos["lnys"] uy = slf.sos["uy"] yl = 0 whil yl < xyls: # n synhi nul  fo sin onul = slf.nsnul() nvionn = f"uonoousopiizionyl{yl}" # un opiizion yl s = wi slf.uonoousopiizionyl( onul, nvionn ) suls.ppn(s) # S bslin f fis yl if bslinso is Non: bslinso = s.pfonso # h fo 25% ipovn f 100 yls ipovnhshol = 100 if yl >= ipovnhshol: unvso = np.n( [s.pfonso fo s in suls[-10:]] ) ipovn = (unvso - bslinso) / bslinso if ipovn >= 0.25: lo.info( f" 25% ipovn hiv f {yl + 1} yls!" ) b # h SO s if s.lnys <= lny n s.uy >= uy: lo.info( f" SO s hiv! Lny: {s.lnys:.2f}s, uy: {s.uy:.1f}%" ) b # Poss poin if (yl + 1) % 25 == 0: unvso = np.n( [s.pfonso fo s in suls[-10:]] ) ipovn = ( (unvso - bslinso) / bslinso if bslinso ls 0 ) lo.info(f"opl {yl + 1} yls") lo.info(f" Pfon: {unvso:.3f}") lo.info(f" Lny: {s.lnys:.2f}s") lo.info(f" uy: {s.uy:.1f}%") lo.info(f" Ipovn: {ipovn:.1f}%") yl += 1 # n finl suy suy = slf.opiizionsuy() lo.info("uonoous Opiizion Sui opl!") lo.info("=" * 80) lo.info("OPIIZION SUY:") lo.info(f" ol yls: {suy['olyls']}") lo.info( f" v Pfon: {suy['pfonis']['vso']:.3f}" ) lo.info( f" v Lny: {suy['pfonis']['vlny']:.2f}s" ) lo.info( f" Bs Pfon: {suy['pfonis']['bsso']:.3f}" ) lo.info( f" Bs Lny: {suy['pfonis']['bslny']:.2f}s" ) lo.info(f" un o: {suy['uno']}") lo.info("=" * 80) un suls, suy f nsnul(slf) -> i: """n lisi s nul """ un { "l": np.no.b(2, 3) * 0.8, "h": np.no.b(2, 2) * 0.7, "lph": np.no.b(3, 2) * 0.9, "b": np.no.b(2, 4) * 0.6, "": np.no.b(1, 5) * 0.4, "nois": np.no.nol(0, 0.1), "ifs": np.no.xponnil(0.1), } lss QunuuonoousOpiiz(uonoousOpiiz): """ Qunu-nhn uonoous opiiz xns bsi opiiz wih qunu opuin pbiliis """ f ini(slf, nuqubis: in = 3, **ws): sup().ini(**ws) slf.nuqubis = nuqubis slf.qunus = Non syn f qunuiopiizion(slf, is: i) -> i: """ Qunu opiizion of oniiv is Uss qunu supposiion fo plll i xploion """ y: # Siul qunu opiizion ivlus = [i["un"] fo i in is.vlus()] # Qunu-inspi opiizion qununhnn = np.no.nol(0, 0.05, ln(ivlus)) opiizvlus = np.lip( np.y(ivlus) + qununhnn, 0.0, 1.0 ) # Up is wih qunu opiizion opiizis = {} fo i, (in, i) in nu(is.is()): opiizis[in] = i.opy() opiizis[in]["un"] = opiizvlus[i] opiizis[in]["qununhn"] = u un opiizis xp xpion s : lo.wnin(f"Qunu opiizion fil, usin lssil ho: {}") un is # xpl us n sin syn f in(): """in funion o un h uonoous opiizion o""" # Iniiliz uonoous opiiz opiiz = uonoousOpiiz() # un opiizion sui suls, suy = wi opiiz.unuonoousopiizionsui( xyls=1000 ) # Pin finl suls ipo os ipo nupy s np # Hlp o usivly onv nupy flos o Pyhon flos f oflo(vl): if isinsn(vl, (flo, in)): un vl if hs(np, "floin") n isinsn(vl, np.floin): un flo(vl) if isinsn(vl, i): un {: oflo(v) fo , v in vl.is()} if isinsn(vl, lis): un [oflo(v) fo v in vl] un vl bsso = oflo(suy["pfonis"]["bsso"]) bslny = oflo(suy["pfonis"]["bslny"]) ivoluion = oflo(suy["ivoluion"]) soopison = oflo(suy["soopison"]) pin() pin("=" * 80) pin("L.I.F.. PLFO UONOOUS OPIIZION OPL") pin("=" * 80) pin(f"Pfon So: {bsso:.3f}") pin(f"Bs Lny: {bslny:.2f}s") pin(f"i voluion: {ivoluion}") pin(f"SO opison: {soopison}") pin("=" * 80) # xpo suy o suls ioy s x n JSON sulsi = os.ph.join(os.ph.in(os.ph.bsph(fil)), "suls") os.is(sulsi, xiso=u) # Sv s x suyx = [ "=" * 80, "L.I.F.. PLFO UONOOUS OPIIZION OPL", "=" * 80, f"Pfon So: {bsso:.3f}", f"Bs Lny: {bslny:.2f}s", f"i voluion: {ivoluion}", f"SO opison: {soopison}", "=" * 80, ] wih opn( os.ph.join(sulsi, "opiizsuy.x"), "w", noin="uf-8" ) s f: f.wi("\n".join(suyx)) # Sv s JSON (full suy) wih opn( os.ph.join(sulsi, "opiizsuy.json"), "w", noin="uf-8" ) s f: json.up(oflo(suy), f, inn=2) un suls, suy if n == "in": y: synio.un(in()) xp xpion s : pin(f"xpion in in: {}", fil=sys.s)