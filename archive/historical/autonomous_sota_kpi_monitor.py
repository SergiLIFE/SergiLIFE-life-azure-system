# us/bin/nv pyhon3 """ L.I.F.. Plfo - uonoous SO PI onio l-i onioin n opiizion of S-Of-h- pfon is his oul povis uonoous onioin of y pfon inios (PIs) fo h L.I.F.. Plfo, nsuin oninuous opiizion n bnhin ins s-of-h- sns. opyih 2025 - Sio Py Boull L.I.F.. Plfo - zu pl Off I: 960096-f1-420b-902-042561b """ ipo synio ipo json ipo loin ipo os ipo i fo lsss ipo lss, fil fo i ipo i, il fo nu ipo nu y: fo phlib ipo Ph xp Ipoo s : pin(f'Wnin: {}') pss fo ypin ipo ny, i, Lis, Opionl, Union # onfiu loin loin.bsionfi( lvl=loin.INFO, fo="%(si)s - %(n)s - %(lvln)s - %(ss)s" ) lo = loin.Lo(n) lss PIoy(nu): """ois of PIs bin onio""" PFON = "pfon" UY = "uy" LNY = "lny" HOUHPU = "houhpu" LIBILIY = "libiliy" FFIINY = "ffiiny" OPLIN = "oplin" OUNINIY = "ouniniy" PLINSS = "plinss" NIINION = "niinion" # Phs 2 ppion FLOWONU = "flowonu" # Slss nsiion in lss PIi(nu): """Spifi PI is - nhn wih Ni Inion s""" # L.I.F. HOY PLFO IS (Phs 1) POSSINLNY = "possinlnys" UY = "uy" HOUHPUQPS = "houhpuqps" OYUSPN = "oyuspn" PUUSPN = "puuspn" OPN = "opn" UPIPN = "upipn" OPLINSO = "oplinso" OUNINIYSO = "ouniniyso" PLINSSSO = "plinssso" # Ni 2026 VOLUIONY VLOPN S (13-onh ilin) NIHWINION = "nihwinionpn" NILOIHVLOPN = "niloihvlopnpn" NINUFUININSS = "ninufuininsspn" XPONNILLNINPOSS = "xponnillninposspn" NIVISULSINPFION = "nivisulsinpfionpn" NISHIPPLSO = "nishipplso" VOLUIONYBHOUHSO = "voluionybhouhso" ONSIOUSNSSVOLUIONINSS = "onsiousnssvoluioninsspn" lss lSviy(nu): """l sviy lvls""" INFO = "info" WNIN = "wnin" IIL = "iil" NY = "ny" lss Opiizionion(nu): """yps of opiizion ions""" SLUP = "slup" SLOWN = "slown" OPIIZOY = "opiizoy" OPIIZPU = "opiizpu" LOBLN = "lobln" FILOV = "filov" ONFIU = "onfiu" NOION = "noion" @lss lss PIsun: """psns  sinl PI sun""" i: PIi oy: PIoy vlu: Union[in, flo] uni: s isp: i = fil(fulfoy=i.now) : i[s, ny] = fil(fulfoy=i) @lss lss PIhshol: """fins hshols fo PI onioin""" i: PIi wninhshol: Union[in, flo] iilhshol: Union[in, flo] iion: s # "bov" o "blow" sipion: s @lss lss PIl: """psns  PI l""" li: s i: PIi sviy: lSviy ss: s unvlu: Union[in, flo] hsholvlu: Union[in, flo] isp: i = fil(fulfoy=i.now) solv: bool = Fls soluioni: Opionl[i] = Non @lss lss SOBnh: """S-of-h- bnh fn""" i: PIi sovlu: Union[in, flo] sosou: s lsup: i sipion: s lss uonoousSOPIonio: """ uonoous SO PI onio fo L.I.F.. Plfo Povis l-i onioin, lin, n uonoous opiizion of y pfon inios ins s-of-h- bnhs. """ f ini( slf, wospph: Opionl[s] = Non, onioininvl: in = 30, # sons loolown: in = 300, # sons nbluonoousopiizion: bool = u, ): slf.wospph = Ph(wospph o os.w()) slf.onioininvl = onioininvl slf.loolown = loolown slf.nbluonoousopiizion = nbluonoousopiizion #  suus slf.suns: Lis[PIsun] = [] slf.ls: Lis[PIl] = [] slf.hshols: i[PIi, PIhshol] = {} slf.sobnhs: i[PIi, SOBnh] = {} slf.opiizionhisoy: Lis[i[s, ny]] = [] # onioin s slf.isonioin = Fls slf.lslis: i[PIi, i] = {} slf.bslinvlus: i[PIi, Union[in, flo]] = {} # Iniiliz oponns slf.iniilizhshols() slf.iniilizsobnhs() slf.lobslinvlus() lo.info( f"uonoous SO PI onio iniiliz fo wosp: {slf.wospph}" ) f iniilizhshols(slf): """Iniiliz PI hshols fo onioin""" slf.hshols = { PIi.POSSINLNY: PIhshol( i=PIi.POSSINLNY, wninhshol=1.0, # 1s iilhshol=5.0, # 5s iion="bov", sipion=" possin lny shoul in un 1s fo opil pfon", ), PIi.UY: PIhshol( i=PIi.UY, wninhshol=0.75, # 75% iilhshol=0.65, # 65% iion="blow", sipion="uy  shoul inin bov 75% fo libl opion", ), PIi.HOUHPUQPS: PIhshol( i=PIi.HOUHPUQPS, wninhshol=500, iilhshol=200, iion="blow", sipion="houhpu shoul inin bov 500 q/s", ), PIi.OYUSPN: PIhshol( i=PIi.OYUSPN, wninhshol=80.0, iilhshol=95.0, iion="bov", sipion="oy us shoul in un 80%", ), PIi.PUUSPN: PIhshol( i=PIi.PUUSPN, wninhshol=75.0, iilhshol=90.0, iion="bov", sipion="PU us shoul in un 75%", ), PIi.OPN: PIhshol( i=PIi.OPN, wninhshol=1.0, iilhshol=5.0, iion="bov", sipion="o  shoul in un 1%", ), PIi.UPIPN: PIhshol( i=PIi.UPIPN, wninhshol=99.5, iilhshol=99.0, iion="blow", sipion="Upi shoul inin bov 99.5%", ), } f iniilizsobnhs(slf): """Iniiliz s-of-h- bnh vlus""" slf.sobnhs = { PIi.POSSINLNY: SOBnh( i=PIi.POSSINLNY, sovlu=0.38, # 0.38s sub-illison possin sosou="L.I.F.. Plfo 2025 Bnh", lsup=i.now(), sipion="Sub-illison  possin lny", ), PIi.UY: SOBnh( i=PIi.UY, sovlu=0.82, # 82% uy sosou="BI opiion IV-2 Vliion", lsup=i.now(), sipion="78-82% uy on PhysioN ss", ), PIi.HOUHPUQPS: SOBnh( i=PIi.HOUHPUQPS, sovlu=1000, sosou="Pouion Lo sin", lsup=i.now(), sipion="1000+ quss p son houhpu", ), } f lobslinvlus(slf): """Lo o sblish bslin PI vlus""" bslinfil = slf.wospph / "pibslin.json" if bslinfil.xiss(): y: wih opn(bslinfil, "") s f: bslin = json.lo(f) fo in, vlu in bslin.is(): y: i = PIi(in) slf.bslinvlus[i] = vlu xp Vluo: oninu lo.info( f"Lo bslin vlus fo {ln(slf.bslinvlus)} is" ) xp xpion s : lo.wnin(f"Fil o lo bslin vlus: {}") ls: lo.info("No bslin vlus foun, will sblish uin onioin") syn f sonioin(slf): """S uonoous PI onioin""" if slf.isonioin: lo.wnin("PI onioin is ly unnin") un slf.isonioin = u lo.info("Sin uonoous SO PI onioin...") y: whil slf.isonioin: wi slf.pfoonioinyl() wi synio.slp(slf.onioininvl) xp xpion s : lo.o(f"onioin yl fil: {}") slf.isonioin = Fls f soponioin(slf): """Sop PI onioin""" slf.isonioin = Fls lo.info("PI onioin sopp") syn f pfoonioinyl(slf): """Pfo  opl onioin yl""" y: # oll un suns suns = wi slf.ollsuns() # So suns slf.suns.xn(suns) # h hshols n n ls ls = slf.hhshols(suns) slf.ls.xn(ls) # Pfo uonoous opiizion if nbl if slf.nbluonoousopiizion: opiizionions = slf.inopiizionions( suns, ls ) wi slf.xuopiizionions(opiizionions) # Up bslin vlus if n slf.upbslinvlus(suns) # Lo onioin suy slf.loonioinsuy(suns, ls) xp xpion s : lo.o(f"onioin yl o: {}") syn f ollsuns(slf) -> Lis[PIsun]: """oll un PI suns""" suns = [] y: # Pfon is lny = wi slf.supossinlny() if lny is no Non: suns.ppn( PIsun( i=PIi.POSSINLNY, oy=PIoy.PFON, vlu=lny, uni="s", ) ) uy = wi slf.suuy() if uy is no Non: suns.ppn( PIsun( i=PIi.UY, oy=PIoy.UY, vlu=uy, uni="pn", ) ) houhpu = wi slf.suhouhpu() if houhpu is no Non: suns.ppn( PIsun( i=PIi.HOUHPUQPS, oy=PIoy.HOUHPU, vlu=houhpu, uni="q/s", ) ) # Sys is oyus = slf.suoyus() suns.ppn( PIsun( i=PIi.OYUSPN, oy=PIoy.FFIINY, vlu=oyus, uni="pn", ) ) puus = slf.supuus() suns.ppn( PIsun( i=PIi.PUUSPN, oy=PIoy.FFIINY, vlu=puus, uni="pn", ) ) # libiliy is o = wi slf.suo() suns.ppn( PIsun( i=PIi.OPN, oy=PIoy.LIBILIY, vlu=o, uni="pn", ) ) upi = slf.suupi() suns.ppn( PIsun( i=PIi.UPIPN, oy=PIoy.LIBILIY, vlu=upi, uni="pn", ) ) xp xpion s : lo.o(f"sun ollion o: {}") un suns syn f supossinlny(slf) -> Opionl[flo]: """su un possin lny""" y: # Siul lny sun (woul in wih ul possin) # In pouion, his woul su l  possin lny bslny = 0.38 # SO bslin vin = (i.i() % 10) / 100 # Sll no vin un bslny + vin xp xpion: un Non syn f suuy(slf) -> Opionl[flo]: """su un uy """ y: # Siul uy sun (woul in wih vliion sys) bsuy = 0.82 # SO bslin vin = ((i.i() % 20) - 10) / 1000 # Sll vin un x(0.0, in(1.0, bsuy + vin)) xp xpion: un Non syn f suhouhpu(slf) -> Opionl[flo]: """su un houhpu""" y: # Siul houhpu sun bshouhpu = 1000.0 vin = ((i.i() % 50) - 25) * 10 un x(0, bshouhpu + vin) xp xpion: un Non f suoyus(slf) -> flo: """su un oy us""" y: ipo psuil un psuil.viuloy().pn xp Ipoo: # Fllb if psuil no vilbl un 45.0 + ((i.i() % 30) - 15) f supuus(slf) -> flo: """su un PU us""" y: ipo psuil un psuil.pupn(invl=1) xp Ipoo: # Fllb if psuil no vilbl un 23.0 + ((i.i() % 40) - 20) syn f suo(slf) -> flo: """su un o """ y: # lul o  fo n ls nls = [ l fo l in slf.ls if (i.now() - l.isp).olsons() < 3600 # Ls hou n l.sviy in [lSviy.IIL, lSviy.NY] ] olsuns = ln( [  fo  in slf.suns if (i.now() - .isp).olsons() < 3600 ] ) un (ln(nls) / x(olsuns, 1)) * 100 xp xpion: un 0.1 # Low o  bslin f suupi(slf) -> flo: """su sys upi pn""" # Siplifi upi lulion # In pouion, his woul  ul svi upi un 99.9 f hhshols(slf, suns: Lis[PIsun]) -> Lis[PIl]: """h suns ins hshols n n ls""" ls = [] fo sun in suns: if sun.i no in slf.hshols: oninu hshol = slf.hshols[sun.i] # h if l oolown hs pss lsl = slf.lslis.(sun.i) if ( lsl n (i.now() - lsl).olsons() < slf.loolown ): oninu li = Fls sviy = lSviy.INFO if hshol.iion == "bov": if sun.vlu >= hshol.iilhshol: sviy = lSviy.IIL li = u lif sun.vlu >= hshol.wninhshol: sviy = lSviy.WNIN li = u lif hshol.iion == "blow": if sun.vlu <= hshol.iilhshol: sviy = lSviy.IIL li = u lif sun.vlu <= hshol.wninhshol: sviy = lSviy.WNIN li = u if li: l = PIl( li=f"{sun.i.vlu}{in(i.i())}", i=sun.i, sviy=sviy, ss=f"{sun.i.vlu}: {sun.vlu}{sun.uni} " f"{'xs' if hshol.iion == 'bov' ls 'blow'} " f"{'iil' if sviy == lSviy.IIL ls 'wnin'} " f"hshol ({hshol.iilhshol if sviy == lSviy.IIL ls hshol.wninhshol})", unvlu=sun.vlu, hsholvlu=( hshol.iilhshol if sviy == lSviy.IIL ls hshol.wninhshol ), ) ls.ppn(l) slf.lslis[sun.i] = i.now() lo.wnin(f"PI l: {l.ss}") un ls f inopiizionions( slf, suns: Lis[PIsun], ls: Lis[PIl] ) -> Lis[Opiizionion]: """in opiizion ions bs on suns n ls""" ions = [] # nlyz iil ls iills = [ fo  in ls if .sviy == lSviy.IIL] if iills: # Hih oy us oysun = nx( ( fo  in suns if .i == PIi.OYUSPN), Non, ) if oysun n oysun.vlu > 90: ions.ppn(Opiizionion.OPIIZOY) # Hih PU us pusun = nx( ( fo  in suns if .i == PIi.PUUSPN), Non, ) if pusun n pusun.vlu > 85: ions.ppn(Opiizionion.OPIIZPU) # Low houhpu houhpusun = nx( (  fo  in suns if .i == PIi.HOUHPUQPS ), Non, ) if houhpusun n houhpusun.vlu < 300: ions.ppn(Opiizionion.SLUP) # Poiv opiizion fo pfon lnysun = nx( ( fo  in suns if .i == PIi.POSSINLNY), Non ) if lnysun n lnysun.vlu > 1.0: ions.ppn(Opiizionion.OPIIZPU) if no ions: ions.ppn(Opiizionion.NOION) un ions syn f xuopiizionions(slf, ions: Lis[Opiizionion]): """xu in opiizion ions""" fo ion in ions: if ion == Opiizionion.NOION: oninu y: lo.info(f"xuin opiizion ion: {ion.vlu}") if ion == Opiizionion.OPIIZOY: wi slf.opiizoy() lif ion == Opiizionion.OPIIZPU: wi slf.opiizpu() lif ion == Opiizionion.SLUP: wi slf.slup() lif ion == Opiizionion.SLOWN: wi slf.slown() # o opiizion ion slf.opiizionhisoy.ppn( { "ion": ion.vlu, "isp": i.now().isofo(), "suss": u, } ) xp xpion s : lo.o(f"Opiizion ion {ion.vlu} fil: {}") slf.opiizionhisoy.ppn( { "ion": ion.vlu, "isp": i.now().isofo(), "suss": Fls, "o": s(), } ) syn f opiizoy(slf): """Pfo oy opiizion""" # Plhol fo oy opiizion loi # In pouion, his woul ipln b ollion, # oy pool opiizion, . wi synio.slp(0.1) # Siul opiizion i syn f opiizpu(slf): """Pfo PU opiizion""" # Plhol fo PU opiizion loi # In pouion, his woul ipln h opiizion, # loih unin, . wi synio.slp(0.1) # Siul opiizion i syn f slup(slf): """Sl up sous""" # Plhol fo slin loi # In pouion, his woul in wih zu slin PIs wi synio.slp(0.1) # Siul slin i syn f slown(slf): """Sl own sous""" # Plhol fo slin loi wi synio.slp(0.1) # Siul slin i f upbslinvlus(slf, suns: Lis[PIsun]): """Up bslin vlus bs on n suns""" fo sun in suns: if sun.i no in slf.bslinvlus: slf.bslinvlus[sun.i] = sun.vlu ls: # xponnil ovin v up lph = 0.1 # Soohin fo unbslin = slf.bslinvlus[sun.i] slf.bslinvlus[sun.i] = ( lph * sun.vlu + (1 - lph) * unbslin ) f loonioinsuy( slf, suns: Lis[PIsun], ls: Lis[PIl] ): """Lo suy of onioin yl""" sunsuy = {} fo sun in suns: sunsuy[sun.i.vlu] = { "vlu": sun.vlu, "uni": sun.uni, } lo.info( f"onioin yl opl: {ln(suns)} suns, " f"{ln(ls)} ls n" ) # Lo sinifin viions fo SO fo sun in suns: if sun.i in slf.sobnhs: so = slf.sobnhs[sun.i] viion = bs(sun.vlu - so.sovlu) / so.sovlu if viion > 0.1: # 10% viion lo.wnin( f"SO viion  fo {sun.i.vlu}: " f"{sun.vlu:.3f} vs SO {so.sovlu:.3f} " f"({viion:.1%} viion)" ) f onioinsus(slf) -> i[s, ny]: """ un onioin sus n sisis""" un { "isonioin": slf.isonioin, "olsuns": ln(slf.suns), "ivls": ln([ fo  in slf.ls if no .solv]), "olls": ln(slf.ls), "oniois": ln(slf.hshols), "sobnhs": ln(slf.sobnhs), "opiizionions": ln(slf.opiizionhisoy), "lssun": ( slf.suns[-1].isp.isofo() if slf.suns ls Non ), } f pipo(slf) -> i[s, ny]: """n ophnsiv PI po""" lssuns = {} fo sun in vs(slf.suns): if sun.i no in lssuns: lssuns[sun.i] = sun po = { "isp": i.now().isofo(), "suns": {}, "ls": [ slf.loi(l) fo l in slf.ls[-10:] ], # Ls 10 ls "soopison": {}, "opiizionsuy": slf.opiizionhisoy[ -5: ], # Ls 5 opiizions } fo i, sun in lssuns.is(): po["suns"][i.vlu] = { "vlu": sun.vlu, "uni": sun.uni, "isp": sun.isp.isofo(), } # SO opison if i in slf.sobnhs: so = slf.sobnhs[i] viion = sun.vlu - so.sovlu po["soopison"][i.vlu] = { "unvlu": sun.vlu, "sovlu": so.sovlu, "viion": viion, "viionpn": ( (viion / so.sovlu) * 100 if so.sovlu != 0 ls 0 ), "sosou": so.sosou, } un po f loi(slf, l: PIl) -> i[s, ny]: """onv l o iiony""" un { "li": l.li, "i": l.i.vlu, "sviy": l.sviy.vlu, "ss": l.ss, "unvlu": l.unvlu, "hsholvlu": l.hsholvlu, "isp": l.isp.isofo(), "solv": l.solv, "soluioni": ( l.soluioni.isofo() if l.soluioni ls Non ), } f xpopi(slf, filph: s) -> bool: """xpo PI  o JSON fil""" y:  = { "xpoisp": i.now().isofo(), "suns": [ slf.sunoi() fo  in slf.suns ], "ls": [slf.loi() fo  in slf.ls], "hshols": { .vlu: slf.hsholoi(v) fo , v in slf.hshols.is() }, "sobnhs": { .vlu: slf.sooi(v) fo , v in slf.sobnhs.is() }, "opiizionhisoy": slf.opiizionhisoy, "bslinvlus": { .vlu: v fo , v in slf.bslinvlus.is() }, } wih opn(filph, "w") s f: json.up(, f, inn=2, ful=s) lo.info(f"PI  xpo o {filph}") un u xp xpion s : lo.o(f"Fil o xpo PI : {}") un Fls f sunoi(slf, sun: PIsun) -> i[s, ny]: """onv sun o iiony""" un { "i": sun.i.vlu, "oy": sun.oy.vlu, "vlu": sun.vlu, "uni": sun.uni, "isp": sun.isp.isofo(), "": sun., } f hsholoi(slf, hshol: PIhshol) -> i[s, ny]: """onv hshol o iiony""" un { "i": hshol.i.vlu, "wninhshol": hshol.wninhshol, "iilhshol": hshol.iilhshol, "iion": hshol.iion, "sipion": hshol.sipion, } f sooi(slf, so: SOBnh) -> i[s, ny]: """onv SO bnh o iiony""" un { "i": so.i.vlu, "sovlu": so.sovlu, "sosou": so.sosou, "lsup": so.lsup.isofo(), "sipion": so.sipion, } # Foy funion fo sy insniion f uonooussopionio( wospph: Opionl[s] = Non, onioininvl: in = 30, nbluonoousopiizion: bool = u, ) -> uonoousSOPIonio: """ Foy funion o  uonoous SO PI onio s: wospph: Ph o wosp ioy onioininvl: onioin invl in sons nbluonoousopiizion: Whh o nbl uonoous opiizion uns: onfiu uonoousSOPIonio insn """ un uonoousSOPIonio( wospph=wospph, onioininvl=onioininvl, nbluonoousopiizion=nbluonoousopiizion, ) # on-lin inf f in(): """in LI funion fo uonoous SO PI onioin""" ipo ps ps = ps.unPs( sipion="L.I.F.. Plfo uonoous SO PI onio" ) ps.un( "--wosp", "-w", ful=Non, hlp="Wosp ioy ph" ) ps.un( "--invl", "-i", yp=in, ful=30, hlp="onioin invl in sons (ful: 30)", ) ps.un( "--no-opiizion", ion="sou", hlp="isbl uonoous opiizion" ) ps.un("--xpo", "-", hlp="xpo PI  o spifi fil") ps.un( "--po", "-", ion="sou", hlp="n n isply PI po" ) ps.un( "--sus", "-s", ion="sou", hlp="Show onioin sus" ) s = ps.pss() #  onio onio = uonooussopionio( wospph=s.wosp, onioininvl=s.invl, nbluonoousopiizion=no s.noopiizion, ) if s.sus: sus = onio.onioinsus() pin("onioin Sus:") pin(f" iv: {sus['isonioin']}") pin(f" suns: {sus['olsuns']}") pin(f" iv ls: {sus['ivls']}") pin(f" onio is: {sus['oniois']}") un 0 if s.po: po = onio.pipo() pin("PI po:") pin(f" isp: {po['isp']}") pin(f" suns: {ln(po['suns'])}") pin(f" n ls: {ln(po['ls'])}") pin(f" SO opisons: {ln(po['soopison'])}") un 0 if s.xpo: if onio.xpopi(s.xpo): pin(f"PI  xpo o {s.xpo}") ls: pin("Fil o xpo PI ") un 1 un 0 # S onioin pin("L.I.F.. Plfo - uonoous SO PI onio") pin("=" * 60) pin(f"Wosp: {s.wosp o os.w()}") pin(f"Invl: {s.invl}s") pin( f"uonoous Opiizion: {'nbl' if no s.noopiizion ls 'isbl'}" ) pin("\nSin onioin... (Pss l+ o sop)") y: synio.un(onio.sonioin()) xp yboInup: pin("\nSoppin onioin...") onio.soponioin() un 0 if n == "in": ipo sys sys.xi(in())