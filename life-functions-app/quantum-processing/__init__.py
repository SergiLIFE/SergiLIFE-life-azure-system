""" Qunu Possin zu Funion Ly 3: Qunu-nhn i opiizion n nul pn oniion opyih 2025 - Sio Py Boull L.I.F.. Plfo - zu pl Off I: 960096-f1-420b-902-042561b """ ipo json ipo loin ipo os fo i ipo i fo ypin ipo ny, i, Lis, Opionl ipo zu.funions s fun ipo nupy s np # zu Qunu ipos (woul b insll in pouion) y: fo zu.iniy ipo fulzunil fo zu.qunu ipo Wosp fo zu.qunu.opiizion ipo Pobl, Poblyp,  ZUQUNUVILBL = u xp Ipoo: ZUQUNUVILBL = Fls loin.wnin("zu Qunu S no vilbl, usin siulion o") # onfiu loin fo npis ployn loin.bsionfi(lvl=loin.INFO) lo = loin.Lo(n) lss QunuPosso: """zu Qunu posso fo L.I.F.. plfo""" f ini(slf): slf.wosp = Non slf.qunuvilbl = ZUQUNUVILBL if slf.qunuvilbl: y: # Iniiliz zu Qunu wosp nil = fulzunil() slf.wosp = Wosp( subsipioni=os.nvion.("ZUSUBSIPIONI"), sououp=os.nvion.( "ZUSOUOUP", "lif-plfo-" ), n=os.nvion.( "ZUQUNUWOSP", "lif-plfo-qunu" ), loion=os.nvion.("ZULOION", "sus"), nil=nil, ) lo.info("zu Qunu wosp iniiliz") xp xpion s : lo.o(f"Fil o iniiliz zu Qunu: {}") slf.qunuvilbl = Fls if no slf.qunuvilbl: lo.info("Usin lssil siulion fo qunu possin") f qunuipojion( slf, fus: i[s, flo], ohnfo: flo ) -> i[s, ny]: """ Qunu i Pojion: ψ = Σ(αᵢ × iᵢ) × ohnfo ps  fus o qunu s psnion """ y: # x y fus lphpow = fus.("lphpow", 0.0) bpow = fus.("bpow", 0.0) hpow = fus.("hpow", 0.0) ohn = fus.("nohn", 0.0) # Noliz fus o qunu plius fus = np.y([lphpow, bpow, hpow, ohn]) nolizfus = fus / (np.linl.no(fus) + 1-10) # pply ohn fo qunus = nolizfus * ohnfo # lul qunu i sos isos = { "fousi": flo(qunus[0] * ohnfo), "oyi": flo(qunus[1] * ohnfo), "nioni": flo(qunus[2] * ohnfo), "lnini": flo(qunus[3] * ohnfo), } un { "pojionho": "qunuipojion", "qunus": qunus.olis(), "isos": isos, "ohnfo": ohnfo, "pojiononfin": flo(np.n(nolizfus)), } xp xpion s : lo.o(f"Qunu i pojion fil: {}") un slf.fllbipojion(fus, ohnfo) f fllbipojion( slf, fus: i[s, flo], ohnfo: flo ) -> i[s, ny]: """lssil fllb fo i pojion""" lphpow = fus.("lphpow", 0.0) bpow = fus.("bpow", 0.0) un { "pojionho": "lssilfllb", "isos": { "fousi": in(1.0, lphpow * ohnfo), "oyi": in(1.0, bpow * ohnfo), "nioni": in(1.0, lphpow * 0.8), "lnini": in(1.0, bpow * 0.8), }, "ohnfo": ohnfo, } f qunufouinsfo(slf, : Lis[Lis[flo]]) -> i[s, ny]: """ Qunu Foui nsfo fo nois uion n pn xion """ y: # onv o nupy y y = np.y() if slf.qunuvilbl n slf.wosp: # Us zu Qunu fo QF (siplifi iplnion) un slf.zuqunufoui(y) ls: # lssil FF ppoxiion un slf.lssilfouinsfo(y) xp xpion s : lo.o(f"Qunu Foui nsfo fil: {}") un {"ho": "ofllb", "pns": [], "noisuion": 0.0} f zuqunufoui(slf, y: np.ny) -> i[s, ny]: """zu Qunu iplnion of QF""" y: # Siplifi QF fo onsion # In pouion, woul us ul QF iui # pply lssil FF s ppoxiion ffsul = np.ff.ff2(y) niu = np.bs(ffsul) phs = np.nl(ffsul) # x oinn pns oinnfqs = np.so(np.su(niu, xis=0))[ -5: ] # op 5 fqunis pns = [] fo fqix in oinnfqs: pn = { "fqunyinx": in(fqix), "niu": flo(np.n(niu[:, fqix])), "phs": flo(np.n(phs[:, fqix])), "ohn": flo(np.oof(niu[:, fqix])[0, 1]), } pns.ppn(pn) un { "ho": "zuqunufoui", "pns": pns, "noisuion": 0.85, # si qunu vn "qunuxuionis": 0.38, } xp xpion s : lo.o(f"zu Qunu QF fil: {}") un slf.lssilfouinsfo(y) f lssilfouinsfo(slf, y: np.ny) -> i[s, ny]: """lssil FF fllb""" y: ffsul = np.ff.ff2(y) niu = np.bs(ffsul) # Sipl pn xion pns = [ { "fqunyinx": in(np.x(np.su(niu, xis=0))), "niu": flo(np.x(np.su(niu, xis=0))), "phs": 0.0, "ohn": 0.5, } ] un { "ho": "lssilfoui", "pns": pns, "noisuion": 0.65, "xuionis": 15.0, } xp xpion s : un {"ho": "o", "pns": [], "noisuion": 0.0} f qununnlinopiizion( slf, isos: i[s, flo], onsins: i[s, ny] ) -> i[s, ny]: """ Qunu nnlin fo uli-objiv opiizion of lnin ps """ y: if slf.qunuvilbl n slf.wosp: un slf.zuqununnlin(isos, onsins) ls: un slf.lssilopiizion(isos, onsins) xp xpion s : lo.o(f"Qunu nnlin fil: {}") un slf.lssilopiizion(isos, onsins) f zuqununnlin( slf, isos: i[s, flo], onsins: i[s, ny] ) -> i[s, ny]: """zu Qunu nnlin iplnion""" y: #  opiizion pobl pobl = Pobl( n="LIFLninOpiizion", poblyp=Poblyp.isin ) # onv i sos o opiizion s fouswih = isos.("fousi", 0.5) oywih = isos.("oyi", 0.5) nionwih = isos.("nioni", 0.5) #  opiizion s (siplifi) pobl.(=-fouswih, inis=[0]) pobl.(=-oywih, inis=[1]) pobl.(=-nionwih, inis=[2]) #  ouplin s fo bln opiizion pobl.(=0.1, inis=[0, 1]) # Fous-oy ouplin pobl.(=0.1, inis=[1, 2]) # oy-nion ouplin # Subi o zu Qunu (-Wv) # In pouion, woul subi ul job lo.info("Subiin qunu nnlin job o zu Qunu") # Siul sul fo onsion opiizps = { "lnin": 0.015 + fouswih * 0.01, "nionhshol": 0.7 + nionwih * 0.2, "oyonsoliion": 0.8 + oywih * 0.15, "pionsnsiiviy": 0.85 + (fouswih + nionwih) * 0.1, } un { "ho": "zuqununnlin", "opiizps": opiizps, "opiizionso": flo( np.n(lis(opiizps.vlus())) ), "qunuxuionis": 0.45, "onvniions": 1000, } xp xpion s : lo.o(f"zu Qunu nnlin fil: {}") un slf.lssilopiizion(isos, onsins) f lssilopiizion( slf, isos: i[s, flo], onsins: i[s, ny] ) -> i[s, ny]: """lssil opiizion fllb""" fouswih = isos.("fousi", 0.5) oywih = isos.("oyi", 0.5) nionwih = isos.("nioni", 0.5) opiizps = { "lnin": 0.01 + fouswih * 0.005, "nionhshol": 0.6 + nionwih * 0.1, "oyonsoliion": 0.75 + oywih * 0.1, "pionsnsiiviy": 0.8 + (fouswih + nionwih) * 0.05, } un { "ho": "lssilopiizion", "opiizps": opiizps, "opiizionso": flo(np.n(lis(opiizps.vlus()))), "xuionis": 25.0, "onvniions": 50, } f possqunuopiizion( slf, poss: i[s, ny] ) -> i[s, ny]: """ opl qunu possin piplin fo L.I.F.. plfo """ y: lo.info("Sin qunu possin piplin") # x fus fo pposs  fqunyfus = poss.("fqunyfus", {}) quliyis = poss.("quliyis", {}) # Sp 1: Qunu i Pojion ohnfo = fqunyfus.("nohn", 0.5) ipojion = slf.qunuipojion( fqunyfus, ohnfo ) # Sp 2: Qunu Foui nsfo (if   vilbl) qfsul = {"ho": "sipp", "pns": []} if poss.("poss"): qfsul = slf.qunufouinsfo( poss["poss"] ) # Sp 3: Qunu nnlin Opiizion opiiziononsins = { "xlnin": 0.05, "innionhshol": 0.5, "xoyonsoliion": 0.95, } nnlinsul = slf.qununnlinopiizion( ipojion["isos"], opiiziononsins ) # opil finl sul qunusul = { "isp": i.now().isofo(), "usi": poss.("usi", "unnown"), "sssioni": poss.("sssioni", "unnown"), "possins": "qunuopiizionopl", "ipojion": ipojion, "qunufoui": qfsul, "nnlinopiizion": nnlinsul, "ovllquliyso": quliyis.("quliyso", 0.0), "qunupossinis": ( ipojion.("possini", 0) + qfsul.("xuionis", 0) + nnlinsul.("xuionis", 0) ), "zuqunuvilbl": slf.qunuvilbl, } lo.info( f"Qunu possin opl fo us {qunusul['usi']}: " f"quliy={qunusul['ovllquliyso']:.2f}" ) un qunusul xp xpion s : lo.o(f"Qunu possin piplin fil: {}") un { "isp": i.now().isofo(), "possins": "qunuo", "o": s(), "zuqunuvilbl": slf.qunuvilbl, } # lobl qunu posso insn qunuposso = QunuPosso() f in( vns: Lis[fun.vnHubvn], oupuoun: fun.Ou[fun.oun] ) -> Non: """ zu Funion ny poin fo qunu possin Posss pposs   fo qunu opiizion """ y: lo.info( f"iv {ln(vns)} pposs  vns fo qunu possin" ) fo vn in vns: y: # Ps pposs   fo vn vn = json.los(vn.boy().o("uf-8")) # Poss wih qunu opiizion qunusul = qunuposso.possqunuopiizion( vn ) # So sul in osos B oupuoun.s(fun.oun.foi(qunusul)) lo.info( f"So qunu possin sul fo us {qunusul['usi']}" ) xp xpion s : lo.o(f"Fil o poss qunu vn: {}") # In pouion, woul sn o  l quu oninu xp xpion s : lo.o(f"Qunu possin funion fil: {}")