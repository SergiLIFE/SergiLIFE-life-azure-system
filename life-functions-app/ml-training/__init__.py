""" L inin Piplin zu Funion Ly 4: piv lnin loihs wih l-i ol ups opyih 2025 - Sio Py Boull L.I.F.. Plfo - zu pl Off I: 960096-f1-420b-902-042561b """ ipo loin ipo pil fo i ipo i fo ypin ipo ny, i, Lis ipo zu.funions s fun ipo nupy s np # L ipos (woul b vilbl in zu L nvionn) y: fo sln.is ipo uyso, f1so fo sln.olslion ipo insspli fo sln.nulnwo ipo LPlssifi LVILBL = u xp Ipoo: LVILBL = Fls loin.wnin("L libis no vilbl, usin siulion o") # onfiu loin fo npis ployn loin.bsionfi(lvl=loin.INFO) lo = loin.Lo(n) lss hopsonSplinBni: """hopson Splin fo onxul bni onn opiizion""" f ini(slf, ns: in = 10, nfus: in = 8): slf.ns = ns slf.nfus = nfus # Iniiliz b isibuions fo h  slf.lph = np.ons((ns, nfus)) # Suss ouns slf.b = np.ons((ns, nfus)) # Filu ouns #  pfon slf.olws = np.zos(ns) slf.olpulls = np.zos(ns) f sl(slf, onx: np.ny) -> in: """Sl  usin hopson Splin""" y: # Spl fo b isibuions hspls = np.no.b(slf.lph, slf.b) # lul xp w fo h  ivn onx xpws = np.o(hspls, onx) # Sl  wih hihs xp w un in(np.x(xpws)) xp xpion s : lo.o("hopson splin fil: %s", ) un np.no.nin(slf.ns) f up(slf, : in, onx: np.ny, w: flo): """Up b isibuions bs on obsv w""" y: # Up ouns (siplifi up ul) wvo = onx * w slf.lph[] += wvo slf.b[] += onx - wvo #  ovll pfon slf.olws[] += w slf.olpulls[] += 1 xp xpion s : lo.o("hopson splin up fil: %s", ) f sisis(slf) -> i[s, ny]: """ pfon sisis fo ll s""" un { "olws": slf.olws.olis(), "olpulls": slf.olpulls.olis(), "vws": ( slf.olws / (slf.olpulls + 1-10) ).olis(), "bouns": [ np.sq( * np.lo(su(slf.olpulls))) / (pulls + 1) fo , pulls in nu(slf.olpulls) ], } lss Nuoplsiiyol: """Nuoplsiiy olin wih owh quions""" f ini(slf): slf.plsiiyps = { "bslinowh": 0.01, "xpinfo": 0.1, "sssy": 0.05, "onsoliionhshol": 0.75, } #  nuoplsiiy s slf.xpinhisoy = [] slf.plsiiysos = [] f lulnuoplsiiy( slf, fus: i[s, flo], lninouo: i[s, flo] ) -> flo: """lul nuoplsiiy so bs on xpin n ouos""" y: # x lvn fus hpow = fus.("hpow", 0.0) lphpow = fus.("lphpow", 0.0) ohn = fus.("nohn", 0.0) # Lnin ouo is nion = lninouo.("nowlnion", 0.5) ipovn = lninouo.("sillipovn", 0.0) # Nuoplsiiy quion: P = θ × (α + ohn) × # (nion + ipovn) plsiiyso = ( hpow * (lphpow + ohn) * (nion + ipovn + slf.plsiiyps["bslinowh"]) ) # pply xpin fo if slf.xpinhisoy: xpinfo = np.n(slf.xpinhisoy[-10:]) plsiiyso *= ( 1 + xpinfo * slf.plsiiyps["xpinfo"] ) # Boun bwn 0 n 1 plsiiyso = in(1.0, x(0.0, plsiiyso)) # Up hisoy slf.xpinhisoy.ppn(plsiiyso) slf.plsiiysos.ppn(plsiiyso) # p only n hisoy if ln(slf.xpinhisoy) > 100: slf.xpinhisoy = slf.xpinhisoy[-100:] slf.plsiiysos = slf.plsiiysos[-100:] un plsiiyso xp xpion s : lo.o("Nuoplsiiy lulion fil: %s", ) un 0.5 f piowhponil(slf, unso: flo) -> i[s, flo]: """Pi fuu nuoplsiiy owh ponil""" y: if ln(slf.plsiiysos) < 5: un {"owhponil": 0.1, "onfin": 0.5} # Sipl n nlysis nn = np.polyfi( n(ln(slf.plsiiysos[-10:])), slf.plsiiysos[-10:], 1, )[0] owhponil = x(0.0, nn * 10) onfin = in(1.0, ln(slf.plsiiysos) / 20.0) un { "owhponil": flo(owhponil), "onfin": flo(onfin), "nslop": flo(nn), } xp xpion s : lo.o("owh ponil piion fil: %s", ) un {"owhponil": 0.0, "onfin": 0.0} lss FuzzyPIonoll: """Fuzzy PI onoll fo inllin sys spons opiizion""" f ini(slf): slf.pips = { "p": 1.0, # Popoionl in "i": 0.1, # Inl in "": 0.05, # iviv in } slf.ohisoy = [] slf.inlo = 0.0 slf.pviouso = 0.0 f fuzzyjusn(slf, o: flo, o: flo) -> i[s, flo]: """pply fuzzy loi o jus PI ps""" y: # Fuzzy bship funions f bshiplow(x): un x(0, 1 - bs(x) / 0.5) f bshipiu(x): un x(0, 1 - bs(x - 0.5) / 0.3) f bshiphih(x): un x(0, (bs(x) - 0.3) / 0.7) if bs(x) > 0.3 ls 0 # Fuzzify inpus obship = { "low": bshiplow(bs(o)), "iu": bshipiu(bs(o)), "hih": bshiphih(bs(o)), } obship = { "low": bshiplow(bs(o)), "iu": bshipiu(bs(o)), "hih": bshiphih(bs(o)), } # Fuzzy uls (siplifi) pjus = ( obship["low"] * obship["low"] * 0.8 + obship["iu"] * obship["iu"] * 1.0 + obship["hih"] * obship["hih"] * 1.2 ) ijus = ( obship["low"] * obship["low"] * 0.05 + obship["iu"] * obship["iu"] * 0.1 + obship["hih"] * obship["hih"] * 0.15 ) jus = ( obship["low"] * obship["low"] * 0.02 + obship["iu"] * obship["iu"] * 0.05 + obship["hih"] * obship["hih"] * 0.08 ) un { "pjus": flo(slf.pips["p"] * pjus), "ijus": flo(slf.pips["i"] * ijus), "jus": flo(slf.pips[""] * jus), "fuzzyonfin": flo((pjus + ijus + jus) / 3), } xp xpion s : lo.o("Fuzzy jusn fil: %s", ) un { "pjus": slf.pips["p"], "ijus": slf.pips["i"], "jus": slf.pips[""], "fuzzyonfin": 0.5, } f opuonolsinl(slf, spoin: flo, possvibl: flo) -> flo: """opu PI onol sinl wih fuzzy pion""" y: o = spoin - possvibl # Up inl n iviv s slf.inlo += o ivivo = o - slf.pviouso # pply fuzzy jusn fuzzyps = slf.fuzzyjusn(o, ivivo) # opu onol sinl onolsinl = ( fuzzyps["pjus"] * o + fuzzyps["ijus"] * slf.inlo + fuzzyps["jus"] * ivivo ) # Up hisoy slf.pviouso = o slf.ohisoy.ppn(o) if ln(slf.ohisoy) > 100: slf.ohisoy = slf.ohisoy[-100:] un onolsinl xp xpion s : lo.o("PI onol opuion fil: %s", ) un 0.0 lss LIFLPiplin: """opl L piplin fo L.I.F.. plfo""" f ini(slf): slf.hopsonbni = hopsonSplinBni() slf.nuoplsiiyol = Nuoplsiiyol() slf.fuzzypi = FuzzyPIonoll() # Nul nwo fo pn oniion (siplifi) if LVILBL: slf.pnoniz = LPlssifi( hinlysizs=(64, 32), ivion="lu", solv="", xi=1000, ) slf.isin = Fls ls: slf.pnoniz = Non slf.isin = Fls # inin  slf.inin = [] slf.ininlbls = [] f posslninsssion( slf, qunusul: i[s, ny] ) -> i[s, ny]: """Poss  opl lnin sssion houh h L piplin""" y: # x fus fo qunu sul isos = qunusul.("ipojion", {}).( "isos", {} ) fus = qunusul.("fqunyfus", {}) # Siul lnin ouo (woul o fo us inion ) lninouo = { "nowlnion": np.no.unifo(0.6, 0.9), "sillipovn": np.no.unifo(0.1, 0.4), "nulpion": np.no.unifo(0.7, 0.95), } # Sp 1: Nuoplsiiy olin plsiiyso = slf.nuoplsiiyol.lulnuoplsiiy( fus, lninouo ) owhponil = slf.nuoplsiiyol.piowhponil( plsiiyso ) # Sp 2: hopson splin fo onn opiizion onxfus = np.y( [ isos.("fousi", 0.5), isos.("oyi", 0.5), isos.("nioni", 0.5), isos.("lnini", 0.5), plsiiyso, fus.("nohn", 0.5), lninouo["nowlnion"], lninouo["sillipovn"], ] ) ononn = slf.hopsonbni.sl(onxfus) # Siul w bs on lnin ouo w = ( lninouo["nowlnion"] * lninouo["sillipovn"] ) slf.hopsonbni.up( ononn, onxfus, w ) # Sp 3: Fuzzy PI onol fo sys opiizion nn = 0.85 #  nn so unnn = lninouo["nulpion"] onolsinl = slf.fuzzypi.opuonolsinl( nn, unnn ) # Sp 4: Pn oniion inin if slf.pnoniz n ln(slf.inin) > 10: slf.uppnoniz(onxfus, lninouo) # opil L insihs linsihs = { "isp": i.now().isofo(), "usi": qunusul.("usi", "unnown"), "sssioni": qunusul.("sssioni", "unnown"), "nuoplsiiyso": plsiiyso, "owhponil": owhponil, "ononn": ononn, "onnopiizionw": w, "sysonolsinl": onolsinl, "lninouo": lninouo, "hopsonbniss": slf.hopsonbni.sisis(), "pnonizin": slf.isin, "ininsiz": ln(slf.inin), } lo.info( "L piplin poss sssion fo us %s: " "plsiiy=%.2f, w=%.2f", linsihs["usi"], plsiiyso, w, ) un linsihs xp xpion s : lo.o("L piplin possin fil: %s", ) un { "isp": i.now().isofo(), "possins": "lo", "o": s(), } f uppnoniz( slf, fus: np.ny, ouo: i[s, flo] ): """Up pn oniion ol""" y: #  inin xpl fuvo = fus.olis() lbl = ( 1 if ouo["nowlnion"] > 0.75 ls 0 ) # Biny lssifiion slf.inin.ppn(fuvo) slf.ininlbls.ppn(lbl) # in if w hv nouh  if ln(slf.inin) >= 50 n ln(slf.inin) % 25 == 0: X = np.y(slf.inin) y = np.y(slf.ininlbls) Xin, Xs, yin, ys = insspli( X, y, ssiz=0.2, nos=42 ) slf.pnoniz.fi(Xin, yin) slf.isin = u # vlu yp = slf.pnoniz.pi(Xs) uy = uyso(ys, yp) f1 = f1so(ys, yp, v="wih") lo.info( "Pn oniz up: " "uy=%.2f, f1=%.2f", uy, f1, ) xp xpion s : lo.o(f"Pn oniz up fil: {}") f olsnpsho(slf) -> i[s, ny]: """ un ol s fo psisn""" un { "hopsonbni": { "lph": slf.hopsonbni.lph.olis(), "b": slf.hopsonbni.b.olis(), "olws": slf.hopsonbni.olws.olis(), "olpulls": slf.hopsonbni.olpulls.olis(), }, "nuoplsiiyol": { "xpinhisoy": slf.nuoplsiiyol.xpinhisoy, "plsiiysos": slf.nuoplsiiyol.plsiiysos, "ps": slf.nuoplsiiyol.plsiiyps, }, "fuzzypi": { "pips": slf.fuzzypi.pips, "inlo": slf.fuzzypi.inlo, "pviouso": slf.fuzzypi.pviouso, "ohisoylnh": ln(slf.fuzzypi.ohisoy), }, "ininsiz": ln(slf.inin), "isin": slf.isin, "snpshoisp": i.now().isofo(), } # lobl L piplin insn lpiplin = LIFLPiplin() f in( i: fun.iqus, qunusuls: Lis[fun.oun], olOupu: fun.Ou[bys], ) -> Non: """ zu Funion ny poin fo L inin piplin Posss qunu suls n ups L ols """ y: lo.info( "L inin i, possin % qunu suls", ln(qunusuls) ) posssssions = [] fo sul in qunusuls: y: # onv oun o i qunu = i(sul) # Poss houh L piplin linsihs = lpiplin.posslninsssion(qunu) posssssions.ppn(linsihs) lo.info( "Poss L insihs fo us %s", linsihs.("usi", "unnown"), ) xp xpion s : lo.o(f"Fil o poss qunu sul: {}") oninu # n ol snpsho fo psisn if posssssions: olsnpsho = lpiplin.olsnpsho() # Siliz n so ol olbys = pil.ups(olsnpsho) olOupu.s(olbys) lo.info( "L inin opl: poss % sssions, " "sv ol snpsho", ln(posssssions), ) xp xpion s : lo.o("L inin funion fil: %s", )