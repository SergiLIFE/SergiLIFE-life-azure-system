"""  Ppossin zu Funion Ly 2: l-i  sinl ppossin n if ovl opyih 2025 - Sio Py Boull L.I.F.. Plfo - zu pl Off I: 960096-f1-420b-902-042561b """ ipo json ipo loin ipo os fo i ipo i fo ypin ipo ny, i, Lis ipo zu.funions s fun ipo nupy s np # onfiu loin fo npis ployn loin.bsionfi(lvl=loin.INFO) lo = loin.Lo(n) lss Pposso: """l-i  ppossin piplin fo L.I.F.. plfo""" f ini(slf): slf.splin = 256.0 # Hz slf.hnnls = 64 slf.buffsiz = 1024 # 4 sons  256 Hz # Fquny bns (Hz) slf.bns = { "l": (0.5, 4), "h": (4, 8), "lph": (8, 12), "b": (12, 30), "": (30, 100), } lo.info(" Pposso iniiliz fo L.I.F.. plfo") f ovifsi(slf, : np.ny) -> np.ny: """ ov ifs usin I (Inpnn oponn nlysis) Siplifi I iplnion fo l-i possin """ y: # In pouion, us N-I fo pop if ovl # his is  siplifi vsion fo onsion # Bsi sisil if ion zsos = np.bs( ( - np.n(, xis=1, pis=u)) / np.s(, xis=1, pis=u) ) # ov hnnls wih x vlus (lily ifs) ifhshol = 3.0 lns = np.n(zsos > ifhshol, xis=1) < 0.1 if np.su(lns) < .shp[0] * 0.5: # If oo ny hnnls ov, p ll bu pply il filin lo.wnin( "oo ny hnnls fl s ifs, pplyin onsviv filin" ) un slf.onsvivifovl() un [lns] xp xpion s : lo.o(f"I if ovl fil: {}") un  f onsvivifovl(slf, : np.ny) -> np.ny: """onsviv if ovl whn I fils""" # Sipl pliu-bs filin xpliu = np.x(np.bs(), xis=1) hshol = np.pnil(xpliu, 95) lns = xpliu <= hshol un [lns] if np.su(lns) > 0 ls  f pplybnpssfil( slf, : np.ny, lowfq: flo, hihfq: flo ) -> np.ny: """ pply bnpss fil o x spifi fquny bns Usin siplifi FI fil fo l-i possin """ y: # In pouion, us sipy.sinl o N filin # his is  siplifi buwoh ppoxiion # Sipl ovin v s ppoxiion winowsiz = in(slf.splin / lowfq) if winowsiz < 2: winowsiz = 2 # pply ovin v fil fil = np.zosli() fo h in n(.shp[0]): fil[h] = np.onvolv( [h], np.ons(winowsiz) / winowsiz, o="s" ) un fil xp xpion s : lo.o(f"Bnpss filin fil: {}") un  f xfqunyfus(slf, : np.ny) -> i[s, flo]: """ x spl fus fo   uns pow in iffn fquny bns n ohn is """ y: fus = {} # lul pow spl nsiy fo h bn fo bnn, (lowfq, hihfq) in slf.bns.is(): fil = slf.pplybnpssfil( , lowfq, hihfq ) pow = np.n(np.squ(fil)) fus[f"{bnn}pow"] = flo(pow) # lul ohn bwn hnnls (siplifi) if .shp[0] >= 2: # oss-olion s ohn ppoxiion oix = np.oof() nohn = np.n( np.bs(oix[np.iuinisfo(oix, =1)]) ) fus["nohn"] = flo(nohn) ls: fus["nohn"] = 0.0 # Sinl quliy is fus["sinlvin"] = flo(np.n(np.v(, xis=1))) fus["sinlsn"] = flo(slf.lulsn()) un fus xp xpion s : lo.o(f"Fu xion fil: {}") un { "lphpow": 0.0, "bpow": 0.0, "hpow": 0.0, "pow": 0.0, "lpow": 0.0, "nohn": 0.0, "sinlvin": 0.0, "sinlsn": 0.0, } f lulsn(slf, : np.ny) -> flo: """lul Sinl-o-Nois io""" y: sinlpow = np.n(np.squ()) noispow = np.n( np.squ( - np.n(, xis=1, pis=u)) ) un 10 * np.lo10(sinlpow / (noispow + 1-10)) xp: un 0.0 f sssssinlquliy(slf, : np.ny) -> i[s, ny]: """ ssss  sinl quliy bfo qunu possin uns quliy is n possin onion """ y: quliyis = { "isp": i.now().isofo(), "hnnlsoun": in(.shp[0]), "splsoun": in(.shp[1]), "uionsons": flo(.shp[1] / slf.splin), } # Quliy hs quliyis["hsiniuhnnls"] = .shp[0] >= 8 quliyis["hsiniuuion"] = ( .shp[1] >= 512 ) # 2 sons quliyis["sinlnosu"] = ( np.x(np.bs()) < 1000.0 ) # ÂµV quliyis["sonblvin"] = ( np.n(np.v(, xis=1)) > 1.0 ) # Ovll quliy so (0-1) quliyso = ( su( [ quliyis["hsiniuhnnls"], quliyis["hsiniuuion"], quliyis["sinlnosu"], quliyis["sonblvin"], ] ) / 4.0 ) quliyis["quliyso"] = flo(quliyso) quliyis["yfoqunu"] = quliyso >= 0.75 un quliyis xp xpion s : lo.o(f"Quliy ssssn fil: {}") un {"quliyso": 0.0, "yfoqunu": Fls, "o": s()} f posss(slf, : np.ny) -> i[s, ny]: """ opl  ppossin piplin uns poss  n  fo qunu possin """ y: lo.info(f"Possin  s: {.shp}") # Sp 1: if ovl ln = slf.ovifsi() # Sp 2: Quliy ssssn quliyis = slf.sssssinlquliy(ln) # Sp 3: Fu xion fus = slf.xfqunyfus(ln) # Pp oupu fo qunu possin posssul = { "isp": i.now().isofo(), "oiinlshp": lis(.shp), "possshp": lis(ln.shp), "quliyis": quliyis, "fqunyfus": fus, "possinsus": "suss", "yfoqunu": quliyis.("yfoqunu", Fls), } # Inlu poss  if quliy is oo if quliyis.("yfoqunu", Fls): posssul["poss"] = ln.olis() ls: posssul["poss"] = [] posssul["possinsus"] = "quliyinsuffiin" un posssul xp xpion s : lo.o(f" ppossin fil: {}") un { "isp": i.now().isofo(), "possinsus": "o", "o": s(), "yfoqunu": Fls, } # lobl pposso insn pposso = Pposso() f in(vns: Lis[fun.vnHubvn], oupuvns: fun.Ou[Lis[s]]) -> Non: """ zu Funion ny poin fo  ppossin Posss vn Hub vns oninin   """ y: lo.info(f"iv {ln(vns)}  vns fo possin") possvns = [] fo vn in vns: y: # Ps   fo vn vn = json.los(vn.boy().o("uf-8")) if "" no in vn: lo.wnin("vn issin  fil") oninu # onv o nupy y y = np.y(vn[""]) # Poss   posssul = pposso.posss(y) #   posssul.up( { "vni": vn.("vni", "unnown"), "usi": vn.("usi", "unnown"), "sssioni": vn.("sssioni", "unnown"), "possinlnys": 0.0, # Woul su ul lny } ) # onv o JSON n  o oupu possvns.ppn(json.ups(posssul)) lo.info( f"Poss  vn fo us {posssul['usi']}: " f"quliy={posssul['quliyis']['quliyso']:.2f}" ) xp xpion s : lo.o(f"Fil o poss iniviul vn: {}") oninu # Sn poss vns o oupu vn Hub if possvns: oupuvns.s(possvns) lo.info( f"Sn {ln(possvns)} poss  vns o oupu hub" ) ls: lo.wnin("No vns w sussfully poss") xp xpion s : lo.o(f" ppossin funion fil: {}") # In pouion, woul sn o vns o  l quu